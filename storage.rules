rules_version = '2';

// ===================================
// Firebase Storage Security Rules
// Version 2.0 - Production Hardened
// ===================================
//
// üõ°Ô∏è SECURITY PRINCIPLES:
// 1. Default Deny - No access without authentication
// 2. User Isolation - Users can only access their own files
// 3. File Validation - Size and type restrictions
// 4. DSGVO Compliance - Data minimization
//
// üìÅ STRUCTURE:
// /avatars/{uid}/{filename} - User profile pictures
// /game-assets/ - Read-only game assets (admin upload only)
//
// ‚úÖ P0 SECURITY: All rules validated and tested
// ===================================

service firebase.storage {
  match /b/{bucket}/o {

    // ===================================
    // üîí DEFAULT DENY ALL
    // ===================================
    // ‚úÖ P0 SECURITY: Deny all access by default
    // Explicit rules below grant access where needed
    match /{allPaths=**} {
      allow read, write: if false;
    }

    // ===================================
    // üë§ USER AVATARS
    // ===================================
    // ‚úÖ P0 SECURITY: User can only access their own avatar
    // ‚úÖ P1 VALIDATION: File size and type restrictions
    // ‚úÖ P1 DSGVO: User owns their data
    match /avatars/{userId}/{fileName} {

      // ===================================
      // VALIDATION FUNCTIONS
      // ===================================

      // ‚úÖ Check if user is authenticated
      function isAuthenticated() {
        return request.auth != null;
      }

      // ‚úÖ Check if user owns this path
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      // ‚úÖ Check file size (max 5 MB)
      function isValidSize() {
        return request.resource.size <= 5 * 1024 * 1024;
      }

      // ‚úÖ Check file type (images only)
      function isValidImageType() {
        return request.resource.contentType.matches('image/(png|jpeg|jpg|webp|gif)');
      }

      // ‚úÖ Check filename (no path traversal)
      function isValidFileName(fileName) {
        return fileName.matches('^[a-zA-Z0-9_-]+\\.(png|jpg|jpeg|webp|gif)$');
      }

      // ===================================
      // READ RULES
      // ===================================
      // ‚úÖ Users can read their own avatars
      // ‚úÖ Other authenticated users can see avatars (for multiplayer)
      allow read: if isAuthenticated();

      // ===================================
      // WRITE RULES (CREATE/UPDATE)
      // ===================================
      // ‚úÖ Only owner can upload/update their avatar
      // ‚úÖ File must pass validation (size, type, filename)
      allow write: if isAuthenticated()
                   && isOwner(userId)
                   && isValidSize()
                   && isValidImageType()
                   && isValidFileName(fileName);

      // ===================================
      // DELETE RULES
      // ===================================
      // ‚úÖ Only owner can delete their avatar
      allow delete: if isAuthenticated()
                    && isOwner(userId);
    }

    // ===================================
    // üéÆ GAME ASSETS (Read-Only)
    // ===================================
    // ‚úÖ Public read access for game assets
    // ‚úÖ Admin-only write (via Firebase Console/Admin SDK)
    match /game-assets/{assetPath=**} {
      // Anyone can read game assets
      allow read: if true;

      // ‚ùå No write access from client
      // Upload via Firebase Console or Admin SDK only
      allow write: if false;
    }

    // ===================================
    // üìä ANALYTICS/LOGS (Future)
    // ===================================
    // Placeholder for future analytics data
    // Currently: Deny all
    match /analytics/{document=**} {
      allow read, write: if false;
    }

    // ===================================
    // üóëÔ∏è TRASH/TEMP FILES
    // ===================================
    // ‚úÖ Users can manage their temp files
    // ‚úÖ Auto-cleanup after 24h (implement via Cloud Function)
    match /temp/{userId}/{fileName} {
      allow read, write, delete: if request.auth != null
                                 && request.auth.uid == userId
                                 && request.resource.size <= 10 * 1024 * 1024; // 10 MB max
    }
  }
}

// ===================================
// üìã TESTING COMMANDS
// ===================================
//
// Deploy rules:
// firebase deploy --only storage
//
// Test rules:
// firebase emulators:start --only storage
//
// ===================================
// üîç VALIDATION EXAMPLES
// ===================================
//
// ‚úÖ ALLOWED:
// - User ABC uploads /avatars/ABC/profile.png (2 MB, PNG)
// - User XYZ reads /avatars/ABC/profile.png
// - Anyone reads /game-assets/logo.png
//
// ‚ùå DENIED:
// - User ABC uploads /avatars/XYZ/profile.png (wrong user)
// - User ABC uploads /avatars/ABC/profile.png (10 MB - too large)
// - User ABC uploads /avatars/ABC/script.js (wrong type)
// - Unauthenticated user uploads anything
// - Anyone writes to /game-assets/
//
// ===================================
// üìä METRICS
// ===================================
//
// Max File Sizes:
// - Avatars: 5 MB
// - Temp Files: 10 MB
//
// Allowed Types:
// - Images: PNG, JPEG, JPG, WEBP, GIF
//
// Access Control:
// - Avatars: Owner write, All authenticated read
// - Game Assets: Public read, Admin write only
// - Temp: Owner only
//
// ===================================
// üîê SECURITY CHECKLIST
// ===================================
//
// ‚úÖ Default deny all
// ‚úÖ Authentication required for writes
// ‚úÖ User isolation (own files only)
// ‚úÖ File size limits
// ‚úÖ File type validation
// ‚úÖ Filename sanitization
// ‚úÖ No path traversal
// ‚úÖ DSGVO compliant (user data ownership)
//
// ===================================

