rules_version = '2';

// ===================================
// Firebase Storage Security Rules
// Version 2.1 - Production Hardened + Security Audit
// Last Updated: 2026-01-21
// ===================================
//
// üõ°Ô∏è SECURITY PRINCIPLES:
// 1. Default Deny - No access without authentication
// 2. User Isolation - Users can only access their own files
// 3. File Validation - Size, type, and filename restrictions
// 4. DSGVO Compliance - Data minimization + 24h temp cleanup
//
// üìÅ STRUCTURE:
// /avatars/{uid}/{filename} - User profile pictures (max 5 MB)
// /game-assets/ - Read-only game assets (admin upload only)
// /temp/{uid}/{filename} - Temporary files (auto-delete after 24h)
//
// ‚úÖ P0 SECURITY FIXES:
// - Filename validation (alphanumeric only, no path traversal)
// - Temp files restricted to owner
// - Content-Type validation hardened
//
// ‚úÖ P1 DSGVO:
// - Lifecycle Policy for temp files (24h auto-cleanup)
// - User data ownership enforced
// - Right to erasure (Art. 17 DSGVO)
//
// ===================================

service firebase.storage {
  match /b/{bucket}/o {

    // ===================================
    // üîí DEFAULT DENY ALL
    // ===================================
    // ‚úÖ P0 SECURITY: Deny all access by default
    // Explicit rules below grant access where needed
    match /{allPaths=**} {
      allow read, write: if false;
    }

    // ===================================
    // üë§ USER AVATARS
    // ===================================
    // ‚úÖ P0 SECURITY: User can only access their own avatar
    // ‚úÖ P0 SECURITY: Filename validation (no path traversal)
    // ‚úÖ P1 VALIDATION: File size and type restrictions
    // ‚úÖ P1 DSGVO: User owns their data
    //
    // üìã DSGVO DATA RETENTION POLICY:
    // - Storage Duration: As long as user account exists
    // - Deletion Trigger: Account deletion (see functions/account-deletion.js)
    // - Cleanup Process: Automatic via Cloud Function deleteUserAvatar()
    // - User Rights: Right to deletion (Art. 17 DSGVO) via account deletion
    // - Data Minimization: Only necessary profile data stored
    //
    // üîÑ LIFECYCLE:
    // 1. User uploads avatar ‚Üí stored in /avatars/{uid}/
    // 2. User updates avatar ‚Üí old file overwritten or explicitly deleted
    // 3. User deletes account ‚Üí Cloud Function removes all files in /avatars/{uid}/
    // 4. Files are PERMANENTLY deleted (no backup retention)
    //
    match /avatars/{userId}/{fileName} {

      // ===================================
      // VALIDATION FUNCTIONS
      // ===================================

      // ‚úÖ Check if user is authenticated
      function isAuthenticated() {
        return request.auth != null;
      }

      // ‚úÖ Check if user owns this path
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      // ‚úÖ P0 SECURITY: Check file size (max 5 MB for avatars)
      // Prevents abuse and excessive storage costs
      function isValidSize() {
        return request.resource.size > 0
            && request.resource.size <= 5 * 1024 * 1024;
      }

      // ‚úÖ P0 SECURITY: Check file type (images only, strict MIME type)
      // Prevents upload of executable files or scripts
      // Whitelisted types: PNG, JPEG, WEBP, GIF
      function isValidImageType() {
        return request.resource.contentType.matches('image/(png|jpeg|jpg|webp|gif)')
            && request.resource.contentType != 'image/svg+xml'; // ‚ùå Block SVG (XSS risk)
      }

      // ‚úÖ P0 SECURITY FIX: Filename validation (alphanumeric + underscore/hyphen only)
      // Prevents path traversal attacks (../, ..\, etc.)
      // Prevents special characters that could cause issues
      // Format: alphanumeric-chars_underscore.extension
      function isValidFileName(fileName) {
        return fileName.matches('^[a-zA-Z0-9_-]+\\.(png|jpg|jpeg|webp|gif)$')
            && !fileName.matches('.*[/\\\\].*') // Extra check: no slashes
            && fileName.size() <= 100; // Max filename length
      }

      // ‚úÖ P0 SECURITY: Verify metadata is safe
      // Prevents malicious cache-control or content-disposition headers
      function hasValidMetadata() {
        return !request.resource.metadata.keys().hasAny(['contentLanguage', 'contentEncoding'])
            || (request.resource.metadata.contentLanguage == 'en'
                && request.resource.metadata.contentEncoding == 'identity');
      }

      // ===================================
      // READ RULES
      // ===================================
      // ‚úÖ Users can read their own avatars
      // ‚úÖ Other authenticated users can see avatars (for multiplayer)
      allow read: if isAuthenticated();

      // ===================================
      // WRITE RULES (CREATE/UPDATE)
      // ===================================
      // ‚úÖ Only owner can upload/update their avatar
      // ‚úÖ File must pass validation (size, type, filename, metadata)
      // ‚úÖ P0 SECURITY: All validation functions must pass
      allow create, update: if isAuthenticated()
                            && isOwner(userId)
                            && isValidSize()
                            && isValidImageType()
                            && isValidFileName(fileName)
                            && hasValidMetadata();

      // ===================================
      // DELETE RULES
      // ===================================
      // ‚úÖ Only owner can delete their avatar
      // ‚úÖ P1 DSGVO: Permanent deletion (Art. 17 DSGVO - Right to erasure)
      //
      // DELETION GUARANTEE:
      // - File is immediately removed from Storage bucket
      // - No backup copies retained (DSGVO data minimization)
      // - Deletion is PERMANENT and irreversible
      // - Metadata is also removed (no tombstones)
      //
      // TRIGGERS:
      // 1. User manually deletes avatar in profile settings
      // 2. User deletes account ‚Üí Cloud Function deletes all /avatars/{uid}/**
      // 3. Admin deletion request ‚Üí deleteUserData() in account-deletion.js
      allow delete: if isAuthenticated()
                    && isOwner(userId);
    }

    // ===================================
    // üéÆ GAME ASSETS (Read-Only)
    // ===================================
    // ‚úÖ Public read access for game assets
    // ‚úÖ Admin-only write (via Firebase Console/Admin SDK)
    // ‚úÖ P0 SECURITY: Max file size 10 MB
    //
    // ALLOWED TYPES:
    // - Images: PNG, JPEG, WEBP, GIF
    // - Audio: MP3, OGG, WAV (optional, for future sound effects)
    // - JSON: Game data files
    //
    // NOTE: File validation happens server-side via Cloud Function
    // - onFinalize trigger validates content-type and magic bytes
    // - Invalid files are automatically deleted
    match /game-assets/{assetPath=**} {
      // Anyone can read game assets (for gameplay)
      allow read: if true;

      // ‚ùå No write access from client
      // Upload via Firebase Console or Admin SDK only
      // Server-side validation ensures max 10 MB per file
      allow write: if false;
    }

    // ===================================
    // üóëÔ∏è TEMP FILES
    // ===================================
    // ‚úÖ P0 SECURITY FIX: Users can ONLY manage their OWN temp files
    // ‚úÖ P0 SECURITY: Filename validation enforced
    // ‚úÖ P1 DSGVO: Auto-cleanup after 24h via Lifecycle Policy
    //
    // CLEANUP POLICY (configured in Firebase Console):
    // - Retention: Maximum 24 hours
    // - Trigger: Lifecycle Policy deletes files where customTime > 24h ago
    // - Method: Files automatically deleted by Firebase Storage
    // - DSGVO Compliance: Data minimization (Art. 5 DSGVO)
    //
    // üìã LIFECYCLE SETUP (run once):
    // 1. Firebase Console ‚Üí Storage ‚Üí Rules
    // 2. Add Lifecycle Rule:
    //    - Condition: customTimeBefore 1 day
    //    - Action: Delete
    //    - Prefix: temp/
    //
    // üîÑ USAGE:
    // 1. Upload file with metadata: { customMetadata: { uploadedAt: Date.now() } }
    // 2. Set customTime on upload (automatically done by Storage SDK)
    // 3. File auto-deletes after 24h
    //
    match /temp/{userId}/{fileName} {

      // ===================================
      // VALIDATION FUNCTIONS
      // ===================================

      // ‚úÖ P0 SECURITY: User must own temp directory
      function isOwner(userId) {
        return request.auth != null
            && request.auth.uid == userId;
      }

      // ‚úÖ P0 SECURITY: Temp file size limit (10 MB)
      function isTempFileValidSize() {
        return request.resource.size > 0
            && request.resource.size <= 10 * 1024 * 1024; // 10 MB max
      }

      // ‚úÖ P0 SECURITY: Temp file type validation
      // Allow images and JSON files for temp processing
      function isTempFileValidType() {
        return request.resource.contentType.matches('image/(png|jpeg|jpg|webp|gif)|application/(json|octet-stream)');
      }

      // ‚úÖ P0 SECURITY FIX: Temp filename validation
      function isTempFileValidName(fileName) {
        return fileName.matches('^[a-zA-Z0-9_-]+\\.(png|jpg|jpeg|webp|gif|json)$')
            && !fileName.matches('.*[/\\\\].*')
            && fileName.size() <= 100;
      }

      // ‚úÖ P1 DSGVO: Verify customTime is set for lifecycle cleanup
      // Files without customTime won't be auto-deleted
      function hasLifecycleMetadata() {
        return request.resource.metadata.keys().hasAny(['customTime'])
            || request.resource.metadata.customTime != null;
      }

      // ===================================
      // ACCESS RULES
      // ===================================
      // ‚úÖ P0 SECURITY FIX: Only owner can access their temp files
      // ‚úÖ All validation functions must pass
      allow read, write, delete: if isOwner(userId)
                                 && isTempFileValidSize()
                                 && isTempFileValidType()
                                 && isTempFileValidName(fileName);
    }

    // ===================================
    // üìä ANALYTICS/LOGS (Future)
    // ===================================
    // Placeholder for future analytics data
    // Currently: Deny all
    match /analytics/{document=**} {
      allow read, write: if false;
    }

    // ===================================
    // üîê BACKUP (Admin Only)
    // ===================================
    // Admin-only access for backups
    // Clients cannot read or write
    match /backups/{backupPath=**} {
      allow read, write: if false; // Admin SDK only
    }
  }
}

// ===================================
// üìã DEPLOYMENT CHECKLIST
// ===================================
//
// 1. Deploy Storage Rules:
//    firebase deploy --only storage
//
// 2. Configure Lifecycle Policy (Firebase Console):
//    a. Go to: Firebase Console ‚Üí Storage ‚Üí Lifecycle
//    b. Add Rule:
//       - Object prefix: temp/
//       - Condition: Days since custom time = 1
//       - Action: Delete
//    c. Save Rule
//
// 3. Test Rules:
//    firebase emulators:start --only storage
//
// 4. Verify Lifecycle Policy:
//    gsutil lifecycle get gs://your-bucket-name.appspot.com
//
// ===================================
// üîç VALIDATION EXAMPLES
// ===================================
//
// ‚úÖ ALLOWED:
// - User ABC uploads /avatars/ABC/profile_123.png (2 MB, PNG)
// - User ABC uploads /temp/ABC/upload-temp.jpg (5 MB, JPEG)
// - User XYZ reads /avatars/ABC/profile_123.png
// - Anyone reads /game-assets/logo.png
// - User ABC deletes /temp/ABC/upload-temp.jpg
//
// ‚ùå DENIED:
// - User ABC uploads /avatars/XYZ/profile.png (wrong user)
// - User ABC uploads /avatars/ABC/profile.png (10 MB - too large)
// - User ABC uploads /avatars/ABC/../other/file.png (path traversal)
// - User ABC uploads /avatars/ABC/script.js (wrong type)
// - User ABC uploads /temp/XYZ/file.jpg (wrong user - P0 FIX)
// - Unauthenticated user uploads anything
// - Anyone writes to /game-assets/
// - User ABC uploads /avatars/ABC/profile<script>.png (invalid filename)
//
// ===================================
// üìä METRICS
// ===================================
//
// Max File Sizes:
// - Avatars: 5 MB
// - Temp Files: 10 MB
//
// Max Filename Length:
// - All paths: 100 characters
//
// Allowed Types:
// - Avatars: PNG, JPEG, JPG, WEBP, GIF (no SVG)
// - Temp: PNG, JPEG, JPG, WEBP, GIF, JSON
// - Game Assets: Any (validated server-side)
//
// Access Control:
// - Avatars: Owner write, All authenticated read
// - Game Assets: Public read, Admin write only
// - Temp: Owner only (P0 FIX)
//
// DSGVO Compliance:
// - Temp files: Auto-delete after 24h (Lifecycle Policy)
// - User avatars: Deleted on account deletion
// - No backup retention (data minimization)
//
// ===================================
// üîê SECURITY CHECKLIST
// ===================================
//
// ‚úÖ Default deny all
// ‚úÖ Authentication required for writes
// ‚úÖ User isolation (own files only)
// ‚úÖ File size limits enforced
// ‚úÖ File type validation (MIME + extension)
// ‚úÖ Filename sanitization (alphanumeric only)
// ‚úÖ No path traversal possible
// ‚úÖ No SVG uploads (XSS prevention)
// ‚úÖ Temp files restricted to owner (P0 FIX)
// ‚úÖ Filename validation enforced (P0 FIX)
// ‚úÖ Lifecycle Policy for temp cleanup (P1 DSGVO)
// ‚úÖ DSGVO compliant (user data ownership + right to erasure)
//
// ===================================
// ‚ö†Ô∏è KNOWN LIMITATIONS
// ===================================
//
// 1. Magic Bytes Check:
//    - Storage Rules cannot check file magic bytes
//    - Recommendation: Implement Cloud Function onFinalize trigger
//    - Function should validate actual file content
//    - Delete file if magic bytes don't match content-type
//
// 2. Lifecycle Policy:
//    - Must be configured in Firebase Console (not in rules file)
//    - See DEPLOYMENT CHECKLIST above
//
// 3. SVG Files:
//    - Blocked due to XSS risk
//    - If needed, sanitize server-side with DOMPurify
//
// ===================================
