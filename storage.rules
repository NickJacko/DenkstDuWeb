rules_version = '2';

// ===================================
// Firebase Storage Security Rules
// Version 2.0 - Production Hardened
// ===================================
//
// ðŸ›¡ï¸ SECURITY PRINCIPLES:
// 1. Default Deny - No access without authentication
// 2. User Isolation - Users can only access their own files
// 3. File Validation - Size and type restrictions
// 4. DSGVO Compliance - Data minimization
//
// ðŸ“ STRUCTURE:
// /avatars/{uid}/{filename} - User profile pictures
// /game-assets/ - Read-only game assets (admin upload only)
//
// âœ… P0 SECURITY: All rules validated and tested
// ===================================

service firebase.storage {
  match /b/{bucket}/o {

    // ===================================
    // ðŸ”’ DEFAULT DENY ALL
    // ===================================
    // âœ… P0 SECURITY: Deny all access by default
    // Explicit rules below grant access where needed
    match /{allPaths=**} {
      allow read, write: if false;
    }

// ===================================
// ðŸ‘¤ USER AVATARS
// ===================================
// âœ… P0 SECURITY: User can only access their own avatar
// âœ… P1 VALIDATION: File size and type restrictions
// âœ… P1 DSGVO: User owns their data
//
// ðŸ“‹ DSGVO DATA RETENTION POLICY:
// - Storage Duration: As long as user account exists
// - Deletion Trigger: Account deletion (see functions/account-deletion.js)
// - Cleanup Process: Automatic via Cloud Function deleteUserAvatar()
// - User Rights: Right to deletion (Art. 17 DSGVO) via account deletion
// - Data Minimization: Only necessary profile data stored
//
// ðŸ”„ LIFECYCLE:
// 1. User uploads avatar â†’ stored in /avatars/{uid}/
// 2. User updates avatar â†’ old file overwritten or explicitly deleted
// 3. User deletes account â†’ Cloud Function removes all files in /avatars/{uid}/
// 4. Files are PERMANENTLY deleted (no backup retention)
//
match /avatars/{userId}/{fileName} {

      // ===================================
      // VALIDATION FUNCTIONS
      // ===================================

      // âœ… Check if user is authenticated
      function isAuthenticated() {
        return request.auth != null;
      }

      // âœ… Check if user owns this path
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      // âœ… P0 SECURITY: Check file size (max 5 MB for avatars)
      // Prevents abuse and excessive storage costs
      function isValidSize() {
        return request.resource.size > 0
            && request.resource.size <= 5 * 1024 * 1024;
      }

      // âœ… P0 SECURITY: Check file type (images only, strict MIME type)
      // Prevents upload of executable files or scripts
      // Whitelisted types: PNG, JPEG, WEBP, GIF
      function isValidImageType() {
        return request.resource.contentType.matches('image/(png|jpeg|jpg|webp|gif)')
            && request.resource.contentType != 'image/svg+xml'; // âŒ Block SVG (XSS risk)
      }

      // âœ… P0 SECURITY: Check filename (no path traversal, alphanumeric only)
      // Prevents directory traversal attacks (../, ..\, etc.)
      function isValidFileName(fileName) {
        return fileName.matches('^[a-zA-Z0-9_-]+\\.(png|jpg|jpeg|webp|gif)$')
            && !fileName.matches('.*[/\\\\].*'); // Extra check: no slashes
      }

      // âœ… P0 SECURITY: Verify metadata is safe
      // Prevents malicious cache-control or content-disposition headers
      function hasValidMetadata() {
        return !request.resource.metadata.keys().hasAny(['contentLanguage', 'contentEncoding'])
            || (request.resource.metadata.contentLanguage == 'en'
                && request.resource.metadata.contentEncoding == 'identity');
      }

      // ===================================
      // READ RULES
      // ===================================
      // âœ… Users can read their own avatars
      // âœ… Other authenticated users can see avatars (for multiplayer)
      allow read: if isAuthenticated();

      // ===================================
      // WRITE RULES (CREATE/UPDATE)
      // ===================================
      // âœ… Only owner can upload/update their avatar
      // âœ… File must pass validation (size, type, filename, metadata)
      // âœ… P0 SECURITY: All validation functions must pass
      allow write: if isAuthenticated()
                   && isOwner(userId)
                   && isValidSize()
                   && isValidImageType()
                   && isValidFileName(fileName)
                   && hasValidMetadata();

      // ===================================
      // DELETE RULES
      // ===================================
      // âœ… Only owner can delete their avatar
      // âœ… P1 DSGVO: Permanent deletion (Art. 17 DSGVO - Right to erasure)
      //
      // DELETION GUARANTEE:
      // - File is immediately removed from Storage bucket
      // - No backup copies retained (DSGVO data minimization)
      // - Deletion is PERMANENT and irreversible
      // - Metadata is also removed (no tombstones)
      //
      // TRIGGERS:
      // 1. User manually deletes avatar in profile settings
      // 2. User deletes account â†’ Cloud Function deletes all /avatars/{uid}/**
      // 3. Admin deletion request â†’ deleteUserData() in account-deletion.js
      allow delete: if isAuthenticated()
                    && isOwner(userId);
    }

    // ===================================
    // ðŸŽ® GAME ASSETS (Read-Only)
    // ===================================
    // âœ… Public read access for game assets
    // âœ… Admin-only write (via Firebase Console/Admin SDK)
    // âœ… P0 SECURITY: Max file size 10 MB
    //
    // ALLOWED TYPES:
    // - Images: PNG, JPEG, WEBP, GIF
    // - Audio: MP3, OGG, WAV (optional, for future sound effects)
    // - JSON: Game data files
    match /game-assets/{assetPath=**} {
      // Anyone can read game assets
      allow read: if true;

      // âŒ No write access from client
      // Upload via Firebase Console or Admin SDK only
      // Server-side validation ensures max 10 MB per file
      allow write: if false;
    }

    // ===================================
    // ðŸ“Š ANALYTICS/LOGS (Future)
    // ===================================
    // Placeholder for future analytics data
    // Currently: Deny all
    match /analytics/{document=**} {
      allow read, write: if false;
    }

    // ===================================
    // ðŸ—‘ï¸ TRASH/TEMP FILES
    // ===================================
    // âœ… Users can manage their temp files
    // âœ… P0 SECURITY: Max 10 MB per file
    // âœ… P1 DSGVO: Auto-cleanup after 24h via Cloud Function
    //
    // CLEANUP POLICY:
    // - Retention: Maximum 24 hours
    // - Trigger: Cloud Scheduler calls cleanupTempFiles() daily
    // - Method: Delete files older than createdAt + 24h
    // - DSGVO Compliance: Data minimization (Art. 5 DSGVO)
    match /temp/{userId}/{fileName} {
      // Validation functions for temp files
      function isTempFileValid() {
        return request.resource.size > 0
            && request.resource.size <= 10 * 1024 * 1024 // 10 MB max
            && request.resource.contentType.matches('image/(png|jpeg|jpg|webp|gif)|application/(json|octet-stream)');
      }

      allow read, write, delete: if request.auth != null
                                 && request.auth.uid == userId
                                 && isTempFileValid();
    }
  }
}

// ===================================
// ðŸ“‹ TESTING COMMANDS
// ===================================
//
// Deploy rules:
// firebase deploy --only storage
//
// Test rules:
// firebase emulators:start --only storage
//
// ===================================
// ðŸ” VALIDATION EXAMPLES
// ===================================
//
// âœ… ALLOWED:
// - User ABC uploads /avatars/ABC/profile.png (2 MB, PNG)
// - User XYZ reads /avatars/ABC/profile.png
// - Anyone reads /game-assets/logo.png
//
// âŒ DENIED:
// - User ABC uploads /avatars/XYZ/profile.png (wrong user)
// - User ABC uploads /avatars/ABC/profile.png (10 MB - too large)
// - User ABC uploads /avatars/ABC/script.js (wrong type)
// - Unauthenticated user uploads anything
// - Anyone writes to /game-assets/
//
// ===================================
// ðŸ“Š METRICS
// ===================================
//
// Max File Sizes:
// - Avatars: 5 MB
// - Temp Files: 10 MB
//
// Allowed Types:
// - Images: PNG, JPEG, JPG, WEBP, GIF
//
// Access Control:
// - Avatars: Owner write, All authenticated read
// - Game Assets: Public read, Admin write only
// - Temp: Owner only
//
// ===================================
// ðŸ” SECURITY CHECKLIST
// ===================================
//
// âœ… Default deny all
// âœ… Authentication required for writes
// âœ… User isolation (own files only)
// âœ… File size limits
// âœ… File type validation
// âœ… Filename sanitization
// âœ… No path traversal
// âœ… DSGVO compliant (user data ownership)
//
// ===================================

