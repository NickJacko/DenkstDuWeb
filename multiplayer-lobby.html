<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DenkstDu - Multiplayer Lobby</title>
    <style>
        /* Basic styling for the lobby */
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            color: white;
        }

        .lobby-container {
            max-width: 600px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .lobby-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .game-id-display {
            font-size: 2rem;
            font-weight: bold;
            background: rgba(255, 255, 255, 0.2);
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            letter-spacing: 3px;
        }

        .players-section {
            margin: 30px 0;
        }

        .player-item {
            display: flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            margin: 10px 0;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .player-avatar {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
        }

        .player-info {
            flex: 1;
        }

        .player-name {
            font-weight: bold;
            font-size: 1.1rem;
        }

        .player-role {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .player-status {
            padding: 5px 15px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .host-player .player-avatar {
            background: linear-gradient(135deg, #FFD700, #FFA500);
        }

        .guest-player .player-avatar {
            background: linear-gradient(135deg, #4CAF50, #45a049);
        }

        .status-ready {
            background: rgba(76, 175, 80, 0.3);
            border: 1px solid #4CAF50;
            color: #4CAF50;
        }

        .controls {
            text-align: center;
            margin-top: 30px;
        }

        .btn {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            margin: 10px;
            transition: transform 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.5);
        }

        .refresh-info {
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="lobby-container">
        <div class="lobby-header">
            <h1>üåê Multiplayer Lobby</h1>
            <p>Warte auf Spieler und starte das Spiel</p>
            
            <div class="game-id-display" id="game-id-display">ABC123</div>
        </div>

        <div class="players-section">
            <h3>üë• Spieler <span id="player-count">(1/8)</span></h3>
            <div id="players-list">
                <!-- Players will be loaded here -->
            </div>
        </div>

        <div class="controls">
            <button class="btn" onclick="startGame()" id="start-btn" disabled>
                üöÄ Spiel starten
            </button>
            <button class="btn btn-secondary" onclick="leaveLobby()">
                üö™ Lobby verlassen
            </button>
        </div>
    </div>

    <script>
        // ===== GAME STATE MANAGEMENT =====
        class GameState {
            constructor(playerKey = null) {
                this.playerKey = playerKey;
                this.reset();
                this.loadFromStorage();
            }

            reset() {
                this.deviceMode = null;
                this.selectedCategories = [];
                this.difficulty = null;
                this.players = [];
                this.gameId = null;
                this.playerName = null;
                this.isHost = false;
                this.isGuest = false;
                this.currentQuestionIndex = 0;
                this.gamePhase = 'lobby';
                this.timestamp = Date.now();
            }

            getStorageKey() {
                if (this.playerKey) {
                    return `denkstdu_game_state_${this.playerKey}`;
                }
                return 'denkstdu_game_state';
            }

            saveToStorage() {
                try {
                    const stateToSave = {
                        deviceMode: this.deviceMode,
                        selectedCategories: this.selectedCategories,
                        difficulty: this.difficulty,
                        players: this.players,
                        gameId: this.gameId,
                        playerName: this.playerName,
                        isHost: this.isHost,
                        isGuest: this.isGuest,
                        currentQuestionIndex: this.currentQuestionIndex,
                        gamePhase: this.gamePhase,
                        timestamp: Date.now(),
                        lastHeartbeat: Date.now(), // Add heartbeat timestamp
                        version: 2,
                        playerKey: this.playerKey
                    };
                    
                    localStorage.setItem(this.getStorageKey(), JSON.stringify(stateToSave));
                    
                    if (this.isHost) {
                        localStorage.setItem('denkstdu_game_state', JSON.stringify(stateToSave));
                    }
                    
                    return true;
                } catch (error) {
                    console.error('‚ùå Failed to save GameState:', error);
                    return false;
                }
            }

            updateHeartbeat() {
                // Update only the heartbeat timestamp
                try {
                    const currentState = localStorage.getItem(this.getStorageKey());
                    if (currentState) {
                        const state = JSON.parse(currentState);
                        state.lastHeartbeat = Date.now();
                        localStorage.setItem(this.getStorageKey(), JSON.stringify(state));
                        
                        if (this.isHost) {
                            localStorage.setItem('denkstdu_game_state', JSON.stringify(state));
                        }
                    }
                } catch (error) {
                    console.error('‚ùå Failed to update heartbeat:', error);
                }
            }

            loadFromStorage() {
                try {
                    const saved = localStorage.getItem(this.getStorageKey());
                    if (saved) {
                        const state = JSON.parse(saved);
                        const maxAge = 24 * 60 * 60 * 1000;
                        if (state.timestamp && (Date.now() - state.timestamp) < maxAge) {
                            Object.keys(state).forEach(key => {
                                if (this.hasOwnProperty(key) || key === 'deviceMode' || key === 'playerKey') {
                                    this[key] = state[key];
                                }
                            });
                            return true;
                        } else {
                            this.clearStorage();
                        }
                    }
                } catch (error) {
                    console.error('‚ùå Failed to load GameState:', error);
                    this.clearStorage();
                }
                return false;
            }

            clearStorage() {
                localStorage.removeItem(this.getStorageKey());
                if (this.isHost) {
                    localStorage.removeItem('denkstdu_game_state');
                }
            }
        }

        // ===== GLOBAL VARIABLES =====
        let gameState = null;
        let refreshInterval = null;
        let heartbeatInterval = null;

        // ===== INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', function() {
            initLobby();
        });

        function initLobby() {
            console.log('üåê Initializing multiplayer lobby...');
            
            // Find the correct GameState instance
            gameState = findPlayerGameState();
            
            if (!gameState || !gameState.gameId) {
                console.error('‚ùå No valid game state found');
                alert('Kein g√ºltiges Spiel gefunden. Zur√ºck zum Hauptmen√º.');
                window.location.href = 'index.html';
                return;
            }

            // Update UI with game info
            updateGameDisplay();
            
            // Start background services
            startHeartbeat();
            startAutoRefresh();
            
            // Initial player list load
            loadAllPlayers();
            
            // Setup cleanup on page unload
            setupCleanupHandlers();
            
            console.log('‚úÖ Lobby initialized for:', {
                playerName: gameState.playerName,
                isHost: gameState.isHost,
                gameId: gameState.gameId
            });
        }

        function findPlayerGameState() {
            // Try to find the player's specific GameState
            const keys = Object.keys(localStorage);
            
            // First try to load from main key
            try {
                const mainState = localStorage.getItem('denkstdu_game_state');
                if (mainState) {
                    const state = JSON.parse(mainState);
                    if (state.deviceMode === 'multi' && state.gameId) {
                        return new GameState(); // Load main state
                    }
                }
            } catch (e) {
                // Ignore
            }
            
            // Then try to find guest states
            for (let key of keys) {
                if (key.startsWith('denkstdu_game_state_guest_')) {
                    try {
                        const guestState = JSON.parse(localStorage.getItem(key));
                        if (guestState.deviceMode === 'multi' && guestState.gameId) {
                            const playerKey = key.replace('denkstdu_game_state_', '');
                            return new GameState(playerKey);
                        }
                    } catch (e) {
                        // Ignore
                    }
                }
            }
            
            return null;
        }

        function updateGameDisplay() {
            document.getElementById('game-id-display').textContent = gameState.gameId;
        }

        // ===== PLAYER MANAGEMENT =====
        function loadAllPlayers() {
            const playersList = document.getElementById('players-list');
            playersList.innerHTML = '';
            
            const allPlayers = getAllPlayersInGame();
            
            // Add each player
            allPlayers.forEach(player => {
                addPlayerToDisplay(player);
            });
            
            // Update counter and controls
            updatePlayerCount(allPlayers.length);
            updateStartButton(allPlayers.length);
        }

        function getAllPlayersInGame() {
            const players = [];
            const gameId = gameState.gameId;
            const now = Date.now();
            const maxOfflineTime = 10000; // 10 seconds offline = remove player
            
            // Get host player (check if still online)
            try {
                const hostState = localStorage.getItem('denkstdu_game_state');
                if (hostState) {
                    const host = JSON.parse(hostState);
                    if (host.gameId === gameId && host.isHost) {
                        const isOnline = !host.lastHeartbeat || (now - host.lastHeartbeat) < maxOfflineTime;
                        if (isOnline) {
                            players.push({
                                name: host.playerName || 'Host',
                                isHost: true,
                                isGuest: false,
                                avatar: (host.playerName || 'Host').substring(0, 2).toUpperCase(),
                                lastSeen: host.lastHeartbeat || host.timestamp
                            });
                        } else {
                            console.log('üî¥ Host is offline, removing...');
                            // Host is offline - in a real app, this might transfer host status
                        }
                    }
                }
            } catch (e) {
                console.error('Error loading host:', e);
            }
            
            // Get all guest players (check if still online)
            const keys = Object.keys(localStorage);
            const playersToRemove = [];
            
            for (let key of keys) {
                if (key.startsWith('denkstdu_game_state_guest_')) {
                    try {
                        const guestState = JSON.parse(localStorage.getItem(key));
                        if (guestState.gameId === gameId && guestState.isGuest) {
                            const isOnline = !guestState.lastHeartbeat || (now - guestState.lastHeartbeat) < maxOfflineTime;
                            
                            if (isOnline) {
                                players.push({
                                    name: guestState.playerName,
                                    isHost: false,
                                    isGuest: true,
                                    avatar: guestState.playerName.substring(0, 2).toUpperCase(),
                                    lastSeen: guestState.lastHeartbeat || guestState.timestamp,
                                    storageKey: key
                                });
                            } else {
                                console.log(`üî¥ Guest ${guestState.playerName} is offline, marking for removal...`);
                                playersToRemove.push(key);
                            }
                        }
                    } catch (e) {
                        console.error('Error loading guest:', e);
                        // Remove corrupted entries
                        playersToRemove.push(key);
                    }
                }
            }
            
            // Clean up offline players
            playersToRemove.forEach(key => {
                console.log(`üóëÔ∏è Removing offline player: ${key}`);
                localStorage.removeItem(key);
            });
            
            // Clean up shared games list as well
            cleanupSharedGames(gameId, players);
            
            return players;
        }

        function cleanupSharedGames(gameId, activePlayers) {
            try {
                const sharedGames = JSON.parse(localStorage.getItem('denkstdu_shared_games') || '{}');
                if (sharedGames[gameId] && sharedGames[gameId].joinedPlayers) {
                    const activePlayerNames = activePlayers.map(p => p.name.toLowerCase());
                    
                    // Remove players that are no longer active
                    const oldCount = sharedGames[gameId].joinedPlayers.length;
                    sharedGames[gameId].joinedPlayers = sharedGames[gameId].joinedPlayers.filter(
                        p => activePlayerNames.includes(p.name.toLowerCase())
                    );
                    
                    const newCount = sharedGames[gameId].joinedPlayers.length;
                    if (oldCount !== newCount) {
                        console.log(`üßπ Cleaned shared games: ${oldCount} ‚Üí ${newCount} players`);
                        localStorage.setItem('denkstdu_shared_games', JSON.stringify(sharedGames));
                    }
                }
            } catch (e) {
                console.error('Error cleaning shared games:', e);
            }
        }

        function addPlayerToDisplay(player) {
            const playersList = document.getElementById('players-list');
            
            const playerElement = document.createElement('div');
            playerElement.className = `player-item ${player.isHost ? 'host-player' : 'guest-player'}`;
            
            playerElement.innerHTML = `
                <div class="player-avatar">${player.avatar}</div>
                <div class="player-info">
                    <div class="player-name">${player.name}</div>
                    <div class="player-role">
                        ${player.isHost ? 'üëë Host' : 'üéÆ Spieler'}
                    </div>
                </div>
                <div class="player-status status-ready">‚úÖ Bereit</div>
            `;
            
            playersList.appendChild(playerElement);
        }

        function updatePlayerCount(count) {
            document.getElementById('player-count').textContent = `(${count}/8)`;
        }

        function updateStartButton(playerCount) {
            const startBtn = document.getElementById('start-btn');
            if (gameState.isHost && playerCount >= 2) {
                startBtn.disabled = false;
                startBtn.textContent = `üöÄ Spiel starten (${playerCount} Spieler)`;
            } else if (gameState.isHost) {
                startBtn.disabled = true;
                startBtn.textContent = `üöÄ Spiel starten (${playerCount}/2 Spieler)`;
            } else {
                startBtn.disabled = true;
                startBtn.textContent = '‚è≥ Warten auf Host...';
            }
        }

        // ===== HEARTBEAT & AUTO REFRESH =====
        function startHeartbeat() {
            // Send heartbeat every 3 seconds to show we're still online
            heartbeatInterval = setInterval(() => {
                gameState.updateHeartbeat();
            }, 3000);
        }

        function startAutoRefresh() {
            // Refresh player list every 2 seconds (silent in background)
            refreshInterval = setInterval(() => {
                loadAllPlayers();
            }, 2000);
        }

        function setupCleanupHandlers() {
            // Clean up when page is unloaded
            window.addEventListener('beforeunload', function() {
                cleanupOnExit();
            });
            
            // Also clean up on visibility change (mobile browsers)
            document.addEventListener('visibilitychange', function() {
                if (document.hidden) {
                    cleanupOnExit();
                }
            });
        }

        function cleanupOnExit() {
            // Stop intervals
            if (refreshInterval) clearInterval(refreshInterval);
            if (heartbeatInterval) clearInterval(heartbeatInterval);
            
            // Remove player from game if guest
            if (gameState && gameState.isGuest) {
                removePlayerFromSharedGame();
                gameState.clearStorage();
                console.log('üßπ Guest player cleaned up on exit');
            }
        }

        // ===== GAME CONTROLS =====
        function startGame() {
            if (!gameState.isHost) {
                showNotification('Nur der Host kann das Spiel starten!', 'warning');
                return;
            }

            const allPlayers = getAllPlayersInGame();
            if (allPlayers.length < 2) {
                showNotification('Mindestens 2 Spieler ben√∂tigt!', 'warning');
                return;
            }

            // Stop background processes
            if (refreshInterval) clearInterval(refreshInterval);
            if (heartbeatInterval) clearInterval(heartbeatInterval);

            showNotification('Spiel wird gestartet...', 'success');
            
            // Update game phase for all players
            gameState.gamePhase = 'playing';
            gameState.saveToStorage();

            setTimeout(() => {
                window.location.href = 'multiplayer-gameplay.html';
            }, 2000);
        }

        function leaveLobby() {
            // Stop all background processes
            if (refreshInterval) clearInterval(refreshInterval);
            if (heartbeatInterval) clearInterval(heartbeatInterval);

            // Remove player from shared games
            if (gameState.isGuest) {
                removePlayerFromSharedGame();
            }

            // Clear storage
            gameState.clearStorage();

            showNotification('Lobby verlassen...', 'info');
            
            setTimeout(() => {
                window.location.href = 'index.html';
            }, 1000);
        }

        function removePlayerFromSharedGame() {
            try {
                const sharedGames = JSON.parse(localStorage.getItem('denkstdu_shared_games') || '{}');
                if (sharedGames[gameState.gameId] && sharedGames[gameState.gameId].joinedPlayers) {
                    sharedGames[gameState.gameId].joinedPlayers = sharedGames[gameState.gameId].joinedPlayers.filter(
                        p => p.name.toLowerCase() !== gameState.playerName.toLowerCase()
                    );
                    localStorage.setItem('denkstdu_shared_games', JSON.stringify(sharedGames));
                }
            } catch (error) {
                console.error('Error removing player from shared game:', error);
            }
        }

        // ===== NOTIFICATIONS =====
        function showNotification(message, type = 'info') {
            // Remove existing notifications
            document.querySelectorAll('.notification').forEach(n => n.remove());
            
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 10px;
                color: white;
                font-weight: bold;
                z-index: 9999;
                transform: translateX(100%);
                transition: transform 0.3s ease;
                background: ${type === 'success' ? '#4CAF50' : type === 'warning' ? '#FF9800' : '#2196F3'};
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => notification.style.transform = 'translateX(0)', 100);
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // ===== DEBUG FUNCTIONS =====
        window.debugLobby = function() {
            console.log('üîç Lobby Debug Info:');
            console.log('GameState:', gameState);
            console.log('All Players:', getAllPlayersInGame());
            console.log('localStorage keys:', Object.keys(localStorage).filter(k => k.includes('denkstdu')));
        };

        window.simulateJoinPlayer = function(name = 'TestPlayer') {
            const playerKey = `guest_${name}_${Date.now()}`;
            const guestState = new GameState(playerKey);
            guestState.gameId = gameState.gameId;
            guestState.playerName = name;
            guestState.deviceMode = 'multi';
            guestState.isHost = false;
            guestState.isGuest = true;
            guestState.gamePhase = 'lobby';
            guestState.saveToStorage();
            
            loadAllPlayers();
            showNotification(`${name} ist beigetreten!`, 'success');
        };

        console.log('‚úÖ Multiplayer Lobby loaded');
        console.log('üéÆ Commands: debugLobby(), simulateJoinPlayer("Name")');
    </script>
</body>
</html>