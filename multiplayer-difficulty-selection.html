<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>DenkstDu - Schwierigkeit wählen (Host)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        /* Background Animation */
        .background-particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }

        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            animation: float 6s ease-in-out infinite;
        }

        .particle:nth-child(1) { top: 20%; left: 20%; animation-delay: 0s; }
        .particle:nth-child(2) { top: 80%; left: 80%; animation-delay: 2s; }
        .particle:nth-child(3) { top: 40%; left: 40%; animation-delay: 4s; }
        .particle:nth-child(4) { top: 60%; left: 10%; animation-delay: 6s; }
        .particle:nth-child(5) { top: 10%; left: 90%; animation-delay: 8s; }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
        }

        /* Loading Screen */
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(102, 126, 234, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .loading.show {
            opacity: 1;
            visibility: visible;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            color: white;
            font-size: 1.1rem;
            font-weight: 500;
        }

        /* Header */
        .header {
            text-align: center;
            padding: 40px 20px 20px;
            color: white;
        }

        .back-button {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 10px 16px;
            border-radius: 10px;
            font-family: inherit;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 100;
            font-size: 0.9rem;
        }

        .back-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateX(-2px);
        }

        .host-badge {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }

        .header h1 {
            font-size: 2.2rem;
            font-weight: 800;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1rem;
            font-weight: 400;
            opacity: 0.9;
            margin-bottom: 20px;
        }

        /* Main Content */
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 0 20px 40px;
        }

        /* Game Info Display */
        .game-info {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 15px 20px;
            margin-top: 30px;
            margin-bottom: 30px;
            font-size: 0.9rem;
            text-align: center;
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: rgba(255, 255, 255, 0.9);
        }

        .game-info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .game-info-row:last-child {
            margin-bottom: 0;
        }

        .game-info-label {
            font-weight: 500;
            opacity: 0.8;
        }

        .game-info-value {
            font-weight: 600;
            color: white;
        }

        /* Selected Categories Display */
        .selected-categories-display {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 30px;
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        .categories-title {
            color: white;
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 15px;
            text-align: center;
        }

        .categories-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            align-items: center;
        }

        .category-display-tag {
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .category-display-tag[data-category="fsk0"] {
            border-left: 4px solid #4CAF50;
        }

        .category-display-tag[data-category="fsk16"] {
            border-left: 4px solid #FF9800;
        }

        .category-display-tag[data-category="fsk18"] {
            border-left: 4px solid #F44336;
        }

        /* Difficulty Cards */
        .difficulty-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        @media (min-width: 768px) {
            .difficulty-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (min-width: 1024px) {
            .difficulty-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        .difficulty-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px solid transparent;
            position: relative;
            overflow: hidden;
            min-height: 320px;
            display: flex;
            flex-direction: column;
        }

        .difficulty-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.15);
        }

        /* Individual Difficulty Styles & Animations */
        
        /* Easy - Grün (Entspannt) */
        .difficulty-card[data-difficulty="easy"].selected {
            border-color: #4CAF50;
            background: linear-gradient(145deg, rgba(76, 175, 80, 0.2), rgba(139, 195, 74, 0.1));
            animation: easyGlow 3s ease-in-out infinite;
        }

        .difficulty-card[data-difficulty="easy"].selected::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, #4CAF50, #8BC34A, #66BB6A, #4CAF50);
            background-size: 400% 400%;
            border-radius: 22px;
            z-index: -1;
            animation: easyBorder 4s ease infinite;
        }

        .difficulty-card[data-difficulty="easy"].selected::after {
            content: '😌';
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 1.8rem;
            opacity: 0.8;
            animation: easyFloat 3s ease-in-out infinite;
        }

        @keyframes easyGlow {
            0%, 100% { 
                transform: scale(1.03);
                box-shadow: 0 15px 35px rgba(76, 175, 80, 0.4);
            }
            50% { 
                transform: scale(1.05);
                box-shadow: 0 20px 40px rgba(139, 195, 74, 0.5);
            }
        }

        @keyframes easyBorder {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        @keyframes easyFloat {
            0%, 100% { 
                opacity: 0.7;
                transform: rotate(0deg) scale(1);
            }
            50% { 
                opacity: 1;
                transform: rotate(5deg) scale(1.1);
            }
        }

        /* Medium - Orange (Ausgewogen) */
        .difficulty-card[data-difficulty="medium"].selected {
            border-color: #FF9800;
            background: linear-gradient(145deg, rgba(255, 152, 0, 0.25), rgba(255, 193, 7, 0.15));
            animation: mediumPulse 2.5s ease-in-out infinite;
        }

        .difficulty-card[data-difficulty="medium"].selected::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, #FF9800, #FFC107, #FF8F00, #FFB300);
            background-size: 300% 300%;
            border-radius: 22px;
            z-index: -1;
            animation: mediumRave 3s linear infinite;
        }

        .difficulty-card[data-difficulty="medium"].selected::after {
            content: '🎯';
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 1.8rem;
            opacity: 0.8;
            animation: mediumTarget 2s ease-in-out infinite;
        }

        @keyframes mediumPulse {
            0%, 100% { 
                transform: scale(1.03) rotate(0deg);
                box-shadow: 0 15px 35px rgba(255, 152, 0, 0.4);
            }
            33% { 
                transform: scale(1.06) rotate(0.5deg);
                box-shadow: 0 20px 40px rgba(255, 193, 7, 0.5);
            }
            66% { 
                transform: scale(1.04) rotate(-0.5deg);
                box-shadow: 0 18px 38px rgba(255, 143, 0, 0.45);
            }
        }

        @keyframes mediumRave {
            0% { background-position: 0% 0%; }
            50% { background-position: 100% 100%; }
            100% { background-position: 0% 0%; }
        }

        @keyframes mediumTarget {
            0%, 100% { 
                opacity: 0.8;
                transform: rotate(0deg) scale(1);
            }
            50% { 
                opacity: 1;
                transform: rotate(180deg) scale(1.2);
            }
        }

        /* Hard - Rot (Intensiv) */
        .difficulty-card[data-difficulty="hard"].selected {
            border-color: #F44336;
            background: linear-gradient(145deg, rgba(244, 67, 54, 0.3), rgba(211, 47, 47, 0.2));
            animation: hardIntensity 2s ease-in-out infinite;
        }

        .difficulty-card[data-difficulty="hard"].selected::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, #F44336, #D32F2F, #E53935, #C62828);
            background-size: 400% 400%;
            border-radius: 22px;
            z-index: -1;
            animation: hardFire 1.5s ease-in-out infinite;
        }

        .difficulty-card[data-difficulty="hard"].selected::after {
            content: '💀';
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 1.8rem;
            opacity: 0.8;
            animation: hardShake 1s ease-in-out infinite;
        }

        @keyframes hardIntensity {
            0%, 100% { 
                transform: scale(1.03);
                box-shadow: 0 15px 35px rgba(244, 67, 54, 0.5);
            }
            25% { 
                transform: scale(1.07) rotate(0.8deg);
                box-shadow: 0 22px 45px rgba(211, 47, 47, 0.6);
            }
            50% { 
                transform: scale(1.05) rotate(0deg);
                box-shadow: 0 18px 38px rgba(229, 57, 53, 0.55);
            }
            75% { 
                transform: scale(1.07) rotate(-0.8deg);
                box-shadow: 0 22px 45px rgba(198, 40, 40, 0.6);
            }
        }

        @keyframes hardFire {
            0% { background-position: 0% 50%; }
            25% { background-position: 100% 0%; }
            50% { background-position: 0% 100%; }
            75% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        @keyframes hardShake {
            0%, 100% { 
                opacity: 0.8;
                transform: rotate(0deg) scale(1);
            }
            25% { 
                opacity: 1;
                transform: rotate(-5deg) scale(1.1);
            }
            50% { 
                opacity: 0.9;
                transform: rotate(0deg) scale(1.2);
            }
            75% { 
                opacity: 1;
                transform: rotate(5deg) scale(1.1);
            }
        }

        /* Difficulty specific text colors when selected */
        .difficulty-card[data-difficulty="easy"].selected .difficulty-name {
            color: #2E7D32;
            font-weight: 800;
            text-shadow: 0 2px 4px rgba(76, 175, 80, 0.3);
        }

        .difficulty-card[data-difficulty="medium"].selected .difficulty-name {
            color: #E65100;
            font-weight: 800;
            text-shadow: 0 2px 4px rgba(255, 152, 0, 0.4);
        }

        .difficulty-card[data-difficulty="hard"].selected .difficulty-name {
            color: #B71C1C;
            font-weight: 800;
            text-shadow: 0 2px 4px rgba(244, 67, 54, 0.4);
        }

        .difficulty-card[data-difficulty="easy"].selected .difficulty-description {
            color: #1B5E20;
        }

        .difficulty-card[data-difficulty="medium"].selected .difficulty-description {
            color: #BF360C;
        }

        .difficulty-card[data-difficulty="hard"].selected .difficulty-description {
            color: #880E4F;
        }

        .difficulty-icon {
            font-size: 3.5rem;
            margin-bottom: 20px;
            display: block;
        }

        .difficulty-name {
            font-size: 1.4rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 10px;
        }

        .difficulty-description {
            color: #666;
            font-size: 0.95rem;
            line-height: 1.5;
            margin-bottom: 20px;
            flex-grow: 1;
        }

        .difficulty-stats {
            background: rgba(0, 0, 0, 0.05);
            border-radius: 15px;
            padding: 15px;
            margin-top: auto;
        }

        .stats-grid {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .stat-icon {
            font-size: 1.5rem;
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 0.8rem;
            color: #888;
            font-weight: 500;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 1rem;
            font-weight: 700;
            color: #333;
        }

        /* Selection Indicator */
        .selection-indicator {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 45px;
            height: 45px;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.3rem;
            opacity: 0;
            transform: scale(0) rotate(-180deg);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 3px solid white;
        }

        .difficulty-card.selected .selection-indicator {
            opacity: 1;
            transform: scale(1) rotate(0deg);
            animation: checkmarkBounce 0.6s ease-out 0.2s;
        }

        @keyframes checkmarkBounce {
            0% { transform: scale(1) rotate(0deg); }
            50% { transform: scale(1.3) rotate(10deg); }
            100% { transform: scale(1) rotate(0deg); }
        }

        /* Difficulty-specific Selection Indicators */
        .difficulty-card[data-difficulty="easy"] .selection-indicator {
            background: linear-gradient(135deg, #4CAF50, #8BC34A);
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
        }

        .difficulty-card[data-difficulty="medium"] .selection-indicator {
            background: linear-gradient(135deg, #FF9800, #FFC107);
            box-shadow: 0 4px 15px rgba(255, 152, 0, 0.4);
        }

        .difficulty-card[data-difficulty="hard"] .selection-indicator {
            background: linear-gradient(135deg, #F44336, #D32F2F);
            box-shadow: 0 4px 15px rgba(244, 67, 54, 0.4);
        }

        /* Controls */
        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 15px 30px;
            border-radius: 12px;
            border: none;
            font-family: inherit;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
            min-width: 150px;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(76, 175, 80, 0.4);
        }

        .btn-outline {
            background: transparent;
            border: 2px solid rgba(255, 255, 255, 0.5);
            color: white;
        }

        .btn-outline:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.1);
            border-color: white;
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: white;
            color: #333;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            z-index: 2000;
            transition: transform 0.3s ease;
            font-weight: 500;
            max-width: 90%;
        }

        .notification.show {
            transform: translateX(-50%) translateY(0);
        }

        .notification.success {
            border-left: 4px solid #4CAF50;
        }

        .notification.warning {
            border-left: 4px solid #FF9800;
        }

        .notification.error {
            border-left: 4px solid #f44336;
        }

        /* Mobile Optimizations */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8rem;
                margin-bottom: 8px;
            }

            .header p {
                font-size: 0.9rem;
            }

            .back-button, .host-badge {
                position: static;
                margin: 5px;
                display: inline-block;
                font-size: 0.8rem;
                padding: 8px 14px;
            }

            .header {
                padding: 15px 15px 15px;
            }

            .container {
                padding: 0 15px 30px;
            }

            .difficulty-grid {
                grid-template-columns: 1fr;
                gap: 15px;
                margin-bottom: 25px;
            }

            .difficulty-card {
                padding: 25px 20px;
                min-height: 280px;
                border-radius: 16px;
            }

            .difficulty-icon {
                font-size: 3rem;
                margin-bottom: 15px;
            }

            .difficulty-name {
                font-size: 1.2rem;
                margin-bottom: 8px;
            }

            .difficulty-description {
                font-size: 0.9rem;
                line-height: 1.4;
                margin-bottom: 15px;
            }

            .selection-indicator {
                width: 40px;
                height: 40px;
                top: 15px;
                left: 15px;
                font-size: 1.2rem;
            }

            .difficulty-card[data-difficulty="easy"].selected::after,
            .difficulty-card[data-difficulty="medium"].selected::after,
            .difficulty-card[data-difficulty="hard"].selected::after {
                top: 12px;
                right: 12px;
                font-size: 1.6rem;
            }

            /* Mobile animations - less intense */
            .difficulty-card[data-difficulty="easy"].selected {
                animation: easyGlowMobile 3s ease-in-out infinite;
            }

            .difficulty-card[data-difficulty="medium"].selected {
                animation: mediumPulseMobile 2.5s ease-in-out infinite;
            }

            .difficulty-card[data-difficulty="hard"].selected {
                animation: hardIntensityMobile 2s ease-in-out infinite;
            }

            @keyframes easyGlowMobile {
                0%, 100% { 
                    transform: scale(1.02);
                    box-shadow: 0 12px 25px rgba(76, 175, 80, 0.3);
                }
                50% { 
                    transform: scale(1.04);
                    box-shadow: 0 15px 30px rgba(139, 195, 74, 0.4);
                }
            }

            @keyframes mediumPulseMobile {
                0%, 100% { 
                    transform: scale(1.02);
                    box-shadow: 0 12px 25px rgba(255, 152, 0, 0.3);
                }
                50% { 
                    transform: scale(1.04);
                    box-shadow: 0 15px 30px rgba(255, 193, 7, 0.4);
                }
            }

            @keyframes hardIntensityMobile {
                0%, 100% { 
                    transform: scale(1.02);
                    box-shadow: 0 12px 25px rgba(244, 67, 54, 0.4);
                }
                50% { 
                    transform: scale(1.04);
                    box-shadow: 0 15px 30px rgba(211, 47, 47, 0.5);
                }
            }

            .selected-categories-display {
                padding: 16px;
                border-radius: 16px;
                margin-bottom: 25px;
            }

            .categories-list {
                gap: 8px;
            }

            .category-display-tag {
                padding: 6px 12px;
                font-size: 0.8rem;
                border-radius: 16px;
            }

            .controls {
                flex-direction: column;
                align-items: center;
                gap: 12px;
            }

            .btn {
                width: 100%;
                max-width: 320px;
                padding: 14px 28px;
                font-size: 0.95rem;
                border-radius: 10px;
            }

            .game-info {
                font-size: 0.85rem;
                padding: 12px 16px;
            }

            /* Touch feedback for mobile */
            .difficulty-card:active {
                transform: scale(0.98) !important;
                transition: transform 0.1s ease;
            }

            .btn:active {
                transform: scale(0.98) translateY(1px);
            }
        }

        /* Extra small screens */
        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.6rem;
            }

            .difficulty-card {
                min-height: 260px;
                padding: 20px 16px;
            }

            .difficulty-icon {
                font-size: 2.5rem;
            }

            .difficulty-name {
                font-size: 1.1rem;
            }

            .selection-indicator {
                width: 35px;
                height: 35px;
                font-size: 1.1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Background Particles -->
    <div class="background-particles">
        <div class="particle"></div>
        <div class="particle"></div>
<div class="particle"></div>
        <div class="particle"></div>
    </div>

    <!-- Loading Screen -->
    <div class="loading" id="loading">
        <div class="loading-spinner"></div>
        <div class="loading-text">Schwierigkeit wird geladen...</div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification"></div>

    <!-- Back Button -->
    <button class="back-button" onclick="goBack()">← Zurück</button>

    <!-- Host Badge -->
    <div class="host-badge">👑 Host</div>

    <!-- Header -->
    <div class="header">
        <h1>⚡ Schwierigkeit wählen</h1>
        <p>Bestimme, wie hart das Spiel werden soll</p>
    </div>

    <!-- Main Content -->
    <div class="container">
        <div class="content">
            <!-- Game Info Display -->
            <div class="game-info">
                <div class="game-info-row">
                    <span class="game-info-label">🎮 Spiel-ID:</span>
                    <span class="game-info-value" id="game-id-display">Wird geladen...</span>
                </div>
                <div class="game-info-row">
                    <span class="game-info-label">👥 Spieler:</span>
                    <span class="game-info-value" id="player-count-display">1</span>
                </div>
            </div>

            <!-- Selected Categories Display -->
            <div class="selected-categories-display">
                <div class="categories-title">📋 Ausgewählte Kategorien</div>
                <div class="categories-list" id="categories-list">
                    <!-- Categories will be inserted here -->
                </div>
            </div>

            <!-- Difficulty Grid -->
            <div class="difficulty-grid">
                <div class="difficulty-card" data-difficulty="easy" onclick="selectDifficulty(this)">
                    <div class="selection-indicator">✓</div>
                    <span class="difficulty-icon">😌</span>
                    <h3 class="difficulty-name">Entspannt</h3>
                    <p class="difficulty-description">
                        Perfekt für gemütliche Runden. Niedrige Strafen und viel Spaß 
                        stehen im Vordergrund.
                    </p>
                    <div class="difficulty-stats">
                        <div class="stats-grid">
                            <div class="stat-item">
                                <div class="stat-icon">🍺</div>
                                <div class="stat-label">Schlücke bei Fehler</div>
                                <div class="stat-value">1-2</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="difficulty-card" data-difficulty="medium" onclick="selectDifficulty(this)">
                    <div class="selection-indicator">✓</div>
                    <span class="difficulty-icon">🎯</span>
                    <h3 class="difficulty-name">Ausgewogen</h3>
                    <p class="difficulty-description">
                        Die goldene Mitte zwischen Spaß und Herausforderung. 
                        Ideal für die meisten Gruppen.
                    </p>
                    <div class="difficulty-stats">
                        <div class="stats-grid">
                            <div class="stat-item">
                                <div class="stat-icon">🍺</div>
                                <div class="stat-label">Schlücke bei Fehler</div>
                                <div class="stat-value">2-3</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="difficulty-card" data-difficulty="hard" onclick="selectDifficulty(this)">
                    <div class="selection-indicator">✓</div>
                    <span class="difficulty-icon">💀</span>
                    <h3 class="difficulty-name">Hardcore</h3>
                    <p class="difficulty-description">
                        Nur für mutige Gruppen! Hohe Strafen machen jeden 
                        Fehler richtig teuer.
                    </p>
                    <div class="difficulty-stats">
                        <div class="stats-grid">
                            <div class="stat-item">
                                <div class="stat-icon">🍺</div>
                                <div class="stat-label">Schlücke bei Fehler</div>
                                <div class="stat-value">3-5</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="controls">
                <button class="btn btn-outline" onclick="goBack()">← Zurück</button>
                <button class="btn btn-primary" id="continueBtn" onclick="proceedToLobby()" disabled>
                    Schwierigkeit auswählen
                </button>
            </div>
        </div>
    </div>

    <script>
        // ===== Firebase & GameState Service =====
        class FirebaseGameService {
            constructor() {
                this.isInitialized = false;
                this.app = null;
                this.database = null;
                this.gameRef = null;
                this.playersRef = null;
                this.settingsRef = null;
                this.currentGameId = null;
                this.listeners = [];
                
                this.config = {
                    apiKey: "AIzaSyC_cu_2X2uFCPcxYetxIUHi2v56F1Mz0Vk",
                    authDomain: "denkstduwebsite.firebaseapp.com",
                    databaseURL: "https://denkstduwebsite-default-rtdb.europe-west1.firebasedatabase.app",
                    projectId: "denkstduwebsite",
                    storageBucket: "denkstduwebsite.firebasestorage.app",
                    messagingSenderId: "27029260611",
                    appId: "1:27029260611:web:3c7da4db0bf92e8ce247f6"
                };
            }

            async initialize(gameId = null) {
                try {
                    if (typeof firebase === 'undefined') {
                        throw new Error('Firebase SDK not loaded');
                    }

                    if (!firebase.apps.length) {
                        this.app = firebase.initializeApp(this.config);
                    } else {
                        this.app = firebase.app();
                    }

                    this.database = firebase.database();
                    this.isInitialized = true;

                    if (gameId) {
                        await this.connectToGame(gameId);
                    }

                    console.log('🔥 Firebase service initialized');
                    return true;
                } catch (error) {
                    console.error('❌ Firebase initialization failed:', error);
                    return false;
                }
            }

            async connectToGame(gameId) {
                if (!this.isInitialized) return false;

                try {
                    this.currentGameId = gameId;
                    this.gameRef = this.database.ref(`games/${gameId}`);
                    this.playersRef = this.database.ref(`games/${gameId}/players`);
                    this.settingsRef = this.database.ref(`games/${gameId}/settings`);

                    // Setup real-time listeners
                    this.setupListeners();

                    console.log('🎮 Connected to game:', gameId);
                    return true;
                } catch (error) {
                    console.error('❌ Failed to connect to game:', error);
                    return false;
                }
            }

            setupListeners() {
                // Listen for player count changes
                const playersListener = this.playersRef.on('value', (snapshot) => {
                    const players = snapshot.val() || {};
                    const playerCount = Object.keys(players).length;
                    updatePlayerCount(playerCount);
                });
                
                this.listeners.push({ ref: this.playersRef, type: 'value', listener: playersListener });

                // Listen for settings changes from other players
                const settingsListener = this.settingsRef.on('value', (snapshot) => {
                    const settings = snapshot.val();
                    if (settings) {
                        handleSettingsUpdate(settings);
                    }
                });
                
                this.listeners.push({ ref: this.settingsRef, type: 'value', listener: settingsListener });
            }

            async updateDifficulty(difficulty) {
                if (!this.settingsRef) return false;

                try {
                    await this.settingsRef.child('difficulty').set(difficulty);
                    console.log('🎯 Difficulty synced to Firebase:', difficulty);
                    return true;
                } catch (error) {
                    console.error('❌ Failed to sync difficulty:', error);
                    return false;
                }
            }

            async updateGameSettings(settings) {
                if (!this.settingsRef) return false;

                try {
                    const updateData = {
                        ...settings,
                        lastUpdated: Date.now(),
                        updatedBy: gameState.playerName || 'Host'
                    };
                    
                    await this.settingsRef.update(updateData);
                    console.log('⚙️ Game settings synced:', updateData);
                    return true;
                } catch (error) {
                    console.error('❌ Failed to sync game settings:', error);
                    return false;
                }
            }

            cleanup() {
                // Remove all Firebase listeners
                this.listeners.forEach(({ ref, type, listener }) => {
                    ref.off(type, listener);
                });
                this.listeners = [];
                console.log('🧹 Firebase listeners cleaned up');
            }
        }

        // ===== GameState Management =====
        class GameState {
            constructor() {
                this.deviceMode = 'single';
                this.isHost = false;
                this.gameId = null;
                this.selectedCategories = [];
                this.difficulty = null;
                this.playerName = '';
                this.gamePhase = 'difficulty-selection';
                this.loadFromStorage();
            }

            setDifficulty(difficulty) {
                this.difficulty = difficulty;
                this.saveToStorage();
                console.log('🎯 Difficulty updated:', this.difficulty);
            }

            saveToStorage() {
                try {
                    const stateData = {
                        deviceMode: this.deviceMode,
                        isHost: this.isHost,
                        gameId: this.gameId,
                        selectedCategories: this.selectedCategories,
                        difficulty: this.difficulty,
                        playerName: this.playerName,
                        gamePhase: this.gamePhase,
                        timestamp: Date.now()
                    };
                    localStorage.setItem('denkstdu_game_state', JSON.stringify(stateData));
                } catch (error) {
                    console.error('❌ Failed to save GameState:', error);
                }
            }

            loadFromStorage() {
                try {
                    const stored = localStorage.getItem('denkstdu_game_state');
                    if (stored) {
                        const stateData = JSON.parse(stored);
                        const maxAge = 60 * 60 * 1000; // 1 hour
                        
                        if (Date.now() - (stateData.timestamp || 0) > maxAge) {
                            this.clearStorage();
                            return;
                        }
                        
                        Object.keys(stateData).forEach(key => {
                            if (key !== 'timestamp' && this.hasOwnProperty(key)) {
                                this[key] = stateData[key];
                            }
                        });
                    }
                } catch (error) {
                    console.error('❌ Failed to load GameState:', error);
                    this.clearStorage();
                }
            }

            clearStorage() {
                localStorage.removeItem('denkstdu_game_state');
            }

            isValidForMultiplayer() {
                return this.deviceMode === 'multi' && 
                       this.gameId && 
                       this.selectedCategories.length > 0;
            }

            getDebugInfo() {
                return {
                    deviceMode: this.deviceMode,
                    isHost: this.isHost,
                    gameId: this.gameId,
                    categories: this.selectedCategories,
                    difficulty: this.difficulty,
                    playerName: this.playerName,
                    gamePhase: this.gamePhase,
                    isValid: this.isValidForMultiplayer()
                };
            }
        }

        // ===== Global Variables =====
        let gameState;
        let firebaseService;
        let selectedDifficulty = null;

        // Category data for display
        const categoryData = {
            fsk0: {
                name: 'Familie & Freunde',
                icon: '👨‍👩‍👧‍👦',
                questions: 350,
                color: '#4CAF50'
            },
            fsk16: {
                name: 'Party Time',
                icon: '🎉',
                questions: 300,
                color: '#FF9800'
            },
            fsk18: {
                name: 'Heiß & Gewagt',
                icon: '🔥',
                questions: 250,
                color: '#F44336'
            }
        };

        const difficultyData = {
            easy: {
                name: 'Entspannt',
                icon: '😌',
                description: 'Niedrige Strafen, viel Spaß',
                penalties: '1-2 Schlücke'
            },
            medium: {
                name: 'Ausgewogen',
                icon: '🎯',
                description: 'Perfekte Balance',
                penalties: '2-3 Schlücke'
            },
            hard: {
                name: 'Hardcore',
                icon: '💀',
                description: 'Hohe Strafen',
                penalties: '3-5 Schlücke'
            }
        };

        // ===== Page Initialization =====
        async function initPage() {
            console.log('⚡ Initializing multiplayer difficulty selection...');
            
            try {
                showLoading();
                
                // Initialize services
                gameState = new GameState();
                firebaseService = new FirebaseGameService();
                
                // Validate multiplayer state
                if (!validateMultiplayerState()) {
                    return;
                }

                // Initialize Firebase connection
                const firebaseOk = await firebaseService.initialize(gameState.gameId);
                if (!firebaseOk) {
                    showNotification('Firebase-Verbindung fehlgeschlagen', 'error');
                    return;
                }

                // Display game info
                displayGameInfo();
                
                // Display selected categories
                displaySelectedCategories();
                
                // Load previously selected difficulty if any
                loadPreviousDifficulty();
                
                console.log('✅ Multiplayer difficulty selection initialized:', gameState.getDebugInfo());
                hideLoading();
                
            } catch (error) {
                console.error('❌ Failed to initialize page:', error);
                showNotification('Fehler beim Laden der Seite', 'error');
                hideLoading();
            }
        }

        function validateMultiplayerState() {
            // Check if in multiplayer mode
            if (gameState.deviceMode !== 'multi') {
                console.warn('❌ Not in multiplayer mode, redirecting...');
                showNotification('Nicht im Multiplayer-Modus. Weiterleitung...', 'warning');
                setTimeout(() => {
                    window.location.href = 'device-selection.html';
                }, 2000);
                return false;
            }

            // Check if categories were selected
            if (!gameState.selectedCategories || gameState.selectedCategories.length === 0) {
                console.warn('❌ No categories selected, redirecting...');
                showNotification('Keine Kategorien ausgewählt. Zurück zur Kategorieauswahl...', 'warning');
                setTimeout(() => {
                    window.location.href = 'multiplayer-category-selection.html';
                }, 2000);
                return false;
            }

            // Check if game ID exists
            if (!gameState.gameId) {
                console.warn('❌ No game ID found, redirecting...');
                showNotification('Keine Spiel-ID gefunden. Spiel wird erstellt...', 'warning');
                setTimeout(() => {
                    window.location.href = 'multiplayer-create-game.html';
                }, 2000);
                return false;
            }

            return true;
        }

        function displayGameInfo() {
            const gameIdElement = document.getElementById('game-id-display');
            if (gameState.gameId) {
                gameIdElement.textContent = gameState.gameId;
            } else {
                gameIdElement.textContent = 'Fehler beim Laden';
            }
        }

        function displaySelectedCategories() {
            const categoriesListElement = document.getElementById('categories-list');
            
            if (gameState.selectedCategories && gameState.selectedCategories.length > 0) {
                const categoryTags = gameState.selectedCategories.map(category => {
                    const data = categoryData[category];
                    return `
                        <div class="category-display-tag" data-category="${category}">
                            <span>${data.icon}</span>
                            <span>${data.name}</span>
                        </div>
                    `;
                }).join('');
                
                categoriesListElement.innerHTML = categoryTags;
                console.log('📋 Categories displayed:', gameState.selectedCategories);
            } else {
                categoriesListElement.innerHTML = '<p style="color: rgba(255,255,255,0.7); text-align: center;">Keine Kategorien ausgewählt</p>';
            }
        }

        function loadPreviousDifficulty() {
            if (gameState.difficulty) {
                selectedDifficulty = gameState.difficulty;
                const card = document.querySelector(`[data-difficulty="${gameState.difficulty}"]`);
                if (card) {
                    card.classList.add('selected');
                    updateContinueButton();
                }
                console.log('🔄 Previous difficulty loaded:', gameState.difficulty);
            }
        }

        // ===== Real-time Updates =====
        function updatePlayerCount(count) {
            const playerCountElement = document.getElementById('player-count-display');
            if (playerCountElement) {
                playerCountElement.textContent = count.toString();
            }
        }

        function handleSettingsUpdate(settings) {
            // Only update if not initiated by this client
            if (settings.difficulty && settings.difficulty !== selectedDifficulty) {
                console.log('🔄 Difficulty updated by another player:', settings.difficulty);
                
                // Update UI to reflect the change
                document.querySelectorAll('.difficulty-card').forEach(card => {
                    card.classList.remove('selected');
                });
                
                const card = document.querySelector(`[data-difficulty="${settings.difficulty}"]`);
                if (card) {
                    card.classList.add('selected');
                    selectedDifficulty = settings.difficulty;
                    gameState.setDifficulty(settings.difficulty);
                    updateContinueButton();
                }
                
                showNotification(`Schwierigkeit zu "${difficultyData[settings.difficulty].name}" geändert`, 'info');
            }
        }

        // ===== Difficulty Selection Logic =====
        function selectDifficulty(element) {
            const difficulty = element.dataset.difficulty;
            console.log('⚡ Selecting difficulty:', difficulty);
            
            // Add visual feedback immediately
            element.style.transform = 'scale(0.95)';
            setTimeout(() => {
                element.style.transform = '';
            }, 150);

            // Remove previous selection
            document.querySelectorAll('.difficulty-card').forEach(card => {
                card.classList.remove('selected');
            });

            // Add current selection
            element.classList.add('selected');
            selectedDifficulty = difficulty;
            
            // Update game state
            gameState.setDifficulty(difficulty);
            
            // Show notification
            showNotification(`${difficultyData[difficulty].name} ausgewählt!`, 'success');
            
            // Add celebration effect
            createCelebrationEffect(element);
            
            // Update UI
            updateContinueButton();
            
            // Sync with Firebase
            syncWithFirebase();
        }

        function updateContinueButton() {
            const continueBtn = document.getElementById('continueBtn');
            
            if (selectedDifficulty) {
                continueBtn.disabled = false;
                continueBtn.textContent = 'Zur Lobby';
                console.log('✅ Continue button enabled for difficulty:', selectedDifficulty);
            } else {
                continueBtn.disabled = true;
                continueBtn.textContent = 'Schwierigkeit auswählen';
            }
        }

        // ===== Firebase Synchronization =====
        async function syncWithFirebase() {
            console.log('🔄 Syncing difficulty with Firebase:', selectedDifficulty);
            
            if (!firebaseService.isInitialized || !selectedDifficulty) {
                console.warn('⚠️ Cannot sync - Firebase not ready or no difficulty selected');
                return;
            }

            try {
                // Sync difficulty
                await firebaseService.updateDifficulty(selectedDifficulty);
                
                // Sync complete game settings
                const gameSettings = {
                    categories: gameState.selectedCategories,
                    difficulty: selectedDifficulty,
                    gameId: gameState.gameId,
                    hostName: gameState.playerName || 'Host',
                    deviceMode: gameState.deviceMode,
                    gamePhase: gameState.gamePhase,
                    totalQuestions: calculateTotalQuestions(),
                    createdAt: Date.now()
                };
                
                await firebaseService.updateGameSettings(gameSettings);
                console.log('✅ Game settings synced successfully');
                
            } catch (error) {
                console.error('❌ Failed to sync with Firebase:', error);
                showNotification('Synchronisation fehlgeschlagen', 'warning');
            }
        }

        function calculateTotalQuestions() {
            return gameState.selectedCategories.reduce((total, category) => {
                return total + (categoryData[category]?.questions || 0);
            }, 0);
        }

        // ===== Celebration Effects =====
        function createCelebrationEffect(element) {
            const difficulty = element.dataset.difficulty;
            const rect = element.getBoundingClientRect();
            
            let emojis, colors;
            
            switch(difficulty) {
                case 'easy':
                    emojis = ['😌', '🌟', '✨', '💚', '👍', '🎈'];
                    colors = ['#4CAF50', '#8BC34A', '#66BB6A', '#81C784'];
                    break;
                case 'medium':
                    emojis = ['🎯', '⚡', '🏆', '💪', '🔥', '⭐'];
                    colors = ['#FF9800', '#FFC107', '#FFB74D', '#FFD54F'];
                    break;
                case 'hard':
                    emojis = ['💀', '🔥', '⚡', '💥', '👹', '🚨'];
                    colors = ['#F44336', '#D32F2F', '#E53935', '#C62828'];
                    break;
                default:
                    emojis = ['✨', '🌟', '💫'];
                    colors = ['#4CAF50'];
            }
            
            const isMobile = window.innerWidth <= 768;
            const emojiCount = isMobile ? 4 : 8;
            
            for (let i = 0; i < emojiCount; i++) {
                const emoji = document.createElement('div');
                emoji.textContent = emojis[Math.floor(Math.random() * emojis.length)];
                
                const randomColor = colors[Math.floor(Math.random() * colors.length)];
                const randomAngle = Math.random() * 360;
                const randomDistance = isMobile ? 100 : 150;
                const randomDelay = i * 0.1;
                
                emoji.style.cssText = `
                    position: fixed;
                    left: ${rect.left + rect.width / 2}px;
                    top: ${rect.top + rect.height / 2}px;
                    font-size: ${isMobile ? '1.3rem' : '1.6rem'};
                    pointer-events: none;
                    z-index: 10000;
                    filter: drop-shadow(0 2px 4px ${randomColor}40);
                    animation: difficultyFloat 1.4s ease-out forwards;
                    animation-delay: ${randomDelay}s;
                    --random-x: ${Math.cos(randomAngle * Math.PI / 180) * randomDistance}px;
                    --random-y: ${Math.sin(randomAngle * Math.PI / 180) * randomDistance}px;
                `;
                
                document.body.appendChild(emoji);
                
                setTimeout(() => {
                    if (emoji.parentNode) {
                        emoji.parentNode.removeChild(emoji);
                    }
                }, 1600);
            }
            
            // Add CSS animation if not exists
            if (!document.getElementById('celebration-style')) {
                const style = document.createElement('style');
                style.id = 'celebration-style';
                style.textContent = `
                    @keyframes difficultyFloat {
                        0% {
                            opacity: 1;
                            transform: translate(0, 0) scale(1) rotate(0deg);
                        }
                        100% {
                            opacity: 0;
                            transform: translate(var(--random-x), var(--random-y)) scale(1.6) rotate(360deg);
                        }
                    }
                `;
                document.head.appendChild(style);
            }
        }

        // ===== Navigation Functions =====
        async function proceedToLobby() {
            if (!selectedDifficulty) {
                showNotification('Bitte wähle eine Schwierigkeit aus', 'warning');
                return;
            }

            if (!gameState.isValidForMultiplayer()) {
                showNotification('Spieleinstellungen unvollständig', 'error');
                return;
            }

            console.log('🚀 Proceeding to lobby with settings:', gameState.getDebugInfo());

            showLoading();
            
            try {
                // Final sync with Firebase
                await syncWithFirebase();
                
                // Set game phase to lobby
                gameState.gamePhase = 'lobby';
                gameState.saveToStorage();
                
                setTimeout(() => {
                    window.location.href = 'multiplayer-lobby.html';
                }, 800);
                
            } catch (error) {
                console.error('❌ Failed to proceed to lobby:', error);
                showNotification('Fehler beim Fortfahren', 'error');
                hideLoading();
            }
        }

        function goBack() {
            console.log('⬅️ Going back to category selection');
            
            // Cleanup Firebase listeners
            if (firebaseService) {
                firebaseService.cleanup();
            }
            
            showLoading();
            
            setTimeout(() => {
                window.location.href = 'multiplayer-category-selection.html';
            }, 300);
        }

        // ===== Utility Functions =====
        function showLoading() {
            const loading = document.getElementById('loading');
            if (loading) {
                loading.classList.add('show');
            }
        }

        function hideLoading() {
            const loading = document.getElementById('loading');
            if (loading) {
                loading.classList.remove('show');
            }
        }

        function showNotification(message, type = 'info', duration = 3000) {
            const notification = document.getElementById('notification');
            if (notification) {
                notification.textContent = message;
                notification.className = `notification ${type} show`;
                
                setTimeout(() => {
                    notification.classList.remove('show');
                }, duration);
                
                console.log(`📢 Notification: ${message} (${type})`);
            }
        }

        // ===== Error Handling & Cleanup =====
        window.addEventListener('error', function(event) {
            console.error('💥 JavaScript Error:', event.error);
            showNotification('Ein unerwarteter Fehler ist aufgetreten', 'error');
        });

        window.addEventListener('beforeunload', function() {
            if (firebaseService) {
                firebaseService.cleanup();
            }
        });

        // ===== Initialize on DOM Ready =====
        document.addEventListener('DOMContentLoaded', function() {
            console.log('📄 DOM loaded, initializing page...');
            
            setTimeout(() => {
                initPage();
            }, 100);
        });

        // ===== Debugging Functions =====
        window.debugMultiplayerDifficulty = function() {
            console.log('🐛 Multiplayer Difficulty Debug Info:', {
                gameState: gameState ? gameState.getDebugInfo() : 'Not initialized',
                selectedDifficulty: selectedDifficulty,
                firebase: {
                    initialized: firebaseService ? firebaseService.isInitialized : false,
                    gameId: firebaseService ? firebaseService.currentGameId : null,
                    hasDatabase: firebaseService ? !!firebaseService.database : false
                },
                dom: {
                    continueButtonDisabled: document.getElementById('continueBtn')?.disabled,
                    selectedCards: document.querySelectorAll('.difficulty-card.selected').length,
                    gameIdDisplay: document.getElementById('game-id-display')?.textContent,
                    playerCountDisplay: document.getElementById('player-count-display')?.textContent
                }
            });
        };
    </script>
</body>
</html>