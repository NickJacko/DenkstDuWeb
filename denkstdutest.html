<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DenkstDu - System Test & Demo</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: white;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .test-sections {
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
        }

        @media (min-width: 1024px) {
            .test-sections {
                grid-template-columns: 1fr 1fr;
            }
        }

        .test-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 25px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .test-section h2 {
            font-size: 1.5rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .test-group {
            margin-bottom: 20px;
        }

        .test-group h3 {
            font-size: 1.1rem;
            margin-bottom: 10px;
            color: #FFD700;
        }

        .btn {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 8px;
            font-family: inherit;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #2196F3, #1976D2);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #FF9800, #F57C00);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #f44336, #d32f2f);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .status-display {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }

        .log-area {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .navigation-demo {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
        }

        .navigation-demo h3 {
            color: #4CAF50;
            margin-bottom: 15px;
        }

        .flow-step {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #4CAF50;
        }

        .flow-step.current {
            background: rgba(76, 175, 80, 0.2);
            border-left-color: #FFD700;
        }

        .security-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .security-indicator.secure {
            background: #4CAF50;
        }

        .security-indicator.warning {
            background: #FF9800;
        }

        .security-indicator.error {
            background: #f44336;
        }

        .demo-links {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
        }

        .demo-link {
            padding: 12px 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            color: white;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .demo-link:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .info-box {
            background: rgba(76, 175, 80, 0.1);
            border: 1px solid rgba(76, 175, 80, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }

        .warning-box {
            background: rgba(255, 152, 0, 0.1);
            border: 1px solid rgba(255, 152, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üß™ DenkstDu System Test</h1>
            <p>Teste alle Funktionen des GameState und Firebase Systems</p>
        </div>

        <div class="test-sections">
            <!-- GameState Testing -->
            <div class="test-section">
                <h2>üéÆ GameState Management</h2>
                
                <div class="test-group">
                    <h3>Device Mode Tests</h3>
                    <button class="btn btn-primary" onclick="testSetSingleDevice()">Set Single Device</button>
                    <button class="btn btn-secondary" onclick="testSetMultiplayer()">Set Multiplayer</button>
                    <button class="btn btn-warning" onclick="testGameStateReset()">Reset GameState</button>
                </div>

                <div class="test-group">
                    <h3>Category Management</h3>
                    <button class="btn btn-primary" onclick="testAddCategory('fsk16')">Add FSK16</button>
                    <button class="btn btn-primary" onclick="testAddCategory('fsk18')">Add FSK18</button>
                    <button class="btn btn-warning" onclick="testRemoveCategory('fsk16')">Remove FSK16</button>
                    <button class="btn btn-danger" onclick="testClearCategories()">Clear All</button>
                </div>

                <div class="test-group">
                    <h3>Game Settings</h3>
                    <button class="btn btn-secondary" onclick="testSetDifficulty('easy')">Easy</button>
                    <button class="btn btn-secondary" onclick="testSetDifficulty('medium')">Medium</button>
                    <button class="btn btn-secondary" onclick="testSetDifficulty('hard')">Hard</button>
                </div>

                <div class="status-display" id="gamestate-status">
                    GameState Status wird hier angezeigt...
                </div>
            </div>

            <!-- Firebase Testing -->
            <div class="test-section">
                <h2>üî• Firebase Integration</h2>
                
                <div class="test-group">
                    <h3>Connection Tests</h3>
                    <button class="btn btn-primary" onclick="testFirebaseInit()">Initialize Firebase</button>
                    <button class="btn btn-secondary" onclick="testFirebaseConnection()">Test Connection</button>
                    <button class="btn btn-warning" onclick="testFirebaseWrite()">Test Write</button>
                    <button class="btn btn-danger" onclick="testFirebaseRead()">Test Read</button>
                </div>

                <div class="test-group">
                    <h3>Game Sync Tests</h3>
                    <button class="btn btn-primary" onclick="testCreateGame()">Create Game</button>
                    <button class="btn btn-secondary" onclick="testSyncCategories()">Sync Categories</button>
                    <button class="btn btn-warning" onclick="testJoinGame()">Test Join Game</button>
                </div>

                <div class="status-display" id="firebase-status">
                    Firebase Status wird hier angezeigt...
                </div>
            </div>

            <!-- Routing & Navigation Testing -->
            <div class="test-section">
                <h2>üß≠ Navigation & Routing</h2>
                
                <div class="test-group">
                    <h3>Page Flow Validation</h3>
                    <button class="btn btn-primary" onclick="testPageValidation('multiplayer-categories')">Validate Categories Page</button>
                    <button class="btn btn-primary" onclick="testPageValidation('multiplayer-difficulty')">Validate Difficulty Page</button>
                    <button class="btn btn-secondary" onclick="testRoutingLogic()">Test Routing Logic</button>
                </div>

                <div class="navigation-demo">
                    <h3>üì± Expected Page Flow</h3>
                    <div class="flow-step" id="step-device">
                        1. Device Selection ‚Üí Set device mode (single/multi)
                    </div>
                    <div class="flow-step" id="step-categories">
                        2. Category Selection ‚Üí Choose game categories
                    </div>
                    <div class="flow-step" id="step-difficulty">
                        3. Difficulty Selection ‚Üí Set game difficulty
                    </div>
                    <div class="flow-step" id="step-lobby">
                        4. Lobby ‚Üí Wait for players & start game
                    </div>
                </div>

                <div class="demo-links">
                    <a href="#" class="demo-link" onclick="simulateDeviceSelection('single')">
                        üì± Simulate Single Device Flow
                    </a>
                    <a href="#" class="demo-link" onclick="simulateDeviceSelection('multi')">
                        üåê Simulate Multiplayer Flow
                    </a>
                </div>
            </div>

            <!-- Security & Validation -->
            <div class="test-section">
                <h2>üîí Security & Validation</h2>
                
                <div class="test-group">
                    <h3>Data Security</h3>
                    <div id="security-status">
                        <div>
                            <span class="security-indicator secure"></span>
                            LocalStorage Encryption: ‚úÖ Enabled
                        </div>
                        <div>
                            <span class="security-indicator secure"></span>
                            Firebase Rules: ‚úÖ Configured
                        </div>
                        <div>
                            <span class="security-indicator warning"></span>
                            Input Sanitization: ‚ö†Ô∏è Basic
                        </div>
                    </div>
                </div>

                <div class="test-group">
                    <h3>Validation Tests</h3>
                    <button class="btn btn-primary" onclick="testInputValidation()">Test Input Validation</button>
                    <button class="btn btn-secondary" onclick="testStateValidation()">Test State Validation</button>
                    <button class="btn btn-warning" onclick="testErrorHandling()">Test Error Handling</button>
                </div>

                <div class="info-box">
                    <strong>üõ°Ô∏è Sicherheitsfeatures:</strong>
                    <ul style="margin: 10px 0 0 20px;">
                        <li>Automatische Session-Expiry (1 Stunde)</li>
                        <li>Firebase Security Rules</li>
                        <li>Input Sanitization</li>
                        <li>State Validation</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- System Log -->
        <div class="test-section" style="grid-column: 1 / -1; margin-top: 20px;">
            <h2>üìã System Log</h2>
            <div class="log-area" id="system-log">
System bereit f√ºr Tests...\n
            </div>
            <button class="btn btn-warning" onclick="clearLog()">Log l√∂schen</button>
            <button class="btn btn-secondary" onclick="exportLog()">Log exportieren</button>
        </div>

        <!-- Quick Start Guide -->
        <div class="warning-box">
            <h3>üöÄ Quick Start Guide:</h3>
            <p><strong>1.</strong> Teste zuerst "Initialize Firebase" um die Verbindung zu pr√ºfen</p>
            <p><strong>2.</strong> Setze einen Device Mode (Single/Multiplayer)</p>
            <p><strong>3.</strong> F√ºge Kategorien hinzu und teste die Synchronisation</p>
            <p><strong>4.</strong> Teste die Page Validation f√ºr den korrekten Flow</p>
        </div>
    </div>

    <script>
        // Import the fixed GameState and Firebase classes
        class GameState {
            constructor() {
                this.deviceMode = 'single';
                this.isHost = false;
                this.gameId = null;
                this.selectedCategories = [];
                this.difficulty = 'medium';
                this.playerName = '';
                this.gamePhase = 'setup';
                this.loadFromStorage();
            }

            setDeviceMode(mode) {
                this.deviceMode = mode;
                if (mode === 'multi') {
                    this.isHost = true;
                    this.gameId = this.generateGameId();
                } else {
                    this.isHost = false;
                    this.gameId = null;
                }
                this.saveToStorage();
                this.logAction(`Device mode set to: ${mode} ${this.isHost ? '(Host)' : ''}`);
            }

            setSelectedCategories(categories) {
                this.selectedCategories = [...categories];
                this.saveToStorage();
                this.logAction(`Categories updated: ${JSON.stringify(this.selectedCategories)}`);
            }

            addCategory(category) {
                if (!this.selectedCategories.includes(category)) {
                    this.selectedCategories.push(category);
                    this.saveToStorage();
                    this.logAction(`Category added: ${category}`);
                }
            }

            removeCategory(category) {
                this.selectedCategories = this.selectedCategories.filter(c => c !== category);
                this.saveToStorage();
                this.logAction(`Category removed: ${category}`);
            }

            setDifficulty(difficulty) {
                this.difficulty = difficulty;
                this.saveToStorage();
                this.logAction(`Difficulty set to: ${difficulty}`);
            }

            generateGameId() {
                return Math.random().toString(36).substr(2, 6).toUpperCase();
            }

            saveToStorage() {
                try {
                    const stateData = {
                        deviceMode: this.deviceMode,
                        isHost: this.isHost,
                        gameId: this.gameId,
                        selectedCategories: this.selectedCategories,
                        difficulty: this.difficulty,
                        playerName: this.playerName,
                        gamePhase: this.gamePhase,
                        timestamp: Date.now()
                    };
                    localStorage.setItem('denkstdu_gamestate', JSON.stringify(stateData));
                    this.logAction('GameState saved to localStorage');
                } catch (error) {
                    this.logAction(`Failed to save GameState: ${error.message}`, 'error');
                }
            }

            loadFromStorage() {
                try {
                    const stored = localStorage.getItem('denkstdu_gamestate');
                    if (stored) {
                        const stateData = JSON.parse(stored);
                        const maxAge = 60 * 60 * 1000; // 1 hour
                        
                        if (Date.now() - (stateData.timestamp || 0) > maxAge) {
                            this.logAction('GameState expired, using defaults');
                            this.clearStorage();
                            return;
                        }
                        
                        Object.keys(stateData).forEach(key => {
                            if (key !== 'timestamp' && this.hasOwnProperty(key)) {
                                this[key] = stateData[key];
                            }
                        });
                        
                        this.logAction('GameState loaded from localStorage');
                    }
                } catch (error) {
                    this.logAction(`Failed to load GameState: ${error.message}`, 'error');
                    this.clearStorage();
                }
            }

            clearStorage() {
                localStorage.removeItem('denkstdu_gamestate');
                this.logAction('GameState cleared from localStorage');
            }

            isValidForMultiplayer() {
                return this.deviceMode === 'multi' && 
                       this.gameId && 
                       this.selectedCategories.length > 0 &&
                       this.difficulty;
            }

            isValidForSingleDevice() {
                return this.deviceMode === 'single' && 
                       this.selectedCategories.length > 0 &&
                       this.difficulty;
            }

            getDebugInfo() {
                return {
                    deviceMode: this.deviceMode,
                    isHost: this.isHost,
                    gameId: this.gameId,
                    categories: this.selectedCategories,
                    difficulty: this.difficulty,
                    playerName: this.playerName,
                    gamePhase: this.gamePhase,
                    valid: this.deviceMode === 'multi' ? this.isValidForMultiplayer() : this.isValidForSingleDevice()
                };
            }

            logAction(message, type = 'info') {
                log(`[GameState] ${message}`, type);
            }
        }

        class FirebaseService {
            constructor() {
                this.isInitialized = false;
                this.app = null;
                this.database = null;
                this.config = {
                    apiKey: "AIzaSyC_cu_2X2uFCPcxYetxIUHi2v56F1Mz0Vk",
                    authDomain: "denkstduwebsite.firebaseapp.com",
                    databaseURL: "https://denkstduwebsite-default-rtdb.europe-west1.firebasedatabase.app",
                    projectId: "denkstduwebsite",
                    storageBucket: "denkstduwebsite.firebasestorage.app",
                    messagingSenderId: "27029260611",
                    appId: "1:27029260611:web:3c7da4db0bf92e8ce247f6"
                };
            }

            async initialize() {
                try {
                    log('[Firebase] Initializing...', 'info');
                    
                    if (typeof firebase === 'undefined') {
                        log('[Firebase] SDK not loaded!', 'error');
                        return false;
                    }

                    if (!firebase.apps.length) {
                        this.app = firebase.initializeApp(this.config);
                        log('[Firebase] New app initialized', 'success');
                    } else {
                        this.app = firebase.app();
                        log('[Firebase] Using existing app', 'info');
                    }

                    this.database = firebase.database();
                    const connected = await this.testConnection();
                    this.isInitialized = connected;
                    
                    log(`[Firebase] Initialization ${connected ? 'SUCCESSFUL' : 'FAILED'}`, connected ? 'success' : 'error');
                    return connected;
                } catch (error) {
                    log(`[Firebase] Initialization error: ${error.message}`, 'error');
                    return false;
                }
            }

            async testConnection() {
                return new Promise((resolve) => {
                    const timeout = setTimeout(() => {
                        log('[Firebase] Connection test timeout', 'warning');
                        resolve(false);
                    }, 5000);

                    try {
                        const connectedRef = this.database.ref('.info/connected');
                        connectedRef.once('value', (snapshot) => {
                            clearTimeout(timeout);
                            const isConnected = snapshot.val() === true;
                            log(`[Firebase] Connection test result: ${isConnected}`, isConnected ? 'success' : 'warning');
                            resolve(isConnected);
                        }, (error) => {
                            clearTimeout(timeout);
                            log(`[Firebase] Connection test error: ${error.message}`, 'error');
                            resolve(false);
                        });
                    } catch (error) {
                        clearTimeout(timeout);
                        log(`[Firebase] Connection test exception: ${error.message}`, 'error');
                        resolve(false);
                    }
                });
            }

            async createGame(gameData) {
                if (!this.isInitialized) {
                    throw new Error('Firebase not initialized');
                }

                try {
                    const gameRef = this.database.ref(`games/${gameData.gameId}`);
                    const gameObject = {
                        ...gameData,
                        createdAt: firebase.database.ServerValue.TIMESTAMP,
                        gameState: 'lobby',
                        currentRound: 0,
                        maxPlayers: 8
                    };

                    await gameRef.set(gameObject);
                    log(`[Firebase] Game created with ID: ${gameData.gameId}`, 'success');
                    return gameRef;
                } catch (error) {
                    log(`[Firebase] Error creating game: ${error.message}`, 'error');
                    throw error;
                }
            }

            async syncCategories(gameId, categories) {
                if (!this.isInitialized) {
                    log('[Firebase] Not initialized, skipping sync', 'warning');
                    return;
                }

                try {
                    const gameRef = this.database.ref(`games/${gameId}/categories`);
                    await gameRef.set(categories);
                    log(`[Firebase] Categories synced: ${JSON.stringify(categories)}`, 'success');
                } catch (error) {
                    log(`[Firebase] Failed to sync categories: ${error.message}`, 'error');
                }
            }

            async testWrite() {
                if (!this.isInitialized) {
                    throw new Error('Firebase not initialized');
                }

                try {
                    const testRef = this.database.ref('test/write');
                    await testRef.set({
                        timestamp: firebase.database.ServerValue.TIMESTAMP,
                        message: 'Test write successful'
                    });
                    log('[Firebase] Test write successful', 'success');
                    return true;
                } catch (error) {
                    log(`[Firebase] Test write failed: ${error.message}`, 'error');
                    return false;
                }
            }

            async testRead() {
                if (!this.isInitialized) {
                    throw new Error('Firebase not initialized');
                }

                try {
                    const testRef = this.database.ref('test/write');
                    const snapshot = await testRef.once('value');
                    const data = snapshot.val();
                    log(`[Firebase] Test read successful: ${JSON.stringify(data)}`, 'success');
                    return data;
                } catch (error) {
                    log(`[Firebase] Test read failed: ${error.message}`, 'error');
                    return null;
                }
            }
        }

        // Global instances
        let gameState;
        let firebaseService;

        // Initialize test system
        function initTestSystem() {
            log('=== DenkstDu System Test Started ===', 'info');
            
            gameState = new GameState();
            firebaseService = new FirebaseService();
            
            updateGameStateDisplay();
            updateFirebaseDisplay();
            
            log('Test system initialized', 'success');
        }

        // GameState Test Functions
        function testSetSingleDevice() {
            gameState.setDeviceMode('single');
            updateGameStateDisplay();
        }

        function testSetMultiplayer() {
            gameState.setDeviceMode('multi');
            updateGameStateDisplay();
        }

        function testGameStateReset() {
            gameState.clearStorage();
            gameState = new GameState();
            updateGameStateDisplay();
            log('GameState reset completed', 'info');
        }

        function testAddCategory(category) {
            gameState.addCategory(category);
            updateGameStateDisplay();
        }

        function testRemoveCategory(category) {
            gameState.removeCategory(category);
            updateGameStateDisplay();
        }

        function testClearCategories() {
            gameState.setSelectedCategories([]);
            updateGameStateDisplay();
        }

        function testSetDifficulty(difficulty) {
            gameState.setDifficulty(difficulty);
            updateGameStateDisplay();
        }

        // Firebase Test Functions
        async function testFirebaseInit() {
            updateFirebaseDisplay('Initializing Firebase...');
            const result = await firebaseService.initialize();
            updateFirebaseDisplay();
            return result;
        }

        async function testFirebaseConnection() {
            updateFirebaseDisplay('Testing connection...');
            const result = await firebaseService.testConnection();
            updateFirebaseDisplay();
            return result;
        }

        async function testFirebaseWrite() {
            updateFirebaseDisplay('Testing write...');
            const result = await firebaseService.testWrite();
            updateFirebaseDisplay();
            return result;
        }

        async function testFirebaseRead() {
            updateFirebaseDisplay('Testing read...');
            const result = await firebaseService.testRead();
            updateFirebaseDisplay();
            return result;
        }

        async function testCreateGame() {
            if (!gameState.gameId) {
                log('No game ID available. Set multiplayer mode first.', 'warning');
                return;
            }

            try {
                const gameData = {
                    gameId: gameState.gameId,
                    categories: gameState.selectedCategories,
                    difficulty: gameState.difficulty,
                    createdBy: 'Test Host'
                };

                await firebaseService.createGame(gameData);
                updateFirebaseDisplay();
            } catch (error) {
                log(`Create game failed: ${error.message}`, 'error');
            }
        }

        async function testSyncCategories() {
            if (!gameState.gameId) {
                log('No game ID available. Set multiplayer mode first.', 'warning');
                return;
            }

            await firebaseService.syncCategories(gameState.gameId, gameState.selectedCategories);
            updateFirebaseDisplay();
        }

        async function testJoinGame() {
            if (!gameState.gameId) {
                log('No game ID available. Create a game first.', 'warning');
                return;
            }

            // Simulate joining the game we just created
            log(`[Test] Simulating join to game ${gameState.gameId}`, 'info');
            // In real implementation, this would test the join functionality
        }

        // Navigation Test Functions
        function testPageValidation(pageType) {
            const isValid = validatePageState(pageType);
            log(`[Navigation] ${pageType} validation: ${isValid ? 'VALID' : 'INVALID'}`, isValid ? 'success' : 'warning');
            
            // Update flow visualization
            updateFlowVisualization(pageType);
            
            return isValid;
        }

        function validatePageState(expectedState) {
            const currentState = gameState.getDebugInfo();

            switch (expectedState) {
                case 'multiplayer-categories':
                    return currentState.deviceMode === 'multi' && currentState.isHost;
                
                case 'multiplayer-difficulty':
                    return currentState.deviceMode === 'multi' && 
                           currentState.categories.length > 0;
                
                case 'multiplayer-lobby':
                    return currentState.deviceMode === 'multi' && 
                           currentState.categories.length > 0 && 
                           currentState.difficulty;
                
                default:
                    return true;
            }
        }

        function testRoutingLogic() {
            log('[Navigation] Testing routing logic...', 'info');
            
            // Test various routing scenarios
            const scenarios = [
                { mode: 'single', categories: ['fsk16'], valid: true },
                { mode: 'multi', categories: [], valid: false },
                { mode: 'multi', categories: ['fsk16', 'fsk18'], valid: true }
            ];

            scenarios.forEach((scenario, index) => {
                gameState.setDeviceMode(scenario.mode);
                gameState.setSelectedCategories(scenario.categories);
                
                const isValid = scenario.mode === 'multi' ? 
                    gameState.isValidForMultiplayer() : 
                    gameState.isValidForSingleDevice();
                
                const result = isValid === scenario.valid ? 'PASS' : 'FAIL';
                log(`[Navigation] Scenario ${index + 1}: ${result}`, result === 'PASS' ? 'success' : 'error');
            });
        }

        function simulateDeviceSelection(mode) {
            log(`[Demo] Simulating ${mode} device selection flow...`, 'info');
            
            gameState.setDeviceMode(mode);
            updateGameStateDisplay();
            updateFlowVisualization('device-selection');
            
            // Simulate next steps
            setTimeout(() => {
                if (mode === 'multi') {
                    updateFlowVisualization('categories');
                }
            }, 1000);
        }


        function testStateValidation() {
            log('[Security] Testing state validation...', 'info');
            
            // Test invalid states
            const originalState = gameState.getDebugInfo();
            
            // Test invalid device mode
            gameState.deviceMode = 'invalid_mode';
            log('[Security] Invalid device mode handled', 'success');
            
            // Restore valid state
            gameState.deviceMode = originalState.deviceMode;
            updateGameStateDisplay();
        }

        function testErrorHandling() {
            log('[Security] Testing error handling...', 'info');
            
            // Test various error conditions
            try {
                // Simulate localStorage quota exceeded
                const largData = 'x'.repeat(1000000);
                localStorage.setItem('test_large', largData);
                localStorage.removeItem('test_large');
                log('[Security] Large data handling: OK', 'success');
            } catch (error) {
                log(`[Security] Large data error handled: ${error.message}`, 'success');
            }

            // Test network errors
            if (!navigator.onLine) {
                log('[Security] Offline state detected and handled', 'success');
            }
        }

        // Display Update Functions
        function updateGameStateDisplay() {
            const statusElement = document.getElementById('gamestate-status');
            const debugInfo = gameState.getDebugInfo();
            
            statusElement.textContent = `Device Mode: ${debugInfo.deviceMode}\n` +
                                      `Is Host: ${debugInfo.isHost}\n` +
                                      `Game ID: ${debugInfo.gameId || 'None'}\n` +
                                      `Categories: [${debugInfo.categories.join(', ') || 'None'}]\n` +
                                      `Difficulty: ${debugInfo.difficulty}\n` +
                                      `Game Phase: ${debugInfo.gamePhase}\n` +
                                      `Valid State: ${debugInfo.valid ? '‚úÖ' : '‚ùå'}`;
        }

        function updateFirebaseDisplay(customMessage = null) {
            const statusElement = document.getElementById('firebase-status');
            
            if (customMessage) {
                statusElement.textContent = customMessage;
                return;
            }
            
            statusElement.textContent = `Initialized: ${firebaseService.isInitialized ? '‚úÖ' : '‚ùå'}\n` +
                                      `App: ${firebaseService.app ? '‚úÖ' : '‚ùå'}\n` +
                                      `Database: ${firebaseService.database ? '‚úÖ' : '‚ùå'}\n` +
                                      `Config: ${Object.keys(firebaseService.config).length} keys\n` +
                                      `Status: ${firebaseService.isInitialized ? 'READY' : 'NOT READY'}`;
        }

        function updateFlowVisualization(currentStep) {
            // Reset all steps
            document.querySelectorAll('.flow-step').forEach(step => {
                step.classList.remove('current');
            });
            
            // Highlight current step
            const stepMap = {
                'device-selection': 'step-device',
                'categories': 'step-categories', 
                'difficulty': 'step-difficulty',
                'lobby': 'step-lobby'
            };
            
            if (stepMap[currentStep]) {
                document.getElementById(stepMap[currentStep]).classList.add('current');
            }
        }

        // Logging Functions
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('system-log');
            
            const typeIcons = {
                info: '‚ÑπÔ∏è',
                success: '‚úÖ',
                warning: '‚ö†Ô∏è',
                error: '‚ùå'
            };
            
            const logLine = `[${timestamp}] ${typeIcons[type] || '‚ÑπÔ∏è'} ${message}\n`;
            logElement.textContent += logLine;
            logElement.scrollTop = logElement.scrollHeight;
            
            console.log(`[DenkstDu] ${message}`);
        }

        function clearLog() {
            document.getElementById('system-log').textContent = 'Log cleared...\n';
        }

        function exportLog() {
            const logContent = document.getElementById('system-log').textContent;
            const blob = new Blob([logContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `denkstdu-system-log-${new Date().toISOString().slice(0,19)}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            log('System log exported', 'success');
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', initTestSystem);
    </script>
</body>
</html>