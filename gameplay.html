<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>No-Cap - Spielen</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800&display=swap" rel="stylesheet">

    <!-- Favicon - Kappe Emoji -->
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üß¢</text></svg>">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            overflow: hidden;
            touch-action: manipulation;
            position: relative;
        }

        /* Background Particles */
        .background-particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: -1;
        }

        .particle {
            position: absolute;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 50%;
            animation: float 15s ease-in-out infinite;
        }

        .particle:nth-child(1) { width: 100px; height: 100px; left: 10%; animation-delay: 0s; }
        .particle:nth-child(2) { width: 60px; height: 60px; left: 80%; animation-delay: 3s; }
        .particle:nth-child(3) { width: 80px; height: 80px; left: 30%; animation-delay: 6s; }
        .particle:nth-child(4) { width: 120px; height: 120px; left: 70%; animation-delay: 9s; }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); opacity: 0.3; }
            25% { transform: translateY(-30px) rotate(90deg); opacity: 0.6; }
            50% { transform: translateY(-60px) rotate(180deg); opacity: 0.3; }
            75% { transform: translateY(-30px) rotate(270deg); opacity: 0.6; }
        }

        .app-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 10px;
            max-width: 450px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
            overflow: hidden;
        }

        /* Main Content Area - Flexibel und auf eine Seite passend */
        .game-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
            overflow: hidden;
        }

        /* Question Card - Kompakt */
        .question-card {
            background: rgba(255, 255, 255, 0.12);
            backdrop-filter: blur(30px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.25);
            padding: 15px 20px;
            margin-bottom: 10px;
            text-align: center;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.15);
            position: relative;
            overflow: hidden;
            flex-shrink: 0;
        }

        .question-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, #4CAF50, #2196F3, #9C27B0);
            background-size: 200% 100%;
            animation: shimmer 3s ease-in-out infinite;
        }

        @keyframes shimmer {
            0%, 100% { background-position: 200% 0; }
            50% { background-position: -200% 0; }
        }

        .question-category {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.25), rgba(76, 175, 80, 0.35));
            border: 1px solid rgba(76, 175, 80, 0.5);
            color: white;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.7rem;
            font-weight: 700;
            display: inline-block;
            margin-bottom: 10px;
            backdrop-filter: blur(10px);
        }

        .question-text {
            color: white;
            font-size: 1rem;
            font-weight: 700;
            line-height: 1.4;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        /* Current Player Display - Kompakt */
        .current-player-card {
            background: rgba(255, 255, 255, 0.12);
            backdrop-filter: blur(30px);
            border-radius: 15px;
            padding: 12px 15px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 12px;
            border: 1px solid rgba(255, 255, 255, 0.25);
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.1);
            flex-shrink: 0;
        }

        .player-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 800;
            font-size: 1rem;
            box-shadow: 0 5px 20px rgba(79, 172, 254, 0.3);
            flex-shrink: 0;
        }

        .player-info {
            flex: 1;
        }

        .player-name {
            color: white;
            font-size: 1rem;
            font-weight: 700;
            margin-bottom: 2px;
        }

        .player-status {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.8rem;
        }

        /* Answer Section - Optimiert */
        .answer-section {
            margin-bottom: 10px;
            flex-shrink: 0;
        }

        .answer-title {
            color: white;
            font-size: 0.9rem;
            font-weight: 700;
            margin-bottom: 10px;
            text-align: center;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .answer-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .answer-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.25);
            color: white;
            padding: 15px 10px;
            border-radius: 15px;
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            backdrop-filter: blur(20px);
            position: relative;
            overflow: hidden;
        }

        .answer-btn:active {
            transform: scale(0.95);
        }

        .answer-btn.selected {
            transform: scale(1.02);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .answer-btn.yes.selected {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.3), rgba(76, 175, 80, 0.4));
            border-color: #4CAF50;
            box-shadow: 0 10px 30px rgba(76, 175, 80, 0.3);
        }

        .answer-btn.no.selected {
            background: linear-gradient(135deg, rgba(244, 67, 54, 0.3), rgba(244, 67, 54, 0.4));
            border-color: #f44336;
            box-shadow: 0 10px 30px rgba(244, 67, 54, 0.3);
        }

        .answer-emoji {
            font-size: 1.2rem;
        }

        /* Estimation Section - Sauber und proportional */
        .estimation-section {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.12), rgba(255, 255, 255, 0.08));
            backdrop-filter: blur(30px);
            border-radius: 20px;
            padding: 15px;
            margin-bottom: 10px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            gap: 12px;
            overflow: hidden;
        }

        .estimation-title {
            color: white;
            font-size: 0.85rem;
            font-weight: 600;
            text-align: center;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            flex-shrink: 0;
            opacity: 0.95;
            letter-spacing: 0.3px;
        }

        /* Current Selection Display - Erscheint erst nach Auswahl */
        .current-selection {
            text-align: center;
            flex-shrink: 0;
            opacity: 0;
            max-height: 0;
            overflow: hidden;
            transform: translateY(-10px);
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .current-selection.visible {
            opacity: 1;
            max-height: 50px;
            transform: translateY(0);
            margin-bottom: 8px;
        }

        .selection-display {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.25), rgba(33, 150, 243, 0.2));
            border: 2px solid rgba(76, 175, 80, 0.6);
            border-radius: 18px;
            padding: 8px 16px;
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            min-width: 100px;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.25);
            backdrop-filter: blur(10px);
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .selection-number {
            color: white;
            font-size: 1.4rem;
            font-weight: 800;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.4);
            line-height: 1;
            letter-spacing: 0.5px;
        }

        .selection-label {
            color: rgba(255, 255, 255, 0.95);
            font-size: 0.7rem;
            font-weight: 600;
            text-shadow: 0 1px 5px rgba(0, 0, 0, 0.3);
            white-space: nowrap;
        }

        /* Number Grid - Sauber und kompakt */
        .number-grid {
            display: grid;
            gap: 10px;
            justify-items: center;
            align-content: center;
            overflow: hidden;
        }

        /* Dynamische Grid-Anpassung basierend auf Anzahl der Spieler */
        .number-grid.small {
            grid-template-columns: repeat(auto-fit, minmax(50px, 1fr));
        }
        .number-grid.medium {
            grid-template-columns: repeat(5, 1fr);
        }
        .number-grid.large {
            grid-template-columns: repeat(6, 1fr);
        }

        .number-btn {
            width: 100%;
            max-width: 52px;
            height: 52px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0.08));
            border: 2px solid rgba(255, 255, 255, 0.35);
            color: white;
            border-radius: 50%;
            font-size: 1.1rem;
            font-weight: 800;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            backdrop-filter: blur(20px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15),
            inset 0 1px 2px rgba(255, 255, 255, 0.1);
            position: relative;
        }

        .number-btn:hover {
            border-color: rgba(76, 175, 80, 0.5);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.2);
        }

        .number-btn:active {
            transform: scale(0.95);
        }

        .number-btn.selected {
            background: linear-gradient(135deg, #4CAF50, #2196F3);
            border-color: #4CAF50;
            transform: scale(1.12);
            box-shadow: 0 8px 30px rgba(76, 175, 80, 0.5),
            0 0 20px rgba(76, 175, 80, 0.3);
            color: white;
        }

        .number-btn.selected::before {
            content: '';
            position: absolute;
            inset: -4px;
            border-radius: 50%;
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.3), rgba(33, 150, 243, 0.3));
            z-index: -1;
            filter: blur(10px);
            opacity: 0.7;
        }

        /* F√ºr viele Spieler: Kleinere Buttons */
        .number-grid.large .number-btn {
            max-width: 44px;
            height: 44px;
            font-size: 1rem;
        }

        /* Submit Button */
        .submit-section {
            flex-shrink: 0;
        }

        .submit-btn {
            width: 100%;
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 15px;
            font-size: 1rem;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            opacity: 0.4;
            transform: scale(0.95);
            box-shadow: 0 10px 30px rgba(76, 175, 80, 0.2);
        }

        .submit-btn.enabled {
            opacity: 1;
            transform: scale(1);
            box-shadow: 0 12px 35px rgba(76, 175, 80, 0.4);
        }

        .submit-btn.enabled:active {
            transform: scale(0.98);
        }

        /* Player Change Popup */
        .player-change-popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            animation: fadeIn 0.3s ease-out;
        }

        .player-change-popup.show {
            display: flex;
        }

        .popup-content {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(30px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 25px;
            padding: 40px 30px;
            text-align: center;
            max-width: 300px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: popupSlideIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .popup-avatar {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 800;
            font-size: 2rem;
            margin: 0 auto 20px;
            box-shadow: 0 10px 30px rgba(79, 172, 254, 0.4);
        }

        .popup-name {
            color: white;
            font-size: 1.8rem;
            font-weight: 800;
            margin-bottom: 10px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .popup-message {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1.2rem;
            font-weight: 600;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes popupSlideIn {
            from {
                opacity: 0;
                transform: scale(0.8) translateY(30px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        /* Results Section */
        .results-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
            overflow: hidden;
        }

        .results-header {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.2), rgba(76, 175, 80, 0.3));
            border: 2px solid rgba(76, 175, 80, 0.5);
            backdrop-filter: blur(30px);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 15px;
            text-align: center;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.1);
            flex-shrink: 0;
        }

        .results-summary {
            color: white;
            font-size: 1.2rem;
            font-weight: 700;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .results-grid {
            display: grid;
            gap: 12px;
            margin-bottom: 20px;
            flex: 1;
            align-content: start;
            max-height: 200px;
            overflow-y: auto;
            overflow-x: hidden;
            width: 100%;
        }

        .result-item {
            background: rgba(255, 255, 255, 0.12);
            backdrop-filter: blur(30px);
            border-radius: 15px;
            padding: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid rgba(255, 255, 255, 0.25);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            min-width: 0;
            width: 100%;
        }

        .player-result {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
            min-width: 0;
        }

        .result-avatar {
            width: 35px;
            height: 35px;
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 800;
            font-size: 0.9rem;
            box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3);
            flex-shrink: 0;
        }

        .player-result-info {
            color: white;
            flex: 1;
            min-width: 0;
        }

        .player-result-name {
            font-weight: 700;
            font-size: 0.95rem;
            margin-bottom: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .player-answer {
            font-size: 0.8rem;
            opacity: 0.8;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .sips-penalty {
            background: linear-gradient(135deg, rgba(244, 67, 54, 0.3), rgba(244, 67, 54, 0.4));
            border: 1px solid #f44336;
            color: #f44336;
            padding: 6px 10px;
            border-radius: 12px;
            font-weight: 800;
            font-size: 0.8rem;
            box-shadow: 0 4px 12px rgba(244, 67, 54, 0.2);
            flex-shrink: 0;
            white-space: nowrap;
        }

        .sips-penalty.none {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.3), rgba(76, 175, 80, 0.4));
            border-color: #4CAF50;
            color: #4CAF50;
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.2);
        }

        .results-navigation {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 15px;
            flex-shrink: 0;
        }

        .nav-btn {
            padding: 15px 20px;
            border-radius: 15px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .nav-btn.primary {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
        }

        .nav-btn.secondary {
            background: rgba(255, 255, 255, 0.12);
            border: 2px solid rgba(255, 255, 255, 0.25);
            color: white;
            backdrop-filter: blur(20px);
        }

        .nav-btn:active {
            transform: scale(0.98);
        }

        /* Final Results Section */
        .final-results-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
            padding: 0;
            overflow: hidden;
            width: 100%;
        }

        .final-header {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(255, 215, 0, 0.3));
            border: 2px solid rgba(255, 215, 0, 0.6);
            backdrop-filter: blur(30px);
            border-radius: 20px;
            padding: 15px;
            margin-bottom: 15px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            flex-shrink: 0;
        }

        .final-title {
            color: #FFD700;
            font-size: 1.4rem;
            font-weight: 800;
            margin-bottom: 5px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.4);
        }

        .final-subtitle {
            color: rgba(255, 255, 255, 0.95);
            font-size: 0.9rem;
            font-weight: 600;
        }

        .leaderboard {
            flex: 1;
            margin-bottom: 15px;
            min-height: 0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .leaderboard-title {
            color: white;
            font-size: 1.2rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 3px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .leaderboard-subtitle {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.8rem;
            font-weight: 500;
            text-align: center;
            margin-bottom: 15px;
        }

        #leaderboard-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .leaderboard-item {
            background: rgba(255, 255, 255, 0.12);
            backdrop-filter: blur(30px);
            border-radius: 18px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            border: 1px solid rgba(255, 255, 255, 0.25);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            width: 100%;
            min-width: 0;
            flex-shrink: 0;
        }

        .leaderboard-item:first-child {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.25), rgba(255, 193, 7, 0.35));
            border: 2px solid #FFD700;
            box-shadow: 0 12px 35px rgba(255, 215, 0, 0.3);
        }

        .leaderboard-item:nth-child(2) {
            background: linear-gradient(135deg, rgba(192, 192, 192, 0.2), rgba(160, 160, 160, 0.3));
            border: 2px solid #C0C0C0;
            box-shadow: 0 10px 30px rgba(192, 192, 192, 0.2);
        }

        .leaderboard-item:nth-child(3) {
            background: linear-gradient(135deg, rgba(205, 127, 50, 0.2), rgba(184, 134, 11, 0.3));
            border: 2px solid #CD7F32;
            box-shadow: 0 10px 30px rgba(205, 127, 50, 0.2);
        }

        .rank-number {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 1.2rem;
            flex-shrink: 0;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .rank-1 {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: white;
        }
        .rank-2 {
            background: linear-gradient(135deg, #C0C0C0, #A0A0A0);
            color: white;
        }
        .rank-3 {
            background: linear-gradient(135deg, #CD7F32, #B8860B);
            color: white;
        }
        .rank-other {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.25), rgba(255, 255, 255, 0.15));
            color: white;
        }

        .player-final-stats {
            flex: 1;
            min-width: 0;
        }

        .player-final-name {
            color: white;
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 5px;
            text-shadow: 0 1px 5px rgba(0, 0, 0, 0.3);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .leaderboard-item:first-child .player-final-name {
            color: #FFD700;
            font-size: 1.2rem;
        }

        .player-final-details {
            color: rgba(255, 255, 255, 0.85);
            font-size: 0.9rem;
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .detail-item {
            display: flex;
            align-items: center;
            gap: 5px;
            white-space: nowrap;
        }

        .detail-icon {
            font-size: 1rem;
            flex-shrink: 0;
        }

        .final-navigation {
            flex-shrink: 0;
            width: 100%;
        }

        .nav-btn.large {
            padding: 16px 20px;
            font-size: 1.1rem;
            width: 100%;
        }

        /* Toast Notifications */
        .toast-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(25px);
            border: 1px solid rgba(255, 255, 255, 0.25);
            border-radius: 15px;
            padding: 15px;
            z-index: 10000;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            max-width: 300px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
        }

        .toast-notification.show {
            opacity: 1;
            transform: translateX(0);
        }

        .toast-notification.success {
            border-color: rgba(76, 175, 80, 0.5);
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.15), rgba(76, 175, 80, 0.25));
        }

        .toast-notification.warning {
            border-color: rgba(255, 152, 0, 0.5);
            background: linear-gradient(135deg, rgba(255, 152, 0, 0.15), rgba(255, 152, 0, 0.25));
        }

        .toast-notification.error {
            border-color: rgba(244, 67, 54, 0.5);
            background: linear-gradient(135deg, rgba(244, 67, 54, 0.15), rgba(244, 67, 54, 0.25));
        }

        .toast-content {
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
        }

        .toast-icon {
            font-size: 1.2rem;
        }

        .toast-message {
            font-weight: 600;
            font-size: 0.8rem;
            line-height: 1.3;
        }

        /* Exit confirmation */
        .exit-confirmation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10001;
        }

        .exit-confirmation.show {
            display: flex;
        }

        .exit-content {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(30px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            max-width: 320px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .exit-title {
            color: white;
            font-size: 1.3rem;
            font-weight: 800;
            margin-bottom: 15px;
        }

        .exit-message {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1rem;
            margin-bottom: 25px;
            line-height: 1.4;
        }

        .exit-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .exit-btn {
            padding: 12px 20px;
            border-radius: 15px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
        }

        .exit-btn.cancel {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .exit-btn.confirm {
            background: linear-gradient(135deg, #f44336, #d32f2f);
            color: white;
        }

        .exit-btn:active {
            transform: scale(0.95);
        }

        /* Responsive Design */
        @media (max-width: 480px) {
            .app-container {
                padding: 8px;
            }

            .question-text {
                font-size: 0.95rem;
            }

            .estimation-section {
                padding: 12px;
            }

            .estimation-title {
                font-size: 0.8rem;
            }

            .number-btn {
                max-width: 46px;
                height: 46px;
                font-size: 1rem;
            }

            .number-grid.large .number-btn {
                max-width: 38px;
                height: 38px;
                font-size: 0.9rem;
            }

            .number-grid {
                gap: 8px;
            }

            .selection-display {
                min-width: 90px;
                padding: 6px 14px;
                border-radius: 16px;
            }

            .selection-number {
                font-size: 1.2rem;
            }

            .selection-label {
                font-size: 0.65rem;
            }
        }

        @media (max-height: 700px) {
            .question-text {
                font-size: 0.9rem;
            }

            .estimation-section {
                padding: 12px;
            }

            .estimation-title {
                font-size: 0.8rem;
            }

            .number-btn {
                max-width: 44px;
                height: 44px;
                font-size: 1rem;
            }

            .number-grid.large .number-btn {
                max-width: 36px;
                height: 36px;
                font-size: 0.9rem;
            }

            .number-grid {
                gap: 8px;
            }

            .answer-btn {
                padding: 12px 8px;
            }

            .current-selection.visible {
                max-height: 48px;
            }

            .selection-display {
                padding: 7px 14px;
            }
        }

        @media (max-height: 600px) {
            .app-container {
                padding: 8px;
            }

            .question-card {
                padding: 10px 15px;
                margin-bottom: 8px;
            }

            .current-player-card {
                padding: 10px 12px;
                margin-bottom: 8px;
            }

            .estimation-section {
                padding: 10px;
                border-radius: 16px;
                gap: 10px;
            }

            .estimation-title {
                font-size: 0.75rem;
            }

            .number-btn {
                max-width: 40px;
                height: 40px;
                font-size: 0.95rem;
            }

            .number-grid.large .number-btn {
                max-width: 34px;
                height: 34px;
                font-size: 0.85rem;
            }

            .number-grid {
                gap: 6px;
            }

            .answer-btn {
                padding: 10px 8px;
            }

            .answer-emoji {
                font-size: 1rem;
            }

            .current-selection.visible {
                max-height: 45px;
                margin-bottom: 6px;
            }

            .selection-display {
                padding: 6px 12px;
                min-width: 80px;
                border-radius: 14px;
            }

            .selection-number {
                font-size: 1.1rem;
            }

            .selection-label {
                font-size: 0.6rem;
            }

            .submit-btn {
                padding: 12px;
                font-size: 0.9rem;
            }
        }

        /* Animations */
        .fadeInUp {
            animation: fadeInUp 0.6s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>
<!-- Background Particles -->
<div class="background-particles">
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
</div>

<!-- App Container -->
<div class="app-container">
    <!-- Main Game Content -->
    <div class="game-content">
        <!-- Question Card -->
        <div class="question-card fadeInUp">
            <div class="question-category" id="question-category">
                üéÆ Loading...
            </div>
            <div class="question-text" id="question-text">
                Lade Frage...
            </div>
        </div>

        <!-- Current Player -->
        <div class="current-player-card fadeInUp">
            <div class="player-avatar" id="current-avatar">M</div>
            <div class="player-info">
                <div class="player-name" id="current-player-name">Max</div>
                <div class="player-status">Du bist dran! <span id="player-progress">(1/4)</span></div>
            </div>
        </div>

        <!-- Answer Section -->
        <div class="answer-section fadeInUp" id="answer-section">
            <div class="answer-title">ü§î Deine Antwort</div>
            <div class="answer-buttons">
                <button class="answer-btn yes" onclick="selectAnswer(true)" id="yes-btn">
                    <div class="answer-emoji">‚úÖ</div>
                    <div>Ja, habe ich</div>
                </button>
                <button class="answer-btn no" onclick="selectAnswer(false)" id="no-btn">
                    <div class="answer-emoji">‚ùå</div>
                    <div>Nein, noch nie</div>
                </button>
            </div>
        </div>

        <!-- Estimation Section -->
        <div class="estimation-section fadeInUp" id="estimation-section">
            <div class="estimation-title">üéØ Wie viele antworten mit "Ja"?</div>

            <!-- Current Selection Display - Nur sichtbar nach Auswahl -->
            <div class="current-selection" id="current-selection">
                <div class="selection-display">
                    <div class="selection-number" id="selected-number">-</div>
                    <div class="selection-label">von <span id="total-players">0</span> Spielern</div>
                </div>
            </div>

            <!-- Number Grid -->
            <div class="number-grid small" id="number-grid">
                <!-- Numbers will be generated dynamically -->
            </div>
        </div>

        <!-- Submit Button -->
        <div class="submit-section fadeInUp" id="submit-section">
            <button class="submit-btn" onclick="submitAnswer()" id="submit-btn">
                üì§ Antwort best√§tigen
            </button>
        </div>

        <!-- Results Section -->
        <div class="results-section" id="results-section" style="display: none;">
            <div class="results-header">
                <div class="results-summary" id="results-summary"></div>
            </div>

            <div class="results-grid" id="results-grid">
                <!-- Results will be populated dynamically -->
            </div>

            <div class="results-navigation">
                <button class="nav-btn primary" onclick="nextQuestion()">
                    ‚û°Ô∏è N√§chste Frage
                </button>
                <button class="nav-btn secondary" onclick="endGame()">
                    üö™ Spiel beenden
                </button>
            </div>
        </div>

        <!-- Final Results Section -->
        <div class="final-results-section" id="final-results-section" style="display: none;">
            <div class="final-header">
                <div class="final-title">üèÜ Spiel beendet!</div>
                <div class="final-subtitle">Hier sind die finalen Ergebnisse</div>
            </div>

            <div class="leaderboard">
                <div class="leaderboard-title">üèÖ Rangliste</div>
                <div class="leaderboard-subtitle">Sortiert nach wenigsten Schl√ºcken</div>
                <div id="leaderboard-list">
                    <!-- Leaderboard will be populated dynamically -->
                </div>
            </div>

            <div class="final-navigation">
                <button class="nav-btn primary large" onclick="goHome()">
                    üè† Spiel beenden
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Player Change Popup -->
<div class="player-change-popup" id="player-change-popup">
    <div class="popup-content">
        <div class="popup-avatar" id="popup-avatar">M</div>
        <div class="popup-name" id="popup-name">Max</div>
        <div class="popup-message">ist dran!</div>
    </div>
</div>

<!-- Exit Confirmation -->
<div class="exit-confirmation" id="exit-confirmation">
    <div class="exit-content">
        <div class="exit-title">üö™ Spiel verlassen?</div>
        <div class="exit-message">M√∂chtest du das Spiel wirklich beenden? Der Fortschritt geht verloren.</div>
        <div class="exit-buttons">
            <button class="exit-btn cancel" onclick="cancelExit()">Nein, weiterspielen</button>
            <button class="exit-btn confirm" onclick="confirmExit()">Ja, beenden</button>
        </div>
    </div>
</div>

<script>
    // ===== FIREBASE SERVICE =====
    class FirebaseService {
        constructor() {
            this.app = null;
            this.database = null;
            this.isInitialized = false;
            this.isConnected = false;
            this.config = {
                apiKey: "AIzaSyAcUgQ6rHZXQvKsMQmzMPr77Hk-W4R2Zt0",
                authDomain: "denkstduwebsite.firebaseapp.com",
                databaseURL: "https://denkstduwebsite-default-rtdb.europe-west1.firebasedatabase.app",
                projectId: "denkstduwebsite",
                storageBucket: "denkstduwebsite.appspot.com",
                messagingSenderId: "27029260611",
                appId: "1:27029260611:web:3c7da4db0bf92e8ce247f6",
                measurementId: "G-BNKNW95HK8"
            };
        }

        async initialize() {
            try {
                console.log('üî• Initializing Firebase...');

                if (typeof firebase === 'undefined') {
                    console.warn('‚ö†Ô∏è Firebase SDK not loaded, using fallback mode');
                    return false;
                }

                if (!firebase.apps || firebase.apps.length === 0) {
                    this.app = firebase.initializeApp(this.config);
                } else {
                    this.app = firebase.app();
                }

                this.database = firebase.database();
                this.isInitialized = true;

                // Test connection
                const connectedRef = this.database.ref('.info/connected');
                const snapshot = await connectedRef.once('value');
                this.isConnected = snapshot.val() === true;

                console.log(`‚úÖ Firebase ${this.isConnected ? 'connected' : 'initialized (offline)'}`);
                return true;

            } catch (error) {
                console.error('‚ùå Firebase initialization failed:', error);
                return false;
            }
        }

        async loadQuestionsFromCategory(category) {
            if (!this.isInitialized || !this.isConnected) {
                return null;
            }

            try {
                const questionsRef = this.database.ref(`questions/${category}`);
                const snapshot = await questionsRef.once('value');

                if (snapshot.exists()) {
                    const questionsObj = snapshot.val();
                    return Object.values(questionsObj);
                }
                return null;
            } catch (error) {
                console.error(`‚ùå Error loading ${category} questions:`, error);
                return null;
            }
        }
    }

    // ===== GAME STATE MANAGEMENT =====
    class GameState {
        constructor() {
            this.deviceMode = null;
            this.selectedCategories = [];
            this.difficulty = null;
            this.players = [];
            this.gameId = null;
            this.playerName = null;
            this.isHost = false;
            this.isGuest = false;
            this.gameState = 'setup';
            this.timestamp = Date.now();

            this.loadFromStorage();
        }

        saveToStorage() {
            try {
                const state = {
                    deviceMode: this.deviceMode,
                    selectedCategories: this.selectedCategories,
                    difficulty: this.difficulty,
                    players: this.players,
                    gameId: this.gameId,
                    playerName: this.playerName,
                    isHost: this.isHost,
                    isGuest: this.isGuest,
                    gameState: this.gameState,
                    timestamp: Date.now(),
                    version: 2
                };
                localStorage.setItem('nocap_game_state', JSON.stringify(state));
                console.log('‚úÖ GameState saved:', state);
                return true;
            } catch (error) {
                console.error('‚ùå Could not save game state:', error);
                return false;
            }
        }

        loadFromStorage() {
            try {
                const saved = localStorage.getItem('nocap_game_state');
                if (saved) {
                    const state = JSON.parse(saved);
                    if (state.timestamp && Date.now() - state.timestamp < 24 * 60 * 60 * 1000) {
                        this.deviceMode = state.deviceMode || null;
                        this.selectedCategories = state.selectedCategories || [];
                        this.difficulty = state.difficulty || null;
                        this.players = state.players || [];
                        this.gameId = state.gameId || null;
                        this.playerName = state.playerName || null;
                        this.isHost = state.isHost || false;
                        this.isGuest = state.isGuest || false;
                        this.gameState = state.gameState || 'setup';

                        console.log('‚úÖ GameState loaded from storage:', this);
                        return true;
                    } else {
                        console.log('‚ö†Ô∏è GameState expired, clearing storage');
                        this.clearStorage();
                    }
                }
            } catch (error) {
                console.error('‚ùå Could not load game state:', error);
                this.clearStorage();
            }
            return false;
        }

        clearStorage() {
            localStorage.removeItem('nocap_game_state');
        }

        setSelectedCategories(categories) {
            this.selectedCategories = [...categories];
            this.saveToStorage();
        }

        setDifficulty(difficulty) {
            this.difficulty = difficulty;
            this.saveToStorage();
        }

        setPlayers(players) {
            this.players = [...players];
            this.saveToStorage();
        }

        setDeviceMode(mode) {
            this.deviceMode = mode;
            this.saveToStorage();
        }
    }

    // ===== GLOBAL VARIABLES =====
    let gameState = null;
    let firebaseService = null;
    let alcoholMode = false;
    let currentGame = {
        players: [],
        allQuestions: [],
        usedQuestions: [],
        currentQuestionNumber: 1,
        currentPlayerIndex: 0,
        currentAnswers: {},
        currentEstimates: {},
        gameHistory: []
    };

    // Check alcohol mode
    function checkAlcoholMode() {
        try {
            const alcoholModeStr = localStorage.getItem('nocap_alcohol_mode');
            alcoholMode = alcoholModeStr === 'true';
            console.log('üç∫ Alcohol mode:', alcoholMode);
        } catch (error) {
            console.error('‚ùå Error checking alcohol mode:', error);
            alcoholMode = false;
        }
    }

    // Fallback Questions Database
    const fallbackQuestionsDatabase = {
        fsk0: [
            "Ich habe schon mal... ein ganzes Buch an einem Tag gelesen",
            "Ich habe schon mal... Pizza zum Fr√ºhst√ºck gegessen",
            "Ich habe schon mal... mehr als 12 Stunden am St√ºck geschlafen",
            "Ich habe schon mal... einen ganzen Tag im Pyjama verbracht",
            "Ich habe schon mal... beim Kochen das Essen anbrennen lassen"
        ],
        fsk16: [
            "Ich habe schon mal... so getan, als w√§re ich krank, um nicht zur Schule zu m√ºssen",
            "Ich habe schon mal... bis 3 Uhr morgens Netflix geschaut",
            "Ich habe schon mal... ein Lied so laut gesungen, dass die Nachbarn sich beschwert haben",
            "Ich habe schon mal... vergessen, wo ich mein Auto geparkt habe"
        ],
        fsk18: [
            "Ich habe schon mal... an einem √∂ffentlichen Ort Sex gehabt",
            "Ich habe schon mal... eine Aff√§re gehabt",
            "Ich habe schon mal... in einer Beziehung betrogen"
        ]
    };

    let isExitDialogShown = false;

    // ===== PAGE LEAVE PROTECTION =====
    window.addEventListener('beforeunload', function(e) {
        if (!isExitDialogShown) {
            e.preventDefault();
            e.returnValue = 'M√∂chtest du das Spiel wirklich verlassen? Der Fortschritt geht verloren.';
            return e.returnValue;
        }
    });

    window.addEventListener('popstate', function(e) {
        e.preventDefault();
        showExitConfirmation();
        history.pushState(null, null, window.location.pathname);
    });

    history.pushState(null, null, window.location.pathname);

    function showExitConfirmation() {
        const exitDialog = document.getElementById('exit-confirmation');
        exitDialog.classList.add('show');
    }

    function cancelExit() {
        const exitDialog = document.getElementById('exit-confirmation');
        exitDialog.classList.remove('show');
    }

    function confirmExit() {
        try {
            localStorage.clear();
            sessionStorage.clear();
            isExitDialogShown = true;
            window.location.replace('index.html');
        } catch (error) {
            console.error('Exit error:', error);
            window.location.href = 'index.html?t=' + Date.now();
        }
    }

    function goHome() {
        try {
            localStorage.clear();
            sessionStorage.clear();
            isExitDialogShown = true;
            window.location.replace('index.html');
        } catch (error) {
            window.location.href = 'index.html?t=' + Date.now();
        }
    }

    // ===== INITIALIZATION =====
    document.addEventListener('DOMContentLoaded', function() {
        initializeGame();
    });

    async function initializeGame() {
        console.log('üéÆ Initializing endless single device gameplay...');

        // Check alcohol mode
        checkAlcoholMode();

        // Load game state
        gameState = new GameState();

        // Debug: Log loaded state
        console.log('üìä Loaded GameState:', {
            deviceMode: gameState.deviceMode,
            categories: gameState.selectedCategories,
            difficulty: gameState.difficulty,
            players: gameState.players,
            playersCount: gameState.players ? gameState.players.length : 0
        });

        // Initialize Firebase
        firebaseService = new FirebaseService();
        await firebaseService.initialize();

        // Validate game state
        if (!gameState.players || gameState.players.length < 2) {
            console.error('‚ùå Validation failed: Not enough players', gameState.players);
            showNotification('Keine Spieler gefunden!', 'error');
            setTimeout(() => window.location.href = 'player-setup.html', 2000);
            return;
        }

        if (!gameState.selectedCategories || gameState.selectedCategories.length === 0) {
            console.error('‚ùå Validation failed: No categories', gameState.selectedCategories);
            showNotification('Keine Kategorien ausgew√§hlt!', 'error');
            setTimeout(() => window.location.href = 'category-selection.html', 2000);
            return;
        }

        if (!gameState.difficulty) {
            console.error('‚ùå Validation failed: No difficulty', gameState.difficulty);
            showNotification('Kein Schwierigkeitsgrad ausgew√§hlt!', 'error');
            setTimeout(() => window.location.href = 'difficulty-selection.html', 2000);
            return;
        }

        // Setup game
        currentGame.players = [...gameState.players];
        await generateAllQuestions();

        // Initialize UI
        updateGameDisplay();
        createNumberGrid();

        // Start first question
        startNewQuestion();

        console.log('‚úÖ Endless game initialized:', {
            players: currentGame.players,
            categories: gameState.selectedCategories,
            difficulty: gameState.difficulty,
            totalQuestions: currentGame.allQuestions.length
        });
    }

    async function generateAllQuestions() {
        currentGame.allQuestions = [];

        // Try to load questions from Firebase first
        for (const category of gameState.selectedCategories) {
            const firebaseQuestions = await firebaseService.loadQuestionsFromCategory(category);

            if (firebaseQuestions && firebaseQuestions.length > 0) {
                console.log(`‚úÖ Loaded ${firebaseQuestions.length} questions from Firebase for ${category}`);
                firebaseQuestions.forEach(q => {
                    currentGame.allQuestions.push({
                        text: q,
                        category: category
                    });
                });
            } else {
                // Fallback to local questions
                console.log(`‚ö†Ô∏è Using fallback questions for ${category}`);
                if (fallbackQuestionsDatabase[category]) {
                    fallbackQuestionsDatabase[category].forEach(q => {
                        currentGame.allQuestions.push({
                            text: q,
                            category: category
                        });
                    });
                }
            }
        }

        // Shuffle questions
        currentGame.allQuestions = shuffleArray(currentGame.allQuestions);

        console.log(`üìö Total questions loaded: ${currentGame.allQuestions.length}`);
    }

    function getNextQuestion() {
        if (currentGame.usedQuestions.length >= currentGame.allQuestions.length) {
            currentGame.usedQuestions = [];
            currentGame.allQuestions = shuffleArray(currentGame.allQuestions);
            showNotification('Alle Fragen gespielt! Mische neu...', 'success');
        }

        for (let question of currentGame.allQuestions) {
            if (!currentGame.usedQuestions.includes(question.text)) {
                currentGame.usedQuestions.push(question.text);
                return question;
            }
        }

        return currentGame.allQuestions[0];
    }

    function shuffleArray(array) {
        const shuffled = [...array];
        for (let i = shuffled.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
        }
        return shuffled;
    }

    // ===== GAME FLOW =====
    function updateGameDisplay() {
        document.getElementById('total-players').textContent = currentGame.players.length;

        const currentPlayerName = currentGame.players[currentGame.currentPlayerIndex];
        document.getElementById('current-player-name').textContent = currentPlayerName;
        document.getElementById('current-avatar').textContent = currentPlayerName.charAt(0).toUpperCase();
        document.getElementById('player-progress').textContent =
            `(${currentGame.currentPlayerIndex + 1}/${currentGame.players.length})`;
    }

    function startNewQuestion() {
        console.log(`üé≤ Starting question ${currentGame.currentQuestionNumber}`);

        currentGame.currentPlayerIndex = 0;
        currentGame.currentAnswers = {};
        currentGame.currentEstimates = {};

        const question = getNextQuestion();
        loadQuestion(question);

        resetPlayerUI();
        updateGameDisplay();
        showGameView();
    }

    function nextQuestion() {
        currentGame.currentQuestionNumber++;
        startNewQuestion();
        showNotification('Neue Frage geladen! üéÆ', 'success');
    }

    function endGame() {
        showFinalResults();
    }

    // ===== FINAL RESULTS =====
    function showFinalResults() {
        console.log('üèÜ Calculating final results...');

        const playerStats = calculatePlayerStatistics();
        const finalRankings = playerStats.sort((a, b) => a.totalSips - b.totalSips);

        displayFinalResults(finalRankings);
        showFinalResultsView();
    }

    function calculatePlayerStatistics() {
        const playerStats = {};

        currentGame.players.forEach(player => {
            playerStats[player] = {
                playerName: player,
                totalSips: 0,
                correctGuesses: 0,
                totalGuesses: 0
            };
        });

        currentGame.gameHistory.forEach(round => {
            round.results.forEach(result => {
                const stats = playerStats[result.playerName];
                if (stats) {
                    stats.totalSips += result.sips;
                    stats.totalGuesses++;
                    if (result.isCorrect) {
                        stats.correctGuesses++;
                    }
                }
            });
        });

        return Object.values(playerStats);
    }

    function displayFinalResults(finalRankings) {
        const leaderboardList = document.getElementById('leaderboard-list');
        leaderboardList.innerHTML = '';

        // Emoji basierend auf Alcohol Mode
        const drinkEmoji = alcoholMode ? 'üç∫' : 'üíß';

        finalRankings.forEach((player, index) => {
            const leaderboardItem = document.createElement('div');
            leaderboardItem.className = `leaderboard-item ${index === 0 ? 'winner' : ''}`;

            const rankClass = index === 0 ? 'rank-1' :
                index === 1 ? 'rank-2' :
                    index === 2 ? 'rank-3' : 'rank-other';

            const rankText = index + 1;
            const avatar = player.playerName.charAt(0).toUpperCase();

            // Singular/Plural bei Schl√ºcken und Fragen
            const sipsText = player.totalSips === 1 ? '1 Schluck' : `${player.totalSips} Schl√ºcke`;
            const questionsText = player.correctGuesses === 1 ? '1 Frage richtig' : `${player.correctGuesses} Fragen richtig`;

            leaderboardItem.innerHTML = `
                    <div class="rank-number ${rankClass}">${rankText}</div>
                    <div class="result-avatar">${avatar}</div>
                    <div class="player-final-stats">
                        <div class="player-final-name">${player.playerName}</div>
                        <div class="player-final-details">
                            <div class="detail-item">
                                <span class="detail-icon">${drinkEmoji}</span>
                                <span>${sipsText}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-icon">üéØ</span>
                                <span>${questionsText}</span>
                            </div>
                        </div>
                    </div>
                `;

            leaderboardList.appendChild(leaderboardItem);
        });

        showNotification(
            `üèÜ ${finalRankings[0].playerName} hat gewonnen!`,
            'success',
            3000
        );
    }

    function showFinalResultsView() {
        const questionCard = document.querySelector('.question-card');
        const answerSection = document.getElementById('answer-section');
        const estimationSection = document.getElementById('estimation-section');
        const submitSection = document.getElementById('submit-section');
        const currentPlayerCard = document.querySelector('.current-player-card');
        const resultsSection = document.getElementById('results-section');

        if (questionCard) questionCard.style.display = 'none';
        if (answerSection) answerSection.style.display = 'none';
        if (estimationSection) estimationSection.style.display = 'none';
        if (submitSection) submitSection.style.display = 'none';
        if (currentPlayerCard) currentPlayerCard.style.display = 'none';
        if (resultsSection) resultsSection.style.display = 'none';

        const finalResultsSection = document.getElementById('final-results-section');
        if (finalResultsSection) {
            finalResultsSection.style.display = 'flex';
        }
    }

    function loadQuestion(question) {
        const categoryNames = {
            'fsk0': 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Familie & Freunde',
            'fsk16': 'üéâ Party Time',
            'fsk18': 'üî• Hei√ü & Gewagt'
        };

        document.getElementById('question-text').textContent = question.text;
        document.getElementById('question-category').textContent = categoryNames[question.category] || 'üéÆ Spiel';
    }

    function resetPlayerUI() {
        document.querySelectorAll('.answer-btn').forEach(btn => {
            btn.classList.remove('selected');
        });

        // Reset estimation to unselected state
        currentEstimation = null;
        updateNumberSelection();
        hideSelectionDisplay();
        updateSubmitButton();
    }

    // ===== UI CONTROLS =====
    function createNumberGrid() {
        const numberGrid = document.getElementById('number-grid');
        const playerCount = currentGame.players.length;
        numberGrid.innerHTML = '';

        // Dynamische Grid-Klasse basierend auf Anzahl
        if (playerCount <= 6) {
            numberGrid.className = 'number-grid small';
        } else if (playerCount <= 10) {
            numberGrid.className = 'number-grid medium';
        } else {
            numberGrid.className = 'number-grid large';
        }

        for (let i = 0; i <= playerCount; i++) {
            const numberBtn = document.createElement('button');
            numberBtn.className = 'number-btn';
            numberBtn.textContent = i;
            numberBtn.onclick = () => selectNumber(i);
            numberBtn.id = `number-btn-${i}`;

            numberGrid.appendChild(numberBtn);
        }
    }

    function selectNumber(number) {
        if (number >= 0 && number <= currentGame.players.length) {
            currentEstimation = number;
            updateSelectedNumber(number);
            showSelectionDisplay();
            updateNumberSelection();
            updateSubmitButton();

            if (navigator.vibrate) {
                navigator.vibrate(50);
            }
        }
    }

    function updateSelectedNumber(number) {
        document.getElementById('selected-number').textContent = number;

        const selectionDisplay = document.querySelector('.selection-display');
        // Smooth bounce animation
        selectionDisplay.style.transform = 'scale(1.08)';
        setTimeout(() => {
            selectionDisplay.style.transform = 'scale(1)';
        }, 300);
    }

    function showSelectionDisplay() {
        const selectionEl = document.getElementById('current-selection');
        // Kleine Verz√∂gerung f√ºr smooth animation
        requestAnimationFrame(() => {
            selectionEl.classList.add('visible');
        });
    }

    function hideSelectionDisplay() {
        const selectionEl = document.getElementById('current-selection');
        selectionEl.classList.remove('visible');
    }

    function updateNumberSelection() {
        document.querySelectorAll('.number-btn').forEach(btn => {
            btn.classList.remove('selected');
        });

        if (currentEstimation !== null) {
            const selectedBtn = document.getElementById(`number-btn-${currentEstimation}`);
            if (selectedBtn) {
                selectedBtn.classList.add('selected');
            }
        }
    }

    function selectAnswer(answer) {
        currentAnswer = answer;

        document.querySelectorAll('.answer-btn').forEach(btn => {
            btn.classList.remove('selected');
        });

        const selectedBtn = answer ? document.getElementById('yes-btn') : document.getElementById('no-btn');
        selectedBtn.classList.add('selected');

        updateSubmitButton();
    }

    function updateSubmitButton() {
        const submitBtn = document.getElementById('submit-btn');
        if (currentAnswer !== null && currentEstimation !== null) {
            submitBtn.classList.add('enabled');
            submitBtn.disabled = false;
        } else {
            submitBtn.classList.remove('enabled');
            submitBtn.disabled = true;
        }
    }

    // ===== GAME ACTIONS =====
    let currentAnswer = null;
    let currentEstimation = null;

    function submitAnswer() {
        if (currentAnswer === null || currentEstimation === null) {
            showNotification('Bitte w√§hle eine Antwort und eine Sch√§tzung aus!', 'warning');
            return;
        }

        const currentPlayerName = currentGame.players[currentGame.currentPlayerIndex];

        currentGame.currentAnswers[currentPlayerName] = currentAnswer;
        currentGame.currentEstimates[currentPlayerName] = currentEstimation;

        console.log(`üì§ ${currentPlayerName} answered:`, {
            answer: currentAnswer,
            estimation: currentEstimation
        });

        if (currentGame.currentPlayerIndex < currentGame.players.length - 1) {
            currentGame.currentPlayerIndex++;
            currentAnswer = null;
            currentEstimation = null;
            resetPlayerUI();
            updateGameDisplay();
            showPlayerChangePopup();
        } else {
            showResults();
        }
    }

    // ===== PLAYER CHANGE POPUP =====
    function showPlayerChangePopup() {
        const currentPlayerName = currentGame.players[currentGame.currentPlayerIndex];

        document.getElementById('popup-name').textContent = currentPlayerName;
        document.getElementById('popup-avatar').textContent = currentPlayerName.charAt(0).toUpperCase();

        const popup = document.getElementById('player-change-popup');
        popup.classList.add('show');

        if (navigator.vibrate) {
            navigator.vibrate([100, 50, 100]);
        }

        setTimeout(() => {
            popup.classList.remove('show');
        }, 2000);
    }

    // ===== RESULTS =====
    function showResults() {
        console.log('üìä Calculating results...');

        const actualYesCount = Object.values(currentGame.currentAnswers).filter(answer => answer === true).length;

        const results = currentGame.players.map(playerName => {
            const answer = currentGame.currentAnswers[playerName];
            const estimation = currentGame.currentEstimates[playerName];
            const difference = Math.abs(estimation - actualYesCount);
            const isCorrect = difference === 0;

            let sips = 0;
            if (!isCorrect) {
                const baseSips = getDifficultyMultiplier();
                sips = baseSips + difference;
            }

            return {
                playerName: playerName,
                answer: answer,
                estimation: estimation,
                difference: difference,
                isCorrect: isCorrect,
                sips: sips
            };
        });

        currentGame.gameHistory.push({
            questionNumber: currentGame.currentQuestionNumber,
            actualYesCount: actualYesCount,
            results: results
        });

        displayResults(results, actualYesCount);
        showResultsView();
    }

    function showResultsView() {
        document.getElementById('answer-section').style.display = 'none';
        document.getElementById('estimation-section').style.display = 'none';
        document.getElementById('submit-section').style.display = 'none';
        document.querySelector('.current-player-card').style.display = 'none';
        document.getElementById('results-section').style.display = 'flex';

        showNotification('Ergebnisse werden angezeigt...', 'success', 2000);
    }

    function showGameView() {
        document.getElementById('answer-section').style.display = 'block';
        document.getElementById('estimation-section').style.display = 'flex';
        document.getElementById('submit-section').style.display = 'block';
        document.querySelector('.current-player-card').style.display = 'flex';
        document.getElementById('results-section').style.display = 'none';
    }

    function getDifficultyMultiplier() {
        switch (gameState.difficulty) {
            case 'easy': return 1;
            case 'hard': return 3;
            default: return 2;
        }
    }

    function displayResults(results, actualYesCount) {
        document.getElementById('results-summary').textContent =
            `${actualYesCount} von ${currentGame.players.length} Spielern haben "Ja" geantwortet`;

        const sortedResults = results.sort((a, b) => {
            if (a.isCorrect && !b.isCorrect) return -1;
            if (!a.isCorrect && b.isCorrect) return 1;
            return a.sips - b.sips;
        });

        const resultsGrid = document.getElementById('results-grid');
        resultsGrid.innerHTML = '';

        // Emoji basierend auf Alcohol Mode
        const drinkEmoji = alcoholMode ? 'üç∫' : 'üíß';

        sortedResults.forEach(result => {
            const resultItem = document.createElement('div');
            resultItem.className = 'result-item';

            const avatar = result.playerName.charAt(0).toUpperCase();

            // Singular/Plural bei Schl√ºcken
            const sipsText = result.sips === 0 ? 'Perfekt! üéØ' :
                result.sips === 1 ? `1 Schluck ${drinkEmoji}` :
                    `${result.sips} Schl√ºcke ${drinkEmoji}`;
            const sipsClass = result.sips === 0 ? 'none' : '';

            resultItem.innerHTML = `
                    <div class="player-result">
                        <div class="result-avatar">${avatar}</div>
                        <div class="player-result-info">
                            <div class="player-result-name">${result.playerName}</div>
                            <div class="player-answer">Tipp: ${result.estimation}</div>
                        </div>
                    </div>
                    <div class="sips-penalty ${sipsClass}">${sipsText}</div>
                `;

            resultsGrid.appendChild(resultItem);
        });
    }

    // ===== UTILITY FUNCTIONS =====
    function showNotification(message, type = 'info', duration = 3000) {
        document.querySelectorAll('.toast-notification').forEach(n => n.remove());

        const notification = document.createElement('div');
        notification.className = `toast-notification ${type}`;
        notification.innerHTML = `
                <div class="toast-content">
                    <div class="toast-icon">${type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è'}</div>
                    <div class="toast-message">${message}</div>
                </div>
            `;

        document.body.appendChild(notification);

        setTimeout(() => notification.classList.add('show'), 100);

        setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => {
                if (document.body.contains(notification)) {
                    document.body.removeChild(notification);
                }
            }, 300);
        }, duration);
    }

    console.log('‚úÖ No-Cap Gameplay loaded with Firebase integration');
</script>
</body>
</html>