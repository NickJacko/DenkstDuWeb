{
  "rules": {
    ".read": false,
    ".write": false,

    "games": {
      "$gameId": {
        ".read": "auth != null",

        // ✅ FIX: Erlaubt Host, Spiel zu erstellen und zu updaten
        ".write": "auth != null && (
          !data.exists() ||
          data.child('hostId').val() == auth.uid ||
          root.child('games/' + $gameId + '/players/' + auth.uid).exists()
        )",

        "gameId": {
          ".validate": "newData.isString() && newData.val().length === 6 && newData.val().matches(/^[A-Z0-9]{6}$/)"
        },

        "hostId": {
          ".validate": "newData.isString()"
        },

        "hostName": {
          ".validate": "newData.isString()"
        },

        "status": {
          ".validate": "newData.isString() && (
            newData.val() == 'lobby' ||
            newData.val() == 'waiting' ||
            newData.val() == 'playing' ||
            newData.val() == 'finished'
          )"
        },

        "gameState": {
          ".validate": "newData.isString() && (
            newData.val() == 'waiting' ||
            newData.val() == 'playing' ||
            newData.val() == 'finished'
          )"
        },

        "createdAt": {
          ".validate": "newData.isNumber()"
        },

        "lastActivity": {
          ".validate": "newData.isNumber()"
        },

        // ✅ FIX: lastUpdate darf von Host und Spielern gesetzt werden
        "lastUpdate": {
          ".validate": "newData.isNumber()",
          ".write": "auth != null && (
            data.parent().child('hostId').val() == auth.uid ||
            root.child('games/' + $gameId + '/players/' + auth.uid).exists()
          )"
        },

        "players": {
          "$playerId": {
            ".read": "auth != null",
            // ✅ FIX: Erlaubt Spielern, sich selbst hinzuzufügen oder Host zu ändern
            ".write": "auth != null && (
              !data.exists() ||
              auth.uid == $playerId ||
              root.child('games/' + $gameId + '/hostId').val() == auth.uid
            )",

            "id": {
              ".validate": "newData.isString()"
            },

            "name": {
              ".validate": "newData.isString()"
            },

            "isHost": {
              ".validate": "newData.isBoolean()"
            },

            "isReady": {
              ".validate": "newData.isBoolean()"
            },

            "joinedAt": {
              ".validate": "newData.isNumber()"
            }
          }
        },

        "settings": {
          ".write": "auth != null && (
            !root.child('games/' + $gameId + '/hostId').exists() ||
            root.child('games/' + $gameId + '/hostId').val() == auth.uid
          )",

          "categories": {
            ".validate": "newData.val() != null"
          },

          "difficulty": {
            ".validate": "newData.isString() && (newData.val() == 'easy' || newData.val() == 'medium' || newData.val() == 'hard')"
          },

          "alcoholMode": {
            ".validate": "newData.isBoolean()"
          },


          "mode": {
            ".validate": "newData.isString()"
          }
        },

        "currentQuestion": {
          ".read": "auth != null && root.child('games/' + $gameId + '/players/' + auth.uid).exists()",
          ".write": "auth != null && root.child('games/' + $gameId + '/hostId').val() == auth.uid"
        },

        "answers": {
          "$playerId": {
            ".write": "auth != null && auth.uid == $playerId"
          }
        },

        "scores": {
          ".read": "auth != null",
          ".write": "auth != null && root.child('games/' + $gameId + '/hostId').val() == auth.uid"
        }
      }
    },

    "users": {
      "$userId": {
        ".read": "auth != null && auth.uid == $userId",
        ".write": "auth != null && auth.uid == $userId",


        "displayName": {
          ".validate": "newData.isString() && newData.val().length > 0 && newData.val().length <= 30"
        },

        "ageVerified": {
          ".validate": "newData.isBoolean()"
        },

        "ageVerificationLevel": {
          ".validate": "newData.isNumber() && (newData.val() == 0 || newData.val() == 18)"
        },

        "stats": {
          ".read": "auth != null",
          ".write": "auth != null && auth.uid == $userId"
        }
      }
    },

    "audit_logs": {
      "$userId": {
        ".read": "auth != null && auth.uid == $userId",
        ".write": false
      }
    },

    "leaderboard": {
      ".read": "auth != null",
      ".write": false,
      ".indexOn": ["score", "timestamp"]
    },

    "questions": {
      ".read": "auth != null",
      ".write": false,

      "fsk0": {
        ".read": "auth != null",
        ".indexOn": ["category", "difficulty"]
      },
      "fsk16": {
        ".read": "auth != null",
        ".indexOn": ["category", "difficulty"]
      },
      "fsk18": {
        ".read": "auth != null",
        ".indexOn": ["category", "difficulty"]
      },
      "special": {
        ".read": "auth != null",
        ".indexOn": ["category", "difficulty"]
      }
    }
  }
}

