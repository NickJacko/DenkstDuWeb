{
  "rules": {
    ".read": false,
    ".write": false,

    "games": {
      ".indexOn": ["hostId", "createdAt", "status"],

      "$gameId": {
        ".read": "auth != null && (data.child('players').child(auth.uid).exists() || data.child('hostId').val() === auth.uid)",
        ".write": false,

        ".validate": "newData.hasChildren(['hostId', 'gameCode', 'status', 'createdAt']) && newData.child('players').hasChildren()",

        "hostId": {
          ".validate": "newData.isString() && newData.val().length > 0 && newData.val().length <= 128"
        },

        "gameCode": {
          ".validate": "newData.isString() && newData.val().matches(/^[A-Z0-9]{6}$/)"
        },

        "status": {
          ".write": "auth != null && root.child('games').child($gameId).child('hostId').val() === auth.uid",
          ".validate": "newData.isString() && (newData.val() === 'lobby' || newData.val() === 'playing' || newData.val() === 'results' || newData.val() === 'finished')"
        },

        "phase": {
          ".write": "auth != null && root.child('games').child($gameId).child('hostId').val() === auth.uid",
          ".validate": "newData.isString() && (newData.val() === 'lobby' || newData.val() === 'setup' || newData.val() === 'question' || newData.val() === 'estimation' || newData.val() === 'results' || newData.val() === 'finished' || newData.val() === 'waiting' || newData.val() === 'playing')"
        },

        "startedAt": {
          ".write": "auth != null && root.child('games').child($gameId).child('hostId').val() === auth.uid",
          ".validate": "newData.isNumber() && newData.val() > 0"
        },

        "createdAt": {
          ".validate": "newData.isNumber() && newData.val() > 0"
        },

        "lastUpdate": {
          ".write": "auth != null && root.child('games').child($gameId).child('hostId').val() === auth.uid",
          ".validate": "newData.isNumber() && newData.val() > 0"
        },

        "lastActivity": {
          ".write": "auth != null && (root.child('games').child($gameId).child('hostId').val() === auth.uid || root.child('games').child($gameId).child('players').child(auth.uid).exists())",
          ".validate": "newData.isNumber() && newData.val() > 0"
        },

        "ttl": {
          ".validate": "newData.isNumber() && newData.val() > 0"
        },

        "difficulty": {
          ".validate": "newData.isString() && (newData.val() === 'easy' || newData.val() === 'medium' || newData.val() === 'hard')"
        },

        "alcoholMode": {
          ".validate": "newData.isBoolean()"
        },

        "currentRound": {
          ".write": "auth != null && root.child('games').child($gameId).child('hostId').val() === auth.uid",
          ".validate": "newData.isNumber() && newData.val() >= 1 && newData.val() <= 100"
        },

        "currentQuestionIndex": {
          ".write": "auth != null && root.child('games').child($gameId).child('hostId').val() === auth.uid",
          ".validate": "newData.isNumber() && newData.val() >= 0 && newData.val() <= 1000"
        },

        "scores": {
          ".write": "auth != null && root.child('games').child($gameId).child('hostId').val() === auth.uid",
          "$playerId": {
            ".validate": "newData.isNumber() && newData.val() >= 0 && newData.val() <= 10000"
          }
        },

        "timerStartTime": {
          ".write": "auth != null && root.child('games').child($gameId).child('hostId').val() === auth.uid",
          ".validate": "newData.isNumber() && newData.val() > 0"
        },

        "timerPaused": {
          ".write": "auth != null && root.child('games').child($gameId).child('hostId').val() === auth.uid",
          ".validate": "newData.isBoolean()"
        },

        "timerRemaining": {
          ".write": "auth != null && root.child('games').child($gameId).child('hostId').val() === auth.uid",
          ".validate": "newData.isNumber() && newData.val() >= 0 && newData.val() <= 300"
        },

        "settings": {
          ".read": "auth != null && (root.child('games').child($gameId).child('players').child(auth.uid).exists() || root.child('games').child($gameId).child('hostId').val() === auth.uid)",
          ".write": "auth != null && root.child('games').child($gameId).child('hostId').val() === auth.uid",

          ".validate": "newData.hasChildren(['categories', 'difficulty', 'alcoholMode'])",

          "categories": {
            ".validate": "(newData.hasChildren(['0']) && newData.child('0').isString()) || (newData.child('fsk0').exists() || newData.child('fsk16').exists() || newData.child('fsk18').exists() || newData.child('special').exists())",
            "$i": {
              ".validate": "newData.isString() && (newData.val() === 'fsk0' || newData.val() === 'fsk16' || newData.val() === 'fsk18' || newData.val() === 'special')"
            }
          },

          "difficulty": {
            ".validate": "newData.isString() && (newData.val() === 'easy' || newData.val() === 'medium' || newData.val() === 'hard')"
          },

          "alcoholMode": {
            ".validate": "newData.isBoolean()"
          }
        },

        "players": {
          ".indexOn": ["joinedAt", "online", "isHost"],

          "$playerId": {
            ".read": "auth != null && (root.child('games').child($gameId).child('players').child(auth.uid).exists() || root.child('games').child($gameId).child('hostId').val() === auth.uid)",
            ".write": "auth != null && (auth.uid === $playerId || root.child('games').child($gameId).child('hostId').val() === auth.uid) && root.child('games').child($gameId).child('players').child(auth.uid).exists()",

            ".validate": "newData.hasChildren(['name', 'joinedAt'])",

            "isReady": {
              ".validate": "newData.isBoolean()"
            },

            "categoryReady": {
              ".validate": "newData.isBoolean()"
            },

            "lastSeen": {
              ".validate": "newData.isNumber() && newData.val() > 0"
            },

            "online": {
              ".validate": "newData.isBoolean()"
            },

            "disconnectedAt": {
              ".validate": "newData.isNumber() && newData.val() > 0"
            },

            "rejoinDeadline": {
              ".validate": "(newData.isNumber() && newData.val() > 0) || newData.val() === null"
            },

            "updatedAt": {
              ".validate": "newData.isNumber() && newData.val() > 0"
            },

            "name": {
              ".validate": "newData.isString() && newData.val().length >= 2 && newData.val().length <= 20"
            },

            "isHost": {
              ".validate": "newData.isBoolean()"
            },

            "joinedAt": {
              ".validate": "newData.isNumber() && newData.val() > 0"
            },

            "score": {
              ".write": "auth != null && root.child('games').child($gameId).child('hostId').val() === auth.uid",
              ".validate": "newData.isNumber() && newData.val() >= 0 && newData.val() <= 10000 && (newData.val() - data.val() <= 100 || !data.exists())"
            }
          }
        },

        "rounds": {
          ".indexOn": ["startedAt"],

          "$roundId": {
            ".read": "auth != null && (root.child('games').child($gameId).child('players').child(auth.uid).exists() || root.child('games').child($gameId).child('hostId').val() === auth.uid)",

            ".validate": "newData.hasChildren(['question', 'startedAt'])",

            "question": {
              ".write": "auth != null && root.child('games').child($gameId).child('hostId').val() === auth.uid",
              ".validate": "newData.hasChildren(['text','category']) && newData.child('text').isString() && newData.child('text').val().length > 0 && newData.child('text').val().length <= 300 && newData.child('category').isString() && (newData.child('category').val() === 'fsk0' || newData.child('category').val() === 'fsk16' || newData.child('category').val() === 'fsk18' || newData.child('category').val() === 'special')"
            },

            "startedAt": {
              ".write": "auth != null && root.child('games').child($gameId).child('hostId').val() === auth.uid",
              ".validate": "newData.isNumber() && newData.val() > 0"
            },

            "timerDuration": {
              ".write": "auth != null && root.child('games').child($gameId).child('hostId').val() === auth.uid",
              ".validate": "newData.isNumber() && newData.val() >= 5 && newData.val() <= 300"
            },

            "summary": {
              ".write": "auth != null && root.child('games').child($gameId).child('hostId').val() === auth.uid",
              ".validate": "newData.hasChildren(['totalAnswers','yesCount','aggregatedAt']) && newData.child('totalAnswers').isNumber() && newData.child('totalAnswers').val() >= 0 && newData.child('totalAnswers').val() <= 50 && newData.child('yesCount').isNumber() && newData.child('yesCount').val() >= 0 && newData.child('yesCount').val() <= newData.child('totalAnswers').val() && newData.child('aggregatedAt').isNumber() && newData.child('aggregatedAt').val() > 0"
            },

            "answers": {
              ".indexOn": ["submittedAt"],

              "$uid": {
                ".write": "auth != null && $uid === auth.uid && root.child('games').child($gameId).child('players').child(auth.uid).exists()",
                ".validate": "newData.hasChildren(['answer','estimation','submittedAt']) && newData.child('answer').isBoolean() && newData.child('estimation').isNumber() && newData.child('estimation').val() >= 0 && newData.child('estimation').val() <= 50 && newData.child('submittedAt').isNumber() && newData.child('submittedAt').val() > 0"
              }
            }
          }
        }
      }
    },

    "gameCodes": {
      ".indexOn": ["status", "createdAt", "hostId"],

      "$code": {
        ".read": "auth != null",
        ".write": false,

        ".validate": "newData.hasChildren(['hostId', 'gameId', 'status', 'createdAt']) && newData.val().matches(/^[A-Z0-9]{6}$/)",

        "hostId": {
          ".validate": "newData.isString() && newData.val().length > 0 && newData.val().length <= 128"
        },

        "gameId": {
          ".validate": "newData.isString() && newData.val().length > 0 && newData.val().length <= 128"
        },

        "status": {
          ".validate": "newData.isString() && (newData.val() === 'active' || newData.val() === 'used' || newData.val() === 'expired')"
        },

        "maxPlayers": {
          ".validate": "newData.isNumber() && newData.val() >= 2 && newData.val() <= 8"
        },

        "categories": {
          ".validate": "newData.hasChildren()",
          "$i": {
            ".validate": "newData.isString() && (newData.val() === 'fsk0' || newData.val() === 'fsk16' || newData.val() === 'fsk18' || newData.val() === 'special')"
          }
        },

        "difficulty": {
          ".validate": "newData.isString() && (newData.val() === 'easy' || newData.val() === 'medium' || newData.val() === 'hard')"
        },

        "createdAt": {
          ".validate": "newData.isNumber() && newData.val() > 0"
        },

        "expiresAt": {
          ".validate": "newData.isNumber() && newData.val() > newData.parent().child('createdAt').val()"
        }
      }
    },

    "questions": {
      ".write": false,

      "fsk0": {
        ".read": "auth != null",
        "$questionId": {
          ".validate": "newData.hasChildren(['text']) && newData.child('text').isString() && newData.child('text').val().length > 0 && newData.child('text').val().length <= 300"
        }
      },

      "fsk16": {
        ".read": "auth != null",
        "$questionId": {
          ".validate": "newData.hasChildren(['text']) && newData.child('text').isString() && newData.child('text').val().length > 0 && newData.child('text').val().length <= 300"
        }
      },

      "fsk18": {
        ".read": false,
        "$questionId": {
          ".validate": "newData.hasChildren(['text']) && newData.child('text').isString() && newData.child('text').val().length > 0 && newData.child('text').val().length <= 300"
        }
      },

      "special": {
        ".read": "auth != null",
        "$questionId": {
          ".validate": "newData.hasChildren(['text']) && newData.child('text').isString() && newData.child('text').val().length > 0 && newData.child('text').val().length <= 300"
        }
      }
    },
    "users": {
      ".indexOn": ["createdAt", "lastLogin"],

      "$userId": {
        // ✅ Lesen: Nur eigener User
        ".read": "auth != null && auth.uid === $userId",

        // ❌ Schreiben: EXPLIZIT VERBOTEN auf Root-Level
        ".write": false,

        ".validate": "newData.hasChildren(['createdAt'])",

        // ========================================
        // ✅ PROFILE - User darf schreiben
        // ========================================
        "profile": {
          ".read": "auth != null && auth.uid === $userId",
          ".write": "auth != null && auth.uid === $userId",

          "displayName": {
            ".validate": "newData.isString() && newData.val().length >= 2 && newData.val().length <= 30"
          },

          "email": {
            ".validate": "newData.isString() && newData.val().matches(/^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\.[A-Za-z]{2,}$/)"
          },

          "createdAt": {
            ".validate": "newData.isNumber() && newData.val() > 0 && !data.exists()"
          },

          "lastLogin": {
            ".validate": "newData.isNumber() && newData.val() > 0"
          }
        },

        // ========================================
        // ✅ ENTITLEMENTS - NUR SERVER DARF SCHREIBEN
        // ========================================
        "entitlements": {
          ".read": "auth != null && auth.uid === $userId",
          ".write": false,  // ❌ User darf NIE schreiben!

          "fsk18": {
            ".validate": "newData.hasChildren(['active', 'grantedAt', 'method'])",

            "active": {
              ".validate": "newData.isBoolean()"
            },

            "grantedAt": {
              ".validate": "newData.isNumber() && newData.val() > 0"
            },

            "method": {
              ".validate": "newData.isString() && (newData.val() === 'google' || newData.val() === 'purchase' || newData.val() === 'manual')"
            },

            "expiresAt": {
              ".validate": "(newData.isNumber() && newData.val() > newData.parent().child('grantedAt').val()) || newData.val() === null"
            },

            "revokedAt": {
              ".validate": "(newData.isNumber() && newData.val() > 0) || newData.val() === null"
            }
          },

          "premium": {
            ".validate": "newData.hasChildren(['active', 'grantedAt'])",

            "active": {
              ".validate": "newData.isBoolean()"
            },

            "grantedAt": {
              ".validate": "newData.isNumber() && newData.val() > 0"
            },

            "expiresAt": {
              ".validate": "(newData.isNumber() && newData.val() > newData.parent().child('grantedAt').val()) || newData.val() === null"
            }
          }
        },

        // ========================================
        // ✅ PREFERENCES - User darf schreiben
        // ========================================
        "preferences": {
          ".read": "auth != null && auth.uid === $userId",
          ".write": "auth != null && auth.uid === $userId",

          "notifications": {
            ".validate": "newData.isBoolean()"
          },

          "theme": {
            ".validate": "newData.isString() && (newData.val() === 'light' || newData.val() === 'dark' || newData.val() === 'auto')"
          }
        },

        // ========================================
        // ✅ SAVED GAMES - User darf schreiben
        // ========================================
        "saved_games": {
          ".read": "auth != null && auth.uid === $userId",
          ".write": "auth != null && auth.uid === $userId",
          ".indexOn": ["savedAt", "deviceMode"],

          "$gameId": {
            ".validate": "newData.hasChildren(['players', 'timestamp', 'deviceMode']) && newData.child('players').hasChildren() && newData.child('timestamp').isNumber() && newData.child('timestamp').val() > 0 && newData.child('deviceMode').isString() && (newData.child('deviceMode').val() === 'single' || newData.child('deviceMode').val() === 'multi')",

            "savedAt": {
              ".validate": "newData.isNumber() && newData.val() > 0"
            }
          }
        },

        // ========================================
        // ⚠️ DEPRECATED - Für Migration beibehalten
        // ========================================
        "isPremium": {
          ".write": false,
          ".validate": "newData.isBoolean()"
        },

        "ageVerified": {
          ".write": false,
          ".validate": "newData.isBoolean()"
        },

        "ageLevel": {
          ".write": false,
          ".validate": "newData.isNumber() && (newData.val() === 0 || newData.val() === 16 || newData.val() === 18)"
        },

        "pendingDeletion": {
          ".write": false,
          ".validate": "newData.isBoolean()"
        }
      }
    },

    "deletionRequests": {
      ".indexOn": ["status", "scheduledFor", "requestedAt"],

      "$userId": {
        ".read": "auth != null && auth.uid === $userId",
        ".write": "auth != null && auth.uid === $userId",

        ".validate": "newData.hasChildren(['requestedAt', 'scheduledFor', 'status'])",

        "requestedAt": {
          ".validate": "newData.isNumber() && newData.val() > 0"
        },

        "scheduledFor": {
          ".validate": "newData.isNumber() && newData.val() > newData.parent().child('requestedAt').val()"
        },

        "gracePeriodHours": {
          ".validate": "newData.isNumber() && newData.val() > 0 && newData.val() <= 720"
        },

        "status": {
          ".validate": "newData.isString() && (newData.val() === 'pending' || newData.val() === 'cancelled' || newData.val() === 'completed' || newData.val() === 'scheduled')"
        },

        "completedAt": {
          ".validate": "(newData.isNumber() && newData.val() > 0) || newData.val() === null"
        },

        "cancelledAt": {
          ".validate": "(newData.isNumber() && newData.val() > 0) || newData.val() === null"
        }
      }
    },

    "analytics": {
      ".read": false,
      ".write": false,

      "games": {
        ".indexOn": ["timestamp", "status"],

        "$analyticsId": {
          ".validate": "newData.hasChildren(['timestamp', 'gameId']) && newData.child('timestamp').isNumber() && newData.child('timestamp').val() > 0 && newData.child('gameId').isString()"
        }
      }
    },

    "sessions": {
      "$sessionId": {
        ".read": "auth != null && data.child('userId').val() === auth.uid",
        ".write": "auth != null && newData.child('userId').val() === auth.uid",

        ".validate": "newData.hasChildren(['userId', 'createdAt']) && newData.child('userId').isString() && newData.child('createdAt').isNumber() && newData.child('createdAt').val() > 0",

        "lastActivity": {
          ".validate": "newData.isNumber() && newData.val() > 0"
        },

        "expiresAt": {
          ".validate": "newData.isNumber() && newData.val() > newData.parent().child('createdAt').val()"
        }
      }
    }
  }
}