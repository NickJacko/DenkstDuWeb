{
  "rules": {
    ".read": false,
    ".write": false,

    "games": {
      "$gameId": {
        ".validate": "newData.hasChildren(['gameId', 'hostId', 'gameState', 'createdAt'])",

        ".read": "auth != null && (
        data.child('hostId').val() === auth.uid ||
        data.child('players').child(auth.uid).exists()
        )",

        ".write": "auth != null && (
        !data.exists() ||
        data.child('hostId').val() === auth.uid
        )",

        "gameId": {
          ".validate": "newData.isString() && newData.val().length === 6 && newData.val().matches(/^[A-Z0-9]{6}$/)"
        },

        "hostId": {
          ".validate": "newData.isString() && newData.val().length > 0"
        },

        "gameState": {
          ".validate": "newData.isString() && (
          newData.val() === 'lobby' ||
          newData.val() === 'playing' ||
          newData.val() === 'finished'
          )"
        },

        "categories": {
          ".validate": "newData.hasChildren() && newData.val().length <= 4",
          "$category": {
            ".validate": "newData.isString() && (
            newData.val() === 'fsk0' ||
            newData.val() === 'fsk16' ||
            newData.val() === 'fsk18' ||
            newData.val() === 'special'
            )"
          }
        },

        "difficulty": {
          ".validate": "newData.isString() && (
          newData.val() === 'easy' ||
          newData.val() === 'medium' ||
          newData.val() === 'hard'
          )"
        },

        "alcoholMode": {
          ".validate": "newData.isBoolean()"
        },

        "maxPlayers": {
          ".validate": "newData.isNumber() && newData.val() >= 2 && newData.val() <= 8"
        },

        "currentRound": {
          ".validate": "newData.isNumber() && newData.val() >= 0"
        },

        "createdAt": {
          ".validate": "newData.isNumber() || newData.val() === now"
        },

        "lastUpdate": {
          ".validate": "newData.isNumber() || newData.val() === now"
        },

        "startedAt": {
          ".validate": "newData.isNumber() || newData.val() === now"
        },

        "settings": {
          ".write": "auth != null && root.child('games').child($gameId).child('hostId').val() === auth.uid",

          "questionsPerGame": {
            ".validate": "newData.isNumber() && newData.val() >= 5 && newData.val() <= 50"
          },

          "timePerQuestion": {
            ".validate": "newData.isNumber() && newData.val() >= 10 && newData.val() <= 120"
          },

          "showResults": {
            ".validate": "newData.isBoolean()"
          },

          "allowSpectators": {
            ".validate": "newData.isBoolean()"
          }
        },

        "players": {
          ".validate": "newData.hasChildren()",

          "$playerId": {
            ".validate": "newData.hasChildren(['id', 'name', 'isHost', 'isReady', 'isOnline', 'joinedAt'])",

            ".write": "auth != null && (
            $playerId === auth.uid ||
            root.child('games').child($gameId).child('hostId').val() === auth.uid
            )",

            "id": {
              ".validate": "newData.isString() && newData.val() === $playerId"
            },

            "name": {
              ".validate": "newData.isString() && newData.val().length >= 2 && newData.val().length <= 20"
            },

            "isHost": {
              ".validate": "newData.isBoolean()"
            },

            "isReady": {
              ".validate": "newData.isBoolean()"
            },

            "isOnline": {
              ".validate": "newData.isBoolean()"
            },

            "joinedAt": {
              ".validate": "newData.isNumber() || newData.val() === now"
            },

            "lastSeen": {
              ".validate": "newData.isNumber() || newData.val() === now"
            },

            "rejoined": {
              ".validate": "newData.isBoolean()"
            },

            "rejoinedAt": {
              ".validate": "newData.isNumber() || newData.val() === now"
            },

            "reconnectedAt": {
              ".validate": "newData.isNumber() || newData.val() === now"
            },

            "score": {
              ".validate": "newData.isNumber() && newData.val() >= 0"
            },

            "correctGuesses": {
              ".validate": "newData.isNumber() && newData.val() >= 0"
            }
          }
        },

        "currentQuestion": {
          ".write": "auth != null && root.child('games').child($gameId).child('hostId').val() === auth.uid",

          "id": {
            ".validate": "newData.isString()"
          },

          "text": {
            ".validate": "newData.isString() && newData.val().length >= 10 && newData.val().length <= 500"
          },

          "category": {
            ".validate": "newData.isString()"
          },

          "round": {
            ".validate": "newData.isNumber() && newData.val() >= 1"
          }
        },

        "responses": {
          "$playerId": {
            ".validate": "newData.hasChildren(['playerId', 'answer', 'timestamp'])",

            ".write": "auth != null && $playerId === auth.uid",

            "playerId": {
              ".validate": "newData.isString() && newData.val() === $playerId"
            },

            "answer": {
              ".validate": "newData.isBoolean()"
            },

            "timestamp": {
              ".validate": "newData.isNumber() || newData.val() === now"
            }
          }
        },

        "estimates": {
          "$playerId": {
            ".validate": "newData.hasChildren(['playerId', 'estimate', 'timestamp'])",

            ".write": "auth != null && $playerId === auth.uid",

            "playerId": {
              ".validate": "newData.isString() && newData.val() === $playerId"
            },

            "estimate": {
              ".validate": "newData.isNumber() && newData.val() >= 0 && newData.val() <= 8"
            },

            "timestamp": {
              ".validate": "newData.isNumber() || newData.val() === now"
            }
          }
        },

        "roundResults": {
          ".write": "auth != null && root.child('games').child($gameId).child('hostId').val() === auth.uid",

          "$round": {
            "correctAnswer": {
              ".validate": "newData.isNumber() && newData.val() >= 0"
            },

            "results": {
              "$playerId": {
                "estimate": {
                  ".validate": "newData.isNumber() && newData.val() >= 0"
                },

                "difference": {
                  ".validate": "newData.isNumber() && newData.val() >= 0"
                },

                "sips": {
                  ".validate": "newData.isNumber() && newData.val() >= 0"
                },

                "correct": {
                  ".validate": "newData.isBoolean()"
                }
              }
            },

            "timestamp": {
              ".validate": "newData.isNumber() || newData.val() === now"
            }
          }
        },

        "scores": {
          ".write": "auth != null && root.child('games').child($gameId).child('hostId').val() === auth.uid",

          "$playerId": {
            "totalSips": {
              ".validate": "newData.isNumber() && newData.val() >= 0"
            },

            "correctGuesses": {
              ".validate": "newData.isNumber() && newData.val() >= 0"
            },

            "roundsPlayed": {
              ".validate": "newData.isNumber() && newData.val() >= 0"
            }
          }
        },

        "phase": {
          ".write": "auth != null && root.child('games').child($gameId).child('hostId').val() === auth.uid",

          ".validate": "newData.isString() && (
          newData.val() === 'waiting' ||
          newData.val() === 'question' ||
          newData.val() === 'answering' ||
          newData.val() === 'estimating' ||
          newData.val() === 'results' ||
          newData.val() === 'finished'
          )"
        },

        "status": {
          ".write": "auth != null && root.child('games').child($gameId).child('hostId').val() === auth.uid",

          ".validate": "newData.isString()"
        },

        "$other": {
          ".validate": false
        }
      }
    },

    "users": {
      "$uid": {
        ".read": "auth != null && auth.uid === $uid",
        ".write": "auth != null && auth.uid === $uid",

        "email": {
          ".validate": "newData.isString() && newData.val().matches(/^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\.[A-Za-z]{2,}$/)"
        },

        "isAnonymous": {
          ".validate": "newData.isBoolean()"
        },

        "createdAt": {
          ".validate": "newData.isString()"
        },

        "lastSignIn": {
          ".validate": "newData.isString()"
        },

        "ageVerified": {
          ".validate": "newData.isBoolean()"
        },

        "ageVerificationLevel": {
          ".validate": "newData.isNumber() && (
          newData.val() === 0 ||
          newData.val() === 16 ||
          newData.val() === 18
          )"
        },

        "lastUpdate": {
          ".validate": "newData.isNumber() || newData.val() === now"
        },

        "premiumStatus": {
          ".read": "auth != null && auth.uid === $uid",
          ".write": false,
          ".validate": "newData.isBoolean()"
        },

        "$other": {
          ".validate": false
        }
      }
    },

    "premiumUsers": {
      "$uid": {
        ".read": "auth != null && auth.uid === $uid",
        ".write": false,

        "activatedAt": {
          ".validate": "newData.isNumber() || newData.val() === now"
        },

        "expiresAt": {
          ".validate": "newData.isNumber()"
        },

        "plan": {
          ".validate": "newData.isString() && (
          newData.val() === 'monthly' ||
          newData.val() === 'yearly'
          )"
        }
      }
    },

    "questions": {
      ".read": false,
      ".write": false,

      "fsk0": {
        ".read": "auth != null",

        "$questionId": {
          ".validate": "data.hasChildren(['id', 'text', 'category'])",

          "id": {
            ".validate": "data.isString()"
          },

          "text": {
            ".validate": "data.isString() && data.val().length >= 10 && data.val().length <= 500"
          },

          "category": {
            ".validate": "data.isString() && data.val() === 'fsk0'"
          }
        }
      },

      "fsk16": {
        ".read": "auth != null && root.child('users').child(auth.uid).child('ageVerificationLevel').val() >= 16",

        "$questionId": {
          ".validate": "data.hasChildren(['id', 'text', 'category'])",

          "category": {
            ".validate": "data.isString() && data.val() === 'fsk16'"
          }
        }
      },

      "fsk18": {
        ".read": "auth != null && root.child('users').child(auth.uid).child('ageVerificationLevel').val() >= 18",

        "$questionId": {
          ".validate": "data.hasChildren(['id', 'text', 'category'])",

          "category": {
            ".validate": "data.isString() && data.val() === 'fsk18'"
          }
        }
      },

      "special": {
        ".read": "auth != null && root.child('premiumUsers').child(auth.uid).exists()",

        "$questionId": {
          ".validate": "data.hasChildren(['id', 'text', 'category'])",

          "category": {
            ".validate": "data.isString() && data.val() === 'special'"
          },

          "isPremium": {
            ".validate": "data.isBoolean() && data.val() === true"
          }
        }
      }
    },

    "analytics": {
      ".read": false,
      ".write": false,

      "gameCreated": {
        ".write": "auth != null",

        "$timestamp": {
          "gameId": {
            ".validate": "newData.isString() && newData.val().length === 6"
          },

          "hostId": {
            ".validate": "newData.isString()"
          },

          "difficulty": {
            ".validate": "newData.isString()"
          },

          "categories": {
            ".validate": "newData.hasChildren()"
          },

          "timestamp": {
            ".validate": "newData.isNumber() || newData.val() === now"
          }
        }
      }
    },

    "$other": {
      ".validate": false
    }
  }
}