{
  "rules": {
    // ===================================
    // ðŸ“š QUESTIONS COLLECTION
    // âœ… P0 SECURITY: Read-only access for authenticated users
    // âœ… P2 PERFORMANCE: Indexed for category and difficulty queries
    // ===================================
    "questions": {
      ".read": "auth != null",
      ".write": false,

      "fsk0": {
        ".read": "auth != null",
        ".write": false,
        ".indexOn": ["category", "difficulty", "type"]
      },
      "fsk16": {
        ".read": "auth != null",
        ".write": false,
        ".indexOn": ["category", "difficulty", "type"]
      },
      "fsk18": {
        ".read": "auth != null",
        ".write": false,
        ".indexOn": ["category", "difficulty", "type"]
      },
      "special": {
        ".read": "auth != null",
        ".write": false,
        ".indexOn": ["category", "difficulty", "type"]
      }
    },

    // ===================================
    // ðŸŽ® GAMES COLLECTION
    // âœ… P0 SECURITY: Host-only write access for game settings
    // âœ… P2 PERFORMANCE: Indexed for queries
    // ===================================
    "games": {
      ".read": "auth != null",
      ".indexOn": ["createdAt", "status", "hostId"],

      "$gameId": {
        ".read": "auth != null",
        ".write": "!data.exists() && auth != null",

        // ===================================
        // HOST-ONLY FIELDS
        // ===================================
        "hostId": {
          ".write": "!data.exists() && auth != null"
        },
        "status": {
          ".write": "data.parent().child('hostId').val() === auth.uid"
        },
        "settings": {
          ".write": "data.parent().child('hostId').val() === auth.uid"
        },
        "currentQuestion": {
          ".write": "data.parent().child('hostId').val() === auth.uid"
        },
        "roundNumber": {
          ".write": "data.parent().child('hostId').val() === auth.uid"
        },

        // ===================================
        // PLAYERS COLLECTION
        // âœ… P0 SECURITY: Players can only write their own data
        // âœ… P2 PERFORMANCE: Indexed for online status queries
        // ===================================
        "players": {
          ".indexOn": ["isOnline", "joinedAt", "score"],

          "$playerId": {
            ".read": "auth != null",
            ".write": "(
              // Allow creation if doesn't exist
              !data.exists() && auth != null
            ) || (
              // Allow update only by player themselves
              auth.uid === $playerId
            ) || (
              // Allow host to kick players
              data.parent().parent().child('hostId').val() === auth.uid && !newData.exists()
            )",

            // ===================================
            // PLAYER-SPECIFIC FIELDS
            // ===================================
            "answer": {
              ".write": "auth.uid === $playerId"
            },
            "guess": {
              ".write": "auth.uid === $playerId"
            },
            "isReady": {
              ".write": "auth.uid === $playerId"
            },
            "isOnline": {
              ".write": "auth.uid === $playerId"
            },
            "lastSeen": {
              ".write": "auth.uid === $playerId"
            },
            "score": {
              ".write": "auth.uid === $playerId || data.parent().parent().parent().child('hostId').val() === auth.uid"
            }
          }
        },

        // ===================================
        // ANSWERS COLLECTION (read-only after submission)
        // ===================================
        "answers": {
          ".indexOn": ["submittedAt"],

          "$playerId": {
            ".read": "auth != null",
            ".write": "!data.exists() && auth.uid === $playerId"
          }
        },

        // ===================================
        // RESULTS (Host-only write)
        // ===================================
        "results": {
          ".read": "auth != null",
          ".write": "data.parent().child('hostId').val() === auth.uid"
        }
      }
    },

    // ===================================
    // ðŸ‘¤ USER METADATA
    // âœ… P0 SECURITY: Users can only read/write their own data
    // âœ… P1 STABILITY: Cached premium & age verification
    // ===================================
    "users": {
      "$uid": {
        ".read": "auth != null && auth.uid === $uid",
        ".write": "auth != null && auth.uid === $uid",

        "profile": {
          ".validate": "newData.hasChildren(['displayName'])"
        },

        "meta": {
          "isPremium": {
            ".write": false
          },
          "ageLevel": {
            ".write": "auth != null && auth.uid === $uid"
          },
          "lastRefresh": {
            ".write": "auth != null && auth.uid === $uid"
          }
        }
      }
    },

    // ===================================
    // ðŸ“Š STATISTICS (Optional)
    // âœ… P2 PERFORMANCE: Indexed for leaderboards
    // ===================================
    "statistics": {
      ".indexOn": ["score", "gamesPlayed", "wins"],

      "$uid": {
        ".read": true,
        ".write": "auth != null && auth.uid === $uid"
      }
    }
  }
}

