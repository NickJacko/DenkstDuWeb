{
  "rules": {
    ".read": false,
    ".write": false,

    "games": {
      "$gameId": {
        ".validate": "newData.hasChildren(['gameId', 'hostId', 'gameState', 'createdAt'])",

        ".read": "auth != null && (
          root.child('games/' + $gameId + '/players/' + auth.uid).exists() ||
          root.child('games/' + $gameId + '/hostId').val() == auth.uid
        )",

        ".write": "auth != null && (
          !data.exists() ||
          data.child('hostId').val() == auth.uid ||
          data.child('players').hasChild(auth.uid)
        )",

        "gameId": {
          ".validate": "newData.isString() && newData.val().length === 6 && newData.val().matches(/^[A-Z0-9]{6}$/)"
        },

        "hostId": {
          ".validate": "newData.isString() && newData.val() == auth.uid"
        },

        "gameState": {
          ".validate": "newData.isString() && (
            newData.val() == 'waiting' ||
            newData.val() == 'playing' ||
            newData.val() == 'finished'
          )"
        },

        "players": {
          "$playerId": {
            ".read": "auth != null",
            ".write": "auth != null && (
              auth.uid == $playerId ||
              root.child('games/' + $gameId + '/hostId').val() == auth.uid
            )",
            ".validate": "newData.hasChildren(['name', 'isReady'])"
          }
        },

        "settings": {
          ".write": "auth != null && root.child('games/' + $gameId + '/hostId').val() == auth.uid",
          ".validate": "newData.hasChildren(['categories', 'difficulty', 'mode'])",

          "difficulty": {
            ".validate": "newData.isString() && (newData.val() == 'easy' || newData.val() == 'medium' || newData.val() == 'hard')"
          },

          "alcoholMode": {
            ".validate": "newData.isBoolean() && (newData.val() == false || auth.token.ageLevel >= 18)"
          },

          "categories": {
            ".validate": "newData.isString()"
          },

          "mode": {
            ".validate": "newData.isString()"
          }
        },

        "currentQuestion": {
          ".read": "auth != null && root.child('games/' + $gameId + '/players/' + auth.uid).exists()",
          ".write": "auth != null && root.child('games/' + $gameId + '/hostId').val() == auth.uid"
        },

        "answers": {
          "$playerId": {
            ".write": "auth != null && auth.uid == $playerId",
            ".validate": "newData.hasChildren(['value', 'timestamp'])"
          }
        },

        "scores": {
          ".read": "auth != null",
          ".write": "auth != null && root.child('games/' + $gameId + '/hostId').val() == auth.uid"
        }
      }
    },

    "users": {
      "$userId": {
        ".read": "auth != null && auth.uid == $userId",
        ".write": "auth != null && auth.uid == $userId",

        ".validate": "newData.hasChildren(['displayName'])",

        "displayName": {
          ".validate": "newData.isString() && newData.val().length > 0 && newData.val().length <= 30"
        },

        "ageVerified": {
          ".validate": "newData.isBoolean()"
        },

        "ageVerificationLevel": {
          ".validate": "newData.isNumber() && (newData.val() == 0 || newData.val() == 18)"
        },

        "stats": {
          ".read": "auth != null",
          ".write": "auth != null && auth.uid == $userId"
        }
      }
    },

    "audit_logs": {
      "$userId": {
        ".read": "auth != null && auth.uid == $userId",
        ".write": false
      }
    },

    "leaderboard": {
      ".read": "auth != null",
      ".write": false,
      ".indexOn": ["score", "timestamp"]
    },

    "questions": {
      ".read": "auth != null",
      ".write": false,

      "fsk0": {
        ".read": "auth != null",
        ".indexOn": ["category", "difficulty"]
      },
      "fsk16": {
        ".read": "auth != null && auth.token.ageLevel >= 16",
        ".indexOn": ["category", "difficulty"]
      },
      "fsk18": {
        ".read": "auth != null && auth.token.ageLevel >= 18",
        ".indexOn": ["category", "difficulty"]
      },
      "special": {
        ".read": "auth != null && auth.token.isPremium == true",
        ".indexOn": ["category", "difficulty"]
      }
    }
  }
}

