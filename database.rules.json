{
  "rules": {
    ".read": false,
    ".write": false,

    "games": {
      "$gameId": {
        ".read": "auth != null && (data.child('players').child(auth.uid).exists() || data.child('hostId').val() === auth.uid)",

        ".write": false,

        "hostId": {
          ".validate": "newData.isString() && newData.val().length > 0"
        },

        "gameCode": {
          ".validate": "newData.isString() && newData.val().matches(/^[A-Z0-9]{6}$/)"
        },

        "status": {
          ".write": "auth != null && root.child('games').child($gameId).child('hostId').val() === auth.uid",
          ".validate": "newData.isString() && (newData.val() === 'lobby' || newData.val() === 'playing' || newData.val() === 'results' || newData.val() === 'finished')"
        },

        "phase": {
          ".write": "auth != null && root.child('games').child($gameId).child('hostId').val() === auth.uid",
          ".validate": "newData.isString() && (newData.val() === 'lobby' || newData.val() === 'playing' || newData.val() === 'results' || newData.val() === 'finished' || newData.val() === 'waiting' || newData.val() === 'question')"
        },

        "startedAt": {
          ".write": "auth != null && root.child('games').child($gameId).child('hostId').val() === auth.uid",
          ".validate": "newData.isNumber()"
        },

        "createdAt": {
          ".validate": "newData.isNumber()"
        },

        "lastUpdate": {
          ".write": "auth != null && root.child('games').child($gameId).child('hostId').val() === auth.uid",
          ".validate": "newData.isNumber()"
        },

        "lastActivity": {
          ".write": "auth != null && root.child('games').child($gameId).child('hostId').val() === auth.uid",
          ".validate": "newData.isNumber()"
        },

        "ttl": {
          ".validate": "newData.isNumber()"
        },

        "difficulty": {
          ".validate": "newData.isString() && (newData.val() === 'easy' || newData.val() === 'medium' || newData.val() === 'hard')"
        },

        "alcoholMode": {
          ".validate": "newData.isBoolean()"
        },

        "currentRound": {
          ".write": "auth != null && root.child('games').child($gameId).child('hostId').val() === auth.uid",
          ".validate": "newData.isNumber() && newData.val() >= 1"
        },

        "currentQuestionIndex": {
          ".write": "auth != null && root.child('games').child($gameId).child('hostId').val() === auth.uid",
          ".validate": "newData.isNumber() && newData.val() >= 0"
        },

        "scores": {
          ".write": "auth != null && root.child('games').child($gameId).child('hostId').val() === auth.uid"
        },

        "timerStartTime": {
          ".write": "auth != null && root.child('games').child($gameId).child('hostId').val() === auth.uid",
          ".validate": "newData.isNumber()"
        },

        "timerPaused": {
          ".write": "auth != null && root.child('games').child($gameId).child('hostId').val() === auth.uid",
          ".validate": "newData.isBoolean()"
        },

        "timerRemaining": {
          ".write": "auth != null && root.child('games').child($gameId).child('hostId').val() === auth.uid",
          ".validate": "newData.isNumber() && newData.val() >= 0"
        },

        "settings": {
          ".read": "auth != null && (root.child('games').child($gameId).child('players').child(auth.uid).exists() || root.child('games').child($gameId).child('hostId').val() === auth.uid)",
          ".write": false,

          "categories": {
            ".write": "auth != null && root.child('games').child($gameId).child('hostId').val() === auth.uid",
            ".validate": "(newData.hasChildren(['0']) && newData.child('0').isString()) || (newData.child('fsk0').exists() || newData.child('fsk16').exists() || newData.child('fsk18').exists() || newData.child('special').exists())",
            "$i": {
            ".validate": "newData.isString() && (newData.val() === 'fsk0' || newData.val() === 'fsk16' || newData.val() === 'fsk18' || newData.val() === 'special')"
                  }
                        },

          "difficulty": {
            ".write": "auth != null && root.child('games').child($gameId).child('hostId').val() === auth.uid",
            ".validate": "newData.isString() && (newData.val() === 'easy' || newData.val() === 'medium' || newData.val() === 'hard')"
          },

          "alcoholMode": {
            ".write": "auth != null && root.child('games').child($gameId).child('hostId').val() === auth.uid",
            ".validate": "newData.isBoolean()"
          }
        },

        "players": {
          "$playerId": {
            ".read": "auth != null && (root.child('games').child($gameId).child('players').child(auth.uid).exists() || root.child('games').child($gameId).child('hostId').val() === auth.uid)",

            ".write": "auth != null && ($playerId === auth.uid) && root.child('games').child($gameId).child('players').child(auth.uid).exists()",

            "isReady": {
              ".validate": "newData.isBoolean()"
            },

            "categoryReady": {
              ".validate": "newData.isBoolean()"
            },

            "lastSeen": {
              ".validate": "newData.isNumber()"
            },

            "online": {
              ".validate": "newData.isBoolean()"
            },

            "disconnectedAt": {
              ".validate": "newData.isNumber()"
            },

            "rejoinDeadline": {
              ".validate": "newData.isNumber() || newData.val() === null"
            },

            "updatedAt": {
              ".validate": "newData.isNumber()"
            },

            "name": {
              ".validate": "newData.isString() && newData.val().length >= 2 && newData.val().length <= 20"
            },

            "isHost": {
              ".validate": "newData.isBoolean()"
            },

            "joinedAt": {
              ".validate": "newData.isNumber()"
            }
          }
        },

        "rounds": {
          "$roundId": {
            ".read": "auth != null && (root.child('games').child($gameId).child('players').child(auth.uid).exists() || root.child('games').child($gameId).child('hostId').val() === auth.uid)",

            "question": {
              ".write": "auth != null && root.child('games').child($gameId).child('hostId').val() === auth.uid",
              ".validate": "newData.hasChildren(['text','category']) && newData.child('text').isString() && newData.child('text').val().length > 0 && newData.child('text').val().length <= 300 && newData.child('category').isString()"
            },

            "startedAt": {
              ".write": "auth != null && root.child('games').child($gameId).child('hostId').val() === auth.uid",
              ".validate": "newData.isNumber()"
            },

            "timerDuration": {
              ".write": "auth != null && root.child('games').child($gameId).child('hostId').val() === auth.uid",
              ".validate": "newData.isNumber() && newData.val() >= 5 && newData.val() <= 300"
            },

            "summary": {
              ".write": "auth != null && root.child('games').child($gameId).child('hostId').val() === auth.uid",
              ".validate": "newData.hasChildren(['totalAnswers','yesCount','aggregatedAt']) && newData.child('totalAnswers').isNumber() && newData.child('yesCount').isNumber() && newData.child('aggregatedAt').isNumber()"
            },

            "answers": {
              "$uid": {
                ".write": "auth != null && $uid === auth.uid && root.child('games').child($gameId).child('players').child(auth.uid).exists()",
                ".validate": "newData.hasChildren(['answer','estimation','submittedAt']) && newData.child('answer').isBoolean() && newData.child('estimation').isNumber() && newData.child('estimation').val() >= 0 && newData.child('estimation').val() <= 50 && newData.child('submittedAt').isNumber()"
              }
            }
          }
        }
      }
    },

    "gameCodes": {
      "$code": {
        ".read": "auth != null",
        ".write": false,

        "hostId": {
          ".validate": "newData.isString() && newData.val().length > 0"
        },
        "gameId": {
          ".validate": "newData.isString() && newData.val().length > 0"
        },
        "status": {
          ".validate": "newData.isString()"
        },
        "maxPlayers": {
          ".validate": "newData.isNumber() && newData.val() >= 2 && newData.val() <= 8"
        },
        "categories": {
          ".validate": "newData.hasChildren()"
        },
        "difficulty": {
          ".validate": "newData.isString() && (newData.val() === 'easy' || newData.val() === 'medium' || newData.val() === 'hard')"
        },
        "createdAt": {
          ".validate": "newData.isNumber()"
        }
      }
    },

    "questions": {
      ".read": "auth != null",
      ".write": false,
      "$category": {
        ".validate": "$category === 'fsk0' || $category === 'fsk16' || $category === 'fsk18' || $category === 'special'"
      }
    },


    "users": {
      "$userId": {
        ".read": "auth != null && auth.uid === $userId",
        ".write": "auth != null && auth.uid === $userId",

        "isPremium": {
          ".validate": "newData.isBoolean()"
        },
        "ageVerified": {
          ".validate": "newData.isBoolean()"
        },
        "ageLevel": {
          ".validate": "newData.isNumber() && (newData.val() === 0 || newData.val() === 16 || newData.val() === 18)"
        },
        "createdAt": {
          ".validate": "newData.isNumber()"
        },
        "lastLogin": {
          ".validate": "newData.isNumber()"
        },

        "saved_games": {
          ".indexOn": ["savedAt"],
          "$gameId": {
            ".validate": "newData.hasChildren(['players', 'timestamp', 'deviceMode'])"
          }
        }
      }
    },


    "deletionRequests": {
      "$userId": {
        ".read": "auth != null && auth.uid === $userId",
        ".write": "auth != null && auth.uid === $userId",

        "requestedAt": {
          ".validate": "newData.isNumber()"
        },
        "scheduledFor": {
          ".validate": "newData.isNumber()"
        },
        "gracePeriodHours": {
          ".validate": "newData.isNumber() && newData.val() > 0"
        },
        "status": {
          ".validate": "newData.isString() && (newData.val() === 'pending' || newData.val() === 'cancelled' || newData.val() === 'completed')"
        }
      }
    }
  }
}
