<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>No-Cap - Multiplayer Gameplay</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800&display=swap" rel="stylesheet">

    <!-- Favicon - Kappe Emoji -->
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üß¢</text></svg>">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-x: hidden;
            touch-action: manipulation;
            position: relative;
        }

        /* Background Particles */
        .background-particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: -1;
        }

        .particle {
            position: absolute;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 50%;
            animation: float 15s ease-in-out infinite;
        }

        .particle:nth-child(1) { width: 100px; height: 100px; left: 10%; animation-delay: 0s; }
        .particle:nth-child(2) { width: 60px; height: 60px; left: 80%; animation-delay: 3s; }
        .particle:nth-child(3) { width: 80px; height: 80px; left: 30%; animation-delay: 6s; }
        .particle:nth-child(4) { width: 120px; height: 120px; left: 70%; animation-delay: 9s; }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); opacity: 0.3; }
            25% { transform: translateY(-30px) rotate(90deg); opacity: 0.6; }
            50% { transform: translateY(-60px) rotate(180deg); opacity: 0.3; }
            75% { transform: translateY(-30px) rotate(270deg); opacity: 0.6; }
        }

        /* KOMPLETT DYNAMISCHES LAYOUT - Alles passt auf eine Seite */
        .app-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 15px;
            max-width: 450px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
            padding-top: 60px;
        }

        /* Small Game Info Top */
        .game-info-top {
            position: fixed;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 10px;
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.85rem;
            font-weight: 600;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
        }

        .info-text {
            color: white;
        }

        .info-separator {
            color: rgba(255, 255, 255, 0.5);
        }

        /* Game Phases */
        .game-phase {
            display: none;
            flex: 1;
            overflow-y: auto;
            padding-bottom: 20px;
        }

        .game-phase.active {
            display: flex;
            flex-direction: column;
        }

        /* Question Card - KOMPAKTER */
        .question-card {
            background: rgba(255, 255, 255, 0.12);
            backdrop-filter: blur(30px);
            border-radius: 25px;
            border: 1px solid rgba(255, 255, 255, 0.25);
            padding: 25px 20px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.15);
            position: relative;
            overflow: hidden;
        }

        .question-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, #4CAF50, #2196F3, #9C27B0);
            background-size: 200% 100%;
            animation: shimmer 3s ease-in-out infinite;
        }

        @keyframes shimmer {
            0%, 100% { background-position: 200% 0; }
            50% { background-position: -200% 0; }
        }

        .question-category {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.25), rgba(76, 175, 80, 0.35));
            border: 1px solid rgba(76, 175, 80, 0.5);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 700;
            display: inline-block;
            margin-bottom: 15px;
            backdrop-filter: blur(10px);
        }

        .question-text {
            color: white;
            font-size: 1.15rem;
            font-weight: 700;
            line-height: 1.4;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        /* Answer Section - KOMPAKTER */
        .answer-section {
            margin-bottom: 20px;
        }

        .answer-title {
            color: white;
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 15px;
            text-align: center;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .answer-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .answer-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.25);
            color: white;
            padding: 20px 15px;
            border-radius: 20px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            backdrop-filter: blur(20px);
        }

        .answer-btn:active {
            transform: scale(0.95);
        }

        .answer-btn.selected {
            transform: scale(1.05);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
        }

        .answer-btn.yes.selected {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.3), rgba(76, 175, 80, 0.4));
            border-color: #4CAF50;
            box-shadow: 0 15px 40px rgba(76, 175, 80, 0.3);
        }

        .answer-btn.no.selected {
            background: linear-gradient(135deg, rgba(244, 67, 54, 0.3), rgba(244, 67, 54, 0.4));
            border-color: #f44336;
            box-shadow: 0 15px 40px rgba(244, 67, 54, 0.3);
        }

        .answer-emoji {
            font-size: 1.8rem;
        }

        /* Estimation Section - KOMPAKTER */
        .estimation-section {
            background: rgba(255, 255, 255, 0.12);
            backdrop-filter: blur(30px);
            border-radius: 20px;
            padding: 20px 18px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.25);
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.1);
        }

        .estimation-title {
            color: white;
            font-size: 1.1rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 20px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        /* Number Grid - DYNAMISCH */
        .number-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(50px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
            justify-items: center;
        }

        .number-btn {
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.25);
            color: white;
            border-radius: 50%;
            font-size: 1.1rem;
            font-weight: 800;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            backdrop-filter: blur(20px);
        }

        .number-btn:active {
            transform: scale(0.9);
        }

        .number-btn.selected {
            background: linear-gradient(135deg, #4CAF50, #2196F3);
            border-color: #4CAF50;
            transform: scale(1.1);
            box-shadow: 0 10px 30px rgba(76, 175, 80, 0.4);
            color: white;
        }

        /* Current Selection Display - NUR NACH AUSWAHL */
        .current-selection {
            text-align: center;
            margin-bottom: 20px;
            display: none; /* Initially hidden */
        }

        .current-selection.show {
            display: block;
        }

        .selection-display {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 15px;
            display: inline-block;
            min-width: 180px;
        }

        .selection-number {
            color: white;
            font-size: 2rem;
            font-weight: 800;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            margin-bottom: 5px;
        }

        .selection-label {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.95rem;
            font-weight: 600;
        }

        /* Submit Button */
        .submit-section {
            margin-bottom: 15px;
        }

        .submit-btn {
            width: 100%;
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 18px;
            border-radius: 20px;
            font-size: 1.2rem;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            opacity: 0.4;
            transform: scale(0.95);
            box-shadow: 0 10px 30px rgba(76, 175, 80, 0.2);
        }

        .submit-btn.enabled {
            opacity: 1;
            transform: scale(1);
            box-shadow: 0 15px 40px rgba(76, 175, 80, 0.4);
        }

        .submit-btn.enabled:active {
            transform: scale(0.98);
        }

        /* Waiting Phase */
        .waiting-screen {
            text-align: center;
            padding: 40px 20px;
        }

        .waiting-spinner {
            width: 80px;
            height: 80px;
            border: 6px solid rgba(255, 255, 255, 0.1);
            border-top: 6px solid #4CAF50;
            border-radius: 50%;
            animation: spin 1.5s linear infinite;
            margin: 0 auto 30px;
            box-shadow: 0 0 30px rgba(76, 175, 80, 0.3);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .waiting-title {
            color: white;
            font-size: 1.4rem;
            font-weight: 800;
            margin-bottom: 15px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .waiting-description {
            color: rgba(255, 255, 255, 0.8);
            font-size: 1rem;
            line-height: 1.5;
            font-weight: 500;
            margin-bottom: 25px;
        }

        .players-status {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin: 25px 0;
        }

        .player-status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            color: white;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .player-status-item:last-child {
            border-bottom: none;
        }

        .status-indicator {
            padding: 5px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-done {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
        }

        .status-waiting {
            background: rgba(255, 152, 0, 0.3);
            border: 1px solid #ff9800;
            color: #ff9800;
        }

        /* Results Phase - KOMPAKTER & DYNAMISCH */
        .results-screen {
            padding: 5px 0;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .results-header {
            background: rgba(255, 255, 255, 0.12);
            backdrop-filter: blur(30px);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.25);
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.1);
        }

        .results-title {
            color: white;
            font-size: 1.05rem;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            line-height: 1.3;
        }

        .results-summary {
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.95rem;
            font-weight: 600;
        }

        /* Personal Result Box - KOMPAKTER */
        .personal-result-box {
            background: linear-gradient(135deg, rgba(33, 150, 243, 0.2), rgba(33, 150, 243, 0.3));
            backdrop-filter: blur(30px);
            border: 2px solid rgba(33, 150, 243, 0.5);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.1);
        }

        .personal-result-title {
            color: #2196F3;
            font-size: 1rem;
            font-weight: 800;
            margin-bottom: 12px;
            text-align: center;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .personal-result-content {
            display: grid;
            gap: 8px;
        }

        .personal-result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        .personal-result-item.highlight {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(255, 215, 0, 0.3));
            border: 2px solid rgba(255, 215, 0, 0.5);
        }

        .personal-label {
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.85rem;
            font-weight: 600;
        }

        .personal-value {
            color: white;
            font-size: 0.95rem;
            font-weight: 800;
        }

        .personal-result-item.highlight .personal-value {
            color: #FFD700;
            font-size: 1.1rem;
        }

        /* Results Grid - SMART LAYOUT f√ºr viele Spieler */
        .results-grid {
            display: grid;
            gap: 10px;
            margin-bottom: 15px;
            flex: 1;
            overflow-y: auto;
            max-height: calc(100vh - 450px);
            padding-right: 5px;
        }

        /* Scrollbar styling */
        .results-grid::-webkit-scrollbar {
            width: 6px;
        }

        .results-grid::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .results-grid::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
        }

        .result-item {
            background: rgba(255, 255, 255, 0.12);
            backdrop-filter: blur(30px);
            border-radius: 12px;
            padding: 12px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid rgba(255, 255, 255, 0.25);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        /* NEUE FARBKODIERUNG */
        .result-item.correct-not-me {
            border-color: #4CAF50;
            background: rgba(76, 175, 80, 0.15);
        }

        .result-item.is-me {
            border: 2px solid #2196F3;
            background: rgba(33, 150, 243, 0.15);
        }

        .result-item.wrong {
            border-color: rgba(244, 67, 54, 0.3);
        }

        .player-result {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
            min-width: 0;
        }

        .player-avatar {
            width: 35px;
            height: 35px;
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 800;
            font-size: 0.9rem;
            box-shadow: 0 5px 20px rgba(79, 172, 254, 0.3);
            flex-shrink: 0;
        }

        .player-info {
            color: white;
            flex: 1;
            min-width: 0;
        }

        .player-name {
            font-weight: 700;
            font-size: 0.95rem;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .player-answer {
            font-size: 0.8rem;
            opacity: 0.8;
            font-weight: 500;
        }

        .sips-penalty {
            background: linear-gradient(135deg, rgba(244, 67, 54, 0.3), rgba(244, 67, 54, 0.4));
            border: 1px solid #f44336;
            color: #f44336;
            padding: 8px 14px;
            border-radius: 15px;
            font-weight: 800;
            font-size: 0.9rem;
            box-shadow: 0 5px 15px rgba(244, 67, 54, 0.2);
            flex-shrink: 0;
        }

        .sips-penalty.none {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.3), rgba(76, 175, 80, 0.4));
            border-color: #4CAF50;
            color: #4CAF50;
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.2);
        }

        /* Host Controls - KOMPAKTER */
        .host-controls {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(255, 215, 0, 0.15));
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 12px;
            backdrop-filter: blur(20px);
        }

        .host-title {
            color: #FFD700;
            font-weight: 800;
            font-size: 0.95rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        /* Navigation Buttons */
        .nav-buttons {
            display: grid;
            gap: 10px;
            margin-top: 12px;
        }

        .nav-btn {
            padding: 12px;
            border-radius: 12px;
            font-size: 0.95rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .player-waiting {
            text-align: center;
            margin-top: 15px;
        }

        .waiting-host-text {
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.95rem;
            font-weight: 600;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        /* Overall Results Phase */
        .overall-results-screen {
            padding: 5px 0;
        }

        .overall-header {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(255, 215, 0, 0.3));
            border: 2px solid rgba(255, 215, 0, 0.5);
            backdrop-filter: blur(30px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            text-align: center;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.1);
        }

        .overall-title {
            color: #FFD700;
            font-size: 1.6rem;
            font-weight: 800;
            margin-bottom: 8px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .overall-subtitle {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1rem;
            font-weight: 600;
        }

        .overall-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 15px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.12);
            backdrop-filter: blur(30px);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.25);
        }

        .stat-number {
            color: white;
            font-size: 1.8rem;
            font-weight: 800;
            margin-bottom: 5px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .stat-label {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.85rem;
            font-weight: 600;
        }

        .overall-leaderboard {
            margin-bottom: 15px;
        }

        .leaderboard-title {
            color: white;
            font-size: 1.2rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 12px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .leaderboard-item {
            background: rgba(255, 255, 255, 0.12);
            backdrop-filter: blur(30px);
            border-radius: 12px;
            padding: 12px 15px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 12px;
            border: 1px solid rgba(255, 255, 255, 0.25);
        }

        .leaderboard-item.winner {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(255, 215, 0, 0.3));
            border-color: #FFD700;
        }

        .rank-badge {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 1rem;
            color: white;
        }

        .rank-1 { background: linear-gradient(135deg, #FFD700, #FFA500); }
        .rank-2 { background: linear-gradient(135deg, #C0C0C0, #A0A0A0); }
        .rank-3 { background: linear-gradient(135deg, #CD7F32, #B8860B); }
        .rank-other { background: rgba(255, 255, 255, 0.2); }

        .leaderboard-player-info {
            flex: 1;
        }

        .leaderboard-player-name {
            color: white;
            font-weight: 700;
            font-size: 1rem;
            margin-bottom: 4px;
        }

        .leaderboard-player-stats {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.8rem;
            display: flex;
            gap: 10px;
        }

        .nav-btn.primary {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
        }

        .nav-btn.secondary {
            background: rgba(255, 255, 255, 0.12);
            border: 2px solid rgba(255, 255, 255, 0.25);
            color: white;
            backdrop-filter: blur(20px);
        }

        .nav-btn.danger {
            background: linear-gradient(135deg, #f44336, #d32f2f);
            color: white;
        }

        .nav-btn:active {
            transform: scale(0.98);
        }

        /* Toast Notifications */
        .toast-notification {
            position: fixed;
            top: 70px;
            left: 15px;
            right: 15px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(25px);
            border: 1px solid rgba(255, 255, 255, 0.25);
            border-radius: 15px;
            padding: 15px;
            z-index: 10000;
            opacity: 0;
            transform: translateY(-50px);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            max-width: 450px;
            margin: 0 auto;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
        }

        .toast-notification.show {
            opacity: 1;
            transform: translateY(0);
        }

        .toast-notification.success {
            border-color: rgba(76, 175, 80, 0.5);
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.15), rgba(76, 175, 80, 0.25));
        }

        .toast-notification.warning {
            border-color: rgba(255, 152, 0, 0.5);
            background: linear-gradient(135deg, rgba(255, 152, 0, 0.15), rgba(255, 152, 0, 0.25));
        }

        .toast-notification.error {
            border-color: rgba(244, 67, 54, 0.5);
            background: linear-gradient(135deg, rgba(244, 67, 54, 0.15), rgba(244, 67, 54, 0.25));
        }

        .toast-content {
            display: flex;
            align-items: center;
            gap: 12px;
            color: white;
        }

        .toast-icon {
            font-size: 1.3rem;
        }

        .toast-message {
            font-weight: 600;
            font-size: 0.9rem;
            line-height: 1.3;
        }

        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .loading-screen.show {
            opacity: 1;
            visibility: visible;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        .loading-text {
            color: white;
            font-size: 1.1rem;
            font-weight: 600;
        }

        /* Responsive Design */
        @media (max-width: 480px) {
            .app-container {
                padding: 12px;
                padding-top: 55px;
            }

            .question-text {
                font-size: 1.05rem;
            }

            .number-btn {
                width: 45px;
                height: 45px;
                font-size: 1rem;
            }
        }

        /* Animations */
        .fadeInUp {
            animation: fadeInUp 0.5s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>
<!-- Background Particles -->
<div class="background-particles">
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
</div>

<!-- Loading Screen -->
<div class="loading-screen" id="loading-screen">
    <div class="loading-spinner"></div>
    <div class="loading-text">Lade Spiel...</div>
</div>

<!-- App Container -->
<div class="app-container">
    <!-- Small Game Info (no card) -->
    <div class="game-info-top fadeInUp">
        <span class="info-text">ID: <span id="game-id-display">LOADING</span></span>
        <span class="info-separator">‚Ä¢</span>
        <span class="info-text"><span id="players-count">0 Spieler</span></span>
    </div>

    <!-- PHASE 1: Question & Answer -->
    <div class="game-phase active" id="question-phase">
        <!-- Question Card -->
        <div class="question-card fadeInUp">
            <div class="question-category" id="question-category">
                üéÆ Loading...
            </div>
            <div class="question-text" id="question-text">
                Lade Frage...
            </div>
        </div>

        <!-- Answer Section -->
        <div class="answer-section fadeInUp">
            <div class="answer-title">ü§î Deine Antwort</div>
            <div class="answer-buttons">
                <button class="answer-btn yes" onclick="selectAnswer(true)" id="yes-btn">
                    <div class="answer-emoji">‚úÖ</div>
                    <div>Ja, habe ich</div>
                </button>
                <button class="answer-btn no" onclick="selectAnswer(false)" id="no-btn">
                    <div class="answer-emoji">‚ùå</div>
                    <div>Nein, noch nie</div>
                </button>
            </div>
        </div>

        <!-- Estimation Section -->
        <div class="estimation-section fadeInUp">
            <div class="estimation-title">üéØ Wie viele antworten mit "Ja"?</div>

            <!-- Number Grid -->
            <div class="number-grid" id="number-grid">
                <!-- Numbers will be generated dynamically -->
            </div>

            <!-- Current Selection Display - NUR NACH AUSWAHL -->
            <div class="current-selection" id="current-selection">
                <div class="selection-display">
                    <div class="selection-number" id="selected-number">-</div>
                    <div class="selection-label">von <span id="total-players">0</span> Spielern</div>
                </div>
            </div>
        </div>

        <!-- Submit Button -->
        <div class="submit-section fadeInUp">
            <button class="submit-btn" onclick="submitAnswers()" id="submit-btn">
                üì§ Antworten absenden
            </button>
        </div>
    </div>

    <!-- PHASE 2: Waiting for Others -->
    <div class="game-phase" id="waiting-phase">
        <div class="waiting-screen">
            <div class="waiting-spinner"></div>
            <div class="waiting-title">‚è≥ Warten auf andere Spieler</div>
            <div class="waiting-description">
                Deine Antworten wurden gesendet.<br>
                Warte, bis alle anderen geantwortet haben.
            </div>

            <div class="players-status" id="players-status">
                <!-- Player status will be populated dynamically -->
            </div>
        </div>
    </div>

    <!-- PHASE 3: Round Results -->
    <div class="game-phase" id="results-phase">
        <div class="results-screen">
            <div class="results-header fadeInUp">
                <div class="results-title" id="results-question-text">Lade Frage...</div>
                <div class="results-summary" id="results-summary">
                    Berechne Ergebnisse...
                </div>
            </div>

            <!-- Personal Result Box -->
            <div class="personal-result-box fadeInUp" id="personal-result" style="display: none;">
                <div class="personal-result-title">üéØ Dein Ergebnis</div>
                <div class="personal-result-content">
                    <div class="personal-result-item">
                        <span class="personal-label">Deine Sch√§tzung:</span>
                        <span class="personal-value" id="personal-estimation">-</span>
                    </div>
                    <div class="personal-result-item">
                        <span class="personal-label">Status:</span>
                        <span class="personal-value" id="personal-status">-</span>
                    </div>
                    <div class="personal-result-item highlight">
                        <span class="personal-label">Trinken:</span>
                        <span class="personal-value" id="personal-sips">-</span>
                    </div>
                </div>
            </div>

            <div class="results-grid fadeInUp" id="results-grid">
                <!-- Results will be populated dynamically -->
            </div>

            <!-- Host Controls -->
            <div class="host-controls fadeInUp" id="host-controls" style="display: none;">
                <div class="host-title">
                    üëë Host-Kontrollen
                </div>
                <div class="nav-buttons">
                    <button class="nav-btn primary" onclick="nextQuestion()">
                        ‚û°Ô∏è N√§chste Frage
                    </button>
                    <button class="nav-btn secondary" onclick="showOverallResults()">
                        üìä Gesamtergebnisse
                    </button>
                </div>
            </div>

            <!-- Player Controls -->
            <div class="player-waiting fadeInUp" id="player-controls">
                <p class="waiting-host-text">‚è≥ Warten auf Host...</p>
            </div>
        </div>
    </div>

    <!-- PHASE 4: Overall Results -->
    <div class="game-phase" id="overall-results-phase">
        <div class="overall-results-screen">
            <div class="overall-header fadeInUp">
                <div class="overall-title">üèÜ Gesamtergebnisse</div>
                <div class="overall-subtitle">Alle Runden abgeschlossen</div>
            </div>

            <div class="overall-stats fadeInUp">
                <div class="stat-card">
                    <div class="stat-number" id="total-rounds">0</div>
                    <div class="stat-label">Runden gespielt</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="total-players-overall">0</div>
                    <div class="stat-label">Spieler</div>
                </div>
            </div>

            <div class="overall-leaderboard fadeInUp">
                <div class="leaderboard-title">üèÖ Bestenliste</div>
                <div id="overall-leaderboard-list">
                    <!-- Leaderboard populated by JS -->
                </div>
            </div>

            <!-- Host Controls -->
            <div class="host-controls fadeInUp" id="overall-host-controls" style="display: none;">
                <div class="host-title">üëë Host-Kontrollen</div>
                <div class="nav-buttons">
                    <button class="nav-btn primary" onclick="continueGame()">
                        ‚ñ∂Ô∏è Spiel fortfahren
                    </button>
                    <button class="nav-btn danger" onclick="endGameForAll()">
                        üõë Spiel beenden
                    </button>
                </div>
            </div>

            <!-- Player Waiting -->
            <div class="player-waiting fadeInUp" id="overall-player-controls">
                <p class="waiting-host-text">‚è≥ Warten auf Host...</p>
            </div>
        </div>
    </div>
</div>

<script>
    class GameState {
        constructor() {
            this.deviceMode = null;
            this.selectedCategories = [];
            this.difficulty = null;
            this.playerName = '';
            this.gameId = null;
            this.playerId = null;
            this.isHost = false;
            this.isGuest = false;
            this.gamePhase = 'playing';
            this.timestamp = Date.now();
            this.alcoholMode = true; // Default: Mit Alkohol (18+)
            this.load();
        }

        load() {
            try {
                const saved = localStorage.getItem('nocap_game_state');
                if (saved) {
                    const state = JSON.parse(saved);
                    if (state.timestamp && Date.now() - state.timestamp < 24 * 60 * 60 * 1000) {
                        Object.assign(this, state);
                        this.log('‚úÖ State loaded');
                    }
                }

                // Load alcohol mode from age verification
                const ageVerification = localStorage.getItem('nocap_age_verification');
                if (ageVerification) {
                    const ageData = JSON.parse(ageVerification);
                    this.alcoholMode = ageData.isAdult || false;
                    this.log(`üç∫ Alcohol mode: ${this.alcoholMode ? 'Bier' : 'Wasser'}`);
                }
            } catch (error) {
                this.log(`‚ùå Load failed: ${error.message}`, 'error');
            }
        }

        save() {
            try {
                const state = {
                    deviceMode: this.deviceMode,
                    selectedCategories: this.selectedCategories,
                    difficulty: this.difficulty,
                    playerName: this.playerName,
                    gameId: this.gameId,
                    playerId: this.playerId,
                    isHost: this.isHost,
                    isGuest: this.isGuest,
                    gamePhase: this.gamePhase,
                    alcoholMode: this.alcoholMode,
                    timestamp: Date.now(),
                    version: 3
                };
                localStorage.setItem('nocap_game_state', JSON.stringify(state));
                this.log('‚úÖ State saved');
                return true;
            } catch (error) {
                this.log(`‚ùå Save failed: ${error.message}`, 'error');
                return false;
            }
        }

        log(message, type = 'info') {
            console.log(`[GameState] ${message}`);
        }
    }

    // ===== FIREBASE SERVICE CLASS =====
    class FirebaseGameService {
        constructor() {
            this.app = null;
            this.auth = null;
            this.database = null;
            this.isInitialized = false;
            this.isConnected = false;
            this.listeners = [];

            this.config = {
                apiKey: "AIzaSyC_cu_2X2uFCPcxYetxIUHi2v56F1Mz0Vk",
                authDomain: "denkstduwebsite.firebaseapp.com",
                databaseURL: "https://denkstduwebsite-default-rtdb.europe-west1.firebasedatabase.app",
                projectId: "denkstduwebsite",
                storageBucket: "denkstduwebsite.appspot.com",
                messagingSenderId: "27029260611",
                appId: "1:27029260611:web:3c7da4db0bf92e8ce247f6",
                measurementId: "G-BNKNW95HK8"
            };
        }

        async initialize() {
            try {
                this.log('üî• Firebase Service - Initialisierung...');

                if (typeof firebase === 'undefined') {
                    throw new Error('Firebase SDK nicht geladen');
                }

                if (!firebase.apps || firebase.apps.length === 0) {
                    this.app = firebase.initializeApp(this.config);
                } else {
                    this.app = firebase.app();
                }

                // Anonymous Auth
                this.log('üîê Starte anonyme Authentifizierung...');
                this.auth = firebase.auth();

                try {
                    await this.auth.signInAnonymously();
                    this.log('‚úÖ Anonym angemeldet');
                } catch (authError) {
                    this.log(`‚ùå Auth Fehler: ${authError.message}`, 'error');
                    throw authError;
                }

                this.database = firebase.database();

                // Verbindungspr√ºfung
                this.log('üîó Warte auf Datenbankverbindung...');
                let connected = false;
                let attempts = 0;

                while (!connected && attempts < 10) {
                    await new Promise(resolve => setTimeout(resolve, 500));

                    try {
                        const connectedRef = this.database.ref('.info/connected');
                        const snapshot = await connectedRef.once('value');
                        connected = snapshot.val() === true;

                        if (connected) {
                            this.log('‚úÖ Datenbankverbindung hergestellt!');
                        } else {
                            attempts++;
                            this.log(`üîÑ Verbindungsversuch ${attempts}/10...`);
                        }
                    } catch (error) {
                        attempts++;
                    }
                }

                this.isConnected = connected;
                this.isInitialized = connected;

                if (this.isConnected) {
                    this.log('‚úÖ Firebase vollst√§ndig verbunden!');
                } else {
                    this.log('‚ùå Firebase Verbindung fehlgeschlagen');
                }

                return this.isInitialized;

            } catch (error) {
                this.log(`‚ùå Firebase Fehler: ${error.message}`, 'error');
                this.isInitialized = false;
                this.isConnected = false;
                return false;
            }
        }

        async getGameData(gameId) {
            if (!this.isConnected || !gameId) return null;

            try {
                const gameRef = this.database.ref(`games/${gameId}`);
                const snapshot = await gameRef.once('value');
                return snapshot.exists() ? snapshot.val() : null;
            } catch (error) {
                this.log(`‚ùå Fehler beim Laden: ${error.message}`, 'error');
                return null;
            }
        }

        listenToGame(gameId, callback) {
            if (!this.isConnected || !gameId) return null;

            try {
                const gameRef = this.database.ref(`games/${gameId}`);
                gameRef.on('value', callback);
                this.listeners.push({ ref: gameRef, type: 'game' });
                return gameRef;
            } catch (error) {
                this.log(`‚ùå Fehler beim Game Listener: ${error.message}`, 'error');
                return null;
            }
        }

        listenToRound(gameId, roundNumber, callback) {
            if (!this.isConnected || !gameId) return null;

            try {
                const roundRef = this.database.ref(`games/${gameId}/rounds/round_${roundNumber}`);
                roundRef.on('value', callback);
                this.listeners.push({ ref: roundRef, type: 'round' });
                return roundRef;
            } catch (error) {
                this.log(`‚ùå Fehler beim Round Listener: ${error.message}`, 'error');
                return null;
            }
        }

        async startNewRound(gameId, roundNumber, question) {
            if (!this.isConnected) return false;

            try {
                const roundRef = this.database.ref(`games/${gameId}/rounds/round_${roundNumber}`);
                await roundRef.set({
                    question: question,
                    answers: {},
                    startedAt: firebase.database.ServerValue.TIMESTAMP
                });

                const gameRef = this.database.ref(`games/${gameId}`);
                await gameRef.update({
                    currentRound: roundNumber,
                    lastUpdate: firebase.database.ServerValue.TIMESTAMP
                });

                this.log(`‚úÖ Round ${roundNumber} started`);
                return true;
            } catch (error) {
                this.log(`‚ùå Fehler beim Starten der Runde: ${error.message}`, 'error');
                return false;
            }
        }

        async submitAnswer(gameId, roundNumber, playerId, answerData) {
            if (!this.isConnected) throw new Error('Keine Firebase-Verbindung');

            try {
                const answerRef = this.database.ref(`games/${gameId}/rounds/round_${roundNumber}/answers/${playerId}`);
                await answerRef.set({
                    ...answerData,
                    submittedAt: firebase.database.ServerValue.TIMESTAMP
                });

                this.log(`‚úÖ Answer submitted for round ${roundNumber}`);
                return true;
            } catch (error) {
                this.log(`‚ùå Fehler beim Absenden: ${error.message}`, 'error');
                throw error;
            }
        }

        cleanup() {
            this.log('üßπ Cleanup...');

            this.listeners.forEach(({ ref }) => {
                try {
                    ref.off();
                } catch (error) {
                    this.log(`‚ùå Fehler beim Entfernen: ${error.message}`, 'error');
                }
            });

            this.listeners = [];
            this.log('‚úÖ Cleanup abgeschlossen');
        }

        get isReady() {
            return this.isInitialized && this.isConnected;
        }

        log(message, type = 'info') {
            const colors = {
                info: '#4488ff',
                warning: '#ffaa00',
                error: '#ff4444',
                success: '#00ff00'
            };
            console.log(`%c[Firebase] ${message}`, `color: ${colors[type] || colors.info}`);
        }
    }

    // ===== QUESTIONS DATABASE =====
    const questionsDatabase = {
        fsk0: [
            "Ich habe schon mal... ein ganzes Buch an einem Tag gelesen",
            "Ich habe schon mal... Pizza zum Fr√ºhst√ºck gegessen",
            "Ich habe schon mal... mehr als 12 Stunden am St√ºck geschlafen",
            "Ich habe schon mal... einen ganzen Tag im Pyjama verbracht",
            "Ich habe schon mal... beim Kochen das Essen anbrennen lassen",
            "Ich habe schon mal... mein Handy in die Toilette fallen lassen"
        ],
        fsk16: [
            "Ich habe schon mal... heimlich S√º√üigkeiten vor dem Abendessen gegessen",
            "Ich habe schon mal... so getan, als w√§re ich krank, um nicht zur Schule zu m√ºssen",
            "Ich habe schon mal... bis 3 Uhr morgens Netflix geschaut",
            "Ich habe schon mal... ein Lied so laut gesungen, dass die Nachbarn sich beschwert haben",
            "Ich habe schon mal... vergessen, wo ich mein Auto geparkt habe"
        ],
        fsk18: [
            "Ich habe schon mal... an einem √∂ffentlichen Ort Sex gehabt",
            "Ich habe schon mal... eine Aff√§re gehabt",
            "Ich habe schon mal... in einer Beziehung betrogen",
            "Ich habe schon mal... Sex mit jemandem gehabt, nur um es auszuprobieren"
        ]
    };

    // ===== GLOBAL VARIABLES =====
    let gameState = null;
    let firebaseService = null;
    let gameListener = null;
    let roundListener = null;
    let currentGameData = null;
    let currentRoundData = null;
    let currentPlayers = {};
    let currentQuestion = null;
    let userAnswer = null;
    let userEstimation = null; // WICHTIG: Null statt 1
    let totalPlayers = 0;
    let currentQuestionNumber = 1;
    let currentPhase = 'question';

    // Overall stats tracking
    let overallStats = {
        totalRounds: 0,
        playerStats: {}
    };

    const categoryNames = {
        'fsk0': 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Familie & Freunde',
        'fsk16': 'üéâ Party Time',
        'fsk18': 'üî• Hei√ü & Gewagt'
    };

    const difficultyMultipliers = {
        'easy': 1,
        'medium': 2,
        'hard': 3
    };

    // ===== INITIALIZATION =====
    document.addEventListener('DOMContentLoaded', function() {
        initializeGameplay();
    });

    async function initializeGameplay() {
        log('üéÆ Initializing multiplayer gameplay...');
        showLoading();

        // Initialize services
        gameState = new GameState();
        firebaseService = new FirebaseGameService();

        // Validate state
        if (!gameState.gameId || gameState.deviceMode !== 'multi') {
            log('‚ùå Invalid game state', 'error');
            showNotification('Kein g√ºltiges Spiel gefunden', 'error');
            setTimeout(() => {
                window.location.href = 'index.html';
            }, 2000);
            return;
        }

        // Initialize Firebase
        let firebaseReady = await firebaseService.initialize();

        if (firebaseReady) {
            await setupFirebaseListeners();
        } else {
            showNotification('Firebase-Verbindung fehlgeschlagen', 'error');
        }

        // Initialize UI
        updateGameDisplay();
        createNumberGrid();
        updateSubmitButton();

        // Show/hide host controls
        if (gameState.isHost) {
            document.getElementById('host-controls').style.display = 'block';
            document.getElementById('player-controls').style.display = 'none';
        } else {
            document.getElementById('host-controls').style.display = 'none';
            document.getElementById('player-controls').style.display = 'block';
        }

        hideLoading();
        log('‚úÖ Gameplay initialized');
    }

    // ===== FIREBASE LISTENERS =====
    async function setupFirebaseListeners() {
        if (!firebaseService.isReady || !gameState.gameId) {
            log('‚ö†Ô∏è Cannot setup listeners - Firebase not ready');
            return;
        }

        log('üéß Setting up Firebase listeners...');

        // Listen to game updates
        gameListener = firebaseService.listenToGame(gameState.gameId, (snapshot) => {
            if (snapshot.exists()) {
                currentGameData = snapshot.val();
                log('üéÆ Game update received');

                // Update players
                currentPlayers = currentGameData.players || {};
                updatePlayersCount();

                // Check for overall results trigger
                if (currentGameData.showOverallResults && currentPhase !== 'overall-results') {
                    log('üìä Overall results triggered by host');

                    if (currentGameData.overallStats) {
                        overallStats = currentGameData.overallStats;
                    }

                    displayOverallResults();
                }

                // Check if overall results were closed (continue game)
                if (currentGameData.showOverallResults === false && currentPhase === 'overall-results') {
                    log('‚ñ∂Ô∏è Game continues - triggered by host');
                    handleNewRound(currentGameData.currentRound);
                }

                // Check for game end
                if (currentGameData.gameState === 'finished') {
                    log('üõë Game finished by host');
                    showNotification('Spiel wurde vom Host beendet! üëã', 'info');

                    setTimeout(() => {
                        cleanup();
                        window.location.href = 'index.html';
                    }, 3000);
                }

                // Check for round changes
                if (currentGameData.currentRound && currentGameData.currentRound !== currentQuestionNumber && currentPhase !== 'overall-results') {
                    handleNewRound(currentGameData.currentRound);
                }
            }
        });

        // Load initial game data
        const initialData = await firebaseService.getGameData(gameState.gameId);
        if (initialData) {
            currentGameData = initialData;
            currentPlayers = initialData.players || {};
            updatePlayersCount();

            if (initialData.currentRound) {
                currentQuestionNumber = initialData.currentRound;
                updateGameDisplay();
                await loadRoundFromFirebase(currentQuestionNumber);
            } else if (gameState.isHost) {
                await startNewRound();
            }
        } else if (gameState.isHost) {
            await startNewRound();
        }

        log('‚úÖ Firebase listeners setup complete');
    }

    async function loadRoundFromFirebase(roundNumber) {
        if (!firebaseService.isReady) return;

        try {
            log(`üì• Loading round ${roundNumber} from Firebase...`);

            const roundRef = firebaseService.database.ref(`games/${gameState.gameId}/rounds/round_${roundNumber}`);
            const snapshot = await roundRef.once('value');

            if (snapshot.exists()) {
                const roundData = snapshot.val();
                currentQuestion = roundData.question;

                if (currentQuestion) {
                    displayQuestion(currentQuestion);
                    setupRoundListener(roundNumber);
                    log('‚úÖ Question loaded and listener setup');
                }
            } else {
                log('‚ö†Ô∏è Round not found in Firebase');
            }
        } catch (error) {
            log(`‚ùå Error loading round: ${error.message}`, 'error');
        }
    }

    function setupRoundListener(roundNumber) {
        // Remove old listener if exists
        if (roundListener) {
            try {
                roundListener.off();
                log('üóëÔ∏è Removed old round listener');
            } catch (e) {}
        }

        log(`üéß Setting up round listener for round ${roundNumber}`);

        roundListener = firebaseService.listenToRound(gameState.gameId, roundNumber, (snapshot) => {
            if (snapshot.exists()) {
                currentRoundData = snapshot.val();

                const answers = currentRoundData.answers || {};
                const answerCount = Object.keys(answers).length;
                const playerCount = Object.keys(currentPlayers).length;

                log(`üìä Round ${roundNumber} listener triggered: ${answerCount}/${playerCount} answers (Phase: ${currentPhase})`);

                // Update waiting status if in waiting phase
                if (currentPhase === 'waiting') {
                    updateWaitingStatus(answers);

                    // CHECK: All players answered?
                    if (answerCount >= playerCount && playerCount >= 2) {
                        log('üéâ ALL PLAYERS ANSWERED! Showing results for EVERYONE...');

                        setTimeout(() => {
                            if (currentPhase === 'waiting') {
                                calculateAndShowResults();
                            }
                        }, 300);
                    }
                }
            } else {
                log('‚ö†Ô∏è Round data not found in listener');
            }
        });

        log('‚úÖ Round listener active and waiting for updates');
    }

    function handleNewRound(roundNumber) {
        if (roundNumber > currentQuestionNumber) {
            currentQuestionNumber = roundNumber;
            updateGameDisplay();
            loadRoundFromFirebase(roundNumber);
            resetForNewQuestion();
            showPhase('question');
            showNotification('Neue Frage gestartet! üéÆ', 'success');
        }
    }

    // ===== GAME FLOW =====
    async function startNewRound() {
        if (!gameState.isHost) return;

        log(`üé≤ Starting round ${currentQuestionNumber}`);

        // Generate new question
        currentQuestion = generateRandomQuestion();

        // Display question
        displayQuestion(currentQuestion);

        // Start round in Firebase
        if (firebaseService.isReady) {
            await firebaseService.startNewRound(gameState.gameId, currentQuestionNumber, currentQuestion);
            setupRoundListener(currentQuestionNumber);
        }

        log('‚úÖ New round started and listener setup');
    }

    function generateRandomQuestion() {
        const availableQuestions = [];

        gameState.selectedCategories.forEach(category => {
            if (questionsDatabase[category]) {
                questionsDatabase[category].forEach(q => {
                    availableQuestions.push({
                        text: q,
                        category: category
                    });
                });
            }
        });

        if (availableQuestions.length === 0) {
            return {
                text: "Ich habe schon mal... etwas Interessantes erlebt",
                category: "fsk0"
            };
        }

        return availableQuestions[Math.floor(Math.random() * availableQuestions.length)];
    }

    function displayQuestion(question) {
        if (!question) return;

        document.getElementById('question-text').textContent = question.text;
        document.getElementById('question-category').textContent = categoryNames[question.category] || 'üéÆ Spiel';

        log('üìù Question displayed:', question.text);
    }

    function resetForNewQuestion() {
        userAnswer = null;
        userEstimation = null; // WICHTIG: Auf null setzen

        document.querySelectorAll('.answer-btn').forEach(btn => {
            btn.classList.remove('selected');
        });

        // Hide personal result box
        const personalBox = document.getElementById('personal-result');
        if (personalBox) {
            personalBox.style.display = 'none';
        }

        // WICHTIG: Selection display verstecken
        const selectionDisplay = document.getElementById('current-selection');
        selectionDisplay.classList.remove('show');
        document.getElementById('selected-number').textContent = '-';

        updateNumberSelection();
        updateSubmitButton();
    }

    // ===== UI FUNCTIONS =====
    function updateGameDisplay() {
        document.getElementById('game-id-display').textContent = gameState.gameId;
    }

    function updatePlayersCount() {
        totalPlayers = Object.keys(currentPlayers).length;
        document.getElementById('players-count').textContent = `${totalPlayers} Spieler`;
        document.getElementById('total-players').textContent = totalPlayers;

        // Recreate number grid
        createNumberGrid();
    }

    function createNumberGrid() {
        const numberGrid = document.getElementById('number-grid');
        numberGrid.innerHTML = '';

        const maxPlayers = totalPlayers || 8;
        for (let i = 0; i <= maxPlayers; i++) {
            const numberBtn = document.createElement('button');
            numberBtn.className = 'number-btn';
            numberBtn.textContent = i;
            numberBtn.onclick = () => selectNumber(i);
            numberBtn.id = `number-btn-${i}`;

            numberGrid.appendChild(numberBtn);
        }

        updateNumberSelection();
    }

    function selectNumber(number) {
        const maxPlayers = totalPlayers || 8;
        if (number >= 0 && number <= maxPlayers) {
            userEstimation = number;
            updateSelectedNumber(number);
            updateNumberSelection();
            updateSubmitButton();

            // WICHTIG: Zeige selection display erst NACH Auswahl
            const selectionDisplay = document.getElementById('current-selection');
            selectionDisplay.classList.add('show');
        }
    }

    function updateSelectedNumber(number) {
        document.getElementById('selected-number').textContent = number;
    }

    function updateNumberSelection() {
        document.querySelectorAll('.number-btn').forEach(btn => {
            btn.classList.remove('selected');
        });

        if (userEstimation !== null) {
            const selectedBtn = document.getElementById(`number-btn-${userEstimation}`);
            if (selectedBtn) {
                selectedBtn.classList.add('selected');
            }
        }
    }

    function selectAnswer(answer) {
        userAnswer = answer;

        document.querySelectorAll('.answer-btn').forEach(btn => {
            btn.classList.remove('selected');
        });

        const selectedBtn = answer ? document.getElementById('yes-btn') : document.getElementById('no-btn');
        selectedBtn.classList.add('selected');

        updateSubmitButton();
    }

    function updateSubmitButton() {
        const submitBtn = document.getElementById('submit-btn');
        if (userAnswer !== null && userEstimation !== null) {
            submitBtn.classList.add('enabled');
            submitBtn.disabled = false;
        } else {
            submitBtn.classList.remove('enabled');
            submitBtn.disabled = true;
        }
    }

    // ===== GAME ACTIONS =====
    async function submitAnswers() {
        if (userAnswer === null || userEstimation === null) {
            showNotification('Bitte w√§hle eine Antwort UND eine Sch√§tzung aus!', 'warning');
            return;
        }

        log('üì§ Submitting answers:', { answer: userAnswer, estimation: userEstimation });

        const answerData = {
            playerId: gameState.playerId,
            playerName: gameState.playerName,
            answer: userAnswer,
            estimation: userEstimation,
            isHost: gameState.isHost,
            alcoholMode: gameState.alcoholMode
        };

        try {
            if (firebaseService.isReady) {
                await firebaseService.submitAnswer(
                    gameState.gameId,
                    currentQuestionNumber,
                    gameState.playerId,
                    answerData
                );

                log('‚úÖ Answer submitted to Firebase');
            }

            showNotification('Antworten gesendet! üéØ', 'success');
            showPhase('waiting');

            setTimeout(() => {
                checkIfAllAnswered();
            }, 1000);

        } catch (error) {
            log(`‚ùå Error submitting: ${error.message}`, 'error');
            showNotification('Fehler beim Senden', 'error');
        }
    }

    async function checkIfAllAnswered() {
        if (!firebaseService.isReady || !currentQuestionNumber) return;

        try {
            const roundRef = firebaseService.database.ref(`games/${gameState.gameId}/rounds/round_${currentQuestionNumber}`);
            const snapshot = await roundRef.once('value');

            if (snapshot.exists()) {
                const roundData = snapshot.val();
                const answers = roundData.answers || {};
                const answerCount = Object.keys(answers).length;
                const playerCount = Object.keys(currentPlayers).length;

                log(`üîç Manual check: ${answerCount}/${playerCount} answers`);

                if (answerCount >= playerCount && playerCount >= 2 && currentPhase === 'waiting') {
                    log('‚úÖ All answered detected in manual check!');
                    currentRoundData = roundData;
                    calculateAndShowResults();
                }
            }
        } catch (error) {
            log(`‚ùå Error in manual check: ${error.message}`, 'error');
        }
    }

    // ===== PHASE MANAGEMENT =====
    function showPhase(phase) {
        document.querySelectorAll('.game-phase').forEach(p => {
            p.classList.remove('active');
        });

        document.getElementById(`${phase}-phase`).classList.add('active');
        currentPhase = phase;

        log(`üìç Phase: ${phase}`);
    }

    // ===== WAITING PHASE =====
    function updateWaitingStatus(answers = {}) {
        const statusContainer = document.getElementById('players-status');
        statusContainer.innerHTML = '';

        Object.entries(currentPlayers).forEach(([playerId, player]) => {
            const hasAnswered = answers[playerId] !== undefined;

            const statusItem = document.createElement('div');
            statusItem.className = 'player-status-item';

            const statusIndicator = hasAnswered ?
                '<span class="status-indicator status-done">‚úÖ Fertig</span>' :
                '<span class="status-indicator status-waiting">‚è≥ Wartet...</span>';

            statusItem.innerHTML = `
                    <span>${player.name || 'Spieler'}</span>
                    ${statusIndicator}
                `;

            statusContainer.appendChild(statusItem);
        });
    }

    // ===== RESULTS CALCULATION =====
    function calculateAndShowResults() {
        if (!currentRoundData || !currentRoundData.answers) {
            log('‚ùå No round data available');
            return;
        }

        const answers = currentRoundData.answers;
        const actualYesCount = Object.values(answers).filter(a => a.answer === true).length;

        log(`‚úÖ Alle haben geantwortet! Richtige Antwort: ${actualYesCount} Spieler`);

        // Calculate results
        const results = Object.values(answers).map(playerAnswer => {
            const difference = Math.abs(playerAnswer.estimation - actualYesCount);
            const isCorrect = difference === 0;

            let sips = 0;
            if (!isCorrect) {
                const baseSips = difficultyMultipliers[gameState.difficulty] || 2;
                sips = baseSips + Math.floor(difference / 2);
            }

            return {
                playerId: playerAnswer.playerId,
                playerName: playerAnswer.playerName,
                answer: playerAnswer.answer,
                estimation: playerAnswer.estimation,
                difference: difference,
                isCorrect: isCorrect,
                sips: sips,
                alcoholMode: playerAnswer.alcoholMode !== undefined ? playerAnswer.alcoholMode : true
            };
        });

        // SORT BY SIPS (DESCENDING - Most sips first)
        results.sort((a, b) => b.sips - a.sips);

        // UPDATE OVERALL STATS
        overallStats.totalRounds = currentQuestionNumber;

        results.forEach(result => {
            if (!overallStats.playerStats[result.playerId]) {
                overallStats.playerStats[result.playerId] = {
                    name: result.playerName,
                    totalSips: 0,
                    correctGuesses: 0,
                    totalGuesses: 0
                };
            }

            const playerStats = overallStats.playerStats[result.playerId];
            playerStats.totalSips += result.sips;
            playerStats.totalGuesses++;
            if (result.isCorrect) {
                playerStats.correctGuesses++;
            }
        });

        displayRoundResults(results, actualYesCount);
        showPhase('results');

        log('üìä Results calculated and displayed for all players');
    }

    function displayRoundResults(results, actualYesCount) {
        // Zeige die FRAGE als Titel
        if (currentQuestion && currentQuestion.text) {
            document.getElementById('results-question-text').textContent = currentQuestion.text;
        }

        document.getElementById('results-summary').textContent =
            `‚úÖ ${actualYesCount} von ${totalPlayers || results.length} Spielern haben mit "Ja" geantwortet`;

        // Find current player's result
        const myResult = results.find(r => r.playerId === gameState.playerId);

        if (myResult) {
            // Show personal result box
            const personalBox = document.getElementById('personal-result');
            personalBox.style.display = 'block';

            document.getElementById('personal-estimation').textContent = myResult.estimation;

            const statusText = myResult.isCorrect ?
                '‚úÖ Richtig gesch√§tzt!' :
                `‚ùå Falsch (Diff: ${myResult.difference})`;
            const statusEl = document.getElementById('personal-status');
            statusEl.textContent = statusText;
            statusEl.style.color = myResult.isCorrect ? '#4CAF50' : '#f44336';

            const drinkEmoji = myResult.alcoholMode ? 'üç∫' : 'üíß';
            const sipsText = myResult.sips === 0 ?
                'üéØ Keine! Perfekt!' :
                `${myResult.sips} ${drinkEmoji}`;
            document.getElementById('personal-sips').textContent = sipsText;
        }

        // Display results grid (sorted by sips - descending)
        const resultsGrid = document.getElementById('results-grid');
        resultsGrid.innerHTML = '';

        results.forEach((result, index) => {
            const resultItem = document.createElement('div');
            resultItem.className = 'result-item';

            // NEUE FARBKODIERUNG
            const isMe = result.playerId === gameState.playerId;
            const isCorrect = result.isCorrect;

            if (isMe) {
                resultItem.classList.add('is-me');
            } else if (isCorrect) {
                resultItem.classList.add('correct-not-me');
            } else {
                resultItem.classList.add('wrong');
            }

            const avatar = result.playerName.substring(0, 2).toUpperCase();
            const drinkEmoji = result.alcoholMode ? 'üç∫' : 'üíß';
            const sipsText = result.sips === 0 ? 'Perfekt! üéØ' : `${result.sips} ${drinkEmoji}`;
            const sipsClass = result.sips === 0 ? 'none' : '';

            resultItem.innerHTML = `
                    <div class="player-result">
                        <div class="player-avatar">${avatar}</div>
                        <div class="player-info">
                            <div class="player-name">${result.playerName}</div>
                            <div class="player-answer">Tipp: ${result.estimation}</div>
                        </div>
                    </div>
                    <div class="sips-penalty ${sipsClass}">${sipsText}</div>
                `;

            resultsGrid.appendChild(resultItem);
        });
    }

    // ===== GAME CONTROLS =====
    async function nextQuestion() {
        if (!gameState.isHost) {
            showNotification('Nur der Host kann weitermachen!', 'warning');
            return;
        }

        currentQuestionNumber++;
        updateGameDisplay();
        resetForNewQuestion();
        showPhase('question');

        await startNewRound();
        showNotification('Neue Frage geladen! üéÆ', 'success');
    }

    async function showOverallResults() {
        if (!gameState.isHost) {
            showNotification('Nur der Host kann die Gesamtergebnisse zeigen!', 'warning');
            return;
        }

        log('üìä Showing overall results...');

        // Notify all players via Firebase
        if (firebaseService.isReady) {
            try {
                const gameRef = firebaseService.database.ref(`games/${gameState.gameId}`);
                await gameRef.update({
                    showOverallResults: true,
                    overallStats: overallStats,
                    lastUpdate: firebase.database.ServerValue.TIMESTAMP
                });

                log('‚úÖ Overall results notification sent to all players');
            } catch (error) {
                log(`‚ùå Error sending notification: ${error.message}`, 'error');
            }
        }

        // Show for host
        displayOverallResults();
    }

    function displayOverallResults() {
        log('üèÜ Displaying overall results');

        // Update stats
        document.getElementById('total-rounds').textContent = overallStats.totalRounds;
        document.getElementById('total-players-overall').textContent = Object.keys(overallStats.playerStats).length;

        // Create leaderboard
        const leaderboardList = document.getElementById('overall-leaderboard-list');
        leaderboardList.innerHTML = '';

        // Convert to array and sort by total sips (ascending - least sips = winner)
        const leaderboard = Object.values(overallStats.playerStats).sort((a, b) => a.totalSips - b.totalSips);

        leaderboard.forEach((player, index) => {
            const leaderboardItem = document.createElement('div');
            leaderboardItem.className = `leaderboard-item ${index === 0 ? 'winner' : ''}`;

            const rankClass = index === 0 ? 'rank-1' :
                index === 1 ? 'rank-2' :
                    index === 2 ? 'rank-3' : 'rank-other';

            // NEUE TEXT: "x Fragen richtig" statt "100% richtig"
            const correctText = `${player.correctGuesses} Fragen richtig`;

            leaderboardItem.innerHTML = `
                    <div class="rank-badge ${rankClass}">${index + 1}</div>
                    <div class="leaderboard-player-info">
                        <div class="leaderboard-player-name">${player.name}</div>
                        <div class="leaderboard-player-stats">
                            <span>üç∫ ${player.totalSips} Schl√ºcke</span>
                            <span>üéØ ${correctText}</span>
                        </div>
                    </div>
                `;

            leaderboardList.appendChild(leaderboardItem);
        });

        // Show/hide controls
        if (gameState.isHost) {
            document.getElementById('overall-host-controls').style.display = 'block';
            document.getElementById('overall-player-controls').style.display = 'none';
        } else {
            document.getElementById('overall-host-controls').style.display = 'none';
            document.getElementById('overall-player-controls').style.display = 'block';
        }

        showPhase('overall-results');
    }

    async function continueGame() {
        if (!gameState.isHost) {
            showNotification('Nur der Host kann das Spiel fortfahren!', 'warning');
            return;
        }

        log('‚ñ∂Ô∏è Continuing game...');

        // Clear overall results flag
        if (firebaseService.isReady) {
            try {
                const gameRef = firebaseService.database.ref(`games/${gameState.gameId}`);
                await gameRef.update({
                    showOverallResults: false,
                    lastUpdate: firebase.database.ServerValue.TIMESTAMP
                });
            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        // Start next question
        currentQuestionNumber++;
        updateGameDisplay();
        resetForNewQuestion();
        showPhase('question');

        await startNewRound();
        showNotification('Spiel wird fortgesetzt! üéÆ', 'success');
    }

    async function endGameForAll() {
        if (!gameState.isHost) {
            showNotification('Nur der Host kann das Spiel beenden!', 'warning');
            return;
        }

        if (!confirm('Spiel wirklich f√ºr ALLE Spieler beenden?')) {
            return;
        }

        log('üõë Ending game for all players...');

        if (firebaseService.isReady) {
            try {
                const gameRef = firebaseService.database.ref(`games/${gameState.gameId}`);
                await gameRef.update({
                    gameState: 'finished',
                    endedAt: firebase.database.ServerValue.TIMESTAMP,
                    finalStats: overallStats
                });

                showNotification('Spiel wurde beendet! üëã', 'success');

                setTimeout(() => {
                    cleanup();
                    window.location.href = 'index.html';
                }, 2000);

            } catch (error) {
                log(`‚ùå Error ending game: ${error.message}`, 'error');
                showNotification('Fehler beim Beenden', 'error');
            }
        } else {
            // Offline fallback
            cleanup();
            window.location.href = 'index.html';
        }
    }

    function cleanup() {
        if (gameListener) {
            try {
                gameListener.off();
            } catch (e) {}
        }
        if (roundListener) {
            try {
                roundListener.off();
            } catch (e) {}
        }
        if (firebaseService) {
            firebaseService.cleanup();
        }
    }

    // ===== CLEANUP =====
    window.addEventListener('beforeunload', cleanup);

    // ===== UTILITY FUNCTIONS =====
    function showLoading() {
        document.getElementById('loading-screen').classList.add('show');
    }

    function hideLoading() {
        document.getElementById('loading-screen').classList.remove('show');
    }

    function showNotification(message, type = 'info') {
        document.querySelectorAll('.toast-notification').forEach(n => n.remove());

        const notification = document.createElement('div');
        notification.className = `toast-notification ${type}`;
        notification.innerHTML = `
                <div class="toast-content">
                    <div class="toast-icon">${type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è'}</div>
                    <div class="toast-message">${message}</div>
                </div>
            `;

        document.body.appendChild(notification);

        setTimeout(() => notification.classList.add('show'), 100);

        setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => {
                if (document.body.contains(notification)) {
                    document.body.removeChild(notification);
                }
            }, 300);
        }, 4000);
    }

    function log(message, type = 'info') {
        const colors = {
            info: '#4488ff',
            warning: '#ffaa00',
            error: '#ff4444',
            success: '#00ff00'
        };
        console.log(`%c[Gameplay] ${message}`, `color: ${colors[type] || colors.info}`);
    }

    // ===== DEBUG =====
    window.debugGameplay = function() {
        console.log('üîç === GAMEPLAY DEBUG ===');
        console.log('GameState:', gameState);
        console.log('Firebase:', {
            initialized: firebaseService?.isInitialized,
            connected: firebaseService?.isConnected
        });
        console.log('Current Game Data:', currentGameData);
        console.log('Current Round Data:', currentRoundData);
        console.log('Current Question:', currentQuestion);
        console.log('Players:', currentPlayers);
    };

    log('‚úÖ No-Cap Multiplayer Gameplay v7.0 - KOMPLETT NEU - vollst√§ndig geladen!');
    log('üõ†Ô∏è Debug: debugGameplay()');
</script>
</body>
</html>