<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>DenkstDu - Multiplayer Gameplay</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-x: hidden;
            touch-action: manipulation;
            position: relative;
        }

        /* Background Particles */
        .background-particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: -1;
        }

        .particle {
            position: absolute;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 50%;
            animation: float 15s ease-in-out infinite;
        }

        .particle:nth-child(1) { width: 100px; height: 100px; left: 10%; animation-delay: 0s; }
        .particle:nth-child(2) { width: 60px; height: 60px; left: 80%; animation-delay: 3s; }
        .particle:nth-child(3) { width: 80px; height: 80px; left: 30%; animation-delay: 6s; }
        .particle:nth-child(4) { width: 120px; height: 120px; left: 70%; animation-delay: 9s; }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); opacity: 0.3; }
            25% { transform: translateY(-30px) rotate(90deg); opacity: 0.6; }
            50% { transform: translateY(-60px) rotate(180deg); opacity: 0.3; }
            75% { transform: translateY(-30px) rotate(270deg); opacity: 0.6; }
        }

        /* Connection Status */
        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            padding: 10px 15px;
            color: white;
            font-size: 0.8rem;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .connection-status.connected {
            border: 1px solid #4CAF50;
            background: rgba(76, 175, 80, 0.2);
        }

        .connection-status.disconnected {
            border: 1px solid #f44336;
            background: rgba(244, 67, 54, 0.2);
        }

        .app-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 15px;
            max-width: 450px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        /* Header */
        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(25px);
            border-radius: 25px;
            padding: 18px 25px;
            margin-bottom: 25px;
            border: 1px solid rgba(255, 255, 255, 0.25);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .game-info {
            color: white;
        }

        .game-id {
            font-size: 0.8rem;
            opacity: 0.9;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .question-counter {
            font-size: 1.1rem;
            font-weight: 800;
        }

        .players-online {
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
            font-size: 0.95rem;
            font-weight: 600;
        }

        .online-indicator {
            width: 10px;
            height: 10px;
            background: linear-gradient(45deg, #4CAF50, #8BC34A);
            border-radius: 50%;
            animation: pulse 2s infinite;
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.2); }
        }

        /* Game Phases */
        .game-phase {
            display: none;
        }

        .game-phase.active {
            display: block;
        }

        /* Question Card */
        .question-card {
            background: rgba(255, 255, 255, 0.12);
            backdrop-filter: blur(30px);
            border-radius: 30px;
            border: 1px solid rgba(255, 255, 255, 0.25);
            padding: 35px 30px;
            margin-bottom: 30px;
            text-align: center;
            min-height: 180px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.15);
            position: relative;
            overflow: hidden;
        }

        .question-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, #4CAF50, #2196F3, #9C27B0);
            background-size: 200% 100%;
            animation: shimmer 3s ease-in-out infinite;
        }

        @keyframes shimmer {
            0%, 100% { background-position: 200% 0; }
            50% { background-position: -200% 0; }
        }

        .question-category {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.25), rgba(76, 175, 80, 0.35));
            border: 1px solid rgba(76, 175, 80, 0.5);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: 700;
            display: inline-block;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }

        .question-text {
            color: white;
            font-size: 1.3rem;
            font-weight: 700;
            line-height: 1.5;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        /* Answer Section */
        .answer-section {
            margin-bottom: 35px;
        }

        .answer-title {
            color: white;
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 20px;
            text-align: center;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .answer-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .answer-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.25);
            color: white;
            padding: 25px 20px;
            border-radius: 25px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            min-height: 100px;
            backdrop-filter: blur(20px);
            position: relative;
            overflow: hidden;
        }

        .answer-btn:active {
            transform: scale(0.95);
        }

        .answer-btn.selected {
            transform: scale(1.05);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
        }

        .answer-btn.yes.selected {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.3), rgba(76, 175, 80, 0.4));
            border-color: #4CAF50;
            box-shadow: 0 15px 40px rgba(76, 175, 80, 0.3);
        }

        .answer-btn.no.selected {
            background: linear-gradient(135deg, rgba(244, 67, 54, 0.3), rgba(244, 67, 54, 0.4));
            border-color: #f44336;
            box-shadow: 0 15px 40px rgba(244, 67, 54, 0.3);
        }

        .answer-emoji {
            font-size: 2rem;
        }

        /* Estimation Section */
        .estimation-section {
            background: rgba(255, 255, 255, 0.12);
            backdrop-filter: blur(30px);
            border-radius: 25px;
            padding: 30px 25px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.25);
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.1);
        }

        .estimation-title {
            color: white;
            font-size: 1.2rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 30px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        /* Number Grid */
        .number-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
            justify-items: center;
        }

        .number-btn {
            width: 60px;
            height: 60px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.25);
            color: white;
            border-radius: 50%;
            font-size: 1.2rem;
            font-weight: 800;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            backdrop-filter: blur(20px);
        }

        .number-btn:active {
            transform: scale(0.9);
        }

        .number-btn.selected {
            background: linear-gradient(135deg, #4CAF50, #2196F3);
            border-color: #4CAF50;
            transform: scale(1.1);
            box-shadow: 0 10px 30px rgba(76, 175, 80, 0.4);
            color: white;
        }

        /* Current Selection Display */
        .current-selection {
            text-align: center;
            margin-bottom: 25px;
        }

        .selection-display {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 20px;
            display: inline-block;
            min-width: 200px;
        }

        .selection-number {
            color: white;
            font-size: 2.5rem;
            font-weight: 800;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            margin-bottom: 5px;
        }

        .selection-label {
            color: rgba(255, 255, 255, 0.8);
            font-size: 1rem;
            font-weight: 600;
        }

        /* Submit Button */
        .submit-section {
            margin-bottom: 30px;
        }

        .submit-btn {
            width: 100%;
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 22px;
            border-radius: 25px;
            font-size: 1.3rem;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            opacity: 0.4;
            transform: scale(0.95);
            box-shadow: 0 10px 30px rgba(76, 175, 80, 0.2);
        }

        .submit-btn.enabled {
            opacity: 1;
            transform: scale(1);
            box-shadow: 0 15px 40px rgba(76, 175, 80, 0.4);
        }

        .submit-btn.enabled:active {
            transform: scale(0.98);
        }

        /* Waiting Phase */
        .waiting-screen {
            text-align: center;
            padding: 60px 20px;
        }

        .waiting-spinner {
            width: 100px;
            height: 100px;
            border: 8px solid rgba(255, 255, 255, 0.1);
            border-top: 8px solid #4CAF50;
            border-radius: 50%;
            animation: spin 1.5s linear infinite;
            margin: 0 auto 40px;
            box-shadow: 0 0 30px rgba(76, 175, 80, 0.3);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .waiting-title {
            color: white;
            font-size: 1.6rem;
            font-weight: 800;
            margin-bottom: 20px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .waiting-description {
            color: rgba(255, 255, 255, 0.8);
            font-size: 1.1rem;
            line-height: 1.6;
            font-weight: 500;
            margin-bottom: 30px;
        }

        .players-status {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 25px;
            margin: 30px 0;
        }

        .player-status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            color: white;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .player-status-item:last-child {
            border-bottom: none;
        }

        .status-indicator {
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-done {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
        }

        .status-waiting {
            background: rgba(255, 152, 0, 0.3);
            border: 1px solid #ff9800;
            color: #ff9800;
        }

        /* Results Phase */
        .results-screen {
            padding: 20px 0;
        }

        .results-header {
            background: rgba(255, 255, 255, 0.12);
            backdrop-filter: blur(30px);
            border-radius: 25px;
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.25);
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.1);
        }

        .results-title {
            color: white;
            font-size: 1.6rem;
            font-weight: 800;
            margin-bottom: 15px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .results-summary {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .correct-answer {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.3), rgba(76, 175, 80, 0.4));
            border: 1px solid #4CAF50;
            border-radius: 15px;
            padding: 15px;
            color: white;
            font-weight: 700;
            font-size: 1.1rem;
        }

        .results-grid {
            display: grid;
            gap: 18px;
            margin-bottom: 30px;
        }

        .result-item {
            background: rgba(255, 255, 255, 0.12);
            backdrop-filter: blur(30px);
            border-radius: 20px;
            padding: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid rgba(255, 255, 255, 0.25);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .player-result {
            display: flex;
            align-items: center;
            gap: 18px;
        }

        .player-avatar {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 800;
            font-size: 1.1rem;
            box-shadow: 0 5px 20px rgba(79, 172, 254, 0.3);
        }

        .player-info {
            color: white;
        }

        .player-name {
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .player-answer {
            font-size: 0.9rem;
            opacity: 0.8;
            font-weight: 500;
        }

        .sips-penalty {
            background: linear-gradient(135deg, rgba(244, 67, 54, 0.3), rgba(244, 67, 54, 0.4));
            border: 1px solid #f44336;
            color: #f44336;
            padding: 10px 18px;
            border-radius: 20px;
            font-weight: 800;
            font-size: 0.95rem;
            box-shadow: 0 5px 15px rgba(244, 67, 54, 0.2);
        }

        .sips-penalty.none {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.3), rgba(76, 175, 80, 0.4));
            border-color: #4CAF50;
            color: #4CAF50;
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.2);
        }

        /* Host Controls */
        .host-controls {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(255, 215, 0, 0.15));
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 25px;
            backdrop-filter: blur(20px);
        }

        .host-title {
            color: #FFD700;
            font-weight: 800;
            font-size: 1.1rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        /* Final Results Screen */
        .final-results-screen {
            padding: 20px 0;
        }

        .final-header {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(255, 215, 0, 0.3));
            border: 2px solid rgba(255, 215, 0, 0.5);
            backdrop-filter: blur(30px);
            border-radius: 25px;
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.1);
        }

        .final-title {
            color: #FFD700;
            font-size: 2rem;
            font-weight: 800;
            margin-bottom: 15px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .final-subtitle {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1.2rem;
            font-weight: 600;
        }

        .final-stats {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 20px;
            margin: 20px 0;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            color: white;
            font-size: 1.8rem;
            font-weight: 800;
            margin-bottom: 5px;
        }

        .stat-label {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
            font-weight: 600;
        }

        .leaderboard {
            margin: 30px 0;
        }

        .leaderboard-title {
            color: white;
            font-size: 1.4rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 20px;
        }

        .leaderboard-item {
            background: rgba(255, 255, 255, 0.12);
            backdrop-filter: blur(30px);
            border-radius: 20px;
            padding: 20px;
            margin: 15px 0;
            display: flex;
            align-items: center;
            gap: 20px;
            border: 1px solid rgba(255, 255, 255, 0.25);
        }

        .leaderboard-item.winner {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(255, 215, 0, 0.3));
            border-color: #FFD700;
        }

        .rank-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 1.2rem;
        }

        .rank-1 { background: linear-gradient(135deg, #FFD700, #FFA500); color: white; }
        .rank-2 { background: linear-gradient(135deg, #C0C0C0, #A0A0A0); color: white; }
        .rank-3 { background: linear-gradient(135deg, #CD7F32, #B8860B); color: white; }
        .rank-other { background: rgba(255, 255, 255, 0.2); color: white; }

        .player-final-stats {
            flex: 1;
        }

        .player-final-name {
            color: white;
            font-weight: 700;
            font-size: 1.2rem;
            margin-bottom: 8px;
        }

        .player-final-details {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
            display: flex;
            gap: 15px;
        }

        /* Navigation Buttons */
        .nav-buttons {
            display: grid;
            gap: 18px;
            margin-top: 25px;
        }

        .nav-btn {
            padding: 20px;
            border-radius: 20px;
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .nav-btn.primary {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
        }

        .nav-btn.secondary {
            background: rgba(255, 255, 255, 0.12);
            border: 2px solid rgba(255, 255, 255, 0.25);
            color: white;
            backdrop-filter: blur(20px);
        }

        .nav-btn.danger {
            background: linear-gradient(135deg, #f44336, #d32f2f);
            color: white;
        }

        .nav-btn:active {
            transform: scale(0.98);
        }

        /* Toast Notifications */
        .toast-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(25px);
            border: 1px solid rgba(255, 255, 255, 0.25);
            border-radius: 20px;
            padding: 20px;
            z-index: 10000;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            max-width: 350px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
        }

        .toast-notification.show {
            opacity: 1;
            transform: translateX(0);
        }

        .toast-notification.success {
            border-color: rgba(76, 175, 80, 0.5);
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.15), rgba(76, 175, 80, 0.25));
        }

        .toast-notification.warning {
            border-color: rgba(255, 152, 0, 0.5);
            background: linear-gradient(135deg, rgba(255, 152, 0, 0.15), rgba(255, 152, 0, 0.25));
        }

        .toast-notification.error {
            border-color: rgba(244, 67, 54, 0.5);
            background: linear-gradient(135deg, rgba(244, 67, 54, 0.15), rgba(244, 67, 54, 0.25));
        }

        .toast-content {
            display: flex;
            align-items: center;
            gap: 15px;
            color: white;
        }

        .toast-icon {
            font-size: 1.5rem;
        }

        .toast-message {
            font-weight: 600;
            font-size: 0.95rem;
            line-height: 1.4;
        }

        /* Responsive Design */
        @media (max-width: 480px) {
            .app-container {
                padding: 12px;
            }
            
            .question-text {
                font-size: 1.2rem;
            }
            
            .number-btn {
                width: 50px;
                height: 50px;
                font-size: 1.1rem;
            }

            .final-stats {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .player-final-details {
                flex-direction: column;
                gap: 5px;
            }

            .connection-status {
                top: 15px;
                right: 15px;
                font-size: 0.7rem;
                padding: 8px 12px;
            }
        }

        /* Animations */
        .fadeInUp {
            animation: fadeInUp 0.6s ease-out;
        }

@keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>
    <!-- Background Particles -->
    <div class="background-particles">
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
    </div>

    <!-- Connection Status -->
    <div class="connection-status connected" id="connection-status">
        🟢 Online
    </div>

    <!-- App Container -->
    <div class="app-container">
        <!-- Game Header -->
        <div class="game-header fadeInUp">
            <div class="game-info">
                <div class="game-id">ID: <span id="game-id-display">LOADING</span></div>
                <div class="question-counter">Frage <span id="question-number">1</span></div>
            </div>
            <div class="players-online">
                <div class="online-indicator"></div>
                <span id="players-count">0 Spieler</span>
            </div>
        </div>

        <!-- PHASE 1: Question & Answer -->
        <div class="game-phase active" id="question-phase">
            <!-- Question Card -->
            <div class="question-card fadeInUp">
                <div class="question-category" id="question-category">
                    🎮 Loading...
                </div>
                <div class="question-text" id="question-text">
                    Lade Frage...
                </div>
            </div>

            <!-- Answer Section -->
            <div class="answer-section fadeInUp">
                <div class="answer-title">🤔 Deine Antwort</div>
                <div class="answer-buttons">
                    <button class="answer-btn yes" onclick="selectAnswer(true)" id="yes-btn">
                        <div class="answer-emoji">✅</div>
                        <div>Ja, habe ich</div>
                    </button>
                    <button class="answer-btn no" onclick="selectAnswer(false)" id="no-btn">
                        <div class="answer-emoji">❌</div>
                        <div>Nein, noch nie</div>
                    </button>
                </div>
            </div>

            <!-- Estimation Section -->
            <div class="estimation-section fadeInUp">
                <div class="estimation-title">🎯 Wie viele antworten mit "Ja"?</div>
                
                <!-- Current Selection Display -->
                <div class="current-selection">
                    <div class="selection-display">
                        <div class="selection-number" id="selected-number">1</div>
                        <div class="selection-label">von <span id="total-players">0</span> Spielern</div>
                    </div>
                </div>

                <!-- Number Grid -->
                <div class="number-grid" id="number-grid">
                    <!-- Numbers will be generated dynamically -->
                </div>
            </div>

            <!-- Submit Button -->
            <div class="submit-section fadeInUp">
                <button class="submit-btn" onclick="submitAnswers()" id="submit-btn">
                    📤 Antworten absenden
                </button>
            </div>
        </div>

        <!-- PHASE 2: Waiting for Others -->
        <div class="game-phase" id="waiting-phase">
            <div class="waiting-screen">
                <div class="waiting-spinner"></div>
                <div class="waiting-title">⏳ Warten auf andere Spieler</div>
                <div class="waiting-description">
                    Deine Antworten wurden gesendet.<br>
                    Warte, bis alle anderen geantwortet haben.
                </div>

                <div class="players-status" id="players-status">
                    <!-- Player status will be populated dynamically -->
                </div>
            </div>
        </div>

        <!-- PHASE 3: Round Results -->
        <div class="game-phase" id="results-phase">
            <div class="results-screen">
                <div class="results-header fadeInUp">
                    <div class="results-title">📊 Ergebnis Frage <span id="results-round">1</span></div>
                    <div class="results-summary" id="results-summary">
                        Berechne Ergebnisse...
                    </div>
                    <div class="correct-answer">
                        ✅ Korrekte Antwort: <span id="correct-count">0</span> Spieler
                    </div>
                </div>

                <div class="results-grid fadeInUp" id="results-grid">
                    <!-- Results will be populated dynamically -->
                </div>

                <!-- Host Controls (only visible for host) -->
                <div class="host-controls fadeInUp" id="host-controls" style="display: none;">
                    <div class="host-title">
                        👑 Host-Kontrollen
                    </div>
                    <div class="nav-buttons">
                        <button class="nav-btn primary" onclick="nextQuestion()">
                            ➡️ Nächste Frage
                        </button>
                        <button class="nav-btn danger" onclick="endGame()">
                            🏁 Spiel beenden
                        </button>
                    </div>
                </div>

                <!-- Player Controls (for non-hosts) -->
                <div class="nav-buttons fadeInUp" id="player-controls">
                    <button class="nav-btn secondary" onclick="waitForHost()">
                        ⏳ Warten auf Host...
                    </button>
                </div>
            </div>
        </div>

        <!-- PHASE 4: Final Results -->
        <div class="game-phase" id="final-results-phase">
            <div class="final-results-screen">
                <div class="final-header fadeInUp">
                    <div class="final-title">🏆 Spiel beendet!</div>
                    <div class="final-subtitle">Hier sind die Gesamtergebnisse</div>
                    
                    <div class="final-stats">
                        <div class="stat-item">
                            <div class="stat-value" id="total-questions">0</div>
                            <div class="stat-label">Fragen gespielt</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="total-players-final">0</div>
                            <div class="stat-label">Spieler</div>
                        </div>
                    </div>
                </div>

                <div class="leaderboard fadeInUp">
                    <div class="leaderboard-title">🏅 Bestenliste</div>
                    <div id="leaderboard-list">
                        <!-- Leaderboard will be populated dynamically -->
                    </div>
                </div>

                <div class="nav-buttons fadeInUp">
                    <button class="nav-btn primary" onclick="playAgain()">
                        🔄 Nochmal spielen
                    </button>
                    <button class="nav-btn secondary" onclick="goHome()">
                        🏠 Zur Startseite
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== FIREBASE INTEGRATION =====
        class FirebaseGameService {
            constructor() {
                this.app = null;
                this.database = null;
                this.isInitialized = false;
                this.isConnected = false;
                this.gameRef = null;
                this.currentRoundRef = null;
                
                // Firebase Config
                this.config = {
                    apiKey: "AIzaSyC_cu_2X2uFCPcxYetxIUHi2v56F1Mz0Vk",
                    authDomain: "denkstduwebsite.firebaseapp.com",
                    databaseURL: "https://denkstduwebsite-default-rtdb.europe-west1.firebasedatabase.app",
                    projectId: "denkstduwebsite",
                    storageBucket: "denkstduwebsite.appspot.com",
                    messagingSenderId: "27029260611",
                    appId: "1:27029260611:web:3c7da4db0bf92e8ce247f6",
                    measurementId: "G-BNKNW95HK8"
                };
            }

            async initialize() {
                try {
                    if (typeof firebase === 'undefined') {
                        throw new Error('Firebase SDK not loaded');
                    }

                    if (!firebase.apps || firebase.apps.length === 0) {
                        this.app = firebase.initializeApp(this.config);
                    } else {
                        this.app = firebase.app();
                    }

                    this.database = firebase.database();
                    this.setupConnectionMonitoring();

                    const connected = await this.testConnection();
                    this.isInitialized = connected;
                    
                    return this.isInitialized;

                } catch (error) {
                    console.error('❌ Firebase initialization failed:', error);
                    this.updateConnectionStatus('disconnected');
                    return false;
                }
            }

            setupConnectionMonitoring() {
                const connectedRef = this.database.ref('.info/connected');
                connectedRef.on('value', (snapshot) => {
                    this.isConnected = snapshot.val() === true;
                    this.updateConnectionStatus(this.isConnected ? 'connected' : 'disconnected');
                });
            }

            async testConnection() {
                try {
                    this.updateConnectionStatus('connecting');
                    
                    const testRef = this.database.ref('.info/connected');
                    const snapshot = await testRef.once('value');
                    const connected = snapshot.val() === true;
                    
                    this.updateConnectionStatus(connected ? 'connected' : 'disconnected');
                    return connected;
                    
                } catch (error) {
                    console.error('❌ Connection test failed:', error);
                    this.updateConnectionStatus('disconnected');
                    return false;
                }
            }

            updateConnectionStatus(status) {
                const statusEl = document.getElementById('connection-status');
                if (!statusEl) return;

                statusEl.className = `connection-status ${status}`;
                
                switch (status) {
                    case 'connected':
                        statusEl.innerHTML = '🟢 Online';
                        break;
                    case 'disconnected':
                        statusEl.innerHTML = '🔴 Offline';
                        break;
                    case 'connecting':
                        statusEl.innerHTML = '🔄 Verbinde...';
                        break;
                }
            }

            // Setup game reference
            setupGameRef(gameId) {
                this.gameRef = this.database.ref(`games/${gameId}`);
                return this.gameRef;
            }

            // Submit answer to Firebase
            async submitAnswer(gameId, roundNumber, playerId, answerData) {
                if (!this.isInitialized) throw new Error('Firebase not initialized');

                try {
                    const answerRef = this.database.ref(`games/${gameId}/rounds/${roundNumber}/answers/${playerId}`);
                    await answerRef.set({
                        ...answerData,
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    });
                    
                    console.log('✅ Answer submitted to Firebase');
                    return true;
                } catch (error) {
                    console.error('❌ Error submitting answer:', error);
                    throw error;
                }
            }

            // Start new round
            async startNewRound(gameId, roundNumber, question) {
                if (!this.isInitialized) throw new Error('Firebase not initialized');

                try {
                    const roundRef = this.database.ref(`games/${gameId}/rounds/${roundNumber}`);
                    await roundRef.set({
                        roundNumber: roundNumber,
                        question: question,
                        answers: {},
                        results: null,
                        startedAt: firebase.database.ServerValue.TIMESTAMP,
                        status: 'active'
                    });

                    // Update game current round
                    await this.database.ref(`games/${gameId}/currentRound`).set(roundNumber);
                    
                    console.log(`✅ Round ${roundNumber} started in Firebase`);
                    return true;
                } catch (error) {
                    console.error('❌ Error starting round:', error);
                    throw error;
                }
            }

            // End game
            async endGame(gameId, finalResults) {
                if (!this.isInitialized) throw new Error('Firebase not initialized');

                try {
                    await this.database.ref(`games/${gameId}`).update({
                        gameState: 'finished',
                        finishedAt: firebase.database.ServerValue.TIMESTAMP,
                        finalResults: finalResults
                    });
                    
                    console.log('✅ Game ended in Firebase');
                    return true;
                } catch (error) {
                    console.error('❌ Error ending game:', error);
                    throw error;
                }
            }

            // Listen to game updates
            listenToGame(gameId, callback) {
                if (!this.isInitialized) return null;
                
                const gameRef = this.database.ref(`games/${gameId}`);
                gameRef.on('value', callback);
                return gameRef;
            }

            // Listen to round updates
            listenToRound(gameId, roundNumber, callback) {
                if (!this.isInitialized) return null;
                
                const roundRef = this.database.ref(`games/${gameId}/rounds/${roundNumber}`);
                roundRef.on('value', callback);
                return roundRef;
            }

            // Cleanup
            cleanup() {
                if (this.gameRef) this.gameRef.off();
                if (this.currentRoundRef) this.currentRoundRef.off();
            }
        }

        // ===== GAME STATE MANAGEMENT =====
        class GameState {
            constructor(playerKey = null) {
                this.playerKey = playerKey;
                this.reset();
                this.loadFromStorage();
            }

            reset() {
                this.deviceMode = 'multi';
                this.selectedCategories = [];
                this.difficulty = null;
                this.players = [];
                this.gameId = null;
                this.playerId = null;
                this.playerName = null;
                this.isHost = false;
                this.isGuest = false;
                this.currentQuestionIndex = 0;
                this.gamePhase = 'playing';
                this.timestamp = Date.now();
                this.totalQuestionsPlayed = 0;
                this.gameStats = {
                    totalSips: 0,
                    correctGuesses: 0,
                    totalGuesses: 0
                };
            }

            getStorageKey() {
                if (this.playerKey) {
                    return `denkstdu_game_state_${this.playerKey}`;
                }
                return 'denkstdu_game_state';
            }

            saveToStorage() {
                try {
                    const stateToSave = {
                        deviceMode: this.deviceMode,
                        selectedCategories: this.selectedCategories,
                        difficulty: this.difficulty,
                        players: this.players,
                        gameId: this.gameId,
                        playerId: this.playerId,
                        playerName: this.playerName,
                        isHost: this.isHost,
                        isGuest: this.isGuest,
                        currentQuestionIndex: this.currentQuestionIndex,
                        gamePhase: this.gamePhase,
                        totalQuestionsPlayed: this.totalQuestionsPlayed,
                        gameStats: this.gameStats,
                        timestamp: Date.now(),
                        version: 3,
                        playerKey: this.playerKey
                    };
                    
                    localStorage.setItem(this.getStorageKey(), JSON.stringify(stateToSave));
                    return true;
                } catch (error) {
                    console.error('❌ Failed to save GameState:', error);
                    return false;
                }
            }

            loadFromStorage() {
                try {
                    const saved = localStorage.getItem(this.getStorageKey());
                    if (saved) {
                        const state = JSON.parse(saved);
                        const maxAge = 24 * 60 * 60 * 1000; // 24 hours
                        if (state.timestamp && (Date.now() - state.timestamp) < maxAge) {
                            Object.keys(state).forEach(key => {
                                if (this.hasOwnProperty(key) || ['deviceMode', 'playerKey', 'playerId', 'gameStats', 'totalQuestionsPlayed'].includes(key)) {
                                    this[key] = state[key];
                                }
                            });
                            return true;
                        } else {
                            this.clearStorage();
                        }
                    }
                } catch (error) {
                    console.error('❌ Failed to load GameState:', error);
                    this.clearStorage();
                }
                return false;
            }

            clearStorage() {
                localStorage.removeItem(this.getStorageKey());
            }
        }

        // ===== GLOBAL VARIABLES =====
        let firebaseService = new FirebaseGameService();
        let gameState = null;
        let gameListener = null;
        let roundListener = null;
        let currentGameData = null;
        let currentRoundData = null;
        let currentPlayers = {};
        let currentQuestion = null;
        let userAnswer = null;
        let userEstimation = 1;
        let totalPlayers = 0;
        let currentQuestionNumber = 1;
        let currentPhase = 'question';
        let allTimeStats = {
            totalQuestionsPlayed: 0,
            totalSips: 0,
            correctGuesses: 0,
            playerStats: {}
        };

        // Questions Database
        const questionsDatabase = {
            fsk0: [
                "Ich habe schon mal... ein ganzes Buch an einem Tag gelesen",
                "Ich habe schon mal... Pizza zum Frühstück gegessen",
                "Ich habe schon mal... mehr als 12 Stunden am Stück geschlafen",
                "Ich habe schon mal... einen ganzen Tag im Pyjama verbracht",
                "Ich habe schon mal... beim Kochen das Essen anbrennen lassen",
                "Ich habe schon mal... mein Handy in die Toilette fallen lassen"
            ],
            fsk16: [
                "Ich habe schon mal... heimlich Süßigkeiten vor dem Abendessen gegessen",
                "Ich habe schon mal... so getan, als wäre ich krank, um nicht zur Schule zu müssen",
                "Ich habe schon mal... bis 3 Uhr morgens Netflix geschaut",
                "Ich habe schon mal... ein Lied so laut gesungen, dass die Nachbarn sich beschwert haben",
                "Ich habe schon mal... vergessen, wo ich mein Auto geparkt habe"
            ],
            fsk18: [
                "Ich habe schon mal... an einem öffentlichen Ort Sex gehabt",
                "Ich habe schon mal... eine Affäre gehabt",
                "Ich habe schon mal... in einer Beziehung betrogen",
                "Ich habe schon mal... einen Amateur-Porno gedreht",
                "Ich habe schon mal... einen Porno mit mehreren Personen zusammen angesehen",
                "Ich habe schon mal... Sex gehabt und es danach bereut",
                "Ich habe schon mal... Analsex gehabt",
                "Ich habe schon mal... einen Dreier gehabt",
                "Ich habe schon mal... mich vor Oralsex geekelt",
                "Ich habe schon mal... einen Blowjob gegeben",
                "Ich habe schon mal... einen Blowjob bekommen",
                "Ich habe schon mal... Sperma geschluckt",
                "Ich habe schon mal... Sperma ins Auge bekommen",
                "Ich habe schon mal... während dem Autofahren einen Blowjob bekommen oder gegeben",
                "Ich habe schon mal... im Wald einen geblasen bekommen",
                "Ich habe schon mal... beim Sex kotzen müssen",
                "Ich habe schon mal... beim Sex gelacht",
                "Ich habe schon mal... mich beim Sex im Spiegel beobachtet",
                "Ich habe schon mal... einen Orgasmus gefaked",
                "Ich habe schon mal... mehrere Orgasmen hintereinander gehabt",
                "Ich habe schon mal... für jemanden gestrippt",
                "Ich habe schon mal... bei einer Sex-Hotline angerufen",
                "Ich habe schon mal... für Sex bezahlt",
                "Ich habe schon mal... darüber nachgedacht, für Sex Geld zu verlangen",
                "Ich habe schon mal... Geld oder Geschenke für sexuelle Dienste erhalten",
                "Ich habe schon mal... gesagt bekommen, dass ich zu schnell gekommen bin",
                "Ich habe schon mal... jemanden geschwängert",
                "Ich habe schon mal... einen Vaterschaftstest gemacht",
                "Ich habe schon mal... ein Intim-Piercing gehabt",
                "Ich habe schon mal... Fantasien gehabt, in denen ich gefesselt wurde",
                "Ich habe schon mal... so laut gestöhnt, dass andere mich gehört haben",
                "Ich habe schon mal... wegen eines Sexunfalls ins Krankenhaus gemusst",
                "Ich habe schon mal... das Verlangen gehabt, meinen Partner zu betrügen",
                "Ich habe schon mal... über das Geschlechtsteil des anderen gelacht",
                "Ich habe schon mal... mein Geschlechtsteil mit einem Lineal gemessen",
                "Ich habe schon mal... Lebensmittel beim Sex benutzt",
                "Ich habe schon mal... Lebensmittel zur Selbstbefriedigung verwendet",
                "Ich habe schon mal... eine elektrische Zahnbürste zur Selbstbefriedigung verwendet",
                "Ich habe schon mal... nach dem Trinken keinen hochbekommen",
                "Ich habe schon mal... eine Person geküsst, die gerade mitspielt",
                "Ich habe schon mal... mit mehreren Personen am selben Tag geschlafen",
                "Ich habe schon mal... über die Anzahl meiner Sexualpartner gelogen",
                "Ich habe schon mal... mit mehr als 10 Personen geschlafen",
                "Ich habe schon mal... eine Stellung aus dem Kamasutra ausprobiert",
                "Ich habe schon mal... Sex mit meinem Ex gehabt",
                "Ich habe schon mal... jemanden geküsst, der vergeben war",
                "Ich habe schon mal... Sex mit jemandem gehabt, der vergeben war",
                "Ich habe schon mal... beim Sex den falschen Namen gesagt",
                "Ich habe schon mal... mit jemandem geschlafen, dessen Namen ich nicht kannte",
                "Ich habe schon mal... mit jemandem geschlafen und es danach geleugnet",
                "Ich habe schon mal... heimlich Sexspielzeug gekauft",
                "Ich habe schon mal... während einer Videokonferenz masturbiert",
                "Ich habe schon mal... Sex im Elternhaus gehabt, während die Eltern da waren",
                "Ich habe schon mal... versehentlich einen Sextraum laut ausgesprochen",
                "Ich habe schon mal... beim Sex eingeschlafen",
                "Ich habe schon mal... Sex in einem öffentlichen Verkehrsmittel gehabt",
                "Ich habe schon mal... jemanden beim Masturbieren erwischt",
                "Ich habe schon mal... beim Masturbieren erwischt worden",
                "Ich habe schon mal... Unterwäsche gestohlen",
                "Ich habe schon mal... getragene Unterwäsche geschnüffelt",
                "Ich habe schon mal... Sex im Büro gehabt",
                "Ich habe schon mal... mit einem Prominenten geschlafen",
                "Ich habe schon mal... mit jemandem geschlafen, der doppelt so alt war wie ich",
                "Ich habe schon mal... mit jemandem geschlafen, der halb so alt war wie ich",
                "Ich habe schon mal... Sex mit einem Fremden aus dem Internet gehabt",
                "Ich habe schon mal... bei einem One-Night-Stand einen falschen Namen gegeben",
                "Ich habe schon mal... heimlich Nacktfotos von jemandem gemacht",
                "Ich habe schon mal... meine Nacktfotos an die falsche Person geschickt",
                "Ich habe schon mal... beim Sex geweint",
                "Ich habe schon mal... jemanden zum Orgasmus geleckt",
                "Ich habe schon mal... Sexting mit mehreren Personen gleichzeitig betrieben",
                "Ich habe schon mal... Sex während der Periode gehabt",
                "Ich habe schon mal... beim Sex den Namen meines Ex geschrien",
                "Ich habe schon mal... Sex in einem Fahrstuhl gehabt",
                "Ich habe schon mal... Sex in einem Schwimmbad gehabt",
                "Ich habe schon mal... Sex am Strand gehabt",
                "Ich habe schon mal... Sex in einem Kino gehabt",
                "Ich habe schon mal... beim Sex die Nachbarn geweckt",
                "Ich habe schon mal... mit dem besten Freund/der besten Freundin meines Partners geschlafen",
                "Ich habe schon mal... heimlich die Kondome meines Mitbewohners benutzt",
                "Ich habe schon mal... Sex ohne Verhütung gehabt, obwohl ich hätte verhüten sollen",
                "Ich habe schon mal... beim Sex meinen Körper komplett versteckt",
                "Ich habe schon mal... während eines Dates heimlich gegoogelt, was mein Date mag",
                "Ich habe schon mal... mich vor einem Date rasiert und dann wurde es abgesagt",
                "Ich habe schon mal... einem Partner vorgespielt, dass ich unerfahren bin",
                "Ich habe schon mal... einem Partner vorgespielt, dass ich sehr erfahren bin",
                "Ich habe schon mal... Sex gehabt, nur um den anderen loszuwerden",
                "Ich habe schon mal... mich beim Sex verletzt",
                "Ich habe schon mal... jemanden beim Sex verletzt",
                "Ich habe schon mal... Sex gehabt und dabei an jemand anderen gedacht",
                "Ich habe schon mal... vor dem Sex gelogen, wie viele Partner ich hatte",
                "Ich habe schon mal... Sex gehabt und mich dabei gefilmt",
                "Ich habe schon mal... ein Sexvideo von mir selbst angeschaut",
                "Ich habe schon mal... beim Sex ein Möbelstück kaputt gemacht",
                "Ich habe schon mal... Sex in einem Hotelzimmer gehabt, das nicht meins war",
                "Ich habe schon mal... mich selbst beim Sex im Handy-Display beobachtet",
                "Ich habe schon mal... Sex gehabt, während andere im selben Raum geschlafen haben",
                "Ich habe schon mal... mit einer verheirateten Person geschlafen",
                "Ich habe schon mal... Sex mit dem Kollegen/der Kollegin gehabt",
                "Ich habe schon mal... eine Affäre mit dem Chef/der Chefin gehabt",
                "Ich habe schon mal... Sex am Arbeitsplatz gehabt",
                "Ich habe schon mal... mich über eine Dating-App nur für Sex verabredet",
                "Ich habe schon mal... beim ersten Date Sex gehabt",
                "Ich habe schon mal... Sex mit jemandem gehabt, den ich eigentlich nicht attraktiv fand",
                "Ich habe schon mal... aus Mitleid Sex gehabt",
                "Ich habe schon mal... Sex gehabt, um jemanden eifersüchtig zu machen",
                "Ich habe schon mal... heimlich die Handynachrichten meines Partners gelesen",
                "Ich habe schon mal... meinen Partner beim Fremdgehen erwischt",
                "Ich habe schon mal... beim Fremdgehen erwischt worden",
                "Ich habe schon mal... Sex in einem Auto gehabt",
                "Ich habe schon mal... Sex in der Natur gehabt und dabei fast erwischt worden",
                "Ich habe schon mal... vergessen, wie mein One-Night-Stand hieß",
                "Ich habe schon mal... Sex mit zwei verschiedenen Personen an einem Tag gehabt",
                "Ich habe schon mal... gelogen, dass ich verhüte",
                "Ich habe schon mal... ein Kondom heimlich entfernt",
                "Ich habe schon mal... so getan, als würde ich kommen",
                "Ich habe schon mal... beim Sex an meinen Ex gedacht",
                "Ich habe schon mal... Sex gehabt, obwohl ich eigentlich keine Lust hatte",
                "Ich habe schon mal... eine Geschlechtskrankheit gehabt",
                "Ich habe schon mal... verschwiegen, dass ich eine Geschlechtskrankheit hatte",
                "Ich habe schon mal... mich gefragt, ob ich homosexuell bin",
                "Ich habe schon mal... mit einer Person des gleichen Geschlechts experimentiert",
                "Ich habe schon mal... von einer Person des gleichen Geschlechts geträumt",
                "Ich habe schon mal... einen Fetisch entwickelt",
                "Ich habe schon mal... meinen Fetisch vor meinem Partner verheimlicht",
                "Ich habe schon mal... Sex mit jemandem gehabt, nur um es auszuprobieren"
            ]
        };

        // ===== INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', function() {
            initializeGameplay();
        });

        async function initializeGameplay() {
            console.log('🎮 Initializing multiplayer gameplay...');
            
            // Initialize Firebase
            await firebaseService.initialize();
            
            // Find game state
            gameState = findPlayerGameState();
            
            if (!gameState || !gameState.gameId) {
                console.error('❌ No valid game state found');
                showNotification('Kein gültiges Spiel gefunden. Zurück zur Lobby.', 'error');
                setTimeout(() => {
                    window.location.href = 'multiplayer-lobby.html';
                }, 2000);
                return;
            }

            // Setup Firebase listeners
            if (firebaseService.isInitialized) {
                setupFirebaseListeners();
            } else {
                showNotification('Firebase-Verbindung fehlgeschlagen. Fallback auf lokalen Modus.', 'warning');
                startLocalMode();
            }

            // Initialize UI
            updateGameDisplay();
            createNumberGrid();
            updateSelectedNumber(1);
            updateSubmitButton();
            
            // Load first question
            loadNewQuestion();
            
            // Show host controls if user is host
            if (gameState.isHost) {
                document.getElementById('host-controls').style.display = 'block';
                document.getElementById('player-controls').style.display = 'none';
            } else {
                document.getElementById('host-controls').style.display = 'none';
                document.getElementById('player-controls').style.display = 'block';
            }
            
            console.log('✅ Gameplay initialized for:', {
                playerName: gameState.playerName,
                isHost: gameState.isHost,
                gameId: gameState.gameId,
                firebase: firebaseService.isInitialized
            });
        }

        function findPlayerGameState() {
            // Find the correct GameState instance (same logic as in lobby)
            const keys = Object.keys(localStorage);
            
            // Try host first
            try {
                const mainState = localStorage.getItem('denkstdu_game_state');
                if (mainState) {
                    const state = JSON.parse(mainState);
                    if (state.deviceMode === 'multi' && state.gameId) {
                        return new GameState();
                    }
                }
            } catch (e) {
                // Ignore
            }
            
            // Try guest states
            for (let key of keys) {
                if (key.startsWith('denkstdu_game_state_guest_')) {
                    try {
                        const guestState = JSON.parse(localStorage.getItem(key));
                        if (guestState.deviceMode === 'multi' && guestState.gameId) {
                            const playerKey = key.replace('denkstdu_game_state_', '');
                            return new GameState(playerKey);
                        }
                    } catch (e) {
                        // Ignore
                    }
                }
            }
            
            return null;
        }

        // ===== FIREBASE LISTENERS =====
        function setupFirebaseListeners() {
            console.log('🎧 Setting up Firebase listeners...');
            
            // Setup game reference
            firebaseService.setupGameRef(gameState.gameId);
            
            // Listen to game updates
            gameListener = firebaseService.listenToGame(gameState.gameId, (snapshot) => {
                if (snapshot.exists()) {
                    currentGameData = snapshot.val();
                    console.log('🎮 Game update received:', currentGameData);
                    
                    // Update players list
                    currentPlayers = currentGameData.players || {};
                    updatePlayersCount();
                    
                    // Check for game end
                    if (currentGameData.gameState === 'finished') {
                        handleGameFinished(currentGameData.finalResults);
                    }
                    
                    // Check for new round
                    if (currentGameData.currentRound && currentGameData.currentRound !== currentQuestionNumber) {
                        handleNewRound(currentGameData.currentRound);
                    }
                }
            });
        }

        function setupRoundListener(roundNumber) {
            if (roundListener) {
                roundListener.off();
            }
            
            roundListener = firebaseService.listenToRound(gameState.gameId, roundNumber, (snapshot) => {
                if (snapshot.exists()) {
                    currentRoundData = snapshot.val();
                    console.log(`📊 Round ${roundNumber} update:`, currentRoundData);
                    
                    // Check if all players answered
                    const answers = currentRoundData.answers || {};
                    const answerCount = Object.keys(answers).length;
                    const playerCount = Object.keys(currentPlayers).length;
                    
                    if (answerCount === playerCount && currentPhase === 'waiting') {
                        // All answered, calculate results
                        calculateAndShowResults();
                    }
                    
                    // Update waiting status
                    if (currentPhase === 'waiting') {
                        updateWaitingStatus(answers);
                    }
                }
            });
        }

        function startLocalMode() {
            console.log('🔄 Starting local mode fallback...');
            // For demo purposes, we'll simulate multiplayer with localStorage
            // In a real app, you'd have a different strategy
        }

        // ===== GAME FLOW =====
        function updateGameDisplay() {
            document.getElementById('game-id-display').textContent = gameState.gameId;
            document.getElementById('question-number').textContent = currentQuestionNumber;
        }

        function updatePlayersCount() {
            totalPlayers = Object.keys(currentPlayers).length;
            document.getElementById('players-count').textContent = `${totalPlayers} Spieler`;
            document.getElementById('total-players').textContent = totalPlayers;
            
            // Recreate number grid with new player count
            createNumberGrid();
        }

        function loadNewQuestion() {
            // Get random question from selected categories
            const availableQuestions = [];
            gameState.selectedCategories.forEach(category => {
                if (questionsDatabase[category]) {
                    questionsDatabase[category].forEach(q => {
                        availableQuestions.push({
                            text: q,
                            category: category
                        });
                    });
                }
            });
            
            if (availableQuestions.length === 0) {
                // Fallback
                currentQuestion = {
                    text: "Ich habe schon mal... etwas Interessantes erlebt",
                    category: "fsk0"
                };
            } else {
                currentQuestion = availableQuestions[Math.floor(Math.random() * availableQuestions.length)];
            }
            
            // Update UI
            const categoryNames = {
                'fsk0': '👨‍👩‍👧‍👦 Familie & Freunde',
                'fsk16': '🎉 Party Time',
                'fsk18': '🔥 Heiß & Gewagt'
            };
            
            document.getElementById('question-text').textContent = currentQuestion.text;
            document.getElementById('question-category').textContent = categoryNames[currentQuestion.category] || '🎮 Spiel';
            
            console.log('📝 New question loaded:', currentQuestion);
        }

        function startNewRound() {
            console.log(`🎲 Starting round ${currentQuestionNumber}`);
            
            // Load new question
            loadNewQuestion();
            
            // Reset user inputs
            userAnswer = null;
            userEstimation = Math.min(1, totalPlayers || 1);
            
            // Reset UI
            document.querySelectorAll('.answer-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            updateSelectedNumber(userEstimation);
            updateNumberSelection();
            updateSubmitButton();
            
            // Show question phase
            showPhase('question');
            
            // If Firebase available and host, start round in Firebase
            if (firebaseService.isInitialized && gameState.isHost) {
                firebaseService.startNewRound(gameState.gameId, currentQuestionNumber, currentQuestion);
            }
            
            // Setup round listener
            if (firebaseService.isInitialized) {
                setupRoundListener(currentQuestionNumber);
            }
        }

        function handleNewRound(roundNumber) {
            if (roundNumber > currentQuestionNumber) {
                currentQuestionNumber = roundNumber;
                updateGameDisplay();
                startNewRound();
                showNotification('Neue Frage gestartet! 🎮', 'success');
            }
        }

        // ===== UI CONTROLS =====
        function createNumberGrid() {
            const numberGrid = document.getElementById('number-grid');
            numberGrid.innerHTML = '';

            const maxPlayers = totalPlayers || 8; // Fallback to 8 if no players yet
            for (let i = 0; i <= maxPlayers; i++) {
                const numberBtn = document.createElement('button');
                numberBtn.className = 'number-btn';
                numberBtn.textContent = i;
                numberBtn.onclick = () => selectNumber(i);
                numberBtn.id = `number-btn-${i}`;
                
                numberGrid.appendChild(numberBtn);
            }
            
            updateNumberSelection();
        }

        function selectNumber(number) {
            const maxPlayers = totalPlayers || 8;
            if (number >= 0 && number <= maxPlayers) {
                userEstimation = number;
                updateSelectedNumber(number);
                updateNumberSelection();
                updateSubmitButton();
                
                if (navigator.vibrate) {
                    navigator.vibrate(50);
                }
            }
        }

        function updateSelectedNumber(number) {
            document.getElementById('selected-number').textContent = number;
            
            const selectionDisplay = document.querySelector('.selection-display');
            selectionDisplay.style.transform = 'scale(1.1)';
            setTimeout(() => {
                selectionDisplay.style.transform = 'scale(1)';
            }, 200);
        }

        function updateNumberSelection() {
            document.querySelectorAll('.number-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            const selectedBtn = document.getElementById(`number-btn-${userEstimation}`);
            if (selectedBtn) {
                selectedBtn.classList.add('selected');
            }
        }

        function selectAnswer(answer) {
            userAnswer = answer;
            
            document.querySelectorAll('.answer-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            const selectedBtn = answer ? document.getElementById('yes-btn') : document.getElementById('no-btn');
            selectedBtn.classList.add('selected');
            
            updateSubmitButton();
        }

        function updateSubmitButton() {
            const submitBtn = document.getElementById('submit-btn');
            if (userAnswer !== null) {
                submitBtn.classList.add('enabled');
                submitBtn.disabled = false;
            } else {
                submitBtn.classList.remove('enabled');
                submitBtn.disabled = true;
            }
        }

        // ===== GAME ACTIONS =====
        async function submitAnswers() {
            if (userAnswer === null) {
                showNotification('Bitte wähle eine Antwort aus!', 'warning');
                return;
            }

            console.log('📤 Submitting answers:', {
                answer: userAnswer,
                estimation: userEstimation
            });

            const answerData = {
                playerId: gameState.playerId,
                playerName: gameState.playerName,
                answer: userAnswer,
                estimation: userEstimation,
                isHost: gameState.isHost
            };

            try {
                // Submit to Firebase if available
// Submit to Firebase if available
                if (firebaseService.isInitialized) {
                    await firebaseService.submitAnswer(
                        gameState.gameId, 
                        currentQuestionNumber, 
                        gameState.playerId, 
                        answerData
                    );
                }

                // Update local stats
                gameState.gameStats.totalGuesses++;
                gameState.saveToStorage();

                showNotification('Antworten gesendet! 🎯', 'success');
                
                // Switch to waiting phase
                showPhase('waiting');
                setupRoundListener(currentQuestionNumber);
                
                // If no Firebase, simulate for demo
                if (!firebaseService.isInitialized) {
                    simulateOtherPlayersAnswering();
                }
                
            } catch (error) {
                console.error('❌ Error submitting answers:', error);
                showNotification('Fehler beim Senden der Antworten', 'error');
            }
        }

        function simulateOtherPlayersAnswering() {
            // Fallback simulation when Firebase not available
            console.log('🎭 Simulating other players...');
            
            setTimeout(() => {
                const simulatedAnswers = {};
                const playerNames = ['Host', 'Anna', 'Max', 'Lisa'];
                
                playerNames.forEach((name, index) => {
                    if (name !== gameState.playerName) {
                        simulatedAnswers[`player_${index}`] = {
                            playerName: name,
                            answer: Math.random() > 0.5,
                            estimation: Math.floor(Math.random() * ((totalPlayers || 4) + 1)),
                            isHost: index === 0
                        };
                    }
                });
                
                // Add user's answer
                simulatedAnswers[gameState.playerId || 'user'] = {
                    playerName: gameState.playerName,
                    answer: userAnswer,
                    estimation: userEstimation,
                    isHost: gameState.isHost
                };
                
                currentRoundData = {
                    answers: simulatedAnswers,
                    question: currentQuestion
                };
                
                calculateAndShowResults();
            }, 2000);
        }

        // ===== PHASE MANAGEMENT =====
        function showPhase(phase) {
            document.querySelectorAll('.game-phase').forEach(p => {
                p.classList.remove('active');
            });
            
            document.getElementById(`${phase}-phase`).classList.add('active');
            currentPhase = phase;
            
            console.log(`📍 Phase changed to: ${phase}`);
        }

        // ===== WAITING PHASE =====
        function updateWaitingStatus(answers = {}) {
            const statusContainer = document.getElementById('players-status');
            statusContainer.innerHTML = '';

            Object.values(currentPlayers).forEach(player => {
                const hasAnswered = Object.values(answers).some(a => a.playerName === player.name);
                
                const statusItem = document.createElement('div');
                statusItem.className = 'player-status-item';
                
                const statusIndicator = hasAnswered ? 
                    '<span class="status-indicator status-done">✅ Fertig</span>' :
                    '<span class="status-indicator status-waiting">⏳ Wartet...</span>';
                
                statusItem.innerHTML = `
                    <span>${player.name}</span>
                    ${statusIndicator}
                `;
                
                statusContainer.appendChild(statusItem);
            });
        }

        // ===== RESULTS CALCULATION =====
        function calculateAndShowResults() {
            if (!currentRoundData || !currentRoundData.answers) {
                console.error('❌ No round data available for results');
                return;
            }

            const answers = currentRoundData.answers;
            const actualYesCount = Object.values(answers).filter(a => a.answer === true).length;
            
            // Calculate results for each player
            const results = Object.values(answers).map(playerAnswer => {
                const difference = Math.abs(playerAnswer.estimation - actualYesCount);
                const isCorrect = difference === 0;
                
                // Calculate sips based on difficulty
                let sips = 0;
                if (!isCorrect) {
                    const baseSips = getDifficultyMultiplier();
                    sips = baseSips + Math.floor(difference / 2); // More difference = more sips
                }
                
                return {
                    playerName: playerAnswer.playerName,
                    answer: playerAnswer.answer,
                    estimation: playerAnswer.estimation,
                    difference: difference,
                    isCorrect: isCorrect,
                    sips: sips,
                    isHost: playerAnswer.isHost || false
                };
            });
            
            // Update all-time stats
            updateAllTimeStats(results, actualYesCount);
            
            // Display results
            displayRoundResults(results, actualYesCount);
            showPhase('results');
            
            console.log('📊 Results calculated:', results);
        }

        function getDifficultyMultiplier() {
            switch (gameState.difficulty) {
                case 'easy': return 1;
                case 'hard': return 3;
                default: return 2; // medium
            }
        }

        function updateAllTimeStats(results, actualYesCount) {
            allTimeStats.totalQuestionsPlayed++;
            
            results.forEach(result => {
                // Initialize player stats if not exists
                if (!allTimeStats.playerStats[result.playerName]) {
                    allTimeStats.playerStats[result.playerName] = {
                        totalSips: 0,
                        correctGuesses: 0,
                        totalGuesses: 0,
                        isHost: result.isHost
                    };
                }
                
                const playerStats = allTimeStats.playerStats[result.playerName];
                playerStats.totalSips += result.sips;
                playerStats.totalGuesses++;
                if (result.isCorrect) {
                    playerStats.correctGuesses++;
                }
                
                // Update current player's game state
                if (result.playerName === gameState.playerName) {
                    gameState.gameStats.totalSips += result.sips;
                    gameState.totalQuestionsPlayed++;
                    if (result.isCorrect) {
                        gameState.gameStats.correctGuesses++;
                    }
                    gameState.saveToStorage();
                }
            });
        }

        function displayRoundResults(results, actualYesCount) {
            // Update summary
            document.getElementById('results-round').textContent = currentQuestionNumber;
            document.getElementById('results-summary').textContent = 
                `${actualYesCount} von ${totalPlayers || results.length} Spielern haben mit "Ja" geantwortet`;
            document.getElementById('correct-count').textContent = actualYesCount;

            // Display individual results
            const resultsGrid = document.getElementById('results-grid');
            resultsGrid.innerHTML = '';

            results.forEach(result => {
                const resultItem = document.createElement('div');
                resultItem.className = 'result-item';
                
                const avatar = result.playerName.substring(0, 2).toUpperCase();
                const answerText = result.answer ? 'Ja' : 'Nein';
                const sipsText = result.sips === 0 ? 'Perfekt! 🎯' : `${result.sips} 🍺`;
                const sipsClass = result.sips === 0 ? 'none' : '';

                resultItem.innerHTML = `
                    <div class="player-result">
                        <div class="player-avatar">${avatar}</div>
                        <div class="player-info">
                            <div class="player-name">${result.playerName}</div>
                            <div class="player-answer">${answerText} • Tipp: ${result.estimation}</div>
                        </div>
                    </div>
                    <div class="sips-penalty ${sipsClass}">${sipsText}</div>
                `;

                resultsGrid.appendChild(resultItem);
            });
        }

        // ===== GAME CONTROLS =====
        function nextQuestion() {
            if (!gameState.isHost) {
                showNotification('Nur der Host kann die nächste Frage starten!', 'warning');
                return;
            }

            // Increment question number
            currentQuestionNumber++;
            
            // Reset for next question
            userAnswer = null;
            userEstimation = Math.min(1, totalPlayers || 1);
            
            // Reset UI
            document.querySelectorAll('.answer-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            updateSelectedNumber(userEstimation);
            updateNumberSelection();
            updateSubmitButton();
            updateGameDisplay();
            loadNewQuestion();
            
            // Back to question phase
            showPhase('question');
            
            // If Firebase and host, sync the new round
            if (firebaseService.isInitialized && gameState.isHost) {
                firebaseService.startNewRound(gameState.gameId, currentQuestionNumber, currentQuestion);
            }
            
            showNotification('Neue Frage geladen! 🎮', 'success');
        }

        async function endGame() {
            if (!gameState.isHost) {
                showNotification('Nur der Host kann das Spiel beenden!', 'warning');
                return;
            }

            console.log('🏁 Ending game...');
            
            // Calculate final results
            const finalResults = calculateFinalResults();
            
            try {
                // End game in Firebase if available
                if (firebaseService.isInitialized) {
                    await firebaseService.endGame(gameState.gameId, finalResults);
                }
                
                // Show final results
                showFinalResults(finalResults);
                
            } catch (error) {
                console.error('❌ Error ending game:', error);
                showNotification('Fehler beim Beenden des Spiels', 'error');
            }
        }

        function calculateFinalResults() {
            const playerStats = Object.keys(allTimeStats.playerStats).map(playerName => {
                const stats = allTimeStats.playerStats[playerName];
                const accuracy = stats.totalGuesses > 0 ? 
                    Math.round((stats.correctGuesses / stats.totalGuesses) * 100) : 0;
                
                return {
                    playerName: playerName,
                    totalSips: stats.totalSips,
                    correctGuesses: stats.correctGuesses,
                    totalGuesses: stats.totalGuesses,
                    accuracy: accuracy,
                    score: stats.correctGuesses * 10 - stats.totalSips, // Simple scoring
                    isHost: stats.isHost
                };
            });
            
            // Sort by score (higher is better)
            return playerStats.sort((a, b) => b.score - a.score);
        }

        function showFinalResults(finalResults) {
            // Update final stats
            document.getElementById('total-questions').textContent = allTimeStats.totalQuestionsPlayed;
            document.getElementById('total-players-final').textContent = finalResults.length;
            
            // Build leaderboard
            const leaderboardList = document.getElementById('leaderboard-list');
            leaderboardList.innerHTML = '';
            
            finalResults.forEach((player, index) => {
                const leaderboardItem = document.createElement('div');
                leaderboardItem.className = `leaderboard-item ${index === 0 ? 'winner' : ''}`;
                
                const rankClass = index === 0 ? 'rank-1' : 
                                 index === 1 ? 'rank-2' : 
                                 index === 2 ? 'rank-3' : 'rank-other';
                
                leaderboardItem.innerHTML = `
                    <div class="rank-number ${rankClass}">${index + 1}</div>
                    <div class="player-final-stats">
                        <div class="player-final-name">${player.playerName}</div>
                        <div class="player-final-details">
                            <span>Schlücke: ${player.totalSips}</span>
                            <span>Genauigkeit: ${player.accuracy}%</span>
                            <span>Punkte: ${player.score}</span>
                        </div>
                    </div>
                `;
                
                leaderboardList.appendChild(leaderboardItem);
            });
            
            // Show final results phase
            showPhase('final-results');
            showNotification('Spiel beendet! 🏆', 'success');
        }

        function handleGameFinished(finalResults) {
            if (finalResults) {
                showFinalResults(finalResults);
            } else {
                showNotification('Spiel wurde beendet', 'info');
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 2000);
            }
        }

        function waitForHost() {
            showNotification('Warte auf den Host...', 'info');
        }

        function playAgain() {
            if (confirm('Möchtest du ein neues Spiel starten?')) {
                // Reset all stats
                allTimeStats = {
                    totalQuestionsPlayed: 0,
                    totalSips: 0,
                    correctGuesses: 0,
                    playerStats: {}
                };
                
                currentQuestionNumber = 1;
                
                // Navigate back to lobby
                window.location.href = 'multiplayer-lobby.html';
            }
        }

        function goHome() {
            if (confirm('Spiel wirklich verlassen?')) {
                // Cleanup
                if (gameListener) gameListener.off();
                if (roundListener) roundListener.off();
                firebaseService.cleanup();
                
                window.location.href = 'index.html';
            }
        }

        // ===== CLEANUP =====
        window.addEventListener('beforeunload', function() {
            if (gameListener) gameListener.off();
            if (roundListener) roundListener.off();
            firebaseService.cleanup();
        });

        // ===== UTILITY FUNCTIONS =====
        function showNotification(message, type = 'info') {
            // Remove existing notifications
            document.querySelectorAll('.toast-notification').forEach(n => n.remove());
            
            const notification = document.createElement('div');
            notification.className = `toast-notification ${type}`;
            notification.innerHTML = `
                <div class="toast-content">
                    <div class="toast-icon">${type === 'success' ? '✅' : type === 'warning' ? '⚠️' : type === 'error' ? '❌' : 'ℹ️'}</div>
                    <div class="toast-message">${message}</div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Animate in
            setTimeout(() => notification.classList.add('show'), 100);
            
            // Remove after 4 seconds
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 4000);
        }

        // ===== DEBUG FUNCTIONS =====
        window.debugGameplay = function() {
            console.log('🔍 Gameplay Debug Info:');
            console.log('GameState:', gameState);
            console.log('Firebase Service:', {
                initialized: firebaseService.isInitialized,
                connected: firebaseService.isConnected
            });
            console.log('Current Game Data:', currentGameData);
            console.log('Current Round Data:', currentRoundData);
            console.log('All Time Stats:', allTimeStats);
        };

        window.simulateEndGame = function() {
            if (gameState.isHost) {
                endGame();
            } else {
                console.log('Only host can end the game');
            }
        };

        window.skipToResults = function() {
            userAnswer = true;
            userEstimation = 2;
            simulateOtherPlayersAnswering();
        };

        console.log('✅ Multiplayer Gameplay with Firebase loaded');
        console.log('🎮 Commands:');
        console.log('- debugGameplay() - Show debug info');
        console.log('- simulateEndGame() - End game (host only)');
        console.log('- skipToResults() - Skip to results phase');
    </script>
</body>
</html>