<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>DenkstDu - Multiplayer Gameplay</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800&display=swap" rel="stylesheet">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-x: hidden;
            touch-action: manipulation;
            position: relative;
        }

        /* Background Particles */
        .background-particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: -1;
        }

        .particle {
            position: absolute;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 50%;
            animation: float 15s ease-in-out infinite;
        }

        .particle:nth-child(1) { width: 100px; height: 100px; left: 10%; animation-delay: 0s; }
        .particle:nth-child(2) { width: 60px; height: 60px; left: 80%; animation-delay: 3s; }
        .particle:nth-child(3) { width: 80px; height: 80px; left: 30%; animation-delay: 6s; }
        .particle:nth-child(4) { width: 120px; height: 120px; left: 70%; animation-delay: 9s; }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); opacity: 0.3; }
            25% { transform: translateY(-30px) rotate(90deg); opacity: 0.6; }
            50% { transform: translateY(-60px) rotate(180deg); opacity: 0.3; }
            75% { transform: translateY(-30px) rotate(270deg); opacity: 0.6; }
        }

        /* Connection Status */
        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            padding: 10px 15px;
            color: white;
            font-size: 0.8rem;
            z-index: 1000;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .connection-status.connected {
            border: 1px solid #4CAF50;
            background: rgba(76, 175, 80, 0.2);
        }

        .connection-status.disconnected {
            border: 1px solid #f44336;
            background: rgba(244, 67, 54, 0.2);
        }

        .connection-status.connecting {
            border: 1px solid #ff9800;
            background: rgba(255, 152, 0, 0.2);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .app-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 15px;
            max-width: 450px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        /* Header */
        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(25px);
            border-radius: 25px;
            padding: 18px 25px;
            margin-bottom: 25px;
            border: 1px solid rgba(255, 255, 255, 0.25);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .game-info {
            color: white;
        }

        .game-id {
            font-size: 0.8rem;
            opacity: 0.9;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .question-counter {
            font-size: 1.1rem;
            font-weight: 800;
        }

        .players-online {
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
            font-size: 0.95rem;
            font-weight: 600;
        }

        .online-indicator {
            width: 10px;
            height: 10px;
            background: linear-gradient(45deg, #4CAF50, #8BC34A);
            border-radius: 50%;
            animation: pulse 2s infinite;
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
        }

        /* Game Phases */
        .game-phase {
            display: none;
        }

        .game-phase.active {
            display: block;
        }

        /* Question Card */
        .question-card {
            background: rgba(255, 255, 255, 0.12);
            backdrop-filter: blur(30px);
            border-radius: 30px;
            border: 1px solid rgba(255, 255, 255, 0.25);
            padding: 35px 30px;
            margin-bottom: 30px;
            text-align: center;
            min-height: 180px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.15);
            position: relative;
            overflow: hidden;
        }

        .question-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, #4CAF50, #2196F3, #9C27B0);
            background-size: 200% 100%;
            animation: shimmer 3s ease-in-out infinite;
        }

        @keyframes shimmer {
            0%, 100% { background-position: 200% 0; }
            50% { background-position: -200% 0; }
        }

        .question-category {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.25), rgba(76, 175, 80, 0.35));
            border: 1px solid rgba(76, 175, 80, 0.5);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: 700;
            display: inline-block;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }

        .question-text {
            color: white;
            font-size: 1.3rem;
            font-weight: 700;
            line-height: 1.5;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        /* Answer Section */
        .answer-section {
            margin-bottom: 35px;
        }

        .answer-title {
            color: white;
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 20px;
            text-align: center;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .answer-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .answer-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.25);
            color: white;
            padding: 25px 20px;
            border-radius: 25px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            min-height: 100px;
            backdrop-filter: blur(20px);
            position: relative;
            overflow: hidden;
        }

        .answer-btn:active {
            transform: scale(0.95);
        }

        .answer-btn.selected {
            transform: scale(1.05);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
        }

        .answer-btn.yes.selected {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.3), rgba(76, 175, 80, 0.4));
            border-color: #4CAF50;
            box-shadow: 0 15px 40px rgba(76, 175, 80, 0.3);
        }

        .answer-btn.no.selected {
            background: linear-gradient(135deg, rgba(244, 67, 54, 0.3), rgba(244, 67, 54, 0.4));
            border-color: #f44336;
            box-shadow: 0 15px 40px rgba(244, 67, 54, 0.3);
        }

        .answer-emoji {
            font-size: 2rem;
        }

        /* Estimation Section */
        .estimation-section {
            background: rgba(255, 255, 255, 0.12);
            backdrop-filter: blur(30px);
            border-radius: 25px;
            padding: 30px 25px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.25);
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.1);
        }

        .estimation-title {
            color: white;
            font-size: 1.2rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 30px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        /* Number Grid */
        .number-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
            justify-items: center;
        }

        .number-btn {
            width: 60px;
            height: 60px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.25);
            color: white;
            border-radius: 50%;
            font-size: 1.2rem;
            font-weight: 800;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            backdrop-filter: blur(20px);
        }

        .number-btn:active {
            transform: scale(0.9);
        }

        .number-btn.selected {
            background: linear-gradient(135deg, #4CAF50, #2196F3);
            border-color: #4CAF50;
            transform: scale(1.1);
            box-shadow: 0 10px 30px rgba(76, 175, 80, 0.4);
            color: white;
        }

        /* Current Selection Display */
        .current-selection {
            text-align: center;
            margin-bottom: 25px;
        }

        .selection-display {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 20px;
            display: inline-block;
            min-width: 200px;
        }

        .selection-number {
            color: white;
            font-size: 2.5rem;
            font-weight: 800;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            margin-bottom: 5px;
        }

        .selection-label {
            color: rgba(255, 255, 255, 0.8);
            font-size: 1rem;
            font-weight: 600;
        }

        /* Submit Button */
        .submit-section {
            margin-bottom: 30px;
        }

        .submit-btn {
            width: 100%;
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 22px;
            border-radius: 25px;
            font-size: 1.3rem;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            opacity: 0.4;
            transform: scale(0.95);
            box-shadow: 0 10px 30px rgba(76, 175, 80, 0.2);
        }

        .submit-btn.enabled {
            opacity: 1;
            transform: scale(1);
            box-shadow: 0 15px 40px rgba(76, 175, 80, 0.4);
        }

        .submit-btn.enabled:active {
            transform: scale(0.98);
        }

        /* Waiting Phase */
        .waiting-screen {
            text-align: center;
            padding: 60px 20px;
        }

        .waiting-spinner {
            width: 100px;
            height: 100px;
            border: 8px solid rgba(255, 255, 255, 0.1);
            border-top: 8px solid #4CAF50;
            border-radius: 50%;
            animation: spin 1.5s linear infinite;
            margin: 0 auto 40px;
            box-shadow: 0 0 30px rgba(76, 175, 80, 0.3);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .waiting-title {
            color: white;
            font-size: 1.6rem;
            font-weight: 800;
            margin-bottom: 20px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .waiting-description {
            color: rgba(255, 255, 255, 0.8);
            font-size: 1.1rem;
            line-height: 1.6;
            font-weight: 500;
            margin-bottom: 30px;
        }

        .players-status {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 25px;
            margin: 30px 0;
        }

        .player-status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            color: white;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .player-status-item:last-child {
            border-bottom: none;
        }

        .status-indicator {
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-done {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
        }

        .status-waiting {
            background: rgba(255, 152, 0, 0.3);
            border: 1px solid #ff9800;
            color: #ff9800;
        }

        /* Results Phase */
        .results-screen {
            padding: 20px 0;
        }

        .results-header {
            background: rgba(255, 255, 255, 0.12);
            backdrop-filter: blur(30px);
            border-radius: 25px;
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.25);
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.1);
        }

        .results-title {
            color: white;
            font-size: 1.6rem;
            font-weight: 800;
            margin-bottom: 15px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .results-summary {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .correct-answer {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.3), rgba(76, 175, 80, 0.4));
            border: 1px solid #4CAF50;
            border-radius: 15px;
            padding: 15px;
            color: white;
            font-weight: 700;
            font-size: 1.1rem;
        }

        .results-grid {
            display: grid;
            gap: 18px;
            margin-bottom: 30px;
        }

        .result-item {
            background: rgba(255, 255, 255, 0.12);
            backdrop-filter: blur(30px);
            border-radius: 20px;
            padding: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid rgba(255, 255, 255, 0.25);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .player-result {
            display: flex;
            align-items: center;
            gap: 18px;
        }

        .player-avatar {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 800;
            font-size: 1.1rem;
            box-shadow: 0 5px 20px rgba(79, 172, 254, 0.3);
        }

        .player-info {
            color: white;
        }

        .player-name {
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .player-answer {
            font-size: 0.9rem;
            opacity: 0.8;
            font-weight: 500;
        }

        .sips-penalty {
            background: linear-gradient(135deg, rgba(244, 67, 54, 0.3), rgba(244, 67, 54, 0.4));
            border: 1px solid #f44336;
            color: #f44336;
            padding: 10px 18px;
            border-radius: 20px;
            font-weight: 800;
            font-size: 0.95rem;
            box-shadow: 0 5px 15px rgba(244, 67, 54, 0.2);
        }

        .sips-penalty.none {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.3), rgba(76, 175, 80, 0.4));
            border-color: #4CAF50;
            color: #4CAF50;
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.2);
        }

        /* Host Controls */
        .host-controls {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(255, 215, 0, 0.15));
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 25px;
            backdrop-filter: blur(20px);
        }

        .host-title {
            color: #FFD700;
            font-weight: 800;
            font-size: 1.1rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        /* Navigation Buttons */
        .nav-buttons {
            display: grid;
            gap: 18px;
            margin-top: 25px;
        }

        .nav-btn {
            padding: 20px;
            border-radius: 20px;
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .nav-btn.primary {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
        }

        .nav-btn.secondary {
            background: rgba(255, 255, 255, 0.12);
            border: 2px solid rgba(255, 255, 255, 0.25);
            color: white;
            backdrop-filter: blur(20px);
        }

        .nav-btn.danger {
            background: linear-gradient(135deg, #f44336, #d32f2f);
            color: white;
        }

        .nav-btn:active {
            transform: scale(0.98);
        }

        /* Toast Notifications */
        .toast-notification {
            position: fixed;
            top: 90px;
            left: 15px;
            right: 15px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(25px);
            border: 1px solid rgba(255, 255, 255, 0.25);
            border-radius: 20px;
            padding: 20px;
            z-index: 10000;
            opacity: 0;
            transform: translateY(-50px);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            max-width: 450px;
            margin: 0 auto;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
        }

        .toast-notification.show {
            opacity: 1;
            transform: translateY(0);
        }

        .toast-notification.success {
            border-color: rgba(76, 175, 80, 0.5);
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.15), rgba(76, 175, 80, 0.25));
        }

        .toast-notification.warning {
            border-color: rgba(255, 152, 0, 0.5);
            background: linear-gradient(135deg, rgba(255, 152, 0, 0.15), rgba(255, 152, 0, 0.25));
        }

        .toast-notification.error {
            border-color: rgba(244, 67, 54, 0.5);
            background: linear-gradient(135deg, rgba(244, 67, 54, 0.15), rgba(244, 67, 54, 0.25));
        }

        .toast-content {
            display: flex;
            align-items: center;
            gap: 15px;
            color: white;
        }

        .toast-icon {
            font-size: 1.5rem;
        }

        .toast-message {
            font-weight: 600;
            font-size: 0.95rem;
            line-height: 1.4;
        }

        /* Responsive Design */
        @media (max-width: 480px) {
            .app-container {
                padding: 12px;
            }

            .question-text {
                font-size: 1.2rem;
            }

            .number-btn {
                width: 50px;
                height: 50px;
                font-size: 1.1rem;
            }

            .connection-status {
                top: 15px;
                right: 15px;
                font-size: 0.7rem;
                padding: 8px 12px;
            }
        }

        /* Animations */
        .fadeInUp {
            animation: fadeInUp 0.6s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .loading-screen.show {
            opacity: 1;
            visibility: visible;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        .loading-text {
            color: white;
            font-size: 1.1rem;
            font-weight: 600;
        }
    </style>
</head>
<body>
<!-- Background Particles -->
<div class="background-particles">
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
</div>

<!-- Loading Screen -->
<div class="loading-screen" id="loading-screen">
    <div class="loading-spinner"></div>
    <div class="loading-text">Lade Spiel...</div>
</div>

<!-- Connection Status -->
<div class="connection-status connecting" id="connection-status" onclick="retryConnection()">
    üîÑ Verbinde...
</div>

<!-- App Container -->
<div class="app-container">
    <!-- Game Header -->
    <div class="game-header fadeInUp">
        <div class="game-info">
            <div class="game-id">ID: <span id="game-id-display">LOADING</span></div>
            <div class="question-counter">Frage <span id="question-number">1</span></div>
        </div>
        <div class="players-online">
            <div class="online-indicator"></div>
            <span id="players-count">0 Spieler</span>
        </div>
    </div>

    <!-- PHASE 1: Question & Answer -->
    <div class="game-phase active" id="question-phase">
        <!-- Question Card -->
        <div class="question-card fadeInUp">
            <div class="question-category" id="question-category">
                üéÆ Loading...
            </div>
            <div class="question-text" id="question-text">
                Lade Frage...
            </div>
        </div>

        <!-- Answer Section -->
        <div class="answer-section fadeInUp">
            <div class="answer-title">ü§î Deine Antwort</div>
            <div class="answer-buttons">
                <button class="answer-btn yes" onclick="selectAnswer(true)" id="yes-btn">
                    <div class="answer-emoji">‚úÖ</div>
                    <div>Ja, habe ich</div>
                </button>
                <button class="answer-btn no" onclick="selectAnswer(false)" id="no-btn">
                    <div class="answer-emoji">‚ùå</div>
                    <div>Nein, noch nie</div>
                </button>
            </div>
        </div>

        <!-- Estimation Section -->
        <div class="estimation-section fadeInUp">
            <div class="estimation-title">üéØ Wie viele antworten mit "Ja"?</div>

            <!-- Current Selection Display -->
            <div class="current-selection">
                <div class="selection-display">
                    <div class="selection-number" id="selected-number">1</div>
                    <div class="selection-label">von <span id="total-players">0</span> Spielern</div>
                </div>
            </div>

            <!-- Number Grid -->
            <div class="number-grid" id="number-grid">
                <!-- Numbers will be generated dynamically -->
            </div>
        </div>

        <!-- Submit Button -->
        <div class="submit-section fadeInUp">
            <button class="submit-btn" onclick="submitAnswers()" id="submit-btn">
                üì§ Antworten absenden
            </button>
        </div>
    </div>

    <!-- PHASE 2: Waiting for Others -->
    <div class="game-phase" id="waiting-phase">
        <div class="waiting-screen">
            <div class="waiting-spinner"></div>
            <div class="waiting-title">‚è≥ Warten auf andere Spieler</div>
            <div class="waiting-description">
                Deine Antworten wurden gesendet.<br>
                Warte, bis alle anderen geantwortet haben.
            </div>

            <div class="players-status" id="players-status">
                <!-- Player status will be populated dynamically -->
            </div>
        </div>
    </div>

    <!-- PHASE 3: Round Results -->
    <div class="game-phase" id="results-phase">
        <div class="results-screen">
            <div class="results-header fadeInUp">
                <div class="results-title">üìä Ergebnis Frage <span id="results-round">1</span></div>
                <div class="results-summary" id="results-summary">
                    Berechne Ergebnisse...
                </div>
                <div class="correct-answer">
                    ‚úÖ Korrekte Antwort: <span id="correct-count">0</span> Spieler
                </div>
            </div>

            <div class="results-grid fadeInUp" id="results-grid">
                <!-- Results will be populated dynamically -->
            </div>

            <!-- Host Controls (only visible for host) -->
            <div class="host-controls fadeInUp" id="host-controls" style="display: none;">
                <div class="host-title">
                    üëë Host-Kontrollen
                </div>
                <div class="nav-buttons">
                    <button class="nav-btn primary" onclick="nextQuestion()">
                        ‚û°Ô∏è N√§chste Frage
                    </button>
                    <button class="nav-btn secondary" onclick="goBack()">
                        üè† Zur Lobby
                    </button>
                </div>
            </div>

            <!-- Player Controls (for non-hosts) -->
            <div class="nav-buttons fadeInUp" id="player-controls">
                <button class="nav-btn secondary" onclick="waitForHost()">
                    ‚è≥ Warten auf Host...
                </button>
            </div>
        </div>
    </div>
</div>

<script>

    class GameState {
        constructor() {
            this.deviceMode = null;
            this.selectedCategories = [];
            this.difficulty = null;
            this.playerName = '';
            this.gameId = null;
            this.playerId = null;
            this.isHost = false;
            this.isGuest = false;
            this.gamePhase = 'playing';
            this.timestamp = Date.now();
            this.load();
        }

        load() {
            try {
                const saved = localStorage.getItem('denkstdu_game_state');
                if (saved) {
                    const state = JSON.parse(saved);
                    if (state.timestamp && Date.now() - state.timestamp < 24 * 60 * 60 * 1000) {
                        Object.assign(this, state);
                        this.log('‚úÖ State loaded');
                    }
                }
            } catch (error) {
                this.log(`‚ùå Load failed: ${error.message}`, 'error');
            }
        }

        save() {
            try {
                const state = {
                    deviceMode: this.deviceMode,
                    selectedCategories: this.selectedCategories,
                    difficulty: this.difficulty,
                    playerName: this.playerName,
                    gameId: this.gameId,
                    playerId: this.playerId,
                    isHost: this.isHost,
                    isGuest: this.isGuest,
                    gamePhase: this.gamePhase,
                    timestamp: Date.now(),
                    version: 3
                };
                localStorage.setItem('denkstdu_game_state', JSON.stringify(state));
                this.log('‚úÖ State saved');
                return true;
            } catch (error) {
                this.log(`‚ùå Save failed: ${error.message}`, 'error');
                return false;
            }
        }

        log(message, type = 'info') {
            console.log(`[GameState] ${message}`);
        }
    }

    // ===== FIREBASE SERVICE CLASS =====
    class FirebaseGameService {
        constructor() {
            this.app = null;
            this.database = null;
            this.isInitialized = false;
            this.isConnected = false;
            this.listeners = [];
            this.connectionListeners = [];
            this.retryAttempts = 0;
            this.maxRetries = 3;

            this.config = {
                apiKey: "AIzaSyC_cu_2X2uFCPcxYetxIUHi2v56F1Mz0Vk",
                authDomain: "denkstduwebsite.firebaseapp.com",
                databaseURL: "https://denkstduwebsite-default-rtdb.europe-west1.firebasedatabase.app",
                projectId: "denkstduwebsite",
                storageBucket: "denkstduwebsite.appspot.com",
                messagingSenderId: "27029260611",
                appId: "1:27029260611:web:3c7da4db0bf92e8ce247f6",
                measurementId: "G-BNKNW95HK8"
            };
        }

        async initialize() {
            try {
                this.log('üî• Firebase Service - Initialisierung...');

                if (typeof firebase === 'undefined') {
                    throw new Error('Firebase SDK nicht geladen');
                }

                if (!firebase.apps || firebase.apps.length === 0) {
                    this.app = firebase.initializeApp(this.config);
                } else {
                    this.app = firebase.app();
                }

                this.database = firebase.database();
                await new Promise(resolve => setTimeout(resolve, 300));

                this.isConnected = await this.testConnectionWithTimeout(10000);

                if (this.isConnected) {
                    this.log('‚úÖ Firebase-Verbindung erfolgreich!');
                    this.setupConnectionMonitoring();
                    this.isInitialized = true;
                    this.retryAttempts = 0;
                } else {
                    this.log('‚ö†Ô∏è Firebase-Verbindung fehlgeschlagen', 'warning');
                    this.isInitialized = false;
                }

                return this.isInitialized;

            } catch (error) {
                this.log(`‚ùå Firebase Initialisierung fehlgeschlagen: ${error.message}`, 'error');
                this.isInitialized = false;
                this.isConnected = false;
                return false;
            }
        }

        async testConnectionWithTimeout(timeout = 10000) {
            return new Promise(async (resolve) => {
                const timeoutId = setTimeout(() => {
                    this.log('‚ö†Ô∏è Verbindungstest Timeout', 'warning');
                    resolve(false);
                }, timeout);

                try {
                    const connectedRef = this.database.ref('.info/connected');
                    const snapshot = await connectedRef.once('value');
                    clearTimeout(timeoutId);
                    const connected = snapshot.val() === true;
                    resolve(connected);
                } catch (error) {
                    clearTimeout(timeoutId);
                    resolve(false);
                }
            });
        }

        setupConnectionMonitoring() {
            try {
                const connectedRef = this.database.ref('.info/connected');

                const connectionListener = connectedRef.on('value', (snapshot) => {
                    const wasConnected = this.isConnected;
                    this.isConnected = snapshot.val() === true;

                    if (wasConnected !== this.isConnected) {
                        this.log(`üîÑ Verbindungsstatus: ${this.isConnected ? 'Verbunden ‚úÖ' : 'Getrennt ‚ùå'}`);
                        this.notifyConnectionChange(this.isConnected);
                    }
                });

                this.listeners.push({ ref: connectedRef, listener: connectionListener });

            } catch (error) {
                this.log(`‚ùå Fehler beim Setup: ${error.message}`, 'error');
            }
        }

        async retry() {
            if (this.retryAttempts < this.maxRetries) {
                this.retryAttempts++;
                this.log(`üîÑ Verbindungsversuch ${this.retryAttempts}/${this.maxRetries}...`);
                return await this.initialize();
            }
            return false;
        }

        onConnectionChange(callback) {
            this.connectionListeners.push(callback);
        }

        notifyConnectionChange(connected) {
            this.connectionListeners.forEach(callback => {
                try {
                    callback(connected);
                } catch (error) {
                    this.log(`‚ùå Fehler beim Benachrichtigen: ${error.message}`, 'error');
                }
            });
        }

        async getGameData(gameId) {
            if (!this.isConnected || !gameId) return null;

            try {
                const gameRef = this.database.ref(`games/${gameId}`);
                const snapshot = await gameRef.once('value');
                return snapshot.exists() ? snapshot.val() : null;
            } catch (error) {
                this.log(`‚ùå Fehler beim Laden: ${error.message}`, 'error');
                return null;
            }
        }

        listenToGame(gameId, callback) {
            if (!this.isConnected || !gameId) return null;

            try {
                const gameRef = this.database.ref(`games/${gameId}`);
                gameRef.on('value', callback);
                this.listeners.push({ ref: gameRef, type: 'game' });
                return gameRef;
            } catch (error) {
                this.log(`‚ùå Fehler beim Game Listener: ${error.message}`, 'error');
                return null;
            }
        }

        listenToRound(gameId, roundNumber, callback) {
            if (!this.isConnected || !gameId) return null;

            try {
                const roundRef = this.database.ref(`games/${gameId}/rounds/round_${roundNumber}`);
                roundRef.on('value', callback);
                this.listeners.push({ ref: roundRef, type: 'round' });
                return roundRef;
            } catch (error) {
                this.log(`‚ùå Fehler beim Round Listener: ${error.message}`, 'error');
                return null;
            }
        }

        async startNewRound(gameId, roundNumber, question) {
            if (!this.isConnected) return false;

            try {
                const roundRef = this.database.ref(`games/${gameId}/rounds/round_${roundNumber}`);
                await roundRef.set({
                    question: question,
                    answers: {},
                    startedAt: firebase.database.ServerValue.TIMESTAMP
                });

                const gameRef = this.database.ref(`games/${gameId}`);
                await gameRef.update({
                    currentRound: roundNumber,
                    lastUpdate: firebase.database.ServerValue.TIMESTAMP
                });

                this.log(`‚úÖ Round ${roundNumber} started`);
                return true;
            } catch (error) {
                this.log(`‚ùå Fehler beim Starten der Runde: ${error.message}`, 'error');
                return false;
            }
        }

        async submitAnswer(gameId, roundNumber, playerId, answerData) {
            if (!this.isConnected) throw new Error('Keine Firebase-Verbindung');

            try {
                const answerRef = this.database.ref(`games/${gameId}/rounds/round_${roundNumber}/answers/${playerId}`);
                await answerRef.set({
                    ...answerData,
                    submittedAt: firebase.database.ServerValue.TIMESTAMP
                });

                this.log(`‚úÖ Answer submitted for round ${roundNumber}`);
                return true;
            } catch (error) {
                this.log(`‚ùå Fehler beim Absenden: ${error.message}`, 'error');
                throw error;
            }
        }

        cleanup() {
            this.log('üßπ Cleanup...');

            this.listeners.forEach(({ ref }) => {
                try {
                    ref.off();
                } catch (error) {
                    this.log(`‚ùå Fehler beim Entfernen: ${error.message}`, 'error');
                }
            });

            this.listeners = [];
            this.connectionListeners = [];
            this.log('‚úÖ Cleanup abgeschlossen');
        }

        get isReady() {
            return this.isInitialized && this.isConnected;
        }

        log(message, type = 'info') {
            const colors = {
                info: '#4488ff',
                warning: '#ffaa00',
                error: '#ff4444',
                success: '#00ff00'
            };
            console.log(`%c[Firebase] ${message}`, `color: ${colors[type] || colors.info}`);
        }
    }

    // ===== QUESTIONS DATABASE =====
    const questionsDatabase = {
        fsk0: [
            "Ich habe schon mal... ein ganzes Buch an einem Tag gelesen",
            "Ich habe schon mal... Pizza zum Fr√ºhst√ºck gegessen",
            "Ich habe schon mal... mehr als 12 Stunden am St√ºck geschlafen",
            "Ich habe schon mal... einen ganzen Tag im Pyjama verbracht",
            "Ich habe schon mal... beim Kochen das Essen anbrennen lassen",
            "Ich habe schon mal... mein Handy in die Toilette fallen lassen"
        ],
        fsk16: [
            "Ich habe schon mal... heimlich S√º√üigkeiten vor dem Abendessen gegessen",
            "Ich habe schon mal... so getan, als w√§re ich krank, um nicht zur Schule zu m√ºssen",
            "Ich habe schon mal... bis 3 Uhr morgens Netflix geschaut",
            "Ich habe schon mal... ein Lied so laut gesungen, dass die Nachbarn sich beschwert haben",
            "Ich habe schon mal... vergessen, wo ich mein Auto geparkt habe"
        ],
        fsk18: [
            "Ich habe schon mal... an einem √∂ffentlichen Ort Sex gehabt",
            "Ich habe schon mal... eine Aff√§re gehabt",
            "Ich habe schon mal... in einer Beziehung betrogen",
            "Ich habe schon mal... Sex mit jemandem gehabt, nur um es auszuprobieren"
        ]
    };

    // ===== GLOBAL VARIABLES =====
    let gameState = null;
    let firebaseService = null;
    let gameListener = null;
    let roundListener = null;
    let currentGameData = null;
    let currentRoundData = null;
    let currentPlayers = {};
    let currentQuestion = null;
    let userAnswer = null;
    let userEstimation = 1;
    let totalPlayers = 0;
    let currentQuestionNumber = 1;
    let currentPhase = 'question';

    const categoryNames = {
        'fsk0': 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Familie & Freunde',
        'fsk16': 'üéâ Party Time',
        'fsk18': 'üî• Hei√ü & Gewagt'
    };

    const difficultyMultipliers = {
        'easy': 1,
        'medium': 2,
        'hard': 3
    };

    // ===== INITIALIZATION =====
    document.addEventListener('DOMContentLoaded', function() {
        initializeGameplay();
    });

    async function initializeGameplay() {
        log('üéÆ Initializing multiplayer gameplay...');
        showLoading();

        // Initialize services
        gameState = new GameState();
        firebaseService = new FirebaseGameService();

        // Validate state
        if (!gameState.gameId || gameState.deviceMode !== 'multi') {
            log('‚ùå Invalid game state', 'error');
            showNotification('Kein g√ºltiges Spiel gefunden', 'error');
            setTimeout(() => {
                window.location.href = 'index.html';
            }, 2000);
            return;
        }

        // Initialize Firebase
        updateConnectionStatus('connecting', 'üîÑ Verbinde...');
        await new Promise(resolve => setTimeout(resolve, 500));

        let firebaseReady = await firebaseService.initialize();

        if (!firebaseReady) {
            await new Promise(resolve => setTimeout(resolve, 1000));
            firebaseReady = await firebaseService.retry();
        }

        if (firebaseReady) {
            updateConnectionStatus('connected', '‚úÖ Verbunden');
            setupConnectionStatus();
            await setupFirebaseListeners();
        } else {
            updateConnectionStatus('disconnected', '‚ö†Ô∏è Offline');
            showNotification('Firebase-Verbindung fehlgeschlagen', 'error');
        }

        // Initialize UI
        updateGameDisplay();
        createNumberGrid();
        updateSelectedNumber(1);
        updateSubmitButton();

        // Show/hide host controls
        if (gameState.isHost) {
            document.getElementById('host-controls').style.display = 'block';
            document.getElementById('player-controls').style.display = 'none';
        } else {
            document.getElementById('host-controls').style.display = 'none';
            document.getElementById('player-controls').style.display = 'block';
        }

        hideLoading();
        log('‚úÖ Gameplay initialized');
    }

    async function retryConnection() {
        if (!firebaseService || firebaseService.isConnected) return;

        log('üîÑ Neu-Verbindung...');
        updateConnectionStatus('connecting', 'üîÑ Neu-Verbindung...');

        const success = await firebaseService.retry();

        if (success) {
            updateConnectionStatus('connected', '‚úÖ Verbunden');
            showNotification('Verbindung wiederhergestellt!', 'success');
            await setupFirebaseListeners();
        } else {
            updateConnectionStatus('disconnected', '‚ùå Verbindung fehlgeschlagen');
            showNotification('Verbindung fehlgeschlagen', 'error');
        }
    }

    function setupConnectionStatus() {
        firebaseService.onConnectionChange((connected) => {
            updateConnectionStatus(
                connected ? 'connected' : 'disconnected',
                connected ? '‚úÖ Verbunden' : '‚ö†Ô∏è Offline'
            );

            if (connected) {
                showNotification('Verbindung wiederhergestellt!', 'success');
                setupFirebaseListeners();
            }
        });
    }

    // ===== FIREBASE LISTENERS =====
    async function setupFirebaseListeners() {
        if (!firebaseService.isReady || !gameState.gameId) {
            log('‚ö†Ô∏è Cannot setup listeners - Firebase not ready');
            return;
        }

        log('üéß Setting up Firebase listeners...');

        // Listen to game updates
        gameListener = firebaseService.listenToGame(gameState.gameId, (snapshot) => {
            if (snapshot.exists()) {
                currentGameData = snapshot.val();
                log('üéÆ Game update received');

                // Update players
                currentPlayers = currentGameData.players || {};
                updatePlayersCount();

                // Check for round changes
                if (currentGameData.currentRound && currentGameData.currentRound !== currentQuestionNumber) {
                    handleNewRound(currentGameData.currentRound);
                }
            }
        });

        // Load initial game data
        const initialData = await firebaseService.getGameData(gameState.gameId);
        if (initialData) {
            currentGameData = initialData;
            currentPlayers = initialData.players || {};
            updatePlayersCount();

            // If game has a current round, load it
            if (initialData.currentRound) {
                currentQuestionNumber = initialData.currentRound;
                updateGameDisplay();
                await loadRoundFromFirebase(currentQuestionNumber);
            } else if (gameState.isHost) {
                // Host starts the first round
                await startNewRound();
            }
        } else if (gameState.isHost) {
            // Host starts the first round
            await startNewRound();
        }

        log('‚úÖ Firebase listeners setup complete');
    }

    async function loadRoundFromFirebase(roundNumber) {
        if (!firebaseService.isReady) return;

        try {
            const roundRef = firebaseService.database.ref(`games/${gameState.gameId}/rounds/round_${roundNumber}`);
            const snapshot = await roundRef.once('value');

            if (snapshot.exists()) {
                const roundData = snapshot.val();
                currentQuestion = roundData.question;

                if (currentQuestion) {
                    displayQuestion(currentQuestion);

                    // Setup round listener
                    setupRoundListener(roundNumber);
                }
            }
        } catch (error) {
            log(`‚ùå Error loading round: ${error.message}`, 'error');
        }
    }

    function setupRoundListener(roundNumber) {
        if (roundListener) {
            try {
                roundListener.off();
            } catch (e) {}
        }

        roundListener = firebaseService.listenToRound(gameState.gameId, roundNumber, (snapshot) => {
            if (snapshot.exists()) {
                currentRoundData = snapshot.val();
                log(`üìä Round ${roundNumber} update`);

                // Check if all players answered
                const answers = currentRoundData.answers || {};
                const answerCount = Object.keys(answers).length;
                const playerCount = Object.keys(currentPlayers).length;

                log(`Answers: ${answerCount}/${playerCount}`);

                if (answerCount === playerCount && currentPhase === 'waiting') {
                    // All answered, calculate results
                    calculateAndShowResults();
                }

                // Update waiting status
                if (currentPhase === 'waiting') {
                    updateWaitingStatus(answers);
                }
            }
        });
    }

    function handleNewRound(roundNumber) {
        if (roundNumber > currentQuestionNumber) {
            currentQuestionNumber = roundNumber;
            updateGameDisplay();
            loadRoundFromFirebase(roundNumber);
            resetForNewQuestion();
            showPhase('question');
            showNotification('Neue Frage gestartet! üéÆ', 'success');
        }
    }

    // ===== GAME FLOW =====
    async function startNewRound() {
        if (!gameState.isHost) return;

        log(`üé≤ Starting round ${currentQuestionNumber}`);

        // Generate new question
        currentQuestion = generateRandomQuestion();

        // Display question
        displayQuestion(currentQuestion);

        // Start round in Firebase
        if (firebaseService.isReady) {
            await firebaseService.startNewRound(gameState.gameId, currentQuestionNumber, currentQuestion);
            setupRoundListener(currentQuestionNumber);
        }

        log('‚úÖ New round started');
    }

    function generateRandomQuestion() {
        const availableQuestions = [];

        gameState.selectedCategories.forEach(category => {
            if (questionsDatabase[category]) {
                questionsDatabase[category].forEach(q => {
                    availableQuestions.push({
                        text: q,
                        category: category
                    });
                });
            }
        });

        if (availableQuestions.length === 0) {
            return {
                text: "Ich habe schon mal... etwas Interessantes erlebt",
                category: "fsk0"
            };
        }

        return availableQuestions[Math.floor(Math.random() * availableQuestions.length)];
    }

    function displayQuestion(question) {
        if (!question) return;

        document.getElementById('question-text').textContent = question.text;
        document.getElementById('question-category').textContent = categoryNames[question.category] || 'üéÆ Spiel';

        log('üìù Question displayed:', question.text);
    }

    function resetForNewQuestion() {
        userAnswer = null;
        userEstimation = Math.min(1, totalPlayers || 1);

        document.querySelectorAll('.answer-btn').forEach(btn => {
            btn.classList.remove('selected');
        });

        updateSelectedNumber(userEstimation);
        updateNumberSelection();
        updateSubmitButton();
    }

    // ===== UI FUNCTIONS =====
    function updateGameDisplay() {
        document.getElementById('game-id-display').textContent = gameState.gameId;
        document.getElementById('question-number').textContent = currentQuestionNumber;
    }

    function updatePlayersCount() {
        totalPlayers = Object.keys(currentPlayers).length;
        document.getElementById('players-count').textContent = `${totalPlayers} Spieler`;
        document.getElementById('total-players').textContent = totalPlayers;

        // Recreate number grid
        createNumberGrid();
    }

    function createNumberGrid() {
        const numberGrid = document.getElementById('number-grid');
        numberGrid.innerHTML = '';

        const maxPlayers = totalPlayers || 8;
        for (let i = 0; i <= maxPlayers; i++) {
            const numberBtn = document.createElement('button');
            numberBtn.className = 'number-btn';
            numberBtn.textContent = i;
            numberBtn.onclick = () => selectNumber(i);
            numberBtn.id = `number-btn-${i}`;

            numberGrid.appendChild(numberBtn);
        }

        updateNumberSelection();
    }

    function selectNumber(number) {
        const maxPlayers = totalPlayers || 8;
        if (number >= 0 && number <= maxPlayers) {
            userEstimation = number;
            updateSelectedNumber(number);
            updateNumberSelection();
            updateSubmitButton();
        }
    }

    function updateSelectedNumber(number) {
        document.getElementById('selected-number').textContent = number;
    }

    function updateNumberSelection() {
        document.querySelectorAll('.number-btn').forEach(btn => {
            btn.classList.remove('selected');
        });

        const selectedBtn = document.getElementById(`number-btn-${userEstimation}`);
        if (selectedBtn) {
            selectedBtn.classList.add('selected');
        }
    }

    function selectAnswer(answer) {
        userAnswer = answer;

        document.querySelectorAll('.answer-btn').forEach(btn => {
            btn.classList.remove('selected');
        });

        const selectedBtn = answer ? document.getElementById('yes-btn') : document.getElementById('no-btn');
        selectedBtn.classList.add('selected');

        updateSubmitButton();
    }

    function updateSubmitButton() {
        const submitBtn = document.getElementById('submit-btn');
        if (userAnswer !== null) {
            submitBtn.classList.add('enabled');
            submitBtn.disabled = false;
        } else {
            submitBtn.classList.remove('enabled');
            submitBtn.disabled = true;
        }
    }

    // ===== GAME ACTIONS =====
    async function submitAnswers() {
        if (userAnswer === null) {
            showNotification('Bitte w√§hle eine Antwort aus!', 'warning');
            return;
        }

        log('üì§ Submitting answers:', { answer: userAnswer, estimation: userEstimation });

        const answerData = {
            playerId: gameState.playerId,
            playerName: gameState.playerName,
            answer: userAnswer,
            estimation: userEstimation,
            isHost: gameState.isHost
        };

        try {
            if (firebaseService.isReady) {
                await firebaseService.submitAnswer(
                    gameState.gameId,
                    currentQuestionNumber,
                    gameState.playerId,
                    answerData
                );
            }

            showNotification('Antworten gesendet! üéØ', 'success');
            showPhase('waiting');

        } catch (error) {
            log(`‚ùå Error submitting: ${error.message}`, 'error');
            showNotification('Fehler beim Senden', 'error');
        }
    }

    // ===== PHASE MANAGEMENT =====
    function showPhase(phase) {
        document.querySelectorAll('.game-phase').forEach(p => {
            p.classList.remove('active');
        });

        document.getElementById(`${phase}-phase`).classList.add('active');
        currentPhase = phase;

        log(`üìç Phase: ${phase}`);
    }

    // ===== WAITING PHASE =====
    function updateWaitingStatus(answers = {}) {
        const statusContainer = document.getElementById('players-status');
        statusContainer.innerHTML = '';

        Object.values(currentPlayers).forEach(player => {
            const hasAnswered = answers[player.id] !== undefined;

            const statusItem = document.createElement('div');
            statusItem.className = 'player-status-item';

            const statusIndicator = hasAnswered ?
                '<span class="status-indicator status-done">‚úÖ Fertig</span>' :
                '<span class="status-indicator status-waiting">‚è≥ Wartet...</span>';

            statusItem.innerHTML = `
                    <span>${player.name}</span>
                    ${statusIndicator}
                `;

            statusContainer.appendChild(statusItem);
        });
    }

    // ===== RESULTS CALCULATION =====
    function calculateAndShowResults() {
        if (!currentRoundData || !currentRoundData.answers) {
            log('‚ùå No round data available');
            return;
        }

        const answers = currentRoundData.answers;
        const actualYesCount = Object.values(answers).filter(a => a.answer === true).length;

        // Calculate results
        const results = Object.values(answers).map(playerAnswer => {
            const difference = Math.abs(playerAnswer.estimation - actualYesCount);
            const isCorrect = difference === 0;

            let sips = 0;
            if (!isCorrect) {
                const baseSips = difficultyMultipliers[gameState.difficulty] || 2;
                sips = baseSips + Math.floor(difference / 2);
            }

            return {
                playerName: playerAnswer.playerName,
                answer: playerAnswer.answer,
                estimation: playerAnswer.estimation,
                difference: difference,
                isCorrect: isCorrect,
                sips: sips
            };
        });

        displayRoundResults(results, actualYesCount);
        showPhase('results');

        log('üìä Results calculated:', results);
    }

    function displayRoundResults(results, actualYesCount) {
        document.getElementById('results-round').textContent = currentQuestionNumber;
        document.getElementById('results-summary').textContent =
            `${actualYesCount} von ${totalPlayers || results.length} Spielern haben mit "Ja" geantwortet`;
        document.getElementById('correct-count').textContent = actualYesCount;

        const resultsGrid = document.getElementById('results-grid');
        resultsGrid.innerHTML = '';

        results.forEach(result => {
            const resultItem = document.createElement('div');
            resultItem.className = 'result-item';

            const avatar = result.playerName.substring(0, 2).toUpperCase();
            const answerText = result.answer ? 'Ja' : 'Nein';
            const sipsText = result.sips === 0 ? 'Perfekt! üéØ' : `${result.sips} üç∫`;
            const sipsClass = result.sips === 0 ? 'none' : '';

            resultItem.innerHTML = `
                    <div class="player-result">
                        <div class="player-avatar">${avatar}</div>
                        <div class="player-info">
                            <div class="player-name">${result.playerName}</div>
                            <div class="player-answer">${answerText} ‚Ä¢ Tipp: ${result.estimation}</div>
                        </div>
                    </div>
                    <div class="sips-penalty ${sipsClass}">${sipsText}</div>
                `;

            resultsGrid.appendChild(resultItem);
        });
    }

    // ===== GAME CONTROLS =====
    async function nextQuestion() {
        if (!gameState.isHost) {
            showNotification('Nur der Host kann weitermachen!', 'warning');
            return;
        }

        currentQuestionNumber++;
        updateGameDisplay();
        resetForNewQuestion();
        showPhase('question');

        await startNewRound();
        showNotification('Neue Frage geladen! üéÆ', 'success');
    }

    function waitForHost() {
        showNotification('Warte auf den Host...', 'info');
    }

    function goBack() {
        if (confirm('Zur√ºck zur Lobby?')) {
            cleanup();
            window.location.href = 'multiplayer-lobby.html';
        }
    }

    function cleanup() {
        if (gameListener) {
            try {
                gameListener.off();
            } catch (e) {}
        }
        if (roundListener) {
            try {
                roundListener.off();
            } catch (e) {}
        }
        if (firebaseService) {
            firebaseService.cleanup();
        }
    }

    // ===== CLEANUP =====
    window.addEventListener('beforeunload', cleanup);

    // ===== UTILITY FUNCTIONS =====
    function showLoading() {
        document.getElementById('loading-screen').classList.add('show');
    }

    function hideLoading() {
        document.getElementById('loading-screen').classList.remove('show');
    }

    function showNotification(message, type = 'info') {
        document.querySelectorAll('.toast-notification').forEach(n => n.remove());

        const notification = document.createElement('div');
        notification.className = `toast-notification ${type}`;
        notification.innerHTML = `
                <div class="toast-content">
                    <div class="toast-icon">${type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è'}</div>
                    <div class="toast-message">${message}</div>
                </div>
            `;

        document.body.appendChild(notification);

        setTimeout(() => notification.classList.add('show'), 100);

        setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => {
                if (document.body.contains(notification)) {
                    document.body.removeChild(notification);
                }
            }, 300);
        }, 4000);
    }

    function updateConnectionStatus(status, message = '') {
        const statusEl = document.getElementById('connection-status');
        statusEl.textContent = message || status;
        statusEl.className = `connection-status ${status}`;
    }

    function log(message, type = 'info') {
        const colors = {
            info: '#4488ff',
            warning: '#ffaa00',
            error: '#ff4444',
            success: '#00ff00'
        };
        console.log(`%c[Gameplay] ${message}`, `color: ${colors[type] || colors.info}`);
    }

    // ===== DEBUG =====
    window.debugGameplay = function() {
        console.log('üîç === GAMEPLAY DEBUG ===');
        console.log('GameState:', gameState);
        console.log('Firebase:', {
            initialized: firebaseService?.isInitialized,
            connected: firebaseService?.isConnected
        });
        console.log('Current Game Data:', currentGameData);
        console.log('Current Round Data:', currentRoundData);
        console.log('Current Question:', currentQuestion);
        console.log('Players:', currentPlayers);
    };

    log('‚úÖ Multiplayer Gameplay v6.0 FIXED - vollst√§ndig geladen!');
    log('üõ†Ô∏è Debug: debugGameplay()');
</script>
</body>
</html>