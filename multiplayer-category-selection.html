<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>DenkstDu - Kategorien w√§hlen (Host)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        /* Background Animation */
        .background-particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }

        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            animation: float 6s ease-in-out infinite;
        }

        .particle:nth-child(1) { top: 20%; left: 20%; animation-delay: 0s; }
        .particle:nth-child(2) { top: 80%; left: 80%; animation-delay: 2s; }
        .particle:nth-child(3) { top: 40%; left: 40%; animation-delay: 4s; }
        .particle:nth-child(4) { top: 60%; left: 10%; animation-delay: 6s; }
        .particle:nth-child(5) { top: 10%; left: 90%; animation-delay: 8s; }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
        }

        /* Loading Screen */
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(102, 126, 234, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .loading.show {
            opacity: 1;
            visibility: visible;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            color: white;
            font-size: 1.1rem;
            font-weight: 500;
        }

        /* Header */
        .header {
            text-align: center;
            padding: 40px 20px 20px;
            color: white;
        }

        .back-button {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 10px 16px;
            border-radius: 10px;
            font-family: inherit;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 100;
            font-size: 0.9rem;
        }

        .back-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateX(-2px);
        }

        .host-badge {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }

        .header h1 {
            font-size: 2.2rem;
            font-weight: 800;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1rem;
            font-weight: 400;
            opacity: 0.9;
            margin-bottom: 15px;
        }

        .game-info {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 10px;
            padding: 10px 20px;
            margin: 0 auto;
            max-width: 300px;
            font-size: 0.9rem;
            backdrop-filter: blur(10px);
        }

        /* Main Content */
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 0 20px 40px;
        }

        /* Category Cards */
        .categories-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        @media (min-width: 768px) {
            .categories-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (min-width: 1024px) {
            .categories-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        .category-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 25px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px solid transparent;
            position: relative;
            overflow: hidden;
            min-height: 280px;
            display: flex;
            flex-direction: column;
        }

        .category-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.15);
        }

        .category-card.selected {
            border-color: #4CAF50;
            transform: scale(1.05);
            box-shadow: 0 20px 40px rgba(76, 175, 80, 0.4);
            background: linear-gradient(145deg, rgba(76, 175, 80, 0.15), rgba(76, 175, 80, 0.05));
            position: relative;
            animation: selectedPulse 2s ease-in-out infinite;
        }

        .category-card.selected::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, #4CAF50, #45a049, #66BB6A, #4CAF50);
            background-size: 400% 400%;
            border-radius: 22px;
            z-index: -1;
            animation: gradientShift 3s ease infinite;
        }

        @keyframes selectedPulse {
            0%, 100% { 
                transform: scale(1.05);
                box-shadow: 0 20px 40px rgba(76, 175, 80, 0.4);
            }
            50% { 
                transform: scale(1.08);
                box-shadow: 0 25px 50px rgba(76, 175, 80, 0.6);
            }
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .category-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            display: block;
        }

        .category-name {
            font-size: 1.3rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 8px;
        }

        .category-description {
            color: #666;
            font-size: 0.9rem;
            line-height: 1.4;
            margin-bottom: 15px;
            flex-grow: 1;
        }

        .category-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 15px;
            border-top: 1px solid #eee;
            font-size: 0.85rem;
            margin-top: auto;
        }

        .questions-count {
            font-weight: 600;
            color: #4CAF50;
        }

        .fsk-badge {
            background: #e0e0e0;
            color: #666;
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .fsk-badge.fsk16 {
            background: #FF9800;
            color: white;
        }

        .fsk-badge.fsk18 {
            background: #f44336;
            color: white;
        }

        .selection-indicator {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
            opacity: 0;
            transform: scale(0) rotate(-180deg);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
            border: 3px solid white;
        }

        .category-card.selected .selection-indicator {
            opacity: 1;
            transform: scale(1) rotate(0deg);
            animation: checkmarkBounce 0.6s ease-out 0.2s;
        }

        @keyframes checkmarkBounce {
            0% { transform: scale(1) rotate(0deg); }
            50% { transform: scale(1.3) rotate(10deg); }
            100% { transform: scale(1) rotate(0deg); }
        }

        .category-card.selected .category-name {
            color: #2E7D32;
            font-weight: 800;
            text-shadow: 0 2px 4px rgba(76, 175, 80, 0.2);
        }

        .category-card.selected .category-description {
            color: #388E3C;
        }

        .category-card.selected .questions-count {
            color: #2E7D32;
            font-weight: 700;
            text-shadow: 0 1px 2px rgba(76, 175, 80, 0.3);
        }

        /* Sparkle effect for selected cards */
        .category-card.selected::after {
            content: '‚ú®';
            position: absolute;
            top: 10px;
            left: 10px;
            font-size: 1.5rem;
            opacity: 0.8;
            animation: sparkle 2s ease-in-out infinite;
        }

        @keyframes sparkle {
            0%, 100% { 
                opacity: 0.8;
                transform: rotate(0deg) scale(1);
            }
            50% { 
                opacity: 1;
                transform: rotate(180deg) scale(1.2);
            }
        }

        /* Selection Summary */
        .selection-summary {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            display: none;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .selection-summary.show {
            display: block;
        }

        .summary-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .summary-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: #333;
        }

        .summary-stats {
            font-size: 0.9rem;
            color: #666;
        }

        .selected-categories-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }

        .selected-category-tag {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 10px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
            border: 2px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .selected-category-tag::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .selected-category-tag:hover::before {
            left: 100%;
        }

        .selected-category-tag:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(76, 175, 80, 0.4);
        }

        /* Sync Status */
        .sync-status {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 15px;
            padding: 15px;
            color: white;
            text-align: center;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            backdrop-filter: blur(10px);
        }

        .sync-icon {
            font-size: 1.2rem;
            animation: rotate 2s linear infinite;
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Controls */
        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 15px 30px;
            border-radius: 12px;
            border: none;
            font-family: inherit;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
            min-width: 150px;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(76, 175, 80, 0.4);
        }

        .btn-outline {
            background: transparent;
            border: 2px solid rgba(255, 255, 255, 0.5);
            color: white;
        }

        .btn-outline:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.1);
            border-color: white;
        }

        /* Age Verification Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 0;
            max-width: 500px;
            width: 90%;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            background: linear-gradient(135deg, #f44336, #d32f2f);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.3rem;
            font-weight: 600;
        }

        .modal-body {
            padding: 30px 20px;
            text-align: center;
            color: #333;
        }

        .modal-body p {
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .age-warning {
            background: #fff3e0;
            border: 1px solid #ffb74d;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            color: #e65100;
            font-weight: 500;
        }

        .modal-footer {
            padding: 0 20px 20px;
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: white;
            color: #333;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            z-index: 2000;
            transition: transform 0.3s ease;
            font-weight: 500;
            max-width: 90%;
        }

        .notification.show {
            transform: translateX(-50%) translateY(0);
        }

        .notification.success {
            border-left: 4px solid #4CAF50;
        }

        .notification.warning {
            border-left: 4px solid #FF9800;
        }

        .notification.error {
            border-left: 4px solid #f44336;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8rem;
            }

            .back-button, .host-badge {
                position: static;
                margin: 10px;
                display: inline-block;
            }

            .header {
                padding-top: 20px;
            }

            .category-card {
                padding: 20px 15px;
                min-height: 250px;
            }

            .category-icon {
                font-size: 2.5rem;
            }

            .controls {
                flex-direction: column;
                align-items: center;
            }

            .btn {
                width: 100%;
                max-width: 300px;
            }
        }
    </style>
</head>
<body>
    <!-- Background Particles -->
    <div class="background-particles">
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
    </div>

    <!-- Loading Screen -->
    <div class="loading" id="loading">
        <div class="loading-spinner"></div>
        <div class="loading-text">Kategorien werden synchronisiert...</div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification"></div>

    <!-- Back Button -->
    <button class="back-button" onclick="goBack()">‚Üê Zur√ºck</button>

    <!-- Host Badge -->
    <div class="host-badge">üëë Host</div>

    <!-- Header -->
    <div class="header">
        <h1>üéØ Kategorien ausw√§hlen</h1>
        <p>W√§hle die Kategorien f√ºr euer Spiel aus</p>
        <div class="game-info">
            <span>üéÆ Spiel-ID: <strong id="game-id-display">Wird geladen...</strong></span>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container">
        <div class="content">
            <!-- Categories Grid -->
            <div class="categories-grid">
                <div class="category-card" data-category="fsk0" onclick="toggleCategory(this)">
                    <div class="selection-indicator">‚úì</div>
                    <span class="category-icon">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</span>
                    <h3 class="category-name">Familie & Freunde</h3>
                    <p class="category-description">
                        Harmlose und lustige Fragen f√ºr die ganze Familie. 
                        Perfekt f√ºr gemischte Gruppen jeden Alters.
                    </p>
                    <div class="category-stats">
                        <span class="questions-count">350+ Fragen</span>
                        <span class="fsk-badge">FSK 0</span>
                    </div>
                </div>

                <div class="category-card" data-category="fsk16" onclick="toggleCategory(this)">
                    <div class="selection-indicator">‚úì</div>
                    <span class="category-icon">üéâ</span>
                    <h3 class="category-name">Party Time</h3>
                    <p class="category-description">
                        Freche und witzige Fragen f√ºr Jugendliche und junge Erwachsene. 
                        Ideal f√ºr Partys und WG-Abende.
                    </p>
                    <div class="category-stats">
                        <span class="questions-count">300+ Fragen</span>
                        <span class="fsk-badge fsk16">FSK 16</span>
                    </div>
                </div>

                <div class="category-card" data-category="fsk18" onclick="toggleCategory(this)">
                    <div class="selection-indicator">‚úì</div>
                    <span class="category-icon">üî•</span>
                    <h3 class="category-name">Hei√ü & Gewagt</h3>
                    <p class="category-description">
                        Intime und tabulos Fragen nur f√ºr Erwachsene. 
                        Nichts f√ºr schwache Nerven!
                    </p>
                    <div class="category-stats">
                        <span class="questions-count">250+ Fragen</span>
                        <span class="fsk-badge fsk18">FSK 18</span>
                    </div>
                </div>
            </div>

            <!-- Selection Summary -->
            <div class="selection-summary" id="selection-summary">
                <div class="summary-header">
                    <h3 class="summary-title">üìã Deine Auswahl</h3>
                    <div class="summary-stats">
                        <span id="total-questions">0</span> Fragen verf√ºgbar
                    </div>
                </div>
                <div class="selected-categories-list" id="selected-categories-list">
                    <!-- Selected categories will be inserted here -->
                </div>
            </div>

            <!-- Sync Status -->
            <div class="sync-status">
                <div class="sync-icon">üîÑ</div>
                <div class="sync-text">Kategorien werden mit allen Spielern synchronisiert</div>
            </div>

            <!-- Controls -->
            <div class="controls">
                <button class="btn btn-outline" onclick="goBack()">‚Üê Zur√ºck</button>
                <button class="btn btn-primary" id="continueBtn" onclick="proceedWithCategories()" disabled>
                    Mindestens eine Kategorie w√§hlen
                </button>
            </div>
        </div>
    </div>

    <!-- Age Verification Modal -->
    <div class="modal" id="age-verification-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üîû Altersverifikation</h3>
            </div>
            <div class="modal-body">
                <p><strong>"Hei√ü & Gewagt"</strong> enth√§lt intime und explizite Fragen, die nur f√ºr Erwachsene geeignet sind.</p>
                
                <div class="age-warning">
                    <strong>‚ö†Ô∏è Warnung:</strong> Diese Kategorie enth√§lt sexuelle Inhalte und ist nur f√ºr Personen ab 18 Jahren bestimmt.
                </div>
                
                <p>Best√§tigst du, dass alle Spieler mindestens 18 Jahre alt sind?</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeAgeVerificationModal()">Abbrechen</button>
                <button class="btn btn-primary" onclick="confirmAge()">Ja, alle sind 18+</button>
            </div>
        </div>
    </div>

    <!-- Game State Management -->
    <script>
        // ===== KORRIGIERTE GameState-Klasse =====
        class GameState {
            constructor() {
                this.reset();
                this.loadFromStorage();
            }

            reset() {
                this.deviceMode = null; // 'single' or 'multi'
                this.selectedCategories = [];
                this.difficulty = null; // 'easy', 'medium', 'hard'
                this.players = [];
                this.gameId = null;
                this.playerName = null;
                this.isHost = false;
                this.isGuest = false;
                this.currentRound = 1;
                this.totalRounds = 10;
                this.gameState = 'setup';
                this.currentPlayerIndex = 0;
                this.scores = {};
                this.currentAnswers = {};
                this.questions = [];
                this.isGameActive = false;
                this.gameResults = [];
                this.sipsSettings = {
                    easy: 1,    // 1 Schluck + Abweichung
                    medium: 2,  // 2 Schl√ºcke + Abweichung
                    hard: 3     // 3 Schl√ºcke + Abweichung
                };
            }

            saveToStorage() {
                try {
                    const stateToSave = {
                        deviceMode: this.deviceMode,
                        selectedCategories: this.selectedCategories,
                        difficulty: this.difficulty,
                        players: this.players,
                        gameId: this.gameId,
                        playerName: this.playerName,
                        isHost: this.isHost,
                        isGuest: this.isGuest,
                        currentRound: this.currentRound,
                        totalRounds: this.totalRounds,
                        gameState: this.gameState,
                        currentPlayerIndex: this.currentPlayerIndex,
                        scores: this.scores,
                        isGameActive: this.isGameActive,
                        timestamp: Date.now(),
                        version: 2 // For future compatibility
                    };

                    localStorage.setItem('denkstdu_game_state', JSON.stringify(stateToSave));
                    console.log('üíæ GameState saved successfully:', stateToSave);
                    return true;
                } catch (error) {
                    console.error('‚ùå Could not save game state:', error);
                    return false;
                }
            }

            loadFromStorage() {
                try {
                    // Prim√§rer Key-Versuch
                    let saved = localStorage.getItem('denkstdu_game_state');
                    let keyUsed = 'denkstdu_game_state';
                    
                    // Falls nicht gefunden, versuche alternative Keys
                    if (!saved) {
                        const alternativeKeys = ['denkstdu_gamestate', 'gameState', 'denkstdu_state'];
                        for (const key of alternativeKeys) {
                            saved = localStorage.getItem(key);
                            if (saved) {
                                keyUsed = key;
                                console.log(`üìÇ Found state under alternative key: ${key}`);
                                break;
                            }
                        }
                    }
                    
                    if (saved) {
                        const state = JSON.parse(saved);
                        console.log(`üìÇ Loading state from storage (${keyUsed}):`, state);
                        
                        // Weniger strenge Versionspr√ºfung - akzeptiere alle Versionen
                        if (state.timestamp && Date.now() - state.timestamp < 24 * 60 * 60 * 1000) {
                            Object.assign(this, state);
                            console.log('‚úÖ State loaded successfully from:', keyUsed);
                            
                            // Normalisiere den Storage unter dem Standard-Key
                            if (keyUsed !== 'denkstdu_game_state') {
                                this.saveToStorage();
                                console.log('üîÑ Normalized storage to standard key');
                            }
                            
                            return true;
                        } else {
                            console.log('‚è∞ State too old, clearing...');
                            this.clearStorage();
                        }
                    } else {
                        console.log('üìÇ No saved state found in any localStorage key');
                        
                        // DEBUG: Zeige alle localStorage-Keys an
                        console.log('üîç All localStorage keys:', Object.keys(localStorage).filter(k => k.includes('denkst')));
                    }
                } catch (error) {
                    console.error('‚ùå Could not load game state:', error);
                    this.clearStorage();
                }
                return false;
            }

            clearStorage() {
                localStorage.removeItem('denkstdu_game_state');
                console.log('üóëÔ∏è GameState storage cleared');
            }

            // WICHTIG: Diese Methode wird von device-selection.html aufgerufen
            setDeviceMode(mode) {
                this.deviceMode = mode;
                this.saveToStorage();
                console.log('üîß Device mode set to:', mode);
            }

            // Add/remove categories
            toggleCategory(category) {
                const index = this.selectedCategories.indexOf(category);
                if (index === -1) {
                    this.selectedCategories.push(category);
                } else {
                    this.selectedCategories.splice(index, 1);
                }
                this.saveToStorage();
            }

            // Set difficulty
            setDifficulty(difficulty) {
                this.difficulty = difficulty;
                this.saveToStorage();
            }
        }
        // ===== Global Variables =====
        let gameState;
        let firebaseService;
        let selectedCategories = [];
        let pendingAgeVerification = null;

        // Category data
        const categoryData = {
            fsk0: {
                name: 'Familie & Freunde',
                icon: 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶',
                questions: 350,
                color: '#4CAF50'
            },
            fsk16: {
                name: 'Party Time',
                icon: 'üéâ',
                questions: 300,
                color: '#FF9800'
            },
            fsk18: {
                name: 'Hei√ü & Gewagt',
                icon: 'üî•',
                questions: 250,
                color: '#F44336'
            }
        };

        // ===== Page Initialization =====
        function initPage() {
            console.log('üéØ Initializing multiplayer category selection...');
            
            try {
                // Initialize game state
                gameState = new GameState();
                
                // DEBUG: Log the loaded state
                console.log('üîç Loaded GameState:', {
                    deviceMode: gameState.deviceMode,
                    selectedCategories: gameState.selectedCategories,
                    isHost: gameState.isHost,
                    gameId: gameState.gameId
                });
                
                // DEBUG: Check localStorage directly
                const storedState = localStorage.getItem('denkstdu_game_state');
                if (storedState) {
                    console.log('üîç Direct localStorage check:', JSON.parse(storedState));
                } else {
                    console.log('‚ùå No data in localStorage under key "denkstdu_game_state"');
                }
                
                // WORKAROUND: Also check alternative storage keys
                const altKeys = ['denkstdu_gamestate', 'denkstdu_state'];
                altKeys.forEach(key => {
                    const altState = localStorage.getItem(key);
                    if (altState) {
                        console.log(`üîç Found alternative storage under "${key}":`, JSON.parse(altState));
                        try {
                            const state = JSON.parse(altState);
                            if (state.deviceMode) {
                                gameState.deviceMode = state.deviceMode;
                                gameState.isHost = state.isHost || false;
                                gameState.gameId = state.gameId || null;
                                gameState.selectedCategories = state.selectedCategories || [];
                                console.log('‚úÖ Loaded state from alternative key:', key);
                            }
                        } catch (e) {
                            console.error('‚ùå Error parsing alternative state:', e);
                        }
                    }
                });
                
                // Verify multiplayer state
                if (gameState.deviceMode !== 'multi') {
                    console.warn('‚ùå Not in multiplayer mode. DeviceMode:', gameState.deviceMode);
                    showNotification('Nicht im Multiplayer-Modus. Weiterleitung...', 'warning');
                    setTimeout(() => {
                        window.location.href = 'device-selection.html';
                    }, 2000);
                    return;
                }
                
                // Display game ID
                if (gameState.gameId) {
                    document.getElementById('game-id-display').textContent = gameState.gameId;
                } else {
                    document.getElementById('game-id-display').textContent = 'Wird erstellt...';
                }
                
                // Load previously selected categories
                if (gameState.selectedCategories && gameState.selectedCategories.length > 0) {
                    selectedCategories = [...gameState.selectedCategories];
                    
                    // Update UI to reflect loaded categories
                    selectedCategories.forEach(category => {
                        const card = document.querySelector(`[data-category="${category}"]`);
                        if (card) {
                            card.classList.add('selected');
                        }
                    });
                    
                    updateSelectionSummary();
                }
                
                console.log('‚úÖ Multiplayer category selection initialized:', {
                    deviceMode: gameState.deviceMode,
                    gameId: gameState.gameId,
                    categories: gameState.selectedCategories,
                    isHost: gameState.isHost
                });

                hideLoading();
                
            } catch (error) {
                console.error('‚ùå Failed to initialize page:', error);
                showNotification('Fehler beim Laden der Seite', 'error');
                hideLoading();
            }
        }

        // ===== Category Selection Logic =====
        function toggleCategory(element) {
            const category = element.dataset.category;
            console.log('üîÑ Toggling category:', category);
            
            // Check if it's FSK18 and needs age verification
            if (category === 'fsk18' && !selectedCategories.includes(category)) {
                console.log('üîû FSK18 category requires age verification');
                pendingAgeVerification = element;
                showAgeVerificationModal();
                return;
            }
            
            // Add visual feedback immediately
            element.style.transform = 'scale(0.95)';
            setTimeout(() => {
                element.style.transform = '';
            }, 150);
            
            // Toggle selection
            if (selectedCategories.includes(category)) {
                // Remove category
                selectedCategories = selectedCategories.filter(c => c !== category);
                element.classList.remove('selected');
                showNotification(`${categoryData[category].name} entfernt`, 'warning');
                console.log('‚ûñ Category removed:', category);
            } else {
                // Add category
                selectedCategories.push(category);
                element.classList.add('selected');
                showNotification(`${categoryData[category].name} hinzugef√ºgt`, 'success');
                console.log('‚ûï Category added:', category);
                
                // Add celebration effect
                createCelebrationEffect(element);
            }
            
            updateSelectionSummary();
            syncWithFirebase();
        }

        // Add celebration effect for newly selected categories
        function createCelebrationEffect(element) {
            // Create floating emojis
            const emojis = ['üéâ', '‚ú®', 'üåü', 'üí´'];
            const rect = element.getBoundingClientRect();
            
            for (let i = 0; i < 4; i++) {
                const emoji = document.createElement('div');
                emoji.textContent = emojis[Math.floor(Math.random() * emojis.length)];
                emoji.style.cssText = `
                    position: fixed;
                    left: ${rect.left + rect.width / 2}px;
                    top: ${rect.top + rect.height / 2}px;
                    font-size: 1.5rem;
                    pointer-events: none;
                    z-index: 10000;
                    animation: celebrationFloat 1s ease-out forwards;
                    animation-delay: ${i * 0.1}s;
                `;
                
                document.body.appendChild(emoji);
                
                // Remove after animation
                setTimeout(() => {
                    if (emoji.parentNode) {
                        emoji.parentNode.removeChild(emoji);
                    }
                }, 1200);
            }
            
            // Add CSS for celebration animation if not exists
            if (!document.getElementById('celebration-style')) {
                const style = document.createElement('style');
                style.id = 'celebration-style';
                style.textContent = `
                    @keyframes celebrationFloat {
                        0% {
                            opacity: 1;
                            transform: translate(0, 0) scale(1);
                        }
                        100% {
                            opacity: 0;
                            transform: translate(${Math.random() * 200 - 100}px, -100px) scale(1.5);
                        }
                    }
                `;
                document.head.appendChild(style);
            }
        }

        // ===== Update Selection Summary =====
        function updateSelectionSummary() {
            const summaryElement = document.getElementById('selection-summary');
            const categoriesListElement = document.getElementById('selected-categories-list');
            const totalQuestionsElement = document.getElementById('total-questions');
            const continueBtn = document.getElementById('continueBtn');
            
            console.log('üîÑ Updating selection summary for categories:', selectedCategories);
            
            if (selectedCategories.length > 0) {
                summaryElement.classList.add('show');
                
                // Build category list HTML
                const categoryTags = selectedCategories.map(category => {
                    const data = categoryData[category];
                    return `
                        <div class="selected-category-tag">
                            <span>${data.icon}</span>
                            <span>${data.name}</span>
                        </div>
                    `;
                }).join('');
                
                categoriesListElement.innerHTML = categoryTags;

                // Calculate total questions
                const totalQuestions = selectedCategories.reduce((sum, category) => {
                    return sum + categoryData[category].questions;
                }, 0);
                
                totalQuestionsElement.textContent = totalQuestions.toLocaleString();
                
                // Enable continue button
                continueBtn.disabled = false;
                continueBtn.textContent = 'Weiter zur Schwierigkeit';
                
                console.log('‚úÖ Summary updated:', {
                    categories: selectedCategories,
                    totalQuestions: totalQuestions
                });
            } else {
                summaryElement.classList.remove('show');
                continueBtn.disabled = true;
                continueBtn.textContent = 'Mindestens eine Kategorie w√§hlen';
                console.log('‚ÑπÔ∏è No categories selected, hiding summary');
            }

            // KORREKTUR: Direkte Zuweisung statt setSelectedCategories() Methode
            gameState.selectedCategories = selectedCategories;
            gameState.saveToStorage();
        }

        // ===== Firebase Synchronization =====
        async function syncWithFirebase() {
            console.log('üîÑ Syncing categories with Firebase:', selectedCategories);
            // Placeholder for Firebase sync - would implement real sync here
        }

        // ===== Age Verification Modal =====
        function showAgeVerificationModal() {
            document.getElementById('age-verification-modal').classList.add('show');
            console.log('üîû Age verification modal shown');
        }

        function closeAgeVerificationModal() {
            const modal = document.getElementById('age-verification-modal');
            if (modal) {
                modal.classList.remove('show');
                console.log('‚ùå Age verification modal closed');
            }
            
            if (pendingAgeVerification) {
                console.log('üö´ Age verification cancelled by user');
                pendingAgeVerification = null;
            }
        }

        function confirmAge() {
            console.log('üîû Age confirmation started');
            
            if (pendingAgeVerification) {
                console.log('‚úÖ Pending verification found:', pendingAgeVerification.dataset.category);
                
                try {
                    // Close modal first
                    closeAgeVerificationModal();
                    
                    // Get the category from the pending element
                    const category = pendingAgeVerification.dataset.category;
                    
                    // Add category to selectedCategories array
                    if (!selectedCategories.includes(category)) {
                        selectedCategories.push(category);
                        console.log('‚ûï Category added to array:', category);
                    }
                    
                    // Add visual selection to the card
                    pendingAgeVerification.classList.add('selected');
                    
                    // Show success notification
                    showNotification(`${categoryData[category].name} hinzugef√ºgt`, 'success');
                    console.log('‚úÖ Age verified, FSK18 category added successfully');
                    
                    // Add celebration effect
                    createCelebrationEffect(pendingAgeVerification);
                    
                    // Update the UI
                    updateSelectionSummary();
                    
                    // Sync with Firebase
                    syncWithFirebase();
                    
                    // Clear the pending verification
                    pendingAgeVerification = null;
                    
                } catch (error) {
                    console.error('‚ùå Error in confirmAge:', error);
                    showNotification('Fehler beim Hinzuf√ºgen der Kategorie', 'error');
                    pendingAgeVerification = null;
                }
            } else {
                console.warn('‚ö†Ô∏è No pending age verification found');
                showNotification('Keine ausstehende Altersverifikation gefunden', 'warning');
            }
        }

        // ===== Navigation Functions =====
        function proceedWithCategories() {
            if (selectedCategories.length === 0) {
                showNotification('Bitte w√§hle mindestens eine Kategorie aus', 'warning');
                return;
            }

            console.log('üöÄ Proceeding with categories:', selectedCategories);
            showLoading();
            
            // KORREKTUR: Direkte Zuweisung statt setSelectedCategories() Methode
            gameState.selectedCategories = selectedCategories;
            gameState.saveToStorage();
            
            // Final sync with Firebase
            syncWithFirebase();
            
            setTimeout(() => {
                window.location.href = 'multiplayer-difficulty-selection.html';
            }, 500);
        }

        function goBack() {
            console.log('‚¨ÖÔ∏è Going back to device selection');
            showLoading();
            
            setTimeout(() => {
                window.location.href = 'device-selection.html';
            }, 300);
        }

        // ===== Utility Functions =====
        function showLoading() {
            const loading = document.getElementById('loading');
            if (loading) {
                loading.classList.add('show');
            }
        }

        function hideLoading() {
            const loading = document.getElementById('loading');
            if (loading) {
                loading.classList.remove('show');
            }
        }

        function showNotification(message, type = 'info', duration = 3000) {
            const notification = document.getElementById('notification');
            if (notification) {
                notification.textContent = message;
                notification.className = `notification ${type} show`;
                
                setTimeout(() => {
                    notification.classList.remove('show');
                }, duration);
                
                console.log(`üì¢ Notification: ${message} (${type})`);
            }
        }

        // ===== Error Handling =====
        window.addEventListener('error', function(event) {
            console.error('üí• JavaScript Error:', event.error);
            showNotification('Ein unerwarteter Fehler ist aufgetreten', 'error');
        });

        // ===== Initialize on DOM Ready =====
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üìÑ DOM loaded, initializing page...');
            
            // Small delay to ensure all resources are loaded
            setTimeout(() => {
                initPage();
            }, 100);
        });

        // ===== Debugging Functions (for development) =====
        window.debugInfo = function() {
            console.log('üêõ Debug Info:', {
                gameState: gameState ? {
                    deviceMode: gameState.deviceMode,
                    isHost: gameState.isHost,
                    gameId: gameState.gameId,
                    selectedCategories: gameState.selectedCategories,
                    difficulty: gameState.difficulty
                } : 'Not initialized',
                selectedCategories: selectedCategories,
                dom: {
                    summaryVisible: document.getElementById('selection-summary').classList.contains('show'),
                    continueButtonDisabled: document.getElementById('continueBtn').disabled,
                    selectedCards: document.querySelectorAll('.category-card.selected').length
                }
            });
        };

        // Make debug function available globally for testing
        if (typeof window !== 'undefined') {
            window.denkstduDebug = window.debugInfo;
        }
    </script>
</body>
</html>