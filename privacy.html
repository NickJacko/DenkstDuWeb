// DenkstDu - Privacy & GDPR Compliance Functions
// Datenschutz-konforme Funktionen f√ºr die App

// ============================================================================
// PRIVACY CONSENT MANAGEMENT
// ============================================================================

// Check if user has given privacy consent
function hasPrivacyConsent() {
    const consent = localStorage.getItem('denkstdu_privacy_accepted');
    const consentDate = localStorage.getItem('denkstdu_privacy_date');
    
    if (!consent || !consentDate) {
        return false;
    }
    
    // Check if consent is still valid (1 year)
    const consentTime = new Date(consentDate).getTime();
    const currentTime = Date.now();
    const daysSinceConsent = (currentTime - consentTime) / (24 * 60 * 60 * 1000);
    
    if (daysSinceConsent > 365) {
        // Consent expired - remove old consent
        localStorage.removeItem('denkstdu_privacy_accepted');
        localStorage.removeItem('denkstdu_privacy_date');
        return false;
    }
    
    return true;
}

// Show privacy consent notice
function showPrivacyInfo() {
    const existingNotice = document.getElementById('privacy-notice');
    if (existingNotice) {
        existingNotice.classList.add('show');
        return;
    }
    
    // Create privacy notice if it doesn't exist
    const notice = document.createElement('div');
    notice.id = 'privacy-notice';
    notice.className = 'privacy-notice';
    notice.innerHTML = `
        <div class="privacy-text">
            <strong>üç™ Datenschutz & Cookies</strong><br>
            Wir verwenden nur technisch notwendige Daten f√ºr das Multiplayer-Spiel. 
            Keine Werbung, kein Tracking. Alle Daten werden nach 24h automatisch gel√∂scht.
            <br><br>
            <a href="privacy.html" style="color: #4facfe;" target="_blank">‚Üí Vollst√§ndige Datenschutzerkl√§rung</a>
        </div>
        <div class="privacy-buttons">
            <button class="btn btn-outline" onclick="declinePrivacy()">Ablehnen</button>
            <button class="btn" onclick="acceptPrivacy()">Akzeptieren</button>
        </div>
    `;
    
    document.body.appendChild(notice);
    
    // Show with animation
    setTimeout(() => {
        notice.classList.add('show');
    }, 100);
}

// Accept privacy consent
function acceptPrivacy() {
    const consentData = {
        accepted: true,
        date: new Date().toISOString(),
        version: '1.0',
        userAgent: navigator.userAgent,
        language: navigator.language
    };
    
    localStorage.setItem('denkstdu_privacy_accepted', 'true');
    localStorage.setItem('denkstdu_privacy_date', consentData.date);
    localStorage.setItem('denkstdu_privacy_details', JSON.stringify(consentData));
    
    // Hide privacy notice
    const notice = document.getElementById('privacy-notice');
    if (notice) {
        notice.classList.remove('show');
        setTimeout(() => {
            if (notice.parentNode) {
                notice.remove();
            }
        }, 500);
    }
    
    // Show confirmation
    if (typeof showNotification === 'function') {
        showNotification('Datenschutz akzeptiert! Multiplayer-Features sind nun verf√ºgbar.', 'success');
    }
    
    // Enable multiplayer features
    enableMultiplayerFeatures();
    
    // Track consent (anonymously)
    trackPrivacyConsent('accepted');
}

// Decline privacy consent
function declinePrivacy() {
    // Log declined consent
    const declineData = {
        declined: true,
        date: new Date().toISOString(),
        version: '1.0'
    };
    
    localStorage.setItem('denkstdu_privacy_declined', 'true');
    localStorage.setItem('denkstdu_privacy_decline_date', declineData.date);
    
    // Hide privacy notice
    const notice = document.getElementById('privacy-notice');
    if (notice) {
        notice.classList.remove('show');
        setTimeout(() => {
            if (notice.parentNode) {
                notice.remove();
            }
        }, 500);
    }
    
    // Show information about limitations
    if (typeof showNotification === 'function') {
        showNotification('Ohne Datenschutz-Zustimmung sind nur lokale Spiele m√∂glich.', 'warning', 5000);
    }
    
    // Disable multiplayer features
    disableMultiplayerFeatures();
    
    // Track decline (anonymously)
    trackPrivacyConsent('declined');
}

// Revoke previously given consent
function revokePrivacyConsent() {
    if (confirm('Datenschutz-Zustimmung wirklich widerrufen? Multiplayer-Features werden deaktiviert und alle gespeicherten Daten gel√∂scht.')) {
        // Remove consent
        localStorage.removeItem('denkstdu_privacy_accepted');
        localStorage.removeItem('denkstdu_privacy_date');
        localStorage.removeItem('denkstdu_privacy_details');
        
        // Clear all personal data
        clearPersonalData();
        
        // Disable multiplayer features
        disableMultiplayerFeatures();
        
        // Show confirmation
        if (typeof showNotification === 'function') {
            showNotification('Datenschutz-Zustimmung widerrufen und Daten gel√∂scht.', 'success');
        }
        
        // Track revocation
        trackPrivacyConsent('revoked');
        
        // Redirect to home if on multiplayer page
        if (window.location.pathname.includes('multiplayer') || 
            window.location.pathname.includes('join-game')) {
            window.location.href = 'index.html';
        }
    }
}

// ============================================================================
// MULTIPLAYER FEATURE MANAGEMENT
// ============================================================================

// Enable multiplayer features
function enableMultiplayerFeatures() {
    // Remove disabled state from multiplayer buttons
    document.querySelectorAll('[data-requires-privacy]').forEach(element => {
        element.disabled = false;
        element.classList.remove('privacy-disabled');
    });
    
    // Show multiplayer options
    document.querySelectorAll('.multiplayer-feature').forEach(element => {
        element.style.display = '';
    });
    
    // Initialize Firebase if available
    if (typeof initFirebase === 'function') {
        initFirebase();
    }
}

// Disable multiplayer features
function disableMultiplayerFeatures() {
    // Disable multiplayer buttons
    document.querySelectorAll('[data-requires-privacy]').forEach(element => {
        element.disabled = true;
        element.classList.add('privacy-disabled');
    });
    
    // Hide multiplayer options
    document.querySelectorAll('.multiplayer-feature').forEach(element => {
        element.style.display = 'none';
    });
    
    // Clear any active multiplayer connections
    if (typeof firebase !== 'undefined' && firebase.apps.length > 0) {
        firebase.database().goOffline();
    }
}

// ============================================================================
// DATA MANAGEMENT
// ============================================================================

// Clear all personal data
function clearPersonalData() {
    // List of keys that may contain personal data
    const personalDataKeys = [
        'denkstdu_game_state',
        'denkstdu_player_name',
        'denkstdu_game_history',
        'denkstdu_user_stats',
        'activeGameId',
        'playerName'
    ];
    
    // Remove personal data
    personalDataKeys.forEach(key => {
        localStorage.removeItem(key);
    });
    
    // Clear game state if available
    if (typeof gameState !== 'undefined' && gameState.clearPersonalData) {
        gameState.clearPersonalData();
    }
    
    // Clear any cached data
    if ('caches' in window) {
        caches.keys().then(names => {
            names.forEach(name => {
                if (name.includes('denkstdu')) {
                    caches.delete(name);
                }
            });
        });
    }
}

// Export user data (GDPR Article 20 - Right to data portability)
function exportUserData() {
    const userData = {
        meta: {
            exportDate: new Date().toISOString(),
            version: '1.0',
            appVersion: '1.0.0'
        },
        consent: {
            accepted: localStorage.getItem('denkstdu_privacy_accepted') === 'true',
            date: localStorage.getItem('denkstdu_privacy_date'),
            details: JSON.parse(localStorage.getItem('denkstdu_privacy_details') || '{}')
        },
        settings: JSON.parse(localStorage.getItem('denkstdu_settings') || '{}'),
        statistics: JSON.parse(localStorage.getItem('denkstdu_user_stats') || '{}'),
        gameState: null,
        gameHistory: JSON.parse(localStorage.getItem('denkstdu_game_history') || '[]')
    };
    
    // Add game state if available
    if (typeof gameState !== 'undefined' && gameState.exportGameData) {
        userData.gameState = gameState.exportGameData();
    }
    
    // Create and download file
    const dataStr = JSON.stringify(userData, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    
    const link = document.createElement('a');
    link.href = URL.createObjectURL(dataBlob);
    link.download = `denkstdu-data-export-${new Date().toISOString().split('T')[0]}.json`;
    
    // Trigger download
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    // Show confirmation
    if (typeof showNotification === 'function') {
        showNotification('Daten erfolgreich exportiert!', 'success');
    }
    
    // Log export
    console.log('User data exported:', userData.meta);
}

// ============================================================================
// DATA RETENTION MANAGEMENT
// ============================================================================

// Clean up expired data
function cleanupExpiredData() {
    const now = Date.now();
    const oneDay = 24 * 60 * 60 * 1000;
    const oneWeek = 7 * oneDay;
    
    // Clean up game sessions older than 24 hours
    const gameState = localStorage.getItem('denkstdu_game_state');
    if (gameState) {
        try {
            const parsed = JSON.parse(gameState);
            if (parsed.timestamp && now - parsed.timestamp > oneDay) {
                localStorage.removeItem('denkstdu_game_state');
                console.log('Expired game state cleaned up');
            }
        } catch (e) {
            // Invalid data, remove it
            localStorage.removeItem('denkstdu_game_state');
        }
    }
    
    // Clean up old game history (keep only last 7 days)
    const gameHistory = JSON.parse(localStorage.getItem('denkstdu_game_history') || '[]');
    const recentHistory = gameHistory.filter(game => {
        return game.timestamp && now - game.timestamp < oneWeek;
    });
    
    if (recentHistory.length !== gameHistory.length) {
        localStorage.setItem('denkstdu_game_history', JSON.stringify(recentHistory));
        console.log(`Cleaned up ${gameHistory.length - recentHistory.length} old game records`);
    }
    
    // Clean up declined consent records (after 30 days)
    const declineDate = localStorage.getItem('denkstdu_privacy_decline_date');
    if (declineDate) {
        const thirtyDays = 30 * oneDay;
        if (now - new Date(declineDate).getTime() > thirtyDays) {
            localStorage.removeItem('denkstdu_privacy_declined');
            localStorage.removeItem('denkstdu_privacy_decline_date');
        }
    }
}

// Schedule automatic cleanup
function scheduleDataCleanup() {
    // Clean up on page load
    cleanupExpiredData();
    
    // Schedule periodic cleanup every hour
    setInterval(cleanupExpiredData, 60 * 60 * 1000);
    
    // Clean up on page unload
    window.addEventListener('beforeunload', cleanupExpiredData);
}

// ============================================================================
// PRIVACY TRACKING (ANONYMOUS)
// ============================================================================

// Track privacy consent decisions (anonymously)
function trackPrivacyConsent(action) {
    // Only track basic metrics, no personal information
    const trackingData = {
        action: action, // 'accepted', 'declined', 'revoked'
        timestamp: Date.now(),
        version: '1.0',
        userAgent: navigator.userAgent.substring(0, 50), // Truncated for privacy
        language: navigator.language,
        referrer: document.referrer ? 'external' : 'direct' // Simplified referrer
    };
    
    // Store locally for analytics (no external tracking)
    const existingTracking = JSON.parse(localStorage.getItem('denkstdu_privacy_analytics') || '[]');
    existingTracking.push(trackingData);
    
    // Keep only last 10 entries to limit storage
    const recentTracking = existingTracking.slice(-10);
    localStorage.setItem('denkstdu_privacy_analytics', JSON.stringify(recentTracking));
}

// ============================================================================
// PRIVACY COMPLIANCE CHECKS
// ============================================================================

// Check if feature requires privacy consent
function requiresPrivacyConsent(feature) {
    const privacyRequiredFeatures = [
        'multiplayer',
        'firebase',
        'online-sync',
        'share-game',
        'join-game',
        'cloud-save'
    ];
    
    return privacyRequiredFeatures.includes(feature);
}

// Block feature if privacy consent not given
function checkPrivacyForFeature(feature) {
    if (requiresPrivacyConsent(feature) && !hasPrivacyConsent()) {
        showPrivacyRequiredModal(feature);
        return false;
    }
    return true;
}

// Show modal explaining privacy requirement
function showPrivacyRequiredModal(feature) {
    const modal = document.createElement('div');
    modal.className = 'modal privacy-required-modal';
    modal.innerHTML = `
        <div class="modal-content">
            <h3>üîí Datenschutz-Zustimmung erforderlich</h3>
            <p>F√ºr diese Funktion ben√∂tigen wir deine Zustimmung zur Datenverarbeitung.</p>
            
            <div class="feature-explanation">
                ${getFeatureExplanation(feature)}
            </div>
            
            <div class="privacy-assurance">
                <h4>üõ°Ô∏è Deine Privatsph√§re ist gesch√ºtzt:</h4>
                <ul>
                    <li>‚úÖ Nur notwendige Daten werden verarbeitet</li>
                    <li>‚úÖ Automatische L√∂schung nach 24 Stunden</li>
                    <li>‚úÖ Keine Werbung oder Tracking</li>
                    <li>‚úÖ Jederzeit widerrufbar</li>
                </ul>
            </div>
            
            <div class="modal-buttons">
                <button class="btn btn-outline" onclick="closePrivacyRequiredModal()">
                    Abbrechen
                </button>
                <button class="btn" onclick="acceptPrivacyFromModal()">
                    Zustimmen & Fortfahren
                </button>
            </div>
            
            <div class="privacy-link">
                <a href="privacy.html" target="_blank">‚Üí Vollst√§ndige Datenschutzerkl√§rung</a>
            </div>
        </div>
    `;
    
    modal.style.cssText = `
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.8); display: flex; align-items: center;
        justify-content: center; z-index: 9999; padding: 20px;
    `;
    
    document.body.appendChild(modal);
    
    // Animate in
    setTimeout(() => {
        modal.querySelector('.modal-content').style.transform = 'scale(1)';
        modal.querySelector('.modal-content').style.opacity = '1';
    }, 10);
}

// Get explanation for specific feature
function getFeatureExplanation(feature) {
    const explanations = {
        'multiplayer': '<p><strong>Online-Multiplayer:</strong> Erm√∂glicht es dir, mit Freunden √ºber das Internet zu spielen. Daf√ºr werden Spielername und Spielantworten tempor√§r gespeichert.</p>',
        'firebase': '<p><strong>Cloud-Synchronisation:</strong> Synchronisiert Spielst√§nde zwischen Ger√§ten f√ºr ein nahtloses Spielerlebnis.</p>',
        'share-game': '<p><strong>Spiel teilen:</strong> Erstellt einen Link zum Teilen mit Freunden √ºber soziale Medien oder Messenger.</p>',
        'join-game': '<p><strong>Spiel beitreten:</strong> Erm√∂glicht es dir, einem bestehenden Online-Spiel beizutreten.</p>'
    };
    
    return explanations[feature] || '<p>Diese Funktion erfordert eine Online-Verbindung und Datensynchronisation.</p>';
}

// Close privacy required modal
function closePrivacyRequiredModal() {
    const modal = document.querySelector('.privacy-required-modal');
    if (modal) {
        modal.querySelector('.modal-content').style.transform = 'scale(0.8)';
        modal.querySelector('.modal-content').style.opacity = '0';
        setTimeout(() => {
            modal.remove();
        }, 300);
    }
}

// Accept privacy from modal and continue with feature
function acceptPrivacyFromModal() {
    acceptPrivacy();
    closePrivacyRequiredModal();
}

// ============================================================================
// INITIALIZATION
// ============================================================================

// Initialize privacy management
function initPrivacyManagement() {
    // Schedule data cleanup
    scheduleDataCleanup();
    
    // Check if privacy consent is needed
    if (!hasPrivacyConsent()) {
        // Show privacy notice after a delay (unless explicitly declined recently)
        const declined = localStorage.getItem('denkstdu_privacy_declined');
        const declineDate = localStorage.getItem('denkstdu_privacy_decline_date');
        
        if (!declined || (declineDate && Date.now() - new Date(declineDate).getTime() > 7 * 24 * 60 * 60 * 1000)) {
            // Show notice if not declined or decline was more than 7 days ago
            setTimeout(showPrivacyInfo, 2000);
        }
        
        // Disable multiplayer features initially
        disableMultiplayerFeatures();
    } else {
        // Enable multiplayer features
        enableMultiplayerFeatures();
    }
    
    // Add privacy status to UI
    updatePrivacyStatusUI();
}

// Update UI to show privacy status
function updatePrivacyStatusUI() {
    const hasConsent = hasPrivacyConsent();
    
    // Add CSS classes for styling
    if (hasConsent) {
        document.body.classList.add('privacy-accepted');
        document.body.classList.remove('privacy-required');
    } else {
        document.body.classList.add('privacy-required');
        document.body.classList.remove('privacy-accepted');
    }
    
    // Update multiplayer buttons
    document.querySelectorAll('[data-requires-privacy]').forEach(button => {
        if (!hasConsent) {
            button.setAttribute('title', 'Erfordert Datenschutz-Zustimmung');
            button.addEventListener('click', (e) => {
                e.preventDefault();
                checkPrivacyForFeature('multiplayer');
            });
        }
    });
}

// ============================================================================
// GDPR COMPLIANCE UTILITIES
// ============================================================================

// Generate privacy compliance report
function generatePrivacyReport() {
    const report = {
        timestamp: new Date().toISOString(),
        consent: {
            given: hasPrivacyConsent(),
            date: localStorage.getItem('denkstdu_privacy_date'),
            version: '1.0'
        },
        dataProcessing: {
            purposes: [
                'Multiplayer game functionality',
                'Game state synchronization',
                'User experience improvement'
            ],
            retention: '24 hours maximum',
            sharing: 'No data sharing with third parties',
            location: 'Firebase (Google Cloud, EU region)'
        },
        userRights: {
            access: 'Available via data export',
            rectification: 'Available via settings',
            erasure: 'Available via data deletion',
            portability: 'Available via data export',
            objection: 'Available via consent withdrawal'
        },
        technicalMeasures: {
            encryption: 'Data encrypted in transit and at rest',
            access: 'Restricted to authorized systems only',
            retention: 'Automatic deletion after 24 hours',
            monitoring: 'Access logs maintained'
        }
    };
    
    return report;
}

// Export functions for use in other scripts
if (typeof window !== 'undefined') {
    window.DenkstDuPrivacy = {
        hasPrivacyConsent,
        showPrivacyInfo,
        acceptPrivacy,
        declinePrivacy,
        revokePrivacyConsent,
        clearPersonalData,
        exportUserData,
        requiresPrivacyConsent,
        checkPrivacyForFeature,
        initPrivacyManagement,
        generatePrivacyReport
    };
}

// Auto-initialize when DOM is ready
document.addEventListener('DOMContentLoaded', initPrivacyManagement);